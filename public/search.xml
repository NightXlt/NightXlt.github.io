<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Maximum XOR of Two Numbers in an Array</title>
    <url>/2020/02/09/MAX_XOR/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="https-leetcode-cn-com-problems-maximum-xor-of-two-numbers-in-an-array"><a href="#https-leetcode-cn-com-problems-maximum-xor-of-two-numbers-in-an-array" class="headerlink" title="https://leetcode-cn.com/problems/maximum-xor-of-two-numbers-in-an-array/"></a><a href="https://leetcode-cn.com/problems/maximum-xor-of-two-numbers-in-an-array/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/maximum-xor-of-two-numbers-in-an-array/</a></h3><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>参考题解</p>
<p><a href="https://leetcode-cn.com/problems/maximum-xor-of-two-numbers-in-an-array/solution/li-yong-yi-huo-yun-suan-de-xing-zhi-tan-xin-suan-f/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/maximum-xor-of-two-numbers-in-an-array/solution/li-yong-yi-huo-yun-suan-de-xing-zhi-tan-xin-suan-f/</a></p>
<ol>
<li>如果 a ^ b = c, a ^ c = b, b ^ c = a，用来检测最大前缀是否正确，假设前面 n - 1位已知，假设第 n 位为 1令其为 temp。那么这个 temp 是否真的是最大的前缀呢？通过前面的公式进行测试。如果 t 是正确的最大前缀，那么 temp  ^ set 内的前缀 = set 内的前缀。也就是说 temp ^ set 内的数字 的结果必然在 set 内存在。因为 a (set 内元素) ^ b（set内元素） = C（最大前缀），那最大前缀 C ^ a (set 内元素) = b (set 内元素)</li>
<li>找到最大的值，尽可能找到二进制最高的位（贪心思想）</li>
<li>通过位掩码 找到 前缀，mask &amp; a = 从a 中取出 mask 中的标志位</li>
</ol>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function">fun <span class="title">findMaximumXOR</span><span class="params">(nums: IntArray)</span>: Int </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> mask = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (i in <span class="number">31</span> downTo <span class="number">0</span>) &#123; <span class="comment">//贪心思想，优先找到二进制中最高的位，再依次定下依次低位</span></span><br><span class="line">            mask = <span class="function">mask <span class="title">or</span> <span class="params">(<span class="number">1</span> shl i)</span></span></span><br><span class="line"><span class="function">            val set </span>= HashSet&lt;Int&gt;()</span><br><span class="line">            <span class="keyword">for</span> (num in nums) &#123;</span><br><span class="line">                set.add(num and mask) <span class="comment">//取出各数中对应 mask 的标志位</span></span><br><span class="line">            &#125;</span><br><span class="line">            val t = <span class="function">res <span class="title">or</span> <span class="params">(<span class="number">1</span> shl i)</span></span></span><br><span class="line"><span class="function">            <span class="title">for</span> <span class="params">(prefix in set)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (set.contains(prefix xor t)) &#123; <span class="comment">//判断set内是否存在异或结果</span></span><br><span class="line">                    res = t</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>Divide Two Integers</title>
    <url>/2020/01/31/dividend_with_bit/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><p><a href="https://leetcode-cn.com/problems/divide-two-integers/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/divide-two-integers/</a></p>
<p>给定两个数，不能使用乘除法，mod 运算。只能使用 Int 进行存储。而且当为 Int.MIN_VALUE(- 2^31) / -1返回 Int.MAX_VALUE(2^31 - 1) </p>
<p>Return the quotient after dividing dividend by divisor.</p>
<p>The integer division should truncate toward zero.</p>
<p>Note:</p>
<ul>
<li>Both dividend and divisor will be 32-bit signed integers.</li>
<li>The divisor will never be 0.</li>
<li>Assume we are dealing with an environment which could only store integers within the 32-bit signed integer range: [−2^31,  2^31 − 1]. For the purpose of this problem, assume that your function returns 2^31 − 1 when the division result overflows.</li>
</ul>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>不能使用乘除，mod求商。那只能使用位运算。位运算中左移右移会牵涉到<em>2操作。通过<code>二分法</code>进行迫近被除数，2^(n0 + n1 + n2 + n3+ ….) </em> divisor = dividend，我们需要做的就是逐一找到 n0, n1 等值。 比如 dividend = 10, divisor = 3可以拆为</p>
<p>3 <em>（2^1 + 2^0）+ 余数 等于 10，约等于是因为我们求得是<code>商</code>。除数 </em> 商是可能小于被除数的。余数是满足 &lt; divisor 的。</p>
<p>我们先找到divisor <em> 2 ^n0,这个 n0是所有幂中最大的一个，其最接近于 dividend。比如 dividend = 10, divisor = 3。那n0 = 1。再让 dividend = 10 - 3 </em> 2 = 4，再找到新的 dividend 符合的n1.直至 divisor &gt; dividend 终止，即余数小于除数。将找到的 n0，n1 等值计算得出 2的幂次方和返回。</p>
<p>大致思路如上，具体有些边界处理的问题，比如Int 的最大值为 2^31 - 1, 进行左移时，会出现 2 ^31越界情况。故将其均转为负数统一处理。在转为负数后，原来大的数就变小了，5 &gt; 3, -5 &lt; -3. if 判断里牵涉到 dividend 和 diviso比较r都需要变大小与号。</p>
<p>此外为了防止 divisor * 2^n0 &lt; Int.MIN_VALUE溢出，需要加一层兜底。那这层兜底应该怎么加呢？ 难道是这么判断</p>
<p>if (divisor shl 1 &lt; Int.MIN_VALUE ) {}，非也，如果 divisor 快要溢出了，再左移一位就会变为正数。Int.MIN_VALUE左移一位为 0. 那何不将 Int.MIN_VALUE 变小一点再进行比较呢？如 if (divisor &lt; Int.MIN_VALUE shr 1) {}。值得注意的是这里没有等于号没有等于号没有等于号。我们允许divisor * 2^n == dividend，但不能越界。</p>
<p>此外在从 Int.MIN_VALUE 变号为正号时需要特殊处理。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Divide</span> </span>&#123;</span><br><span class="line">    <span class="function">fun <span class="title">divide</span><span class="params">(dividend: Int, divisor: Int)</span>: Int </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (divisor == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ArithmeticException(<span class="string">"divide zero exception"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        val sign = (dividend &gt; <span class="number">0</span>) xor (divisor &gt; <span class="number">0</span>) <span class="comment">//记录两个数是否同号</span></span><br><span class="line">        <span class="keyword">var</span> dividend = dividend</span><br><span class="line">        <span class="keyword">var</span> divisor = divisor</span><br><span class="line">        <span class="keyword">if</span> (dividend &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            dividend = -dividend</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (divisor &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            divisor = -divisor</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> (dividend &lt;= divisor shl <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (divisor &lt; Int.MIN_VALUE shr <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            count++</span><br><span class="line">            divisor = divisor.shl(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> (count &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (divisor &gt;= dividend) &#123;</span><br><span class="line">                res += (-<span class="number">1</span>).shl(count)</span><br><span class="line">                dividend -= divisor</span><br><span class="line">            &#125;</span><br><span class="line">            count--</span><br><span class="line">            divisor = divisor.shr(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sign) &#123; <span class="comment">//异号直接返回</span></span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res &lt;= Int.MIN_VALUE) &#123; <span class="comment">//同号 * -1前需要进行边界处理</span></span><br><span class="line">            <span class="keyword">return</span> Int.MAX_VALUE</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>Implement strStr()</title>
    <url>/2020/01/30/strStr_kmp/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><p>Return the index of the first occurrence of needle in haystack, or -1 if needle is not part of haystack.</p>
<p>links: <a href="https://leetcode-cn.com/problems/implement-strstr/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/implement-strstr/</a></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>参考：</p>
<p><a href="https://www.cnblogs.com/ciyeer/p/9035072.html" target="_blank" rel="noopener">https://www.cnblogs.com/ciyeer/p/9035072.html</a></p>
<p><a href="https://www.cnblogs.com/ciyeer/p/9035072.html" target="_blank" rel="noopener">https://www.cnblogs.com/ciyeer/p/9035072.html</a></p>
<p>Kmp 题目，复习了 Kmp 的相关知识。（想起了 DS 老师讲解这块时费力的身姿…）</p>
<p>以链接中的例子为例。</p>
<p>主串： ababcabcacbab</p>
<p>模式串： abcabac</p>
<p>Kmp 算法的核心是找到模式串中当第 j 个位置的字符不匹配时，应该从何处 next[j] 重新开始匹配. 关键是如何找到模式串的abcac next[j].</p>
<p>计算公式</p>
<p><img src="/images/kmp.png" alt="kmp 计算公式"></p>
<p>公式最下方怎么理解呢？借助一张图</p>
<p><img src="/images/kmp_principle.png" alt="kmp原理"></p>
<p>当主串中第i 个元素与模式串中的第 j 个元素不同时，这时应当将 j 滑到哪里呢？</p>
<p>首先当主串中第i 个元素与模式串中的第 j 个元素不同时，这意味着 i - j…i-1与1..j-1是相等的。</p>
<p>如果我们能找到一个 最大的K 值满足上图中的条件</p>
<p>即模式串中下标为 1…k-1的元素与j - k .. j-1元素相同，这就意味着下标 1…k-1的元素与 i - k.. i - 1相等。这两块相等就意味着我们可以让模式串滑到 k 处，从 k 这里开始匹配；即 next[j] = k；此外我们希望这个 K 值尽可能的大，因为这样剩余尚需匹配的模式串数目就少。</p>
<p>方便记忆，以匹配串“abcabac”为例求其的next数组。next 的下标从 1开始，j = 0。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">当 j = <span class="number">0</span>时<span class="string">'a'</span>， 子串已经在最左侧了，无法再往左移动 j 了，应该移动 i元素。 令next[<span class="number">1</span>] = <span class="number">0</span>作为标识</span><br><span class="line"></span><br><span class="line">j = <span class="number">1</span>时<span class="string">'b'</span>，当第二个元素不相等时，next[<span class="number">2</span>] = <span class="number">1</span>表示应该与模式串中第一个元素进行比较</span><br><span class="line"></span><br><span class="line">j = <span class="number">2</span>第三个字符 ‘c’ ：由于前一个字符 ‘b’ 的 next 值为 <span class="number">1</span> ，取 T[<span class="number">1</span>] = ‘a’ 和 ‘b’ 相比较，不相等，变更 j = <span class="number">2</span>为 next[j] = <span class="number">1</span> 继续比较；由于 next[<span class="number">1</span>] = <span class="number">0</span>，结束。 ‘c’ 对应的 next 值为<span class="number">1</span>；（只要循环到 next[<span class="number">1</span>] = <span class="number">0</span> ,该字符的 next 值都为 <span class="number">1</span> ）</span><br><span class="line"></span><br><span class="line">模式串T为：          “abcabac”</span><br><span class="line">next数组(下标从<span class="number">1</span>开始)：<span class="number">011</span></span><br><span class="line"></span><br><span class="line">第四个字符 ’a‘ ：由于前一个字符 ‘c’ 的 next 值为 <span class="number">1</span> ，取 T[<span class="number">1</span>] = ‘a’ 和 ‘c’ 相比较，不相等，继续；由于 next[<span class="number">1</span>] = <span class="number">0</span> ，结束。‘a’ 对应的 next 值为 <span class="number">1</span> ；</span><br><span class="line"></span><br><span class="line">模式串T为：          “abcabac”</span><br><span class="line">next数组(下标从<span class="number">1</span>开始)：<span class="number">0111</span></span><br><span class="line"></span><br><span class="line">第五个字符 ’b’ ：由于前一个字符 ‘a’ 的 next 值为 <span class="number">1</span> ，取 T[<span class="number">1</span>] = ‘a’ 和 ‘a’ 相比较，相等，结束。 ‘b’ 对应的 next 值为：<span class="number">1</span>(前一个字符 ‘a’ 的 next 值) + <span class="number">1</span> = <span class="number">2</span> ；</span><br><span class="line"></span><br><span class="line">模式串T为：          “abcabac”</span><br><span class="line">next数组(下标从<span class="number">1</span>开始)：<span class="number">01112</span></span><br><span class="line"></span><br><span class="line">第六个字符 ‘a’ ：由于前一个字符 ‘b’ 的 next 值为 <span class="number">2</span>，取 T[<span class="number">2</span>] = ‘b’ 和 ‘b’ 相比较，相等，所以结束。‘a’ 对应的 next 值为：<span class="number">2</span> (前一个字符 ‘b’ 的 next 值) + <span class="number">1</span> = <span class="number">3</span> ；</span><br><span class="line"></span><br><span class="line">模式串T为：          “abcabac”</span><br><span class="line">next数组(下标从<span class="number">1</span>开始)：<span class="number">011123</span></span><br><span class="line"></span><br><span class="line">第七个字符 ‘c’ ：由于前一个字符 ‘a’ 的 next 值为 <span class="number">3</span> ，取 T[<span class="number">3</span>] = ‘c’ 和 ‘a’ 相比较，不相等，继续；由于 next[<span class="number">3</span>] = <span class="number">1</span> ，所以取 T[<span class="number">1</span>] = ‘a’ 和 ‘a’ 比较，相等，结束。‘a’ 对应的 next 值为：<span class="number">1</span> ( next[<span class="number">3</span>] 的值) + <span class="number">1</span> = <span class="number">2</span> ；</span><br><span class="line"></span><br><span class="line">模式串T为：          “abcabac”</span><br><span class="line">next数组(下标从<span class="number">1</span>开始)：<span class="number">0111232</span></span><br></pre></td></tr></table></figure>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kmp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> next: IntArray</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">strStr</span><span class="params">(haystack: <span class="type">String</span>, needle: <span class="type">String</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (haystack.length &lt; needle.length) &#123;</span><br><span class="line">            <span class="keyword">return</span>  -<span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (haystack.isEmpty() &amp;&amp; haystack == needle) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        initNext(needle)</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> j = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= haystack.length &amp;&amp; j &lt;= needle.length) &#123;</span><br><span class="line">            <span class="keyword">if</span> (j == <span class="number">0</span> || haystack[i - <span class="number">1</span>] == needle[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                i++</span><br><span class="line">                j++</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (needle.length <span class="keyword">in</span> <span class="number">1</span> until j) &#123;</span><br><span class="line">            <span class="keyword">return</span> i - needle.length - <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initNext</span><span class="params">(needle: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (needle.isBlank()) &#123;</span><br><span class="line">            next = IntArray(<span class="number">1</span>)&#123;<span class="number">0</span>&#125;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        next = IntArray(needle.length + <span class="number">1</span>)</span><br><span class="line">        next[<span class="number">0</span>] = needle.length</span><br><span class="line">        next[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> j = <span class="number">0</span> </span><br><span class="line">        <span class="keyword">while</span> (i &lt; next[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> (j == <span class="number">0</span> || needle[i - <span class="number">1</span>] == needle[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                next[++i] = ++j</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j] <span class="comment">//不相等时匹配串滑到对应位置 next[j],j - 1处元素继续和 i-1处元素进行比较</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    print(Kmp().strStr(<span class="string">"aaasdsdfsdfsdf"</span>, <span class="string">"abcabac"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>拍照，图册选取，截图的心路历程</title>
    <url>/2019/04/19/%E6%8B%8D%E7%85%A7%EF%BC%8C%E5%9B%BE%E5%86%8C%E9%80%89%E5%8F%96%EF%BC%8C%E6%88%AA%E5%9B%BE%E7%9A%84%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>考研过程中使用了Anki，不能不感叹这款神器的牛皮，尽管自己尚未开发出这款App的全部功能，但它已经将我的英语词汇和写作往前面推了一些。感叹和由衷地感激这款遍布全球的项目的伟大，我也想为这个项目做些什么。首先就是想完成考研中咒骂了无数次的坑，怎么不自带一个截图功能。后哦来！我总算懂的这个坑因何无人来填。TMD，适配太难受了。尤其是小米和华为这两个行业巨头（中指），系统定制化太过严重，为了提升用户体验，篡改了很多原生Intent设置，不得不写出很多冗余代码只为适配这些独特机型，呵呵，MMP， 在墙内，原生的无法使用必须定制化这可以理解，定制化的系统更加方便国内用户的使用，这毫无疑问，在全球怕是再没有那个国家像中国的Android这样友好的用户体验，一切以用户为核心，从利益出发。这也导致在国内碎片话严重的令人发指，以及各种千奇百怪的保活策略和有意思的白名单。哎呀，现在强盗收保护费都收的那么理直气壮吗？ 我记得一次在面试招XX银行时的时候我遇到这么一个问题，请问你怎么实现保活？emmmm，哈哈哈哈。</p>
<h2 id="顺利完成裁剪任务"><a href="#顺利完成裁剪任务" class="headerlink" title="顺利完成裁剪任务"></a>顺利完成裁剪任务</h2><p>历时两天我完成了裁剪功能的添加。想想也还是有点小激动的，马上成为34个国家app的贡献者之一啦！代码如下：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicImageFieldController</span> <span class="keyword">extends</span> <span class="title">FieldControllerBase</span> <span class="keyword">implements</span> <span class="title">IFieldController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACTIVITY_SELECT_IMAGE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACTIVITY_TAKE_PICTURE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACTIVITY_CROP_PICTURE = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMAGE_SAVE_MAX_WIDTH = <span class="number">1920</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ImageView mImagePreview;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> showCropButton = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createUI</span><span class="params">(Context context, LinearLayout layout)</span> </span>&#123;</span><br><span class="line">        mImagePreview = <span class="keyword">new</span> ImageView(mActivity);</span><br><span class="line">        mLinearLayout = layout;</span><br><span class="line">        DisplayMetrics metrics = getDisplayMetrics();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> height = metrics.heightPixels;</span><br><span class="line">        <span class="keyword">int</span> width = metrics.widthPixels;</span><br><span class="line"></span><br><span class="line">        LinearLayout.LayoutParams p = <span class="keyword">new</span> LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</span><br><span class="line">                android.view.ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        setPreviewImage(mField.getImagePath(), getMaxImageSize());</span><br><span class="line">        mImagePreview.setScaleType(ImageView.ScaleType.CENTER_INSIDE);</span><br><span class="line">        mImagePreview.setAdjustViewBounds(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        mImagePreview.setMaxHeight((<span class="keyword">int</span>) Math.round(height * <span class="number">0.4</span>));</span><br><span class="line">        mImagePreview.setMaxWidth((<span class="keyword">int</span>) Math.round(width * <span class="number">0.6</span>));</span><br><span class="line"></span><br><span class="line">        Button mBtnGallery = <span class="keyword">new</span> Button(mActivity);</span><br><span class="line">        mBtnGallery.setText(gtxt(R.string.multimedia_editor_image_field_editing_galery));</span><br><span class="line">        mBtnGallery.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            Intent i = <span class="keyword">new</span> Intent(Intent.ACTION_PICK, MediaStore.Images.Media.EXTERNAL_CONTENT_URI);</span><br><span class="line">            mActivity.startActivityForResultWithoutAnimation(i, ACTIVITY_SELECT_IMAGE);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Button mBtnCamera = <span class="keyword">new</span> Button(mActivity);</span><br><span class="line">        mBtnCamera.setText(gtxt(R.string.multimedia_editor_image_field_editing_photo));</span><br><span class="line">        mBtnCamera.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            Intent cameraIntent = <span class="keyword">new</span> Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span><br><span class="line">            File image;</span><br><span class="line">            File storageDir;</span><br><span class="line">            String timeStamp = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>, Locale.US).format(<span class="keyword">new</span> Date());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                storageDir = mActivity.getCacheDir();</span><br><span class="line">                image = File.createTempFile(<span class="string">"img_"</span> + timeStamp, <span class="string">".jpg"</span>, storageDir);</span><br><span class="line">                mTempImagePath = image.getPath();</span><br><span class="line">                Uri uriSavedImage = FileProvider.getUriForFile(mActivity,</span><br><span class="line">                        mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>,</span><br><span class="line">                        image);</span><br><span class="line"></span><br><span class="line">                cameraIntent.putExtra(MediaStore.EXTRA_OUTPUT, uriSavedImage);</span><br><span class="line">                <span class="keyword">if</span> (cameraIntent.resolveActivity(context.getPackageManager()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mActivity.startActivityForResultWithoutAnimation(cameraIntent, ACTIVITY_TAKE_PICTURE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    Timber.w(<span class="string">"Device has a camera, but no app to handle ACTION_IMAGE_CAPTURE Intent"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            mBtnCamera.setVisibility(View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Some hardware has no camera or reports yes but has zero (e.g., cheap devices, and Chromebook emulator)</span></span><br><span class="line">        <span class="keyword">if</span> ((!context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_CAMERA) &amp;&amp;</span><br><span class="line">                !context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_CAMERA_FRONT)) ||</span><br><span class="line">                (CompatHelper.getCompat().getCameraCount() &lt; <span class="number">1</span>)) &#123;</span><br><span class="line">            mBtnCamera.setVisibility(View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        layout.addView(mImagePreview, ViewGroup.LayoutParams.MATCH_PARENT, p);</span><br><span class="line">        layout.addView(mBtnGallery, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">        layout.addView(mBtnCamera, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">gtxt</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mActivity.getText(id).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DisplayMetrics <span class="title">getDisplayMetrics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mMetrics == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMetrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">            mActivity.getWindowManager().getDefaultDisplay().getMetrics(mMetrics);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mMetrics;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ignore RESULT_CANCELED but handle image select and take</span></span><br><span class="line">        <span class="keyword">if</span> (resultCode == Activity.RESULT_CANCELED) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestCode == ACTIVITY_SELECT_IMAGE) &#123;</span><br><span class="line">            handleSelectImageResult(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestCode == ACTIVITY_TAKE_PICTURE) &#123;</span><br><span class="line">            handleTakePictureResult();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (requestCode == ACTIVITY_CROP_PICTURE) &#123;</span><br><span class="line">            handleCropResult(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        showCropButton++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (showCropButton == <span class="number">1</span>) &#123;</span><br><span class="line">            Button cropBtn = <span class="keyword">new</span> Button(mActivity);</span><br><span class="line">            cropBtn.setText(gtxt(R.string.crop_button));</span><br><span class="line">            cropBtn.setOnClickListener(v -&gt; &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(mTempImagePath);</span><br><span class="line">                Uri uri = FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>, file);</span><br><span class="line">                photoCrop(uri);</span><br><span class="line">            &#125;);</span><br><span class="line">            mLinearLayout.addView(cropBtn);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">rotateAndCompress</span><span class="params">(String inPath)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Set the rotation of the camera image and save as png</span></span><br><span class="line">        File f = <span class="keyword">new</span> File(inPath);</span><br><span class="line">        <span class="comment">// use same filename but with png extension for output file</span></span><br><span class="line">        String outPath = inPath.substring(<span class="number">0</span>, inPath.lastIndexOf(<span class="string">"."</span>)) + <span class="string">".png"</span>;</span><br><span class="line">        <span class="comment">// Load into a bitmap with max size of 1920 pixels and rotate if necessary</span></span><br><span class="line">        Bitmap b = BitmapUtil.decodeFile(f, IMAGE_SAVE_MAX_WIDTH);</span><br><span class="line">        FileOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = <span class="keyword">new</span> FileOutputStream(outPath);</span><br><span class="line">            b = ExifUtil.rotateFromCamera(f, b);</span><br><span class="line">            b.compress(Bitmap.CompressFormat.PNG, <span class="number">90</span>, out);</span><br><span class="line">            f.delete();</span><br><span class="line">            <span class="keyword">return</span> outPath;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            Timber.e(e, <span class="string">"Error in BasicImageFieldController.rotateAndCompress()"</span>);</span><br><span class="line">            <span class="keyword">return</span> inPath;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPreviewImage</span><span class="params">(String imagePath, <span class="keyword">int</span> maxsize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (imagePath != <span class="keyword">null</span> &amp;&amp; !imagePath.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            File f = <span class="keyword">new</span> File(imagePath);</span><br><span class="line">            Bitmap b = BitmapUtil.decodeFile(f, maxsize);</span><br><span class="line">            b = ExifUtil.rotateFromCamera(f, b);</span><br><span class="line">            mImagePreview.setImageBitmap(b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ImageView imageView = mImagePreview;</span><br><span class="line">        BitmapUtil.freeImageView(imageView);</span><br><span class="line">        showCropButton = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Standard system crop intent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uri</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">photoCrop</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.android.camera.action.CROP"</span>);</span><br><span class="line">        intent.setDataAndType(uri, <span class="string">"image/*"</span>);</span><br><span class="line">        intent.putExtra(<span class="string">"crop"</span>, <span class="string">"true"</span>);</span><br><span class="line">        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">        intent.putExtra(<span class="string">"return-data"</span>, <span class="keyword">true</span>);</span><br><span class="line">        mActivity.startActivityForResultWithoutAnimation(intent, ACTIVITY_CROP_PICTURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showCropDialog</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> MaterialDialog.Builder(mActivity)</span><br><span class="line">                .content(R.string.crop_image)</span><br><span class="line">                .positiveText(R.string.dialog_ok)</span><br><span class="line">                .negativeText(R.string.dialog_cancel)</span><br><span class="line">                .onPositive((dialog, which) -&gt; &#123;</span><br><span class="line">                    photoCrop(uri);</span><br><span class="line">                &#125;)</span><br><span class="line">                .build().show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeCropImage</span><span class="params">(Bitmap cropImage)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cropImage != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            FileOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">            File storageDir = mActivity.getCacheDir();</span><br><span class="line"></span><br><span class="line">            String fileName = mTempImagePath.substring(mTempImagePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>, mTempImagePath.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!fileName.contains(<span class="string">"crop"</span>)) &#123;</span><br><span class="line">                fileName += <span class="string">"_crop"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String outPath = storageDir.getAbsolutePath() + <span class="string">"/"</span> + fileName + <span class="string">".png"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out = <span class="keyword">new</span> FileOutputStream(outPath);</span><br><span class="line">                cropImage.compress(Bitmap.CompressFormat.PNG, <span class="number">90</span>, out);</span><br><span class="line">                mField.setImagePath(outPath);</span><br><span class="line">                mField.setHasTemporaryMedia(<span class="keyword">true</span>);</span><br><span class="line">                mTempImagePath = outPath;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Timber.e(e, <span class="string">"Error in BasicImageFieldController.rotateAndCompress()"</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleSelectImageResult</span><span class="params">(Intent data)</span> </span>&#123;</span><br><span class="line">        Uri selectedImage = data.getData();</span><br><span class="line">        <span class="comment">// Timber.d(selectedImage.toString());</span></span><br><span class="line">        String[] filePathColumn = &#123; MediaColumns.DATA &#125;;</span><br><span class="line"></span><br><span class="line">        Cursor cursor = mActivity.getContentResolver().query(selectedImage, filePathColumn, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        cursor.moveToFirst();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> columnIndex = cursor.getColumnIndex(filePathColumn[<span class="number">0</span>]);</span><br><span class="line">        String filePath = cursor.getString(columnIndex);</span><br><span class="line">        cursor.close();</span><br><span class="line"></span><br><span class="line">        mField.setImagePath(filePath);</span><br><span class="line">        setPreviewImage(filePath, getMaxImageSize());</span><br><span class="line">        mTempImagePath = filePath;</span><br><span class="line">        showCropDialog(selectedImage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleTakePictureResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String imagePath = rotateAndCompress(mTempImagePath);</span><br><span class="line">        mField.setImagePath(imagePath);</span><br><span class="line">        mField.setHasTemporaryMedia(<span class="keyword">true</span>);</span><br><span class="line">        setPreviewImage(imagePath, getMaxImageSize());</span><br><span class="line">        mTempImagePath = imagePath;</span><br><span class="line">        File file = <span class="keyword">new</span> File(imagePath);</span><br><span class="line">        Uri uri = FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>, file);</span><br><span class="line">        showCropDialog(uri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCropResult</span><span class="params">(Intent data)</span> </span>&#123;</span><br><span class="line">        Bundle bundle = data.getExtras();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bundle != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Bitmap b = bundle.getParcelable(<span class="string">"data"</span>);</span><br><span class="line">            mImagePreview.setImageBitmap(b);</span><br><span class="line">            writeCropImage(b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>FilePath文件<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-cache-path</span> <span class="attr">path</span>=<span class="string">"export/"</span> <span class="attr">name</span>=<span class="string">"export-directory"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache-path</span> <span class="attr">path</span>=<span class="string">"/"</span> <span class="attr">name</span>=<span class="string">"cache-directory"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-path</span> <span class="attr">path</span>=<span class="string">"."</span> <span class="attr">name</span>=<span class="string">"photos"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然而适配的并不顺利，小米和华为直接闪退，网上查了下，小米和华为不支持裁剪直接返回Bitmap，想想也是哈，毕竟Binder支持1MB的大小交互，而且闪退时的Error也有出现Binder的影子。想办法解决，那没返回值，像拍照一样直接传入写入的uri让系统裁剪程序向该Uri进行写入，再进行读取岂不妙哉。</p>
<h2 id="失望"><a href="#失望" class="headerlink" title="失望"></a>失望</h2><p>我又一次失败了，TMD，咋一直报安全异常呢<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Writing exception to parcel</span><br><span class="line">    java.lang.SecurityException: Permission Denial: writing androidx.core.content.FileProvider uri content:<span class="comment">//com.ichi2.anki.apkgfileprovider/cache-directory/img_201904190726581247673844.jpg from pid=3207, uid=10008 requires the provider be exported, or grantUriPermission()</span></span><br><span class="line">        at android.content.ContentProvider.enforceWritePermissionInner(ContentProvider.java:<span class="number">682</span>)</span><br><span class="line">        at android.content.ContentProvider$Transport.enforceWritePermission(ContentProvider.java:<span class="number">497</span>)</span><br><span class="line">        at android.content.ContentProvider$Transport.enforceFilePermission(ContentProvider.java:<span class="number">469</span>)</span><br><span class="line">        at android.content.ContentProvider$Transport.openAssetFile(ContentProvider.java:<span class="number">384</span>)</span><br><span class="line">        at android.content.ContentProviderNative.onTransact(ContentProviderNative.java:<span class="number">262</span>)</span><br><span class="line">        at android.os.Binder.execTransact(Binder.java:<span class="number">565</span>)</span><br></pre></td></tr></table></figure></p>
<p>代码我写的不错啊！有条有理，章法清晰的复制粘贴。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicImageFieldController</span> <span class="keyword">extends</span> <span class="title">FieldControllerBase</span> <span class="keyword">implements</span> <span class="title">IFieldController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ignore RESULT_CANCELED but handle image select and take</span></span><br><span class="line">        <span class="keyword">if</span> (resultCode == Activity.RESULT_CANCELED) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestCode == ACTIVITY_SELECT_IMAGE) &#123;</span><br><span class="line">            handleSelectImageResult(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestCode == ACTIVITY_TAKE_PICTURE) &#123;</span><br><span class="line">            handleTakePictureResult();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (requestCode == ACTIVITY_CROP_PICTURE) &#123;</span><br><span class="line">            File cropFile=<span class="keyword">new</span> File(mTempImagePath);</span><br><span class="line">            Uri cropUri = FileProvider.getUriForFile(mActivity,</span><br><span class="line">                    mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>,</span><br><span class="line">                    cropFile);</span><br><span class="line">            handleCropResult(cropUri);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        showCropButton++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (showCropButton == <span class="number">1</span>) &#123;</span><br><span class="line">            Button cropBtn = <span class="keyword">new</span> Button(mActivity);</span><br><span class="line">            cropBtn.setText(gtxt(R.string.crop_button));</span><br><span class="line">            cropBtn.setOnClickListener(v -&gt; &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(mTempImagePath);</span><br><span class="line">                Uri uri = FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>, file);</span><br><span class="line">                photoCrop(uri);</span><br><span class="line">            &#125;);</span><br><span class="line">            mLinearLayout.addView(cropBtn);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">photoCrop</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        File image;</span><br><span class="line">        File storageDir;</span><br><span class="line">        String timeStamp = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>, Locale.US).format(<span class="keyword">new</span> Date());</span><br><span class="line">        storageDir = mActivity.getCacheDir();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            image = File.createTempFile(<span class="string">"img_"</span> + timeStamp, <span class="string">".jpg"</span>, storageDir);</span><br><span class="line">            mTempImagePath = image.getPath();</span><br><span class="line">            Uri cropUri = Uri.fromFile(image);</span><br><span class="line">            mField.setImagePath(mTempImagePath);</span><br><span class="line">            mField.setHasTemporaryMedia(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.android.camera.action.CROP"</span>);</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">                <span class="comment">//添加这一句表示对目标应用临时授权该Uri所代表的文件</span></span><br><span class="line">                intent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">            &#125;</span><br><span class="line">            intent.setDataAndType(uri, <span class="string">"image/*"</span>);</span><br><span class="line">            intent.putExtra(<span class="string">"aspectX"</span>, <span class="number">1</span>); <span class="comment">// 裁剪框比例</span></span><br><span class="line">            intent.putExtra(<span class="string">"aspectY"</span>, <span class="number">1</span>);</span><br><span class="line">            intent.putExtra(<span class="string">"outputX"</span>, <span class="number">300</span>); <span class="comment">// 输出图片大小</span></span><br><span class="line">            intent.putExtra(<span class="string">"outputY"</span>, <span class="number">300</span>);</span><br><span class="line">            intent.putExtra(<span class="string">"scale"</span>, <span class="keyword">true</span>);</span><br><span class="line">            intent.putExtra(<span class="string">"return-data"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            intent.putExtra(MediaStore.EXTRA_OUTPUT, cropUri);</span><br><span class="line">            intent.putExtra(<span class="string">"outputFormat"</span>, Bitmap.CompressFormat.JPEG.toString());</span><br><span class="line">            intent.putExtra(<span class="string">"noFaceDetection"</span>, <span class="keyword">true</span>); <span class="comment">// no face detection</span></span><br><span class="line">            mActivity.startActivityForResultWithoutAnimation(intent, ACTIVITY_CROP_PICTURE);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showCropDialog</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> MaterialDialog.Builder(mActivity)</span><br><span class="line">                .content(R.string.crop_image)</span><br><span class="line">                .positiveText(R.string.dialog_ok)</span><br><span class="line">                .negativeText(R.string.dialog_cancel)</span><br><span class="line">                .onPositive((dialog, which) -&gt; &#123;</span><br><span class="line">                    photoCrop(uri);</span><br><span class="line">                &#125;)</span><br><span class="line">                .build().show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeCropImage</span><span class="params">(Bitmap cropImage)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cropImage != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            FileOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">            File storageDir = mActivity.getCacheDir();</span><br><span class="line"></span><br><span class="line">            String fileName = mTempImagePath.substring(mTempImagePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>, mTempImagePath.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!fileName.contains(<span class="string">"crop"</span>)) &#123;</span><br><span class="line">                fileName += <span class="string">"_crop"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String outPath = storageDir.getAbsolutePath() + <span class="string">"/"</span> + fileName + <span class="string">".png"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out = <span class="keyword">new</span> FileOutputStream(outPath);</span><br><span class="line">                cropImage.compress(Bitmap.CompressFormat.PNG, <span class="number">90</span>, out);</span><br><span class="line">                mField.setImagePath(outPath);</span><br><span class="line">                mField.setHasTemporaryMedia(<span class="keyword">true</span>);</span><br><span class="line">                mTempImagePath = outPath;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Timber.e(e, <span class="string">"Error in BasicImageFieldController.rotateAndCompress()"</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleSelectImageResult</span><span class="params">(Intent data)</span> </span>&#123;</span><br><span class="line">        Uri selectedImage = getImageUri(mActivity, data);</span><br><span class="line">        setPreviewImage(mTempImagePath, getMaxImageSize());</span><br><span class="line">        showCropDialog(selectedImage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleTakePictureResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String imagePath = rotateAndCompress(mTempImagePath);</span><br><span class="line">        mField.setImagePath(imagePath);</span><br><span class="line">        mField.setHasTemporaryMedia(<span class="keyword">true</span>);</span><br><span class="line">        setPreviewImage(imagePath, getMaxImageSize());</span><br><span class="line">        mTempImagePath = imagePath;</span><br><span class="line">        File file = <span class="keyword">new</span> File(imagePath);</span><br><span class="line">        Uri uri = FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>, file);</span><br><span class="line">        showCropDialog(uri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCropResult</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uri != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Bitmap photo = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                photo = BitmapFactory.decodeStream(mActivity.getContentResolver().openInputStream(uri));</span><br><span class="line">                <span class="comment">//mImagePreview.setImageBitmap(photo);</span></span><br><span class="line">                writeCropImage(photo);</span><br><span class="line">                setPreviewImage(mTempImagePath, getMaxImageSize());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Timber.i(<span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Uri <span class="title">getImageUri</span><span class="params">(Context context,Intent data)</span></span>&#123;</span><br><span class="line">        String imagePath = <span class="keyword">null</span>;</span><br><span class="line">        Uri uri = data.getData();</span><br><span class="line">        <span class="keyword">if</span>(Build.VERSION.SDK_INT &gt;= <span class="number">19</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(DocumentsContract.isDocumentUri(context,uri))&#123;</span><br><span class="line">                String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">"com.android.providers.media.documents"</span>.equals(uri.getAuthority()))&#123;</span><br><span class="line">                    String id = docId.split(<span class="string">":"</span>)[<span class="number">1</span>];</span><br><span class="line">                    String selection = MediaStore.Images.Media._ID+<span class="string">"="</span>+id;</span><br><span class="line">                    imagePath = getImagePath(context,MediaStore.Images.Media.EXTERNAL_CONTENT_URI,selection);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"com.android.providers.downloads.documents"</span>.equals(uri.getAuthority()))&#123;</span><br><span class="line">                    Uri contentUri = ContentUris.withAppendedId(Uri.parse(<span class="string">"content://downloads/public_downloads"</span>),Long.valueOf(docId));</span><br><span class="line">                    imagePath = getImagePath(context,contentUri,<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"content"</span>.equalsIgnoreCase(uri.getScheme()))&#123;</span><br><span class="line">                imagePath = getImagePath(context,uri,<span class="keyword">null</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"file"</span>.equalsIgnoreCase(uri.getScheme()))&#123;</span><br><span class="line">                imagePath = uri.getPath();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            uri= data.getData();</span><br><span class="line">            imagePath = getImagePath(context,uri,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        File file = <span class="keyword">new</span> File(imagePath);</span><br><span class="line">        mTempImagePath = imagePath;</span><br><span class="line">        mField.setImagePath(imagePath);</span><br><span class="line">        mField.setHasTemporaryMedia(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">            uri = FileProvider.getUriForFile(context,</span><br><span class="line">                    mActivity.getApplicationContext().getPackageName() + <span class="string">".apkgfileprovider"</span>,</span><br><span class="line">                    file);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            uri = Uri.fromFile(file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getImagePath</span><span class="params">(Context context,Uri uri, String selection)</span> </span>&#123;</span><br><span class="line">        String path = <span class="keyword">null</span>;</span><br><span class="line">        Cursor cursor = context.getContentResolver().query(uri,<span class="keyword">null</span>,selection,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span>(cursor != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(cursor.moveToFirst())&#123;</span><br><span class="line">                path = cursor.getString(cursor.getColumnIndex(MediaStore.Images.Media.DATA));</span><br><span class="line">            &#125;</span><br><span class="line">            cursor.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比了下参考代码，唯一的区别的就是我是选择当前的app的缓存目录作为输出uri，而参考代码则是选择sdcard的外存目录的指定文件夹作为目录，于是我死马当作活马医狠下心选择外存作为写入uri. 还别说，真香</p>
<h2 id="扒开云雾见月明"><a href="#扒开云雾见月明" class="headerlink" title="扒开云雾见月明"></a>扒开云雾见月明</h2><p>为什么同样是将缓存目录作为写入uri,而照相机可以成功写入，而裁剪功能却不行，会报安全异常，权限非法。分析异常可以看出是FileProvider没有授权，然而哈，我已经在FilePath进行了注册，而且拍照功能是可以正常运行的。至今仍是懵逼中。为毛同样的输出Uri，拍照Intent可以写入，而Crop Intent却不行。神奇诶。而且这个并非是定制化的锅，我在官方模拟器测过同样会报这个error，由此可见是系统rom的Crop Intent处理与Take Photo Intent不同。算是一个遗留下的坑以后看系统源码来填。</p>
]]></content>
      <categories>
        <category>Anki开发</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>RelativeLayout与LinearLayout的onMeasure方法</title>
    <url>/2019/04/05/RelativeLayout%E4%B8%8ELinearLayout%E7%9A%84onMeasure%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>转自： <a href="https://www.jianshu.com/p/8a7d059da746" target="_blank" rel="noopener">Android中RelativeLayout和LinearLayout性能分析</a></p>
<h2 id="RelativeLayout的onMeasure-方法"><a href="#RelativeLayout的onMeasure-方法" class="headerlink" title="RelativeLayout的onMeasure()方法"></a>RelativeLayout的onMeasure()方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">View[] views = mSortedHorizontalChildren;</span><br><span class="line">    <span class="keyword">int</span> count = views.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">      View child = views[i];</span><br><span class="line">      <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</span><br><span class="line">        LayoutParams params = (LayoutParams) child.getLayoutParams();</span><br><span class="line">        <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</span><br><span class="line"></span><br><span class="line">        applyHorizontalSizeRules(params, myWidth, rules);</span><br><span class="line">        measureChildHorizontal(child, params, myWidth, myHeight); <span class="comment">// Horizontal measure</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">      View child = views[i];</span><br><span class="line">      <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</span><br><span class="line">        LayoutParams params = (LayoutParams) child.getLayoutParams();</span><br><span class="line">       </span><br><span class="line">        applyVerticalSizeRules(params, myHeight);</span><br><span class="line">        measureChild(child, params, myWidth, myHeight); <span class="comment">// Vertical measure</span></span><br><span class="line">        <span class="keyword">if</span> (positionChildVertical(child, params, myHeight, isWrapContentHeight)) &#123;</span><br><span class="line">          offsetVerticalAxis = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>RelativeLayout 会对子View进行两次measure，因为Relative中的子View的布局是依赖于子View的相互关系，这个顺序可能与layout文件中的子View编写不一致，故在确定子View位置时，先要给子View排一下序。</p>
<blockquote>
<p>又因为RelativeLayout允许A，B 2个子View，横向上B依赖A，纵向上A依赖B。所以需要横向纵向分别进行一次排序测量。</p>
</blockquote>
<h2 id="LinearLayout的onMeasure-方法"><a href="#LinearLayout的onMeasure-方法" class="headerlink" title="LinearLayout的onMeasure()方法"></a>LinearLayout的onMeasure()方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</span><br><span class="line">     measureVertical(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     measureHorizontal(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>进入measureVertical中<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">      <span class="keyword">final</span> View child = getVirtualChildAt(i);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mTotalLength += measureNullChild(i);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (child.getVisibility() == View.GONE) &#123;</span><br><span class="line">       i += getChildrenSkipCount(child, i);</span><br><span class="line">       <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;</span><br><span class="line">        mTotalLength += mDividerHeight;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">      totalWeight += lp.weight;</span><br><span class="line">     </span><br><span class="line">      <span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY &amp;&amp; lp.height == <span class="number">0</span> &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Optimization: don't bother measuring children who are going to use</span></span><br><span class="line">        <span class="comment">// leftover space. These views will get measured again down below if</span></span><br><span class="line">        <span class="comment">// there is any leftover space.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</span><br><span class="line">        mTotalLength = Math.max(totalLength, totalLength + lp.topMargin + lp.bottomMargin);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> oldHeight = Integer.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lp.height == <span class="number">0</span> &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// heightMode is either UNSPECIFIED or AT_MOST, and this</span></span><br><span class="line">          <span class="comment">// child wanted to stretch to fill available space.</span></span><br><span class="line">          <span class="comment">// Translate that to WRAP_CONTENT so that it does not end up</span></span><br><span class="line">          <span class="comment">// with a height of 0</span></span><br><span class="line">          oldHeight = <span class="number">0</span>;</span><br><span class="line">          lp.height = LayoutParams.WRAP_CONTENT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine how big this child would like to be. If this or</span></span><br><span class="line">        <span class="comment">// previous children have given a weight, then we allow it to</span></span><br><span class="line">        <span class="comment">// use all available space (and we will shrink things later</span></span><br><span class="line">        <span class="comment">// if needed).</span></span><br><span class="line">        measureChildBeforeLayout(</span><br><span class="line">           child, i, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec,</span><br><span class="line">           totalWeight == <span class="number">0</span> ? mTotalLength : <span class="number">0</span>);<span class="comment">// Measure child </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (oldHeight != Integer.MIN_VALUE) &#123;</span><br><span class="line">         lp.height = oldHeight;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</span><br><span class="line">        mTotalLength = Math.max(totalLength, totalLength + childHeight + lp.topMargin +</span><br><span class="line">           lp.bottomMargin + getNextLocationOffset(child));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (useLargestChild) &#123;</span><br><span class="line">          largestChildHeight = Math.max(childHeight, largestChildHeight);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p>父视图在对子视图进行measure操作的过程中，使用变量mTotalLength保存已经measure过的child所占用的高度，该变量刚开始时是0。在for循环中调用measureChildBeforeLayout（）对每一个child进行测量;  每次for循环对child测量完毕后，调用child.getMeasuredHeight()获取该子视图最终的高度，并将这个高度添加到mTotalLength中。在本步骤中，暂时避开了lp.weight&gt;0的子视图，即暂时先不测量这些子视图，因为后面将把父视图剩余的高度按照weight值的大小平均分配给相应的子视图。<br>源码中使用了一个局部变量totalWeight累计所有子视图的weight值。处理lp.weight&gt;0的情况需要注意，如果变量<code>heightMode是EXACTLY</code>，那么，当其他子视图占满父视图的高度后，weight&gt;0的子视图<code>分配不到布局空间</code>，从而不被显示，只有当heightMode是AT_MOST或者UNSPECIFIED时，weight&gt;0的视图才能优先获得布局高度。最后我们的结论是：如果<code>不使用weight属性</code>，LinearLayout会在当前方向上进行<code>一次measure</code>的过程，<code>如果使用weight属性</code>，LinearLayout会避开设置过weight属性的view做第一次measure，完了再对设置过weight属性的view做<code>第二次measure</code>。由此可见，weight属性对性能是有影响的，而且本身有大坑，请注意避让。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>RelativeLayout慢于LinearLayout是因为它会让子View调用2次measure过程，而后者只需一次，但是有weight属性存在时，后者同样会进行两次measure。</li>
<li>无嵌套布局的情况使用LinearLayout,否则使用RelativeLayout</li>
<li>DecorView的层级深度已知且固定的，上面一个标题栏，下面一个内容栏，采用RelativeLayout并不会降低层级深度，因此这种情况下使用LinearLayout效率更高。而为开发者默认新建RelativeLayout是希望开发者能采用尽量少的View层级，很多效果是需要多层LinearLayout的嵌套，这必然不如一层的RelativeLayout性能更好。因此我们应该尽量减少布局嵌套，减少层级结构。</li>
</ol>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>数组中的K个最大元素</title>
    <url>/2019/03/22/%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84K%E4%B8%AA%E6%9C%80%E5%A4%A7%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="给定一个数组nums-取出其中最大的K个数"><a href="#给定一个数组nums-取出其中最大的K个数" class="headerlink" title="给定一个数组nums,取出其中最大的K个数"></a>给定一个数组nums,取出其中最大的K个数</h3><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol>
<li>直接Arrays.sort，取出最后K个数</li>
<li>采取优先级队列(小顶堆实现)</li>
<li>自己用大顶堆实现<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//2</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] findKLargest(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k) &#123;</span><br><span class="line">        Queue&lt;Integer&gt; max = <span class="keyword">new</span> PriorityQueue&lt;Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> n : nums) &#123;</span><br><span class="line">            <span class="keyword">if</span> (max.size() &lt; k) max.offer(n);<span class="comment">//构造k个数的优先队列，最小</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt; max.peek()) &#123;</span><br><span class="line">                max.poll();</span><br><span class="line">                max.offer(n);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span>[] res = <span class="keyword">new</span> <span class="keyword">int</span>[k];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            res[i] = max.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">int</span>[] findKLargest(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nums;</span><br><span class="line">        &#125;</span><br><span class="line">        buildMaxHeap(nums);</span><br><span class="line">        <span class="keyword">int</span>[] res = <span class="keyword">new</span> <span class="keyword">int</span>[k];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = nums.length - <span class="number">1</span>; i &gt; nums.length - <span class="number">1</span> - k; i--) &#123;</span><br><span class="line">            swap(nums, i, <span class="number">0</span>);</span><br><span class="line">            res[nums.length - i - <span class="number">1</span>] = nums[i];</span><br><span class="line">            maxHeap(nums, <span class="number">0</span>, i - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = nums.length / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            maxHeap(nums, i, nums.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maxHeap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">2</span> * index + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left &lt; length &amp;&amp; left + <span class="number">1</span> &lt; length &amp;&amp; nums[left] &lt; nums[left + <span class="number">1</span>]) &#123;</span><br><span class="line">            left++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left &lt; length &amp;&amp; nums[index] &lt; nums[left]) &#123;</span><br><span class="line">            swap(nums, index, left);</span><br><span class="line">            maxHeap(nums, left, length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> t = nums[i];</span><br><span class="line">        nums[i] = nums[j];</span><br><span class="line">        nums[j] = t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>Glide源码解析</title>
    <url>/2019/03/11/Glide%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>)</span><br><span class="line">    .load(url)</span><br><span class="line">    .into(imageView);</span><br></pre></td></tr></table></figure>
<p>Glide加载执行流程</p>
<ol>
<li>创建request</li>
<li>执行加载</li>
<li>回调刷新UI</li>
</ol>
<p><img src="/images/glide_resolve.png" alt="glide_running"></p>
<h2 id="创建request"><a href="#创建request" class="headerlink" title="创建request"></a>创建request</h2><h3 id="with"><a href="#with" class="headerlink" title="with()"></a>with()</h3><p>从Glide.with()开始</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(fragment.getActivity()).get(fragment);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(android.app.Fragment fragment)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(fragment.getActivity()).get(fragment);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(context).get(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(view.getContext()).get(view);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有with()均返回了一个RequestManager,进入getRetriever（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RequestManagerRetriever <span class="title">getRetriever</span><span class="params">(@Nullable Context context)</span> </span>&#123;</span><br><span class="line"> ...</span><br><span class="line">    <span class="keyword">return</span> Glide.get(context).getRequestManagerRetriever();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get the singleton.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the singleton</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (Glide<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">          checkAndInitializeGlide(context);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> glide;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>Glide通过DCL创建单例，然后RequestManagerRetriever对象通过Glide单例获取。返回到上面 getRetriever().get()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You cannot start a load on a null Context"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">        <span class="keyword">return</span> get((FragmentActivity) context);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">        <span class="keyword">return</span> get((Activity) context);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">        <span class="keyword">return</span> get(((ContextWrapper) context).getBaseContext());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getApplicationManager(context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">      <span class="keyword">return</span> get(activity.getApplicationContext());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      assertNotDestroyed(activity);</span><br><span class="line">      FragmentManager fm = activity.getSupportFragmentManager();</span><br><span class="line">      <span class="keyword">return</span> supportFragmentGet(</span><br><span class="line">          activity, fm, <span class="comment">/*parentHint=*/</span> <span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Fragment fragment)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(fragment.getActivity(),</span><br><span class="line">          <span class="string">"You cannot start a load on a fragment before it is attached or after it is destroyed"</span>);</span><br><span class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">      <span class="keyword">return</span> get(fragment.getActivity().getApplicationContext());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      FragmentManager fm = fragment.getChildFragmentManager();</span><br><span class="line">      <span class="keyword">return</span> supportFragmentGet(fragment.getActivity(), fm, fragment, fragment.isVisible());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> RequestManager <span class="title">supportFragmentGet</span><span class="params">(Context context, FragmentManager fm,</span></span></span><br><span class="line"><span class="function"><span class="params">      Fragment parentHint)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//1 获取managerFragment</span></span><br><span class="line">    SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);</span><br><span class="line">    RequestManager requestManager = current.getRequestManager();</span><br><span class="line">    <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// TODO(b/27524013): Factor out this Glide.get() call.</span></span><br><span class="line">      Glide glide = Glide.get(context);</span><br><span class="line">      <span class="comment">//2 创建requestManager ，并传入了Lifecycle</span></span><br><span class="line">      requestManager = factory.build(glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode());</span><br><span class="line">     <span class="comment">//3 缓存requestManager,保证一个Activity对应一个requestManager</span></span><br><span class="line">      current.setRequestManager(requestManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requestManager;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//4 创建并添加一个SupportRequestManagerFragment</span></span><br><span class="line">  <span class="function">SupportRequestManagerFragment <span class="title">getSupportRequestManagerFragment</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> FragmentManager fm, Fragment parentHint)</span> </span>&#123;</span><br><span class="line">    SupportRequestManagerFragment current =</span><br><span class="line">        (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">      current = pendingSupportRequestManagerFragments.get(fm);</span><br><span class="line">      <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">        current = <span class="keyword">new</span> SupportRequestManagerFragment();</span><br><span class="line">        current.setParentFragmentHint(parentHint);</span><br><span class="line">        pendingSupportRequestManagerFragments.put(fm, current);</span><br><span class="line">        <span class="comment">//5 这里添加一个隐藏的Fragment</span></span><br><span class="line">        fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">        handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>get方法重载参数虽然很多，但最终就返回两种类型的requestManager。一种是ApplicationManager,它自动和应用的生命周期同步，应用退出，Glide也就停止加载；另外一种则是带有Fragment生命周期的requestManager。对应上述代码中注释，可以看出，Glide添加一个隐藏的Fragment，获取对应的生命周期回调事件，这样就可在Activity销毁时停止加载图片了。这种方式比较巧妙，不仅是Glide，RxPermission项目也是这样使用的。</p>
<p>小结：Glide.with(）：它主要完成了Glide实例化，并返回requestManager对象。</p>
<h3 id="load-url"><a href="#load-url" class="headerlink" title="load(url)"></a>load(url)</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> asDrawable().load(model);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//asDrawable().load(model);最终会调用至loadGeneric</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.model = model;</span><br><span class="line">   isModelSet = <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>返回一个request构造器，接着进入into.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     @NonNull Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">     @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">     BaseRequestOptions&lt;?&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">     Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">   Preconditions.checkNotNull(target);</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">   Request request = buildRequest(target, targetListener, options, callbackExecutor);<span class="comment">//1. 构建request</span></span><br><span class="line"></span><br><span class="line">   Request previous = target.getRequest();</span><br><span class="line">   <span class="keyword">if</span> (request.isEquivalentTo(previous)</span><br><span class="line">       &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) &#123;</span><br><span class="line">     request.recycle();</span><br><span class="line">   ...</span><br><span class="line">   requestManager.clear(target);</span><br><span class="line">   target.setRequest(request);</span><br><span class="line"><span class="comment">//2. 执行request（位于下一小节，执行加载）</span></span><br><span class="line">   requestManager.track(target, request);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> target;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>进入1处构建request<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">      BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">      Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> buildRequestRecursive(</span><br><span class="line">        target,</span><br><span class="line">        targetListener,</span><br><span class="line">        <span class="comment">/*parentCoordinator=*/</span> <span class="keyword">null</span>,</span><br><span class="line">        transitionOptions,</span><br><span class="line">        requestOptions.getPriority(),</span><br><span class="line">        requestOptions.getOverrideWidth(),</span><br><span class="line">        requestOptions.getOverrideHeight(),</span><br><span class="line">        requestOptions,</span><br><span class="line">        callbackExecutor);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> Request <span class="title">buildRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">      TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">      Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">      BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">      Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    Request mainRequest =</span><br><span class="line">        buildThumbnailRequestRecursive(</span><br><span class="line">            target,</span><br><span class="line">            targetListener,</span><br><span class="line">            parentCoordinator,</span><br><span class="line">            transitionOptions,</span><br><span class="line">            priority,</span><br><span class="line">            overrideWidth,</span><br><span class="line">            overrideHeight,</span><br><span class="line">            requestOptions,</span><br><span class="line">            callbackExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> mainRequest;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> Request <span class="title">buildThumbnailRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">      RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">      TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">      Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">      BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">      Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line"> ...<span class="comment">//默认无缩略图情况下</span></span><br><span class="line">      <span class="comment">// Base case: no thumbnail.</span></span><br><span class="line">      <span class="keyword">return</span> obtainRequest(</span><br><span class="line">          target,</span><br><span class="line">          targetListener,</span><br><span class="line">          requestOptions,</span><br><span class="line">          parentCoordinator,</span><br><span class="line">          transitionOptions,</span><br><span class="line">          priority,</span><br><span class="line">          overrideWidth,</span><br><span class="line">          overrideHeight,</span><br><span class="line">          callbackExecutor);</span><br><span class="line">   </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>进入obtainRequest中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">obtainRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestCoordinator requestCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> SingleRequest.obtain(</span><br><span class="line">      context,</span><br><span class="line">      glideContext,</span><br><span class="line">      model,</span><br><span class="line">      transcodeClass,</span><br><span class="line">      requestOptions,</span><br><span class="line">      overrideWidth,</span><br><span class="line">      overrideHeight,</span><br><span class="line">      priority,</span><br><span class="line">      target,</span><br><span class="line">      targetListener,</span><br><span class="line">      requestListeners,</span><br><span class="line">      requestCoordinator,</span><br><span class="line">      glideContext.getEngine(),</span><br><span class="line">      transitionOptions.getTransitionFactory(),</span><br><span class="line">      callbackExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终通过RequestBuilder生成了一个SingleRequest实例。这个SingleRequest类中有各种属性，大部分都是默认了，当然可以在使用时通过RequestOptions配置。</p>
<h3 id="执行加载"><a href="#执行加载" class="headerlink" title="执行加载"></a>执行加载</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">track</span><span class="params">(@NonNull Target&lt;?&gt; target, @NonNull Request request)</span> </span>&#123;</span><br><span class="line">  targetTracker.track(target);</span><br><span class="line">  requestTracker.runRequest(request);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">  requests.add(request);</span><br><span class="line">  <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">    request.begin();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pendingRequests.add(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//以下是SingleRequest类中begin方法实现。</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  <span class="keyword">if</span> (status == Status.COMPLETE) &#123;</span><br><span class="line">    onResourceReady(resource, DataSource.MEMORY_CACHE);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2</span></span><br><span class="line">  status = Status.WAITING_FOR_SIZE;</span><br><span class="line">  <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">    onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    target.getSize(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 3</span></span><br><span class="line">  <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">      &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">    target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">    logV(<span class="string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>加载完成回调。这里是加载、缩放、转换之后的数据，可直接用于UI显示。后面再分析是怎么回调刷新UI的。</li>
<li>这里主要是判断overrideWidth, overrideHeight是否可用。分两种情况：1).如果设置了override(int width, int height) ,直接处理onSizeReady方法逻辑。2).没有设置override，Glide就会等到系统计算完组件宽高后再回调onSizeReady。所以两种情况最后都会调用onSizeReady方法。</li>
<li>开始前，回调设置placeholderDrawable</li>
</ol>
<p>长宽测量完毕进入onSizeReady()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    ...省略</span><br><span class="line">    <span class="comment">//Engine类的load方法，正式步入加载流程。</span></span><br><span class="line">    loadStatus = engine.load(</span><br><span class="line">        glideContext,</span><br><span class="line">        model,<span class="comment">//对应myUrl,图片地址</span></span><br><span class="line">        requestOptions.getSignature(),</span><br><span class="line">        <span class="keyword">this</span>.width,</span><br><span class="line">        <span class="keyword">this</span>.height,</span><br><span class="line">        requestOptions.getResourceClass(),<span class="comment">//默认是Object.class</span></span><br><span class="line">        transcodeClass, <span class="comment">//默认Drawbale.class</span></span><br><span class="line">        priority,</span><br><span class="line">        requestOptions.getDiskCacheStrategy(),<span class="comment">//磁盘缓存策略。默认是DiskCacheStrategy.AUTOMATIC</span></span><br><span class="line">        requestOptions.getTransformations(),</span><br><span class="line">        requestOptions.isTransformationRequired(),</span><br><span class="line">        requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">        requestOptions.getOptions(),</span><br><span class="line">        requestOptions.isMemoryCacheable(),</span><br><span class="line">        requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">        requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>姗姗来迟的load方法中包含了Glid的缓存策略思想<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">      Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">      Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">      DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">      Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">      Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">      ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">      Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 生成缓存的key</span></span><br><span class="line">    EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</span><br><span class="line">        resourceClass, transcodeClass, options);</span><br><span class="line"><span class="comment">// 先从活动资源 (Active Resources) - 正在显示的资源去取</span></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(active, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Loaded resource from active resources"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 再从内存缓存 (Memory cache) - 显示过的资源去取</span></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(cached, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Loaded resource from cache"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">////检查当前Request是否正在执行。</span></span><br><span class="line">    EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">      current.addCallback(cb, callbackExecutor);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Added to existing load"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 创建后台任务</span></span><br><span class="line">    EngineJob&lt;R&gt; engineJob =</span><br><span class="line">        engineJobFactory.build(</span><br><span class="line">            key,</span><br><span class="line">            isMemoryCacheable,</span><br><span class="line">            useUnlimitedSourceExecutorPool,</span><br><span class="line">            useAnimationPool,</span><br><span class="line">            onlyRetrieveFromCache);</span><br><span class="line"></span><br><span class="line">    DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">        decodeJobFactory.build(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            key,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            options,</span><br><span class="line">            engineJob);</span><br><span class="line"></span><br><span class="line">    jobs.put(key, engineJob);</span><br><span class="line"></span><br><span class="line">    engineJob.addCallback(cb, callbackExecutor);</span><br><span class="line">	<span class="comment">//开启任务</span></span><br><span class="line">    engineJob.start(decodeJob);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">      logWithTimeAndKey(<span class="string">"Started new load"</span>, startTime, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>内存：<br>活动资源 (Active Resources) - 正在显示的资源,保护显示的图片不会被LruCache算法回收掉。<br>内存缓存 (Memory cache) - 显示过的资源，采取LRU算法置换</li>
<li>磁盘：<br>资源类型（Resource） - 被解码、转换后的资源<br>数据来源 (Data) - 源文件（未处理过）</li>
</ul>
<p>进入磁盘缓存的start()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//start方法就是根据diskCacheStrategy策略获取一个executor来执行DecodeJob</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line">    <span class="comment">//这里根据缓存策略，决定使用哪个Executor。默认情况返回diskCacheExecutor。</span></span><br><span class="line">    <span class="comment">//共三种执行器：diskCacheExecutor、sourceExecutor、sourceUnlimitedExecutor对应文章前面给出的流程图。</span></span><br><span class="line">    GlideExecutor executor = decodeJob.willDecodeFromCache()</span><br><span class="line">        ? diskCacheExecutor</span><br><span class="line">        : getActiveSourceExecutor();</span><br><span class="line">    executor.execute(decodeJob);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//DecodeJob实现了Runnable接口。直接来看它的run方法。</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TraceCompat.beginSection(<span class="string">"DecodeJob#run"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        notifyFailed();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      runWrapped();<span class="comment">//看这里！</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"DecodeJob threw unexpectedly"</span></span><br><span class="line">            + <span class="string">", isCancelled: "</span> + isCancelled</span><br><span class="line">            + <span class="string">", stage: "</span> + stage, e);</span><br><span class="line">      &#125;</span><br><span class="line">     ....</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//接着看runWrapped方法。</span></span><br><span class="line"><span class="comment">//RunReason是一个枚举，默认值为INITIALIZE。区分任务目的。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">      <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">        currentGenerator = getNextGenerator();</span><br><span class="line">        runGenerators();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">        runGenerators();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">        decodeFromRetrievedData();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized run reason: "</span> + runReason);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//获取任务执行阶段：初始化、读取转换后的缓存、读取原文件缓存、原文件加载、结束状态。</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">      <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">            ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">            ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">        <span class="comment">// Skip loading from source if the user opted to only retrieve the resource from cache.</span></span><br><span class="line">        <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">      <span class="keyword">case</span> FINISHED:</span><br><span class="line">        <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unrecognized stage: "</span> + current);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//根据上一个方法确定的stage，创建对应的Generator(可把它简单理解成资源加载器）</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="comment">//从转换后的缓存中读取文件</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">       <span class="comment">//从原文件缓存中读取文件</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">       <span class="comment">//没有缓存，重新加载资源（比如：网络图片、本地文件）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> FINISHED:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized stage: "</span> + stage);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//这里开始加载执行</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    currentThread = Thread.currentThread();</span><br><span class="line">    startFetchTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//这里Generator.startNext()方法中就是加载过程，如果成功加载则返回true并跳出循环，否则切换Generator继续执行。</span></span><br><span class="line">    <span class="keyword">while</span> (!isCancelled &amp;&amp; currentGenerator != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</span><br><span class="line">      stage = getNextStage(stage);</span><br><span class="line">      currentGenerator = getNextGenerator();</span><br><span class="line">     <span class="comment">//如果任务执行到去加载资源（也就是没有命中磁盘缓存），且切换任务执行环境</span></span><br><span class="line">      <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;</span><br><span class="line">        reschedule();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We've run out of stages and generators, give up.</span></span><br><span class="line">    <span class="keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">      notifyFailed();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise a generator started a new load and we expect to be called back in</span></span><br><span class="line">    <span class="comment">// onDataFetcherReady.</span></span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//更改执行目标为：SOURCE服务。当然也只有在stage == Stage.SOURCE的情况下会被调用。</span></span><br><span class="line">    runReason = RunReason.SWITCH_TO_SOURCE_SERVICE;</span><br><span class="line">    callback.reschedule(<span class="keyword">this</span>);<span class="comment">//这里callback正是EngineJob。</span></span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="comment">//代码跟进EngineJob类中，可以看到实现方法。</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">(DecodeJob&lt;?&gt; job)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 可以看到，这里获取的SourceExecutor来执行decodeJob。</span></span><br><span class="line">    <span class="comment">//也就巧妙地将此decodeJob任务从cacheExecutor切换到了SourceExecutor，这样分工协作更加高效。</span></span><br><span class="line">    getActiveSourceExecutor().execute(job);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>从最开始没有命中内存缓存开始，然后执行Engine的start方法</p>
<ol>
<li>默认情况会获取到cacheExecutor执行器来执行decodeJob任务；</li>
<li>继续decodeJob的run方法，因为RunReason==INITIALIZE，接着获取stage，默认会返回Stage.RESOURCE_CACHE,这时通过getNextGenerator就返回了ResourceCacheGenerator加载</li>
<li>紧接着就是调用 ResourceCacheGenerator的startNext方法 ，从转换后的缓存中读取已缓存的资源，如果命中则结束任务并回调结果，反之，任务切换到DataCacheGenerator加载器继续执行</li>
<li>若还是未命中，则切换到SourceGenerator加载器（第一次加载，由于没有任何缓存，就会走到这里），这时会通过任务调度，将线程运行环境切换到 SourceExecutor执行器来执行，最后，待SourceGenerator加载完成后结束任务，回调结果，流程结束。</li>
</ol>
<p>网络加载过程<br>Glide底层是采用HttpUrlConnection进行网络请求，也可更换为OkHttp请求连接。</p>
<h3 id="回调刷新UI"><a href="#回调刷新UI" class="headerlink" title="回调刷新UI"></a>回调刷新UI</h3><p>回到DecodeJob类中<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherReady</span><span class="params">(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher,</span></span></span><br><span class="line"><span class="function"><span class="params">      DataSource dataSource, Key attemptedKey)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">//资源加载完成后回调，执行</span></span><br><span class="line">      decodeFromRetrievedData();</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//处理源数据</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decodeFromRetrievedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">      logWithTimeAndKey(<span class="string">"Retrieved data"</span>, startFetchTime,</span><br><span class="line">          <span class="string">"data: "</span> + currentData</span><br><span class="line">          + <span class="string">", cache key: "</span> + currentSourceKey</span><br><span class="line">          + <span class="string">", fetcher: "</span> + currentFetcher);</span><br><span class="line">    &#125;</span><br><span class="line">    Resource&lt;R&gt; resource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//比如缩放，转换等。会判断currentDataSource类型。</span></span><br><span class="line">      resource = decodeFromData(currentFetcher, currentData, currentDataSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GlideException e) &#123;</span><br><span class="line">      e.setLoggingDetails(currentAttemptingKey, currentDataSource);</span><br><span class="line">      exceptions.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">      notifyEncodeAndRelease(resource, currentDataSource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      runGenerators();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyEncodeAndRelease</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Initializable) &#123;</span><br><span class="line">      ((Initializable) resource).initialize();</span><br><span class="line">    &#125;</span><br><span class="line">    Resource&lt;R&gt; result = resource;</span><br><span class="line">    LockedResource&lt;R&gt; lockedResource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) &#123;</span><br><span class="line">      lockedResource = LockedResource.obtain(resource);</span><br><span class="line">      result = lockedResource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通知完成，并回调。</span></span><br><span class="line">    notifyComplete(result, dataSource);</span><br><span class="line">    stage = Stage.ENCODE;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//磁盘缓存</span></span><br><span class="line">      <span class="keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) &#123;</span><br><span class="line">        deferredEncodeManager.encode(diskCacheProvider, options);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lockedResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        lockedResource.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">      onEncodeComplete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyComplete</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    setNotifiedOrThrow();</span><br><span class="line">    <span class="comment">//这里的callback就是EngineJob</span></span><br><span class="line">    callback.onResourceReady(resource, dataSource);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>DecodeJob加载完数据后，会做转换、磁盘缓存等操作。进入到EngineJob的onResourceReady<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.resource = resource;</span><br><span class="line">    <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">    <span class="comment">//将回调过程通过Handler切换到主线程</span></span><br><span class="line">    MAIN_THREAD_HANDLER.obtainMessage(MSG_COMPLETE, <span class="keyword">this</span>).sendToTarget();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">      EngineJob&lt;?&gt; job = (EngineJob&lt;?&gt;) message.obj;</span><br><span class="line">      <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MSG_COMPLETE:</span><br><span class="line">          job.handleResultOnMainThread();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_EXCEPTION:</span><br><span class="line">          job.handleExceptionOnMainThread();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_CANCELLED:</span><br><span class="line">          job.handleCancelledOnMainThread();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized message: "</span> + message.what);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">@Synthetic</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">handleResultOnMainThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stateVerifier.throwIfRecycled();</span><br><span class="line">    <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">      resource.recycle();</span><br><span class="line">      release(<span class="keyword">false</span> <span class="comment">/*isRemovedFromQueue*/</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cbs.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Received a resource without any callbacks to notify"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasResource) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already have resource"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    engineResource = engineResourceFactory.build(resource, isCacheable);</span><br><span class="line">    hasResource = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// Hold on to resource for duration of request so we don't recycle it in the middle of</span></span><br><span class="line">    <span class="comment">// notifying if it synchronously released by one of the callbacks.</span></span><br><span class="line">    engineResource.acquire();</span><br><span class="line">    <span class="comment">//通知并缓存到activeResources（内存缓存中的一种）中。</span></span><br><span class="line">    listener.onEngineJobComplete(key, engineResource);</span><br><span class="line">    <span class="keyword">for</span> (ResourceCallback cb : cbs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isInIgnoredCallbacks(cb)) &#123;</span><br><span class="line">        engineResource.acquire();</span><br><span class="line">        <span class="comment">//这里将回调到SingleRequest的onResourceReady中。</span></span><br><span class="line">        cb.onResourceReady(engineResource, dataSource);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Our request is complete, so we can release the resource.</span></span><br><span class="line">    engineResource.release();</span><br><span class="line">    release(<span class="keyword">false</span> <span class="comment">/*isRemovedFromQueue*/</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//继续跟进SingleRequest类</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    onResourceReady((Resource&lt;R&gt;) resource, (R) received, dataSource);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, R result, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We must call isFirstReadyResource before setting status.</span></span><br><span class="line">    <span class="keyword">boolean</span> isFirstResource = isFirstReadyResource();</span><br><span class="line">    status = Status.COMPLETE;</span><br><span class="line">    <span class="keyword">this</span>.resource = resource;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (requestListener == <span class="keyword">null</span></span><br><span class="line">        || !requestListener.onResourceReady(result, model, target, dataSource, isFirstResource)) &#123;</span><br><span class="line">      Transition&lt;? <span class="keyword">super</span> R&gt; animation =</span><br><span class="line">          animationFactory.build(dataSource, isFirstResource);</span><br><span class="line">    <span class="comment">//如果没有设置requestListener或者未消耗事件，就会回调target的onResourceReady方法。</span></span><br><span class="line">    <span class="comment">//默认的target是DrawableImageViewTarget     </span></span><br><span class="line">      target.onResourceReady(result, animation);</span><br><span class="line">    &#125;</span><br><span class="line">    notifyLoadSuccess();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>回调从Decodejob出来，在EngineJob中切换到主线程并一路回调到DrawableImageViewTarget中，至于为什么默认是DrawableImageViewTarget，请查看RequestBuilder中into方法。下面我们再看下DrawableImageViewTarget相关代码，也是设置显示图片的地方。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ublic <span class="class"><span class="keyword">class</span> <span class="title">DrawableImageViewTarget</span> <span class="keyword">extends</span> <span class="title">ImageViewTarget</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DrawableImageViewTarget</span><span class="params">(ImageView view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(view);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(@Nullable Drawable resource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//实现了该方法。简单将drawable设置给imageview。</span></span><br><span class="line">    view.setImageDrawable(resource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTarget</span>&lt;<span class="title">Z</span>&gt; <span class="keyword">extends</span> <span class="title">ViewTarget</span>&lt;<span class="title">ImageView</span>, <span class="title">Z</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Transition</span>.<span class="title">ViewAdapter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ImageViewTarget</span><span class="params">(ImageView view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(view);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Z resource, @Nullable Transition&lt;? <span class="keyword">super</span> Z&gt; transition)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transition == <span class="keyword">null</span> || !transition.transition(resource, <span class="keyword">this</span>)) &#123;</span><br><span class="line">      setResourceInternal(resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      maybeUpdateAnimatable(resource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResourceInternal</span><span class="params">(@Nullable Z resource)</span> </span>&#123;</span><br><span class="line">    maybeUpdateAnimatable(resource);</span><br><span class="line">    setResource(resource);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateAnimatable</span><span class="params">(@Nullable Z resource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Animatable) &#123;</span><br><span class="line">      animatable = (Animatable) resource;</span><br><span class="line">      animatable.start();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      animatable = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(@Nullable Z resource)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>onResourceReady在父类ImageViewTarget中回调，然后调用setResource将图片设置并显示出来。代码执行到这里，回调过程也就结束了。</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>左旋转字符串</title>
    <url>/2019/03/10/%E5%B7%A6%E6%97%8B%E8%BD%AC%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="字符串的左旋转操作是把字符串前面的若干个字符转移到字符串的尾部。请定义一个函数实现字符串左旋转操作的功能。"><a href="#字符串的左旋转操作是把字符串前面的若干个字符转移到字符串的尾部。请定义一个函数实现字符串左旋转操作的功能。" class="headerlink" title="字符串的左旋转操作是把字符串前面的若干个字符转移到字符串的尾部。请定义一个函数实现字符串左旋转操作的功能。"></a>字符串的左旋转操作是把字符串前面的若干个字符转移到字符串的尾部。请定义一个函数实现字符串左旋转操作的功能。</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:abcdefg, <span class="number">2</span></span><br><span class="line">Output:cdefgab</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>K对length进行取余，减少计算量。</p>
<ol>
<li>先旋转前k个字符串</li>
<li>再旋转剩余字符串</li>
<li>全体旋转一次</li>
</ol>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">char</span>[] s, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.length &lt;= <span class="number">1</span> || low &gt; high) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        c = s[low];</span><br><span class="line">        s[low] = s[high];</span><br><span class="line">        s[high] = c;</span><br><span class="line">        low++;</span><br><span class="line">        high--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">leftRotateString</span><span class="params">(<span class="keyword">char</span>[] str, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.length &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    k %= str.length;</span><br><span class="line"></span><br><span class="line">    reverse(str, <span class="number">0</span>, k - <span class="number">1</span>);</span><br><span class="line">    reverse(str, k, str.length - <span class="number">1</span>);</span><br><span class="line">    reverse(str, <span class="number">0</span>, str.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>剑指Offer</tag>
      </tags>
  </entry>
  <entry>
    <title>翻转单词顺序</title>
    <url>/2019/03/10/%E7%BF%BB%E8%BD%AC%E5%8D%95%E8%AF%8D%E9%A1%BA%E5%BA%8F/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="输入一个英文句子，翻转句子中单词的顺序，但单词内字的顺序不变。为简单起见，标点符号和普通字母一样处理。要求空间复杂度为O-1"><a href="#输入一个英文句子，翻转句子中单词的顺序，但单词内字的顺序不变。为简单起见，标点符号和普通字母一样处理。要求空间复杂度为O-1" class="headerlink" title="输入一个英文句子，翻转句子中单词的顺序，但单词内字的顺序不变。为简单起见，标点符号和普通字母一样处理。要求空间复杂度为O(1)"></a>输入一个英文句子，翻转句子中单词的顺序，但单词内字的顺序不变。为简单起见，标点符号和普通字母一样处理。要求空间复杂度为O(1)</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: I am a student.</span><br><span class="line">Output: student. a am I</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>曾听黄工讲过这道题，当时自己的做法是，以“ ”作为分割符得到String[] str，然后用一个StringBuilder逆向遍历数组添加字符串即可。但这样空间复杂度就为O(n)<br>O（1）的话可以这么做，首先全部逆序一次，然后再将每个单词逆序一次即可。emmmmmm,怎么逆序单词呢？ 双指针是个好东西。双指针low,high均从0开始，默认先让high走，直至high所指向的字符为‘ ’时，逆序（low, high - 1）之间的字符，再让low = ++high;<br>当low所指向字符为空格时，low和high一起 ++。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">char</span>[] s, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.length &lt;= <span class="number">1</span> || low &gt; high) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        c = s[low];</span><br><span class="line">        s[low] = s[high];</span><br><span class="line">        s[high] = c;</span><br><span class="line">        low++;</span><br><span class="line">        high--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">String <span class="title">reverseSentence</span><span class="params">(<span class="keyword">char</span>[] data)</span> </span>&#123;<span class="comment">//char比String更好处理，如果是String的话，还需要StringBuilder封装，空间复杂度为O(1)</span></span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span> || data.length &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> length = data.length;</span><br><span class="line">    <span class="keyword">int</span> low = <span class="number">0</span>, high = length - <span class="number">1</span>;</span><br><span class="line">    reverse(data, low, high);</span><br><span class="line"></span><br><span class="line">    high = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> begin;</span><br><span class="line">    <span class="keyword">while</span> (low &lt; length) &#123;</span><br><span class="line">        begin = data[low];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (begin == <span class="string">' '</span>) &#123;</span><br><span class="line">            low++;</span><br><span class="line">            high++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (high == length || data[high] == <span class="string">' '</span>) &#123;</span><br><span class="line">            reverse(data, low, --high);</span><br><span class="line">            high += <span class="number">2</span>;</span><br><span class="line">            low = high;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            high++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>剑指Offer</tag>
      </tags>
  </entry>
  <entry>
    <title>ContentProvider源码解析</title>
    <url>/2019/03/09/ContentProvider%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol>
<li><code>当ContentProvider所在进程启动时，ContentProvider的onCreate会先于Application的onCreate()执行，并且发布到AMS中。</code></li>
<li>ContentProvider是个抽象类，必须继承ContentProvider重写方法方可使用</li>
<li>外界无法直接访问ContentProvider，必须通过ContentResolver来获取AMS中的CotentProvider的Binder接口IContentProvider</li>
<li>ContentResolver是一个抽象类，Context.getContentResolver()获取的实际是实现了ContentResolver接口的ApplicationContentResolver对象</li>
<li>当ContentProvider没有启动，其他应用进程访问ContentProvider时，ContentProvider创建的同时ContentProvider所在进程会启动<h2 id="ContentResolver调用"><a href="#ContentResolver调用" class="headerlink" title="ContentResolver调用"></a>ContentResolver调用</h2>以query为例，分析ContentProvider源码<br>先从ContentResolver开始哈,毕竟它是发起访问的。<figure class="highlight java"><figcaption><span>public final @Nullable Cursor query(final @RequiresPermission.Read @NonNull Uri uri,</span></figcaption><table><tr><td class="code"><pre><span class="line">            <span class="meta">@Nullable</span> String[] projection, <span class="meta">@Nullable</span> Bundle queryArgs,</span><br><span class="line">            <span class="meta">@Nullable</span> CancellationSignal cancellationSignal) &#123;</span><br><span class="line">        Preconditions.checkNotNull(uri, <span class="string">"uri"</span>);</span><br><span class="line">        IContentProvider unstableProvider = acquireUnstableProvider(uri);</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>首先获取IContentProvider对象，acquireUnstableProvider最终调用acquireProvider（抽象方法），而ContentResolver的实现类是源码ContexImpl下的ApplicationContentResolver.（要从AndoridXref看）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContentResolver</span> <span class="keyword">extends</span> <span class="title">ContentResolver</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">ApplicationContentResolver</span><span class="params">(Context context, ActivityThread mainThread)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">super</span>(context);</span><br><span class="line">         mMainThread = mainThread;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">protected</span> IContentProvider <span class="title">acquireProvider</span><span class="params">(Context context, String name)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> mMainThread.acquireProvider(context, name);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">protected</span> IContentProvider <span class="title">acquireExistingProvider</span><span class="params">(Context context, String name)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> mMainThread.acquireExistingProvider(context, name);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">releaseProvider</span><span class="params">(IContentProvider provider)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> mMainThread.releaseProvider(provider);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> ActivityThread mMainThread;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>ApplicationContentResolver的acquireProvider调用了ActivityThread的acquireProvider（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IContentProvider <span class="title">acquireProvider</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Context c, String auth, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> stable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IContentProvider provider = acquireExistingProvider(c, auth, userId, stable);<span class="comment">//1</span></span><br><span class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// There is a possible race here.  Another thread may try to acquire</span></span><br><span class="line">    <span class="comment">// the same provider at the same time.  When this happens, we want to ensure</span></span><br><span class="line">    <span class="comment">// that the first one wins.</span></span><br><span class="line">    <span class="comment">// Note that we cannot hold the lock while acquiring and installing the</span></span><br><span class="line">    <span class="comment">// provider since it might take a long time to run and it could also potentially</span></span><br><span class="line">    <span class="comment">// be re-entrant in the case where the provider is in the same process.</span></span><br><span class="line">    ContentProviderHolder holder = <span class="keyword">null</span>;<span class="comment">//2</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getGetProviderLock(auth, userId)) &#123;</span><br><span class="line">            holder = ActivityManager.getService().getContentProvider(</span><br><span class="line">                    getApplicationThread(), auth, userId, stable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Failed to find provider info for "</span> + auth);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install provider will increment the reference count for us, and break</span></span><br><span class="line">    <span class="comment">// any ties in the race.</span></span><br><span class="line">    holder = installProvider(c, holder, holder.info,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/*noisy*/</span>, holder.noReleaseNeeded, stable);</span><br><span class="line">    <span class="keyword">return</span> holder.provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1处：先从ActivityThread中的 ArrayMap&lt;ProviderKey, ProviderClientRecord&gt; mProviderMap查找是否存在目标ContentProvider,如果存在就直接返回。</p>
<p>2处：如果目前ContentProvider没有启动，就会开启RPC远程调用给AMS让其启动目标ContentProvider，最后通过installProvider修改引用计数。而ContentProvider的启动伴随着App进程的启动。</p>
<p>启动流程为先启动ContentProvider所在进程，然后再启动ContentProvider。然后再启动ContentProvider.由于一个APP从启动到主页面显示经历了哪些过程？已经做过笔记，不再赘述。直接进入handleBindApplication中</p>
<h2 id="ContentProvider创建"><a href="#ContentProvider创建" class="headerlink" title="ContentProvider创建"></a>ContentProvider创建</h2><p>在handleBindApplication中ContentProvider的创建分为四个步骤。</p>
<h3 id="创建ContextImpl-和-Instrumentation"><a href="#创建ContextImpl-和-Instrumentation" class="headerlink" title="创建ContextImpl 和 Instrumentation"></a>创建ContextImpl 和 Instrumentation</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">    mInstrumentation = (Instrumentation)</span><br><span class="line">        cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">        <span class="string">"Unable to instantiate instrumentation "</span></span><br><span class="line">        + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ComponentName component = <span class="keyword">new</span> ComponentName(ii.packageName, ii.name);</span><br><span class="line">mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, component,</span><br><span class="line">        data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br></pre></td></tr></table></figure>
<p>创建ContextImpl，再通过反射创建Instrumentation，并初始化Instrumentation</p>
<h3 id="创建Application对象（并未调用其OnCreate方法）"><a href="#创建Application对象（并未调用其OnCreate方法）" class="headerlink" title="创建Application对象（并未调用其OnCreate方法）"></a>创建Application对象（并未调用其OnCreate方法）</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Propagate autofill compat state</span></span><br><span class="line">           app.setAutofillCompatibilityEnabled(data.autofillCompatibilityEnabled);</span><br><span class="line"></span><br><span class="line">           mInitialApplication = app;</span><br></pre></td></tr></table></figure>
<h3 id="启动ContentProvider，并调用其onCreate方法"><a href="#启动ContentProvider，并调用其onCreate方法" class="headerlink" title="启动ContentProvider，并调用其onCreate方法"></a>启动ContentProvider，并调用其onCreate方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">            <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                    installContentProviders(app, data.providers);</span><br><span class="line">                    <span class="comment">// For process that contains content providers, we want to</span></span><br><span class="line">                    <span class="comment">// ensure that the JIT is enabled "at some point".</span></span><br><span class="line">                    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installContentProviders</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context context, List&lt;ProviderInfo&gt; providers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;ContentProviderHolder&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ProviderInfo cpi : providers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">                StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                buf.append(<span class="string">"Pub "</span>);</span><br><span class="line">                buf.append(cpi.authority);</span><br><span class="line">                buf.append(<span class="string">": "</span>);</span><br><span class="line">                buf.append(cpi.name);</span><br><span class="line">                Log.i(TAG, buf.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            ContentProviderHolder cph = installProvider(context, <span class="keyword">null</span>, cpi,</span><br><span class="line">                    <span class="keyword">false</span> <span class="comment">/*noisy*/</span>, <span class="keyword">true</span> <span class="comment">/*noReleaseNeeded*/</span>, <span class="keyword">true</span> <span class="comment">/*stable*/</span>);</span><br><span class="line">            <span class="keyword">if</span> (cph != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cph.noReleaseNeeded = <span class="keyword">true</span>;</span><br><span class="line">                results.add(cph);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManager.getService().publishContentProviders(</span><br><span class="line">                getApplicationThread(), results);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用installContentProviders会遍历ProviderInfo的list，一一调用installProvider()来启动它们。来启动ContentProvider.接着将已启动的ContentProvider发布到AMS中，AMS会把它们存储到ProvideMap中，供ContentResolver查询<br>进入installProvider<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">installProvider</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">          ContentProviderHolder holder, ProviderInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> noisy, <span class="keyword">boolean</span> noReleaseNeeded, <span class="keyword">boolean</span> stable)</span> </span>&#123;</span><br><span class="line">      ContentProvider localProvider = <span class="keyword">null</span>;</span><br><span class="line">      IContentProvider provider;</span><br><span class="line">  .....</span><br><span class="line">              <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(</span><br><span class="line">                  TAG, <span class="string">"Instantiating local provider "</span> + info.name);</span><br><span class="line">              <span class="comment">// XXX Need to create the correct context for this provider.</span></span><br><span class="line">              localProvider.attachInfo(c, info);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!mInstrumentation.onException(<span class="keyword">null</span>, e)) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                          <span class="string">"Unable to get provider "</span> + info.name</span><br><span class="line">                          + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入attachInfo<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachInfo</span><span class="params">(Context context, ProviderInfo info, <span class="keyword">boolean</span> testing)</span> </span>&#123;</span><br><span class="line">        mNoPerms = testing;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Only allow it to be set once, so after the content service gives</span></span><br><span class="line"><span class="comment">         * this to us clients can't change it.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mContext = context;</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mTransport.mAppOpsManager = (AppOpsManager) context.getSystemService(</span><br><span class="line">                        Context.APP_OPS_SERVICE);</span><br><span class="line">            &#125;</span><br><span class="line">            mMyUid = Process.myUid();</span><br><span class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">                setReadPermission(info.readPermission);</span><br><span class="line">                setWritePermission(info.writePermission);</span><br><span class="line">                setPathPermissions(info.pathPermissions);</span><br><span class="line">                mExported = info.exported;</span><br><span class="line">                mSingleUser = (info.flags &amp; ProviderInfo.FLAG_SINGLE_USER) != <span class="number">0</span>;</span><br><span class="line">                setAuthorities(info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">            ContentProvider.<span class="keyword">this</span>.onCreate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在attachInfo中调用了ContentProvider的onCreate方法</p>
<h3 id="调用Application的onCreate方法"><a href="#调用Application的onCreate方法" class="headerlink" title="调用Application的onCreate方法"></a>调用Application的onCreate方法</h3><p>在handleBindApplication中启动完Binder后调用Application的onCreate方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mInstrumentation.callApplicationOnCreate(app);</span><br></pre></td></tr></table></figure></p>
<h2 id="访问ContentProvider"><a href="#访问ContentProvider" class="headerlink" title="访问ContentProvider"></a>访问ContentProvider</h2><p>经过上述步骤，ContentProvider已经成功启动，且其所在进程的Application也已经启动起来，所以访问进程的ContentResolver就可以通过AMS访问这个ContentProvider.<br>回到ContentResolver中的query方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> <span class="function">Cursor <span class="title">query</span><span class="params">(<span class="keyword">final</span> @RequiresPermission.Read @NonNull Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] projection, @Nullable Bundle queryArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable CancellationSignal cancellationSignal)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(uri, <span class="string">"uri"</span>);</span><br><span class="line">    IContentProvider unstableProvider = acquireUnstableProvider(uri);</span><br><span class="line">    <span class="keyword">if</span> (unstableProvider == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IContentProvider stableProvider = <span class="keyword">null</span>;</span><br><span class="line">    Cursor qCursor = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">        ICancellationSignal remoteCancellationSignal = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (cancellationSignal != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cancellationSignal.throwIfCanceled();</span><br><span class="line">            remoteCancellationSignal = unstableProvider.createCancellationSignal();</span><br><span class="line">            cancellationSignal.setRemote(remoteCancellationSignal);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            qCursor = unstableProvider.query(mPackageName, uri, projection,</span><br><span class="line">                    queryArgs, remoteCancellationSignal);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">            <span class="comment">// The remote process has died...  but we only hold an unstable</span></span><br><span class="line">            <span class="comment">// reference though, so we might recover!!!  Let's try!!!!</span></span><br><span class="line">            <span class="comment">// This is exciting!!1!!1!!!!1</span></span><br><span class="line">            unstableProviderDied(unstableProvider);</span><br><span class="line">            stableProvider = acquireProvider(uri);</span><br><span class="line">            <span class="keyword">if</span> (stableProvider == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            qCursor = stableProvider.query(</span><br><span class="line">                    mPackageName, uri, projection, queryArgs, remoteCancellationSignal);</span><br><span class="line">        &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过acquireUnstableProvider返回的是一个IContentProvider。以I开头的。没错，哼，又是你，Binder机制。IContentProvider就是Binder接口，那它调用query，岂不是代理在RPC咯，那找找服务端实现类和代理类。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentProviderNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContentProviderNative</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        attachInterface(<span class="keyword">this</span>, descriptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cast a Binder object into a content resolver interface, generating</span></span><br><span class="line"><span class="comment">     * a proxy if needed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IContentProvider <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        IContentProvider in =</span><br><span class="line">            (IContentProvider)obj.queryLocalInterface(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ContentProviderProxy(obj);</span><br><span class="line">    &#125;</span><br><span class="line">	.....</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	    <span class="class"><span class="keyword">class</span> <span class="title">Transport</span> <span class="keyword">extends</span> <span class="title">ContentProviderNative</span> </span>&#123;</span><br><span class="line">        AppOpsManager mAppOpsManager = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> mReadOp = AppOpsManager.OP_NONE;</span><br><span class="line">        <span class="keyword">int</span> mWriteOp = AppOpsManager.OP_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="function">ContentProvider <span class="title">getContentProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ContentProvider.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getProviderName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getContentProvider().getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(String callingPkg, Uri uri, @Nullable String[] projection,</span></span></span><br><span class="line"><span class="function"><span class="params">                @Nullable Bundle queryArgs, @Nullable ICancellationSignal cancellationSignal)</span> </span>&#123;</span><br><span class="line">            validateIncomingUri(uri);</span><br><span class="line">            uri = maybeGetUriWithoutUserId(uri);</span><br><span class="line">            <span class="keyword">if</span> (enforceReadPermission(callingPkg, uri, <span class="keyword">null</span>) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="comment">// The caller has no access to the data, so return an empty cursor with</span></span><br><span class="line">                <span class="comment">// the columns in the requested order. The caller may ask for an invalid</span></span><br><span class="line">                <span class="comment">// column and we would not catch that but this is not a problem in practice.</span></span><br><span class="line">                <span class="comment">// We do not call ContentProvider#query with a modified where clause since</span></span><br><span class="line">                <span class="comment">// the implementation is not guaranteed to be backed by a SQL database, hence</span></span><br><span class="line">                <span class="comment">// it may not handle properly the tautology where clause we would have created.</span></span><br><span class="line">                <span class="keyword">if</span> (projection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MatrixCursor(projection, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Null projection means all columns but we have no idea which they are.</span></span><br><span class="line">                <span class="comment">// However, the caller may be expecting to access them my index. Hence,</span></span><br><span class="line">                <span class="comment">// we have to execute the query as if allowed to get a cursor with the</span></span><br><span class="line">                <span class="comment">// columns. We then use the column names to return an empty cursor.</span></span><br><span class="line">                Cursor cursor = ContentProvider.<span class="keyword">this</span>.query(</span><br><span class="line">                        uri, projection, queryArgs,</span><br><span class="line">                        CancellationSignal.fromTransport(cancellationSignal));</span><br><span class="line">                <span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Return an empty cursor for all columns.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> MatrixCursor(cursor.getColumnNames(), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> String original = setCallingPackage(callingPkg);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ContentProvider.<span class="keyword">this</span>.query(</span><br><span class="line">                        uri, projection, queryArgs,</span><br><span class="line">                        CancellationSignal.fromTransport(cancellationSignal));</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                setCallingPackage(original);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>ContentProviderNative继承Binder实现了ICotentProvider，而  ContentProvider.Transport 继承了ContentProviderNative。请注意哈，这里有一个神奇的地方，自己查了很久的书和网站得出结论。ContentProviderNative是一个android自己实现的contentProvider的代理类，然而ContentProvider.Transport继承了 ContentProviderNative 却是服务端实现接口。简言之，<code>当我们从ContentResolver中调用query时，通过 ContentProviderNative 作为代理 访问到了 其子类Transport中的query方法。</code><br>在transport中，重写了父类的CRUD等方法。在transport中会调用当前ContentProvider的query方法。然后返回给代理，代理又返回给客户端。这样客户端就拿到了数据。<br>emmmmm，可以吃饭去了。</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码解析</tag>
      </tags>
  </entry>
  <entry>
    <title>和为S的连续正数序列</title>
    <url>/2019/03/08/%E5%92%8C%E4%B8%BAS%E7%9A%84%E8%BF%9E%E7%BB%AD%E6%AD%A3%E6%95%B0%E5%BA%8F%E5%88%97/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="输入一个正数s-打印出所有和为s的连续正数序列（至少含有两个数）。例如输入15，由于1-2-3-4-5-4-5-6-7-8-15；所以打印出三个连续序列1-5-4-6-7-8；"><a href="#输入一个正数s-打印出所有和为s的连续正数序列（至少含有两个数）。例如输入15，由于1-2-3-4-5-4-5-6-7-8-15；所以打印出三个连续序列1-5-4-6-7-8；" class="headerlink" title="输入一个正数s,打印出所有和为s的连续正数序列（至少含有两个数）。例如输入15，由于1+2+3+4+5=4+5+6=7+8=15；所以打印出三个连续序列1~5,4~6,7~8；"></a>输入一个正数s,打印出所有和为s的连续正数序列（至少含有两个数）。例如输入15，由于1+2+3+4+5=4+5+6=7+8=15；所以打印出三个连续序列1~5,4~6,7~8；</h3><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>从递增数组中两个数和为s的数得到启示，我们也可以设置两个指针，一个指向当前序列的最小的数，一个指向当前序列最大的数。</p>
<p>设置mid变量，赋值为(1+s)/2，因为和为s的序列至少包括两个数，所以只需small指针遍历到s即可</p>
<ol>
<li>设置两个指针，一个为small指向当前正数序列中最小的数，一个为big指向当前正数序列中最大的数；</li>
<li>若是当前的正数序列之和大于S，那么缩小序列范围，让small指针不停往前走，直到等于S或者small &gt; mid；</li>
<li>若是当前的正数序列之和小于S，那么扩大序列范围，让big指针不停往前走，直到和为S停止；</li>
</ol>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">findContinuousSequence</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (s &lt; <span class="number">3</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> small = <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">int</span> big = <span class="number">2</span>;</span><br><span class="line">       <span class="keyword">int</span> mid = (<span class="number">1</span> + s) / <span class="number">2</span>;</span><br><span class="line">       <span class="keyword">int</span> curSum = small + big;<span class="comment">//当前和不从0开始计算</span></span><br><span class="line">       <span class="keyword">while</span> (small &lt; mid) &#123;</span><br><span class="line">           <span class="keyword">if</span> (curSum == s) &#123;<span class="comment">//加上small后和是否相等</span></span><br><span class="line">               print(small, big);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">while</span> (curSum &gt; s &amp;&amp; small &lt; mid) &#123;</span><br><span class="line">               curSum -= small;</span><br><span class="line">               small++;</span><br><span class="line">               <span class="keyword">if</span> (curSum == s) &#123;<span class="comment">//减去small后和是否相等</span></span><br><span class="line">                   print(small, big);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           big++;</span><br><span class="line">           curSum += big;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> small, <span class="keyword">int</span> big)</span> </span>&#123;</span><br><span class="line">       StringBuilder s = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = small; i &lt;= big; i++) &#123;</span><br><span class="line">           s.append(i).append(<span class="string">" "</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(s.toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>剑指Offer</tag>
      </tags>
  </entry>
  <entry>
    <title>平衡二叉树的判断</title>
    <url>/2019/03/06/%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%88%A4%E6%96%AD/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="输入一棵二叉树的根结点，判断该树是不是平衡二叉树。如果某二叉树中任意结点的左右子树的深度相差不超过1-，那么它就是一棵平衡二叉树。"><a href="#输入一棵二叉树的根结点，判断该树是不是平衡二叉树。如果某二叉树中任意结点的左右子树的深度相差不超过1-，那么它就是一棵平衡二叉树。" class="headerlink" title="输入一棵二叉树的根结点，判断该树是不是平衡二叉树。如果某二叉树中任意结点的左右子树的深度相差不超过1 ，那么它就是一棵平衡二叉树。"></a>输入一棵二叉树的根结点，判断该树是不是平衡二叉树。如果某二叉树中任意结点的左右子树的深度相差不超过1 ，那么它就是一棵平衡二叉树。</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:[<span class="number">3</span>,<span class="number">9</span>,<span class="number">20</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="number">15</span>,<span class="number">7</span>]</span><br><span class="line">Output: <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>思路是采用递归的后序遍历，避免重复访问子树。因为浅拷贝的存在，导致传入的参数一旦赋值，实参并不会跟着发生变化。我想了很久怎么实现指针的引用，竟然还想到写一个返回类封装…..<br><code>数组</code> 是个好东西讷！它传入的引用一旦发生改变，形参所指向的地址的数据也同样会发生改变。总觉得还遇到过这样的处理方法一次。<code>谨记，谨记，谨记。</code></p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBalanced</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isBalanced(root, <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBalanced</span><span class="params">(TreeNode root, <span class="keyword">int</span>[] depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            depth[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] left = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span>[] right = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isBalanced(root.left, left) &amp;&amp; isBalanced(root.right, right)) &#123;</span><br><span class="line">            <span class="keyword">int</span> d = Math.abs(left[<span class="number">0</span>] - right[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (d &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                depth[<span class="number">0</span>] = <span class="number">1</span> + ((left[<span class="number">0</span>] &gt; right[<span class="number">0</span>]) ? left[<span class="number">0</span>] : right[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>剑指Offer</tag>
      </tags>
  </entry>
  <entry>
    <title>EventBus源码解析</title>
    <url>/2019/03/03/EventBus%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>转自<a href="https://www.bookstack.cn/read/android_interview/android-open-source-framework-EventBus.md" target="_blank" rel="noopener">EventBus解析</a></p>
<h2 id="简析EventBus"><a href="#简析EventBus" class="headerlink" title="简析EventBus"></a>简析EventBus</h2><p>EventBus是一个Android端优化的publish/subscribe消息总线，简化了应用程序内各组件间、组件与后台线程间的通信。<br>作为一个消息总线主要有三个组成部分：</p>
<p>事件（Event）：可以是任意类型的对象。通过事件的发布者将事件进行传递。</p>
<p>事件订阅者（Subscriber）：接收特定的事件。</p>
<p>事件发布者（Publisher）：用于通知 Subscriber 有事件发生。可以在任意线程任意位置发送事件。<br><img src="/images/eventbus_simple_resolve.png" alt="eventbus_resolve"><br>事件的发布者（Publisher）将事件（Event）通过post()方法发送。EventBus内部进行处理，找到订阅了该事件（Event）的事件订阅者（Subscriber）。然后该事件的订阅者（Subscriber）通过onEvent()方法接收事件进行相关处理（关于onEvent()在EventBus 3.0中有改动，下面详细说明）。</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>注册订阅<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">EventBus.getDefault().register(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>事件处理<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MainThread)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">onNewsEvent</span><span class="params">(NewsEvent event)</span></span>&#123;</span><br><span class="line">        String message = event.getMessage();</span><br><span class="line">        mTv_message.setText(message);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>发布事件<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">EventBus.getDefault().post(<span class="keyword">new</span> NewsEvent(<span class="string">"我是来自SecondActivity的消息，你好！"</span>));</span><br></pre></td></tr></table></figure></p>
<h2 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h2><p>进入getDefault()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> EventBus defaultInstance;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (EventBus<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    defaultInstance = <span class="keyword">new</span> EventBus();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> defaultInstance;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上述代码可以得知，getDefault()中通过双检查锁（DCL）机制实现了EventBus的单例机制，获得了一个默认配置的EventBus对象。<br>在了解register()之前，先要了解一下EventBus中的几个关键的成员变量。方便对下面内容的理解。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Map&lt;订阅事件, 订阅该事件的订阅者集合&gt; */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</span><br><span class="line"><span class="comment">/* Map&lt;订阅者, 订阅事件集合&gt; */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;</span><br><span class="line"><span class="comment">/* Map&lt;订阅事件类类型,订阅事件实例对象&gt;. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents;</span><br></pre></td></tr></table></figure></p>
<p>下面看具体的register()中执行的代码。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line"><span class="comment">//订阅者类型</span></span><br><span class="line">       Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">	 <span class="comment">//获取订阅者全部的响应函数信息（即上面的onNewsEvent()之类的方法）</span></span><br><span class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">	 <span class="comment">//循环每一个事件响应函数，执行 subscribe()方法，更新订阅相关信息</span></span><br><span class="line">           <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">               subscribe(subscriber, subscriberMethod);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>register()</p>
<ol>
<li>获取订阅者的类类型</li>
<li>通过SubscriberMethodFinder类来解析订阅者类,获取所有的响应函数集合</li>
<li>遍历订阅函数,执行 subscribe()方法，更新订阅相关信息</li>
</ol>
<p>继续看subscribe()方法。<br>subscribe 函数分三步<br>第一步：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">//获取订阅的事件类型</span></span><br><span class="line">  Class&lt;?&gt; eventType = subscriberMethod.eventType;</span><br><span class="line"> <span class="comment">//获取订阅该事件的订阅者集合</span></span><br><span class="line">  CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line"><span class="comment">//把通过register()订阅的订阅者包装成Subscription 对象</span></span><br><span class="line">  Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);</span><br><span class="line">  <span class="comment">//订阅者集合为空，创建新的集合，并把newSubscription 加入</span></span><br><span class="line">  <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">      subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Subscription&gt;();</span><br><span class="line">      subscriptionsByEventType.put(eventType, subscriptions);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//集合中已经有该订阅者，抛出异常。不能重复订阅</span></span><br><span class="line">      <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></span><br><span class="line">                  + eventType);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//把新的订阅者按照优先级加入到订阅者集合中。</span></span><br><span class="line">  <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">      <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</span><br><span class="line">              subscriptions.add(i, newSubscription);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>第二步：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//根据订阅者，获得该订阅者订阅的事件类型集合</span></span><br><span class="line"> List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</span><br><span class="line"><span class="comment">//如果事件类型集合为空，创建新的集合，并加入新订阅的事件类型。</span></span><br><span class="line"> <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</span><br><span class="line">     subscribedEvents = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">     typesBySubscriber.put(subscriber, subscribedEvents);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//如果事件类型集合不为空，加入新订阅的事件类型</span></span><br><span class="line"> subscribedEvents.add(eventType);</span><br></pre></td></tr></table></figure></p>
<p>第三步：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//该事件是stick=true。</span></span><br><span class="line"><span class="keyword">if</span> (subscriberMethod.sticky) &#123;</span><br><span class="line">            <span class="comment">//响应订阅事件的父类事件</span></span><br><span class="line">            <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">                Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">                <span class="comment">//循环获得每个stickyEvent事件</span></span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                    Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                    <span class="comment">//是该类的父类</span></span><br><span class="line">                    <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                         <span class="comment">//该事件类型最新的事件发送给当前订阅者。</span></span><br><span class="line">                        Object stickyEvent = entry.getValue();</span><br><span class="line">                        checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Object stickyEvent = stickyEvents.get(eventType);</span><br><span class="line">                checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>通过subscriptionsByEventType得到该事件类型所有订阅者信息队列，根据优先级将当前订阅者信息插入到订阅者队列subscriptionsByEventType中；</li>
<li>在typesBySubscriber中得到当前订阅者订阅的所有事件队列，将此事件保存到队列typesBySubscriber中，用于后续取消订阅；</li>
<li>检查这个事件是否是 Sticky 事件，如果是则从stickyEvents事件保存队列中取出该事件类型最后一个事件发送给当前订阅者。</li>
</ol>
<p>以下是订阅的具体流程图：<br><img src="/images/eventbus_register.png" alt="eventbus_register"></p>
<h2 id="unRegister"><a href="#unRegister" class="headerlink" title="unRegister"></a>unRegister</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取该订阅者所有的订阅事件类类型集合.</span></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</span><br><span class="line">            unsubscribeByEventType(subscriber, eventType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从typesBySubscriber删除该&lt;订阅者对象,订阅事件类类型集合&gt;</span></span><br><span class="line">        typesBySubscriber.remove(subscriber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(<span class="string">"EventBus"</span>, <span class="string">"Subscriber to unregister was not registered before: "</span></span><br><span class="line">                + subscriber.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取订阅事件对应的订阅者信息集合.</span></span><br><span class="line">    List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) &#123;</span><br><span class="line">            Subscription subscription = subscriptions.get(i);</span><br><span class="line">            <span class="comment">// 从订阅者集合中删除特定的订阅者.</span></span><br><span class="line">            <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</span><br><span class="line">                subscription.active = <span class="keyword">false</span>;</span><br><span class="line">                subscriptions.remove(i);</span><br><span class="line">                i --;</span><br><span class="line">                size --;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>unregister()方法比较简单，主要完成了subscriptionsByEventType以及typesBySubscriber两个集合的同步。</p>
<h2 id="Post"><a href="#Post" class="headerlink" title="Post"></a>Post</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前线程的Posting状态.</span></span><br><span class="line">    PostingThreadState postingState = currentPostingThreadState.get();</span><br><span class="line">    <span class="comment">// 获取当前线程的事件队列.</span></span><br><span class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</span><br><span class="line">    <span class="comment">//将当前事件添加到其事件队列</span></span><br><span class="line">    eventQueue.add(event);</span><br><span class="line">    <span class="comment">//判断新加入的事件是否在分发中</span></span><br><span class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;</span><br><span class="line">        postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();</span><br><span class="line">        postingState.isPosting = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 循环处理当前线程eventQueue中的每一个event对象.</span></span><br><span class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</span><br><span class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 重置postingState一些标识信息.</span></span><br><span class="line">            postingState.isPosting = <span class="keyword">false</span>;</span><br><span class="line">            postingState.isMainThread = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>post 函数会首先得到当前线程的 post 信息 PostingThreadState，其中包含事件队列，将当前事件添加到其事件队列中，然后循环调用 postSingleEvent 函数发布队列中的每个事件。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//分发事件的类型</span></span><br><span class="line">    Class&lt;?&gt; eventClass = event.getClass();</span><br><span class="line">    <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</span><br><span class="line">   <span class="comment">//响应订阅事件的父类事件</span></span><br><span class="line">    <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">        <span class="comment">//找出当前订阅事件类类型eventClass的所有父类的类类型和其实现的接口的类类型</span></span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</span><br><span class="line">        <span class="keyword">int</span> countTypes = eventTypes.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h ++) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</span><br><span class="line">            <span class="comment">//发布每个事件到每个订阅者</span></span><br><span class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</span><br><span class="line">    &#125;</span><br><span class="line">........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用 postSingleEventForEventType 函数发布每个事件到每个订阅者。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            Class&lt;?&gt; eventClass)</span> </span>&#123;</span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取订阅事件类类型对应的订阅者信息集合.(register函数时构造的集合)</span></span><br><span class="line">        subscriptions = subscriptionsByEventType.get(eventClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</span><br><span class="line">            postingState.event = event;</span><br><span class="line">            postingState.subscription = subscription;</span><br><span class="line">            <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 发布订阅事件给订阅函数</span></span><br><span class="line">                postToSubscription(subscription, event, postingState.isMainThread);</span><br><span class="line">                aborted = postingState.canceled;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                postingState.event = <span class="keyword">null</span>;</span><br><span class="line">                postingState.subscription = <span class="keyword">null</span>;</span><br><span class="line">                postingState.canceled = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (aborted) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用 postToSubscription 函数向每个订阅者发布事件。<br>postToSubscription 函数中会判断订阅者的 ThreadMode，从而决定在什么 Mode 下执行事件响应函数。这里就不贴源码了。后续还牵着到反射以及线程调度问题，这里就不展开了。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN_ORDERED:</span><br><span class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中mainThreadPoster是一个Handler。<br>下面是具体的post的流程图<br><img src="/images/eventbus_post.png" alt="eventbus_post"></p>
]]></content>
      <categories>
        <category>源码解析</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>开源框架</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux epoll模型</title>
    <url>/2019/03/03/Linux%20epoll%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>举一个自己熟悉的栗子，读者，写者问题。当缓冲区满时，写者怎么办？缓冲区空的时候咋办尼？嗯~阻塞呀！没那么简单哦</p>
<h2 id="Linux下的I-O"><a href="#Linux下的I-O" class="headerlink" title="Linux下的I/O"></a>Linux下的I/O</h2><p>在Linux下对引言中提出的问题，给出的解决办法是：</p>
<ol>
<li>阻塞：卡顿在那里，等待唤醒，与OS中一致</li>
<li>轮询：不停询问，PV操作实现机制</li>
</ol>
<p>流的概念，一个流可以是文件，socket，pipe等等可以进行I/O操作的内核对象。不管是文件，还是套接字，还是管道，我们都可以把他们看作流。<br>阻塞I/O的缺点。在阻塞I/O模式下，一个线程只能处理一个流的I/O事件。如果想要同时处理多个流，要么多进程(fork)，要么多线程(pthread_create)，很不幸这两种方法效率都不高。<br>那么讨论轮询，<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">true</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i in stream[]; &#123;</span><br><span class="line"><span class="keyword">if</span> i has data</span><br><span class="line">read until unavailable</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们只要不停的把所有流从头到尾问一遍，又从头开始。这样就可以处理多个流了，但这样的做法显然不好，因为如果所有的流都没有数据，那么只会白白浪费CPU。这里要补充一点，阻塞模式下，内核对于I/O事件的处理是阻塞或者唤醒，而非阻塞模式下则把I/O事件交给其他对象（后文介绍的select以及epoll）处理甚至直接忽略。<br>为了避免CPU空转，可以引进了一个代理（select/poll代理）。这个代理比较厉害，可以同时观察许多流的I/O事件，在空闲的时候，会把当前线程阻塞掉，当有一个或多个流有I/O事件时，就从阻塞态中醒来，于是我们的程序就会轮询一遍所有的流（于是我们可以把“忙”字去掉了）。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">true</span> &#123;</span><br><span class="line">select(streams[])</span><br><span class="line"><span class="keyword">for</span> i in streams[] &#123;</span><br><span class="line"><span class="keyword">if</span> i has data</span><br><span class="line">read until unavailable</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果没有I/O事件产生，我们的程序就会阻塞在select处。但是依然有个问题，我们从select那里仅仅知道了，有I/O事件发生了，但却并不知道是那几个流（可能有一个，多个，甚至全部），我们只能无差别轮询所有流，找出能读出数据，或者写入数据的流，对他们进行操作。但是使用select，我们有O(n)的无差别轮询复杂度，同时处理的流越多，每一次无差别轮询时间就越长。</p>
<h2 id="epoll模型"><a href="#epoll模型" class="headerlink" title="epoll模型"></a>epoll模型</h2><p><code>epoll 是一个可扩展的 Linux I/O 事件通知机制。</code>即一种IO多路复用机制，可以同时监控多个描述符，当某个描述符就绪(读或写就绪)，则立刻通知相应程序进行读或写操作，本质同步I/O，即读写是阻塞的</p>
<p>epoll可以理解为event poll，不同于忙轮询和无差别轮询，epoll之会把哪个流发生了怎样的I/O事件通知我们。此时我们对这些流的操作都是有意义的。（复杂度降低到了O(k)）</p>
<p>使用epoll的时候，内核会维护一个就绪的链表，这个链表里面的东西就是”那些发生了I/O事件的流”。而这些文件描述符是如何被添加到就绪链表里面的呢？是通过注册的那些epoll在操作系统内核给IO事件注册回调函数回调函数实现的。epoll这个函数返回的只是那些发生了事件的文件描述符。</p>
<h2 id="Looper"><a href="#Looper" class="headerlink" title="Looper"></a>Looper</h2><p>终极问题：为什么Looper不卡咩？众所周知（我也不知道），app程序入口中为主线程准备好了消息队列，并开启了Looper轮询，而Looper.loop是一个死循环。那MainActivity不就卡了吗~</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</span><br><span class="line">    SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先介绍一些基础知识：<br>进程：每个app运行时前首先创建一个进程，该进程是由Zygote fork出来的，用于承载App上运行的各种Activity/Service等组件。进程对于上层应用来说是完全透明的，这也是google有意为之，让App程序都是运行在Android Runtime。大多数情况一个App就运行在一个进程中，除非在AndroidManifest.xml中配置Android:process属性，或通过native代码fork进程。<br>线程：线程对应用来说非常常见，比如每次new Thread().start都会创建一个新的线程。该线程与App所在进程之间资源共享，从Linux角度来说进程与线程除了是否共享资源外，并没有本质的区别，都是一个task_struct结构体，<code>在CPU看来进程或线程无非就是一段可执行的代码</code>，CPU采用CFS调度算法，保证每个task都尽可能公平的享有CPU时间片。</p>
<h3 id="Android中为什么主线程不会因为Looper-loop-里的死循环卡死？"><a href="#Android中为什么主线程不会因为Looper-loop-里的死循环卡死？" class="headerlink" title="Android中为什么主线程不会因为Looper.loop()里的死循环卡死？"></a>Android中为什么主线程不会因为Looper.loop()里的死循环卡死？</h3><p>答： 主线程因为循环才得以存活，否则执行完一系列初始化语句后，就会径直退出</p>
<p>线程既然是一段可执行的代码，当可执行代码执行完成后，线程生命周期便该终止了，线程退出。而对于主线程，我们是绝不希望会被运行一段时间，自己就退出，那么如何保证能一直存活呢？<code>简单做法就是可执行代码是能一直执行下去的，死循环便能保证不会被退出，</code>例如，binder线程也是采用死循环的方法，通过循环方式不同与Binder驱动进行读写操作，当然并非简单地死循环，无消息时会休眠。但这里可能又引发了另一个问题，<code>既然是死循环又如何去处理其他事务呢？通过创建新线程的方式。</code><br>真正会卡死主线程的操作是在回调方法onCreate/onStart/onResume等操作时间过长，会导致掉帧，甚至发生ANR，looper.loop本身不会导致应用卡死。</p>
<h3 id="哪里有相关代码为这个死循环准备了一个新线程去运转？"><a href="#哪里有相关代码为这个死循环准备了一个新线程去运转？" class="headerlink" title="哪里有相关代码为这个死循环准备了一个新线程去运转？"></a>哪里有相关代码为这个死循环准备了一个新线程去运转？</h3><p>会在进入死循环之前便创建了新binder线程，在代码ActivityThread.main()中：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ....</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建Looper和MessageQueue对象，用于处理主线程的消息</span></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建ActivityThread对象</span></span><br><span class="line">        ActivityThread thread = <span class="keyword">new</span> ActivityThread(); </span><br><span class="line"></span><br><span class="line">        <span class="comment">//建立Binder通道 (创建新线程)</span></span><br><span class="line">        thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        Looper.loop(); <span class="comment">//消息循环运行</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>thread.attach(false)；便会创建一个Binder线程（具体是指ApplicationThread，Binder的服务端，用于接收系统服务AMS发送来的事件），该Binder线程通过Handler将Message发送给主线程    。</strong></p>
<p>ActivityThread实际上并非线程，不像HandlerThread类，ActivityThread并没有真正继承Thread类，只是往往运行在主线程，该人以线程的感觉，其实承载ActivityThread的主线程就是由Zygote fork而创建的进程。</p>
<p><code>主线程的死循环一直运行是不是特别消耗CPU资源呢？</code>其实不然，这里就涉及到<code>Linux pipe/epoll机制</code>，简单说就是在主线程的MessageQueue没有消息时，便阻塞在loop的queue.next()中的nativePollOnce()方法里，此时主线程会释放CPU资源进入休眠状态，直到下个消息到达或者有事务发生，通过往pipe管道写端写入数据来唤醒主线程工作。这里的唤醒机制用的epoll机制，<code>是一种IO多路复用机制，可以同时监控多个描述符，当某个描述符就绪(读或写就绪)，则立刻通知相应程序进行读或写操作，本质同步I/O，即读写是阻塞的。</code> 所以说，主线程大多数时候都是处于休眠状态，并不会消耗大量CPU资源。</p>
<h3 id="Activity的生命周期是怎么实现在死循环体外能够执行起来的"><a href="#Activity的生命周期是怎么实现在死循环体外能够执行起来的" class="headerlink" title="Activity的生命周期是怎么实现在死循环体外能够执行起来的"></a>Activity的生命周期是怎么实现在死循环体外能够执行起来的</h3><p>ActivityThread的内部类H继承于Handler，通过handler消息机制，简单说Handler机制用于同一个进程的线程间通信。</p>
<p><code>Activity的生命周期都是依靠主线程的Looper.loop，当收到不同Message时则采用相应措施：</code>在H.handleMessage(msg)方法中，根据接收到不同的msg，执行相应的生命周期。 </p>
<p>比如收到<code>msg=H.LAUNCH_ACTIVITY</code>，则调用<code>ActivityThread.handleLaunchActivity()</code>方法，最终会通过反射机制，创建Activity实例，然后再执行<code>Activity.onCreate()</code>等方法；    再比如收到<code>msg=H.PAUSE_ACTIVITY</code>，则调用<code>ActivityThread.handlePauseActivity()</code>方法，最终会执行<code>Activity.onPause()</code>等方法。 上述过程，我只挑核心逻辑讲，真正该过程远比这复杂。</p>
<p> <strong>主线程的消息又是哪来的呢</strong> 当然是App进程中的其他线程通过Handler发送给主线程.看下图<br>从进程与线程间通信的角度，通过一张图加深自己对App运行过程的理解：<br><img src="/images/app_run_time.jpg" alt="App_run"></p>
<p><strong>system_server进程是系统进程</strong> ，java framework框架的核心载体，里面运行了大量的系统服务，比如这里提供ApplicationThreadProxy（简称ATP），ActivityManagerService（简称AMS），这个两个服务都运行在system_server进程的不同线程中，由于ATP和AMS都是基于IBinder接口，都是binder线程，binder线程的创建与销毁都是由binder驱动来决定的。</p>
<p><strong>App进程则是我们常说的应用程序</strong> ，主线程主要负责Activity/Service等组件的生命周期以及UI相关操作都运行在这个线程； 另外，每个App进程中至少会有两个binder线程 ApplicationThread(简称AT)和ActivityManagerProxy（简称AMP），除了图中画的线程，其中还有很多线程，比如signal catcher线程等，这里就不一一列举。</p>
<p>Binder用于不同进程之间通信，由一个进程的Binder客户端向另一个进程的服务端发送事务，比如图中线程2向线程4发送事务；而handler用于同一个进程中不同线程的通信，比如图中线程4向主线程发送消息。</p>
<p><strong>结合图说说Activity生命周期，比如暂停Activity，流程如下：</strong> </p>
<ol>
<li>线程1的AMS中调用线程2的ATP；（由于同一个进程的线程间资源共享，可以相互直接调用，但需要注意多线程并发问题）</li>
<li>线程2通过binder传输到App进程的线程4</li>
<li>线程4通过handler消息机制，将暂停Activity的消息发送给主线程；</li>
<li>主线程在looper.loop()中循环遍历消息，当收到暂停Activity的消息时，便将消息分发给ActivityThread.H.handleMessage()方法，再经过方法的调用，最后便会调用到Activity.onPause()，当onPause()处理完后，继续循环loop下去。</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.zhihu.com/question/34652589" target="_blank" rel="noopener">https://www.zhihu.com/question/34652589</a><br><a href="https://www.zhihu.com/search?type=content&amp;q=linux%20epoll" target="_blank" rel="noopener">https://www.zhihu.com/search?type=content&amp;q=linux%20epoll</a></p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android，消息机制</tag>
      </tags>
  </entry>
  <entry>
    <title>Retrofit源码解析</title>
    <url>/2019/03/03/Retrofit%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="简述Retrofit流程"><a href="#简述Retrofit流程" class="headerlink" title="简述Retrofit流程"></a>简述Retrofit流程</h2><p><img src="/images/retrofit_process.png" alt="enter description here"></p>
<ol>
<li>通过注解配置API参数</li>
<li>动态代理生成serviceMethod用以解析接口，生成request，返回Call对象</li>
<li>CallAdapter将Call转化为ExecutorCallbackcall</li>
<li>Converter(解析数据并转换成T)<h2 id="Retrofit的创建"><a href="#Retrofit的创建" class="headerlink" title="Retrofit的创建"></a>Retrofit的创建</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Api</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/api/&#123;user&#125; "</span>)</span><br><span class="line">    <span class="function">Call&lt;Author&gt; <span class="title">getAuthor</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span></span><br><span class="line"><span class="function">	<span class="comment">//Rxjava</span></span></span><br><span class="line"><span class="function">	@<span class="title">GET</span><span class="params">(<span class="string">"/api/&#123;user&#125; "</span>)</span></span></span><br><span class="line"><span class="function">    Observable&lt;Author&gt; <span class="title">getAuthor</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Retrofit retrofit </span>= <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">    .baseUrl(API_URL)</span><br><span class="line">    .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">	.addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>采用了建造者模式和外观模式；<br>外观模式：Retrofit给我们暴露的方法和类不多。核心类就是Retrofit，我们只管配置Retrofit，然后做请求。剩下的事情就跟上层无关了，只需要等待回调。这样大大降低了系统的耦合度。<br>建造者模式：动态添加对象属性，提高代码可读性。<br>进入Build（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>(Platform.get());<span class="comment">//1</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>Platform.get()：根据不同运行平台获取对应线程池<br>进入build()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>) &#123;<span class="comment">//必须指定URL</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base URL required."</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      okhttp3.Call.Factory callFactory = <span class="keyword">this</span>.callFactory;<span class="comment">//this.callFactory是构建时调用callFactory()传入设置的</span></span><br><span class="line">      <span class="keyword">if</span> (callFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        callFactory = <span class="keyword">new</span> OkHttpClient();<span class="comment">//如果没设置callFactory（），自动创建</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;<span class="comment">//callbackExecutor将回调传递到UI线程。</span></span><br><span class="line">      <span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        callbackExecutor = platform.defaultCallbackExecutor();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make a defensive copy of the adapters and add the default Call adapter.</span></span><br><span class="line">      List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);<span class="comment">//adapterFactories存储对Call进行转换的工具如RxJavaCallAdapter,AndroidCallAdapter.</span></span><br><span class="line">      adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));<span class="comment">//获取默认的callBackAdapterFactory</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make a defensive copy of the converters.</span></span><br><span class="line">      List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.converterFactories);<span class="comment">// converterFactories 用于存储转化数据对象的工具如Gson</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</span><br><span class="line">          callbackExecutor, validateEagerly);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">callFactory</span><span class="params">(okhttp3.Call.Factory factory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.callFactory = checkNotNull(factory, <span class="string">"factory == null"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">////获取默认的callBackAdapter</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Android</span> <span class="keyword">extends</span> <span class="title">Platform</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Executor <span class="title">defaultCallbackExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MainThreadExecutor();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span> CallAdapter.<span class="function">Factory <span class="title">defaultCallAdapterFactory</span><span class="params">(Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallAdapterFactory(callbackExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainThreadExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">        handler.post(r);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>  根据传入参数初始化成员变量，值得注意的是获取默认callBackExecutor。其中包含了Handler，用于默认的线程回调。所以onResponse回调在主线程，而okHttp并没有Handler。</p>
<h2 id="Call的创建过程"><a href="#Call的创建过程" class="headerlink" title="Call的创建过程"></a>Call的创建过程</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Api api = retrofit.create(Api<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Call&lt;ZhuanLanAuthor&gt; call = api.getAuthor(<span class="string">"night"</span>);</span><br><span class="line"><span class="comment">// 请求数据，并且处理response</span></span><br><span class="line">call.enqueue(<span class="keyword">new</span> Callback&lt;Author&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response&lt;Author&gt; author)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"name： "</span> + author.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">api.getAuthor(<span class="string">"night"</span>) </span><br><span class="line">			.subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .subscribe(<span class="keyword">new</span> Subscriber&lt;Author&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"Get Top Movie Completed"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">				</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Author author)</span> </span>&#123;</span><br><span class="line">                   <span class="comment">//do something</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>
<p>进入create方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// Single-interface proxy creation guarded by parameter safety.</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</span><br><span class="line">    Utils.validateServiceInterface(service);</span><br><span class="line">    <span class="keyword">if</span> (validateEagerly) &#123;</span><br><span class="line">      eagerlyValidateMethods(service);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</span><br><span class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function">              <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></span><br><span class="line">            <span class="keyword">if</span> (method.getDeclaringClass() == Object<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</span><br><span class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</span><br><span class="line">            &#125;</span><br><span class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod =</span><br><span class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);<span class="comment">//1 ，注意哈</span></span><br><span class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</span><br><span class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);<span class="comment">//2.</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  ServiceMethod&lt;?, ?&gt; loadServiceMethod(Method method) &#123;</span><br><span class="line">    ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(method);<span class="comment">//查询传入的方法是否有缓存。有的话就用缓存ServiceMethod；如果没有就创建一个。这是Retrofit的缓存方法机制</span></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</span><br><span class="line">      result = serviceMethodCache.get(method);</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> ServiceMethod.Builder&lt;&gt;(<span class="keyword">this</span>, method).build();</span><br><span class="line">        serviceMethodCache.put(method, result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>create()返回了一个Proxy.newProxyInstance动态代理对象，那么问题来了…动态代理是个什么东西？看Retrofit代码之前我知道Java动态代理是一个很重要的东西，比如在Spring框架里大量的用到，但是它有什么用呢？Java动态代理就是给了程序员一种可能：当你要调用某个Class的方法前或后，插入你想要执行的代码。比如你要执行某个操作前，你必须要判断这个用户是否登录，或者你在付款前，你需要判断这个人的账户中存在这么多钱。</p>
<h3 id="为何使用动态代理"><a href="#为何使用动态代理" class="headerlink" title="为何使用动态代理"></a>为何使用动态代理</h3><p>获取数据的代码就是这句:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Call&lt;Author&gt; call = api.getAuthor(<span class="string">"night"</span>);</span><br></pre></td></tr></table></figure></p>
<p>上面<code>api</code>对象其实是一个动态代理对象，并不是一个真正的<code>Api</code>接口的implements产生的对象，当<code>api</code>对象调用<code>getAuthor</code>方法时会被动态代理拦截，然后调用<code>Proxy.newProxyInstance</code>方法中的InvocationHandler对象，它的<code>invoke</code>方法会传入3个参数：</p>
<ul>
<li>Object proxy: 代理对象，不关心这个</li>
<li>Method method：调用的方法，就是<code>getAuthor</code>方法</li>
<li>Object… args：方法的参数，就是<code>&quot;night&quot;</code></li>
</ul>
<p>而Retrofit关心的就是method和它的参数args，接下去Retrofit就会用Java反射获取到getAuthor方法的注解信息，配合args参数，创建一个<code>ServiceMethod</code>对象.</p>
<p><code>ServiceMethod</code>就像是一个中央处理器，传入<code>Retrofit</code>对象和<code>Method</code>对象，调用各个接口和解析器，最终生成一个<code>Request</code>，包含api 的域名、path、http请求方法、请求头、是否有body、是否是multipart等等。最后返回一个<code>Call</code>对象，Retrofit2中Call接口的默认实现是OkHttpCall，它默认使用OkHttp3作为底层http请求client</p>
<p>使用Java动态代理的目的就要拦截被调用的Java方法，然后解析这个Java方法的注解，最后生成Request由OkHttp发送. </p>
<h3 id="ServiceMethod"><a href="#ServiceMethod" class="headerlink" title="ServiceMethod"></a>ServiceMethod</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span></span>&#123;</span><br><span class="line">      callAdapter = createCallAdapter();</span><br><span class="line">      responseType = callAdapter.responseType();</span><br><span class="line">      <span class="keyword">if</span> (responseType == Response<span class="class">.<span class="keyword">class</span> || <span class="title">responseType</span> </span>== okhttp3.Response<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">"'"</span></span><br><span class="line">            + Utils.getRawType(responseType).getName()</span><br><span class="line">            + <span class="string">"' is not a valid response body type. Did you mean ResponseBody?"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      responseConverter = createResponseConverter();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</span><br><span class="line">        parseMethodAnnotation(annotation);</span><br><span class="line">      &#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</span><br><span class="line">      parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</span><br><span class="line">        Type parameterType = parameterTypes[p];</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"Parameter type must not include a type variable or wildcard: %s"</span>,</span><br><span class="line">              parameterType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</span><br><span class="line">        <span class="keyword">if</span> (parameterAnnotations == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</span><br><span class="line">      &#125;</span><br><span class="line">  ...</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>重点关注四个成员：callFactory，callAdapter，responseConverter和 parameterHandlers。</p>
<ol>
<li><p><code>callFactory</code> 负责创建 HTTP 请求，HTTP 请求被抽象为了 okhttp3.Call 类，它表示一个已经准备好，可以随时执行的 HTTP 请求；</p>
</li>
<li><p><code>callAdapter</code> 把 retrofit2.Call&lt; T &gt; 转为 T（注意和 okhttp3.Call 区分开来，retrofit2.Call&lt; T &gt; 表示的是对一个 Retrofit 方法的调用），这个过程会发送一个 HTTP 请求，拿到服务器返回的数据（通过 okhttp3.Call 实现），并把数据转换为声明的 T 类型对象（通过 Converter&lt;F, T&gt; 实现）；可设置为 RxJavaCallAdapter</p>
</li>
<li><code>responseConverter</code> 是 Converter&lt; ResponseBody, T &gt; 类型，负责把服务器返回的数据（JSON、XML、二进制或者其他格式，由 ResponseBody 封装）转化为 T 类型的对象；</li>
<li><code>parameterHandlers</code> 则负责解析 API 定义时每个方法的参数，并在构造 HTTP 请求时设置参数；</li>
</ol>
<p><a name="GsonConverterFactory声明处" href="#GsonConverterFactory调用处">GsonConverterFactory声明处</a>，接着回到create中的注释2处</p>
<h3 id="ExecutorCallbackCall"><a href="#ExecutorCallbackCall" class="headerlink" title="ExecutorCallbackCall"></a>ExecutorCallbackCall</h3><p>适配器模式： serviceMethod.callAdapter.adapt(okHttpCall);其中adapter方法会创建ExecutorCallbackCall.。而<code>ExecutorCallbackCall</code> 会将call回调主线程。如果采用的是RxJavaCallAdapter，则不会通过ExecutorCallbackCall进行发送网络请求以及回调主线程。</p>
<p>将传入的 okHttpCall 转换为 ExecutorCallbackCall， 为什么要转换呢？因为要给okHttpCall添加回调主线程功能。普通的OkHttp的Response都是运行在子线程必须要自己设置Handler回调,而ExecutorCallbackCall内置有Handler进行回调，见PlatForm处</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">  <span class="keyword">if</span> (getRawType(returnType) != Call<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> Type responseType = Utils.getCallResponseType(returnType);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> responseType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入ExecutorCallbackCall<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorCallbackCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Executor callbackExecutor;</span><br><span class="line">    <span class="keyword">final</span> Call&lt;T&gt; delegate;</span><br><span class="line"></span><br><span class="line">    ExecutorCallbackCall(Executor callbackExecutor, Call&lt;T&gt; delegate) &#123;</span><br><span class="line">      <span class="keyword">this</span>.callbackExecutor = callbackExecutor;</span><br><span class="line">      <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</span><br><span class="line"></span><br><span class="line">      delegate.enqueue(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Response&lt;T&gt; response)</span> </span>&#123;</span><br><span class="line">          callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (delegate.isCanceled()) &#123;</span><br><span class="line">                <span class="comment">// Emulate OkHttp's behavior of throwing/delivering an IOException on cancellation.</span></span><br><span class="line">                callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                callback.onResponse(ExecutorCallbackCall.<span class="keyword">this</span>, response);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">          callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>装饰者模式：ExecutorCallbackCall 主要是通过前面提及的 <code>callbackExecutor</code>将请求回调到主线程，当我们得到<code>call</code>调用enqueue方法时，实则是在调用<code>ExecutorCallbackCall</code>的enqueue方法。而enqueue中实则是在调用中传入的<code>OkHttpCall(delegate)</code>的enqueue方法。而这个OkHttpCall 是在<code>Retrofit.create</code>中创建的.</p>
<p>ExecutorCallbackCall当作是Wrapper，而真正去执行请求的源Source是OkHttpCall。之所以要有个Wrapper类，是希望在源Source操作时去做一些额外操作。这里的操作就是线程转换，将子线程切换到主线程上去。<br>enqueue()方法是异步的，也就是说，当你调用OkHttpCall的enqueue方法，回调的callback是在子线程中的，如果你希望在主线程接受回调，那需要通过Handler转换到主线程上去。ExecutorCallbackCall就是用来干这个事。当然以上是原生retrofit使用的切换线程方式。如果你用rxjava，那就不会用到这个ExecutorCallbackCall而是RxJava的Call了。最后流程图会有揭示</p>
<p>进入OkHttpCall的enqueue()</p>
<h3 id="OKHttpCall"><a href="#OKHttpCall" class="headerlink" title="OKHttpCall"></a>OKHttpCall</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</span><br><span class="line"></span><br><span class="line">    okhttp3.Call call;</span><br><span class="line">    Throwable failure;</span><br><span class="line">...</span><br><span class="line">    call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;<span class="comment">// 1.  调用OkHttp3类型的call的enqueue方法。</span></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Response&lt;T&gt; response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          response = parseResponse(rawResponse);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">          callFailure(e);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        callSuccess(response);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callFailure</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callSuccess</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          callback.onResponse(OkHttpCall.<span class="keyword">this</span>, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>再进入parseResponse方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ResponseBody rawBody = rawResponse.body();</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">int</span> code = rawResponse.code();</span><br><span class="line">    <span class="keyword">if</span> (code &lt; <span class="number">200</span> || code &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Buffer the entire body to avoid future I/O.</span></span><br><span class="line">        ResponseBody bufferedBody = Utils.buffer(rawBody);</span><br><span class="line">        <span class="keyword">return</span> Response.error(bufferedBody, rawResponse);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        rawBody.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (code == <span class="number">204</span> || code == <span class="number">205</span>) &#123;</span><br><span class="line">      rawBody.close();</span><br><span class="line">      <span class="keyword">return</span> Response.success(<span class="keyword">null</span>, rawResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      T body = serviceMethod.toResponse(catchingBody);</span><br><span class="line">      <span class="keyword">return</span> Response.success(body, rawResponse);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">      <span class="comment">// If the underlying source threw an exception, propagate that rather than indicating it was</span></span><br><span class="line">      <span class="comment">// a runtime exception.</span></span><br><span class="line">      catchingBody.throwIfCaught();</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>根据状态码进行对应操作，成功返回的情况下进入ServiceMethod.toResponse（）<br><a name="GsonConverterFactory调用处" href="#GsonConverterFactory声明处">GsonConverterFactory声明处</a><br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> responseConverter.convert(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过此前提到在ServiceMethod的build()中获得了<code>GsonConverterFactory</code><br>来完成数据转换。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/images/retrofit_stay.png" alt="design_pattern"></p>
]]></content>
      <categories>
        <category>源码解析</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>开源框架</tag>
      </tags>
  </entry>
  <entry>
    <title>数组中的逆序对</title>
    <url>/2019/03/02/%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%80%86%E5%BA%8F%E5%AF%B9/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="在数组中的两个数字，如果前面一个数字大于后面的数字，则这两个数字组成一个逆序对。输入一个数组-求出这个数组中的逆序对的总数P。并将P对1000000007取模的结果输出。-即输出P-1000000007"><a href="#在数组中的两个数字，如果前面一个数字大于后面的数字，则这两个数字组成一个逆序对。输入一个数组-求出这个数组中的逆序对的总数P。并将P对1000000007取模的结果输出。-即输出P-1000000007" class="headerlink" title="在数组中的两个数字，如果前面一个数字大于后面的数字，则这两个数字组成一个逆序对。输入一个数组,求出这个数组中的逆序对的总数P。并将P对1000000007取模的结果输出。 即输出P%1000000007"></a>在数组中的两个数字，如果前面一个数字大于后面的数字，则这两个数字组成一个逆序对。输入一个数组,求出这个数组中的逆序对的总数P。并将P对1000000007取模的结果输出。 即输出P%1000000007</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">0</span></span><br><span class="line">Output: <span class="number">7</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="number">7</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">4</span></span><br><span class="line">Output: <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>完全没有思路，汗~<br>分治呀，分治呀，小伙计。<br><img src="/images/merge_sort.png" alt="merge_sort"><br>把数组分解为两个子数组，递归直至数组被拆分成两个为1的子数组。合并子数组同时统计逆序对。统计后需要将统计后的数组排序，防止统计重复。<br>嗨呀！这不就是归并大兄弟嘛，先求出左边已排好序的逆序数，再求出右边已排好序的逆序数，最后合并时求左右两组中的逆序数。<br>合并时需要注意归并排序的特征，在统计逆序数时，前面数组array[i] &gt; 后面数组的array[j]时，那么因为左右两边均是有序数组。那么mid~j处的右侧数组数据必然都小于i。所以count += j - mid;<br>最后天杀的牛客哟，竟然数据会溢出，你放个Int返回值干啥</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">InversePairs</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array == <span class="keyword">null</span> || array.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] copy = <span class="keyword">new</span> <span class="keyword">int</span>[array.length];</span><br><span class="line">    <span class="keyword">return</span> mergeSort(array, copy, <span class="number">0</span>, array.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">mergeSort</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span>[] copy, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (low &lt; high) &#123;</span><br><span class="line">        <span class="keyword">int</span> length = (high - low) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> left = mergeSort(array, copy, low, low + length) % <span class="number">1000000007</span>;</span><br><span class="line">        <span class="keyword">int</span> right = mergeSort(array, copy, low + length + <span class="number">1</span>, high) % <span class="number">1000000007</span>;</span><br><span class="line">        <span class="keyword">int</span> mid = merge(array, copy, low, low + length, high) % <span class="number">1000000007</span>;</span><br><span class="line">        <span class="keyword">return</span> (left + right + mid) % <span class="number">1000000007</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span>[] copy, <span class="keyword">int</span> low, <span class="keyword">int</span> mid, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = low; i &lt;= high; i++) &#123;</span><br><span class="line">        copy[i] = array[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = mid, j = high, k = high;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &gt;= low &amp;&amp; j &gt; mid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy[i] &gt; copy[j]) &#123;</span><br><span class="line">            array[k--] = copy[i--];</span><br><span class="line">            count += j - mid;</span><br><span class="line">            <span class="keyword">if</span> (count &gt;= <span class="number">1000000007</span>)<span class="comment">//数值过大求余</span></span><br><span class="line">            &#123;</span><br><span class="line">                count %= <span class="number">1000000007</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            array[k--] = copy[j--];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i &gt;= low) &#123;</span><br><span class="line">        array[k--] = copy[i--];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (j &gt; mid) &#123;</span><br><span class="line">        array[k--] = copy[j--];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>ConcurrentHashMap源码简析</title>
    <url>/2019/03/01/ConcurrentHashMap%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/</url>
    <content><![CDATA[<p>本文转自<a href="https://www.bookstack.cn/read/android_interview/java-concurrence-ConcurrentHashMap.md" target="_blank" rel="noopener">ConcurrentHashMap</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>HashMap是我们平时开发过程中用的比较多的集合，但它是非线程安全的，在涉及到多线程并发的情况，进行put操作有可能会引起死循环，导致CPU利用率接近100%。<br>解决方案有Hashtable和Collections.synchronizedMap(hashMap)，不过这两个方案基本上是对读写进行加锁操作，一个线程在读写元素，其余线程必须等待，性能可想而知。所以ConcurrentHashMap应运而生</p>
<p>因为ConCurrentHashMap在JDK1.8后有较大改进。故分层次讨论</p>
<h2 id="JDK-1-6分析"><a href="#JDK-1-6分析" class="headerlink" title="JDK 1.6分析"></a>JDK 1.6分析</h2><p>ConcurrentHashMap采用 分段锁的机制，实现并发的更新操作，底层采用数组+链表+红黑树的存储结构。<br>其包含两个核心静态内部类 Segment和HashEntry。</p>
<ol>
<li>Segment继承ReentrantLock用来充当锁的角色，每个 Segment 对象守护每个散列映射表的若干个桶。</li>
<li>HashEntry 用来封装映射表的键 / 值对；</li>
<li>每个桶是由若干个 HashEntry 对象链接起来的链表。</li>
</ol>
<p>一个 ConcurrentHashMap 实例中包含由若干个 Segment 对象组成的数组，下面我们通过一个图来演示一下 ConcurrentHashMap 的结构：<br><img src="/images/jdk_6_concurrent_hashmap.PNG" alt="enter description here"></p>
<h2 id="JDK1-8分析"><a href="#JDK1-8分析" class="headerlink" title="JDK1.8分析"></a>JDK1.8分析</h2><p>1.8的实现已经抛弃了Segment分段锁机制，利用CAS+Synchronized来保证并发更新的安全，底层依然采用数组+链表+红黑树的存储结构。</p>
<p><img src="/images/jdk_8_concurrent_hashmap.PNG" alt="enter description here"></p>
<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><p>在开始之前，有些重要的概念需要介绍一下：</p>
<ol>
<li><p>table：volatile修饰，默认为null，初始化发生在第一次插入操作，默认大小为16的数组，用来存储Node节点数据，扩容时大小总是2的幂次方。</p>
</li>
<li><p>nextTable：volatile修饰，默认为null，扩容时新生成的数组，其大小为原数组的两倍。</p>
</li>
<li><p>sizeCtl：volatile修饰，默认为0，用来控制table的初始化和扩容操作，具体应用在后续会体现出来。<br>-1 代表table正在初始化<br>-N 表示有N-1个线程正在进行扩容操作</p>
</li>
<li><p>其余情况：<br>1、如果table未初始化，表示table需要初始化的大小。<br>2、如果table初始化完成，表示table的容量，默认是table大小的0.75倍，居然用这个公式算0.75（n - (n &gt;&gt;&gt; 2)）。</p>
</li>
<li><p>Node：保存key，value及key的hash值的数据结构。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">  <span class="keyword">final</span> K key;</span><br><span class="line">  <span class="keyword">volatile</span> V val;</span><br><span class="line">  <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line">  ... 省略部分代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>其中value和next都用volatile修饰，保证并发的可见性。</p>
<ol start="6">
<li>ForwardingNode：一个特殊的Node节点，hash值为-1，其中存储nextTable的引用。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">  ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">      <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>只有table发生扩容的时候，ForwardingNode才会发挥作用，作为一个占位符放在table中表示当前节点为null或则已经被移动。</p>
<h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><p>实例化ConcurrentHashMap时带参数时，如同HashMap一半，会根据参数调整table的大小，假设参数为100，最终会调整成256，确保table的大小总是2的幂次方。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ConcurrentHashMap&lt;String, String&gt; hashMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">100</span>);</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意，ConcurrentHashMap在构造函数中只会初始化sizeCtl值，并不会直接初始化table，而是延缓到第一次put操作。</p>
<h3 id="table初始化"><a href="#table初始化" class="headerlink" title="table初始化"></a>table初始化</h3><p>前面已经提到过，table初始化操作会延缓到第一次put行为。但是put是可以并发执行的，Doug Lea是如何实现table只初始化一次的？让我们来看看源码的实现。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//如果一个线程发现sizeCtl&lt;0，意味着另外的线程执行CAS操作成功，当前线程只需要让出cpu时间片</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>) </span><br><span class="line">            Thread.yield(); <span class="comment">//让出CPU时间片</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>sizeCtl默认为0，如果ConcurrentHashMap实例化时有传参数，sizeCtl会是一个2的幂次方的值。所以执行第一次put操作的线程会执行Unsafe.compareAndSwapInt方法修改sizeCtl为-1，有且只有一个线程能够修改成功，其它线程通过Thread.yield()让出CPU时间片等待table初始化完成。</p>
<h3 id="put"><a href="#put" class="headerlink" title="put"></a>put</h3><p>假设table已经初始化完成，put操作采用CAS+synchronized实现并发插入或更新操作，具体实现如下<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();<span class="comment">//初始化table</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        ...省略部分代码</span><br><span class="line">    &#125;</span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>hash算法:static final int spread(int h) {return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;}</li>
<li>table中定位索引位置，n是table的大小:  int index = (n - 1) &amp; hash</li>
<li>获取table中对应索引的元素f。Doug Lea采用Unsafe.getObjectVolatile来获取，也许有人质疑，直接table[index]不可以么，为什么要这么复杂？在java内存模型中，我们已经知道每个线程都有一个工作内存，里面存储着table的副本，虽然table是volatile修饰的，但不能保证线程每次都拿到table中的最新元素，Unsafe.getObjectVolatile可以直接获取指定内存的数据，保证了每次拿到数据都是最新的。</li>
<li>如果f为null，说明table中这个位置第一次插入元素，利用Unsafe.compareAndSwapObject方法插入Node节点。</li>
</ol>
<ul>
<li>如果CAS成功，说明Node节点已经插入，随后addCount(1L, binCount)方法会检查当前容量是否需要进行扩容。</li>
<li>如果CAS失败，说明有其它线程提前插入了节点，自旋重新尝试在这个位置插入节点。</li>
</ul>
<p>5.如果f的hash值为-1，说明当前f是ForwardingNode节点，意味有其它线程正在扩容，则一起进行扩容操作。<br>6.其余情况把新的Node节点按链表或红黑树的方式插入到合适的位置，这个过程采用同步内置锁synchronized实现并发，代码如下:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line"> <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">     <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">         binCount = <span class="number">1</span>;</span><br><span class="line">         <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">             K ek;</span><br><span class="line">             <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                 ((ek = e.key) == key ||</span><br><span class="line">                  (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                 oldVal = e.val;</span><br><span class="line">                 <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                     e.val = value;</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             Node&lt;K,V&gt; pred = e;</span><br><span class="line">             <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                           value, <span class="keyword">null</span>);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">         Node&lt;K,V&gt; p;</span><br><span class="line">         binCount = <span class="number">2</span>;</span><br><span class="line">         <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                        value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             oldVal = p.val;</span><br><span class="line">             <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                 p.val = value;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">         addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">		 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>在节点f上进行同步，节点插入之前，再次利用tabAt(tab, i) == f判断，防止被其它线程修改。</li>
<li>与HashMap类似，如果f.hash &gt;= 0，说明f是链表结构的头结点，遍历链表，如果找到对应的node节点，则修改value，否则在链表尾部加入节点。如果f是TreeBin类型节点，说明f是红黑树根节点，则在树结构上遍历元素，更新或增加节点。如果链表中节点数binCount &gt;= TREEIFY_THRESHOLD(默认是8)，则把链表转化为红黑树结构。</li>
</ol>
<p>在putval（）最后检测是否需要扩容</p>
<h3 id="table-扩容"><a href="#table-扩容" class="headerlink" title="table 扩容"></a>table 扩容</h3><p>当table容量不足的时候，即table的元素数量达到容量阈值sizeCtl，需要对table进行扩容。<br>整个扩容分为两部分：</p>
<p>1 构建一个nextTable，大小为table的两倍。</p>
<ol start="2">
<li>把table的数据复制到nextTable中。<br>这两个过程在单线程下实现很简单，但是ConcurrentHashMap是支持并发插入的，扩容操作自然也会有并发的出现，这种情况下，第二步可以支持节点的并发复制，这样性能自然提升不少，但实现的复杂度也上升了一个台阶。</li>
</ol>
<p>先看第一步，构建nextTable，毫无疑问，这个过程只能只有单个线程进行nextTable的初始化，具体实现如下：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">    ... 省略部分代码</span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过Unsafe.compareAndSwapInt修改sizeCtl值，保证只有一个线程能够初始化nextTable，扩容后的数组长度为原来的两倍，但是容量是原来的1.5</p>
<p>节点从table移动到nextTable，大体思想是遍历、复制的过程。</p>
<ol>
<li>首先根据运算得到需要遍历的次数i，然后利用tabAt方法获得i位置的元素f，初始化一个forwardNode实例fwd。</li>
<li>如果f == null，则在table中的i位置放入fwd，这个过程是采用Unsafe.compareAndSwapObjectf方法实现的，很巧妙的实现了节点的并发移动。</li>
<li>否则采用同步内置锁synchronized实现并发</li>
</ol>
<ul>
<li>如果f是链表的头节点，就构造一个反序链表，把他们分别放在nextTable的i和i+n的位置上，移动完成，采用Unsafe.putObjectVolatile方法给table原位置赋值fwd</li>
<li>如果f是TreeBin节点，也做一个反序处理，并判断是否需要untreeify，把处理的结果分别放在nextTable的i和i+n的位置上，移动完成，同样采用Unsafe.putObjectVolatile方法给table原位置赋值fwd</li>
</ul>
<ol start="4">
<li>遍历过所有的节点以后就完成了复制工作，把table指向nextTable，并更新sizeCtl为新数组大小的0.75倍 ，扩容完成</li>
</ol>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">    <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>判断table是否为空，如果为空，直接返回null</li>
<li>计算key的hash值，并获取指定table中指定位置的Node节点，通过遍历链表或则树结构找到对应的节点，返回value值</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ConcurrentHashMap 是一个并发散列映射表的实现，它允许完全并发的读取，并且支持给定数量的并发更新。相比于 HashTable 和同步包装器包装的 HashMap，使用一个全局的锁来同步不同线程间的并发访问，同一时间点，只能有一个线程持有锁，也就是说在同一时间点，只能有一个线程能访问容器，这虽然保证多线程间的安全并发访问，但同时也导致对容器的访问变成串行化的了</p>
]]></content>
      <categories>
        <category>Java源码</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>源码解析</tag>
      </tags>
  </entry>
  <entry>
    <title>Rxjava订阅解析</title>
    <url>/2019/03/01/Rxjava%E8%AE%A2%E9%98%85%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>转自piasy兄的<a href="https://blog.piasy.com/2016/09/15/Understand-RxJava/index.html" target="_blank" rel="noopener">拆RxJava</a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>顺着常用的场景/用例出发，理解整个过程、结构、原理，不要沉迷于细节，先对常用的内容有一个全局的概览，每一块的细节再按需深入。入手新项目也是这个思路。</p>
</blockquote>
<p>从四个方面分析Rxjava</p>
<ul>
<li>事件流源头（observable）怎么发出数据</li>
<li>响应者（subscriber）怎么收到数据</li>
<li>怎么对事件流进行操作（operator/transformer）</li>
<li>以及整个过程的调度（scheduler）</li>
</ul>
<p>以及一些新鲜的词语如</p>
<ul>
<li>backpressure</li>
<li>hook</li>
</ul>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Observable.just(<span class="string">"Hello world"</span>)</span><br><span class="line">        .subscribe(word -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"got "</span> + word + <span class="string">" @ "</span> </span><br><span class="line">                    + Thread.currentThread().getName());</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="订阅过程"><a href="#订阅过程" class="headerlink" title="订阅过程"></a>订阅过程</h2><h3 id="just"><a href="#just" class="headerlink" title="just"></a>just</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// Observable.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">just</span><span class="params">(<span class="keyword">final</span> T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ScalarSynchronousObservable.create(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScalarSynchronousObservable.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ScalarSynchronousObservable&lt;T&gt; <span class="title">create</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ScalarSynchronousObservable&lt;T&gt;(t);           <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ScalarSynchronousObservable</span><span class="params">(<span class="keyword">final</span> T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(RxJavaHooks.onCreate(<span class="keyword">new</span> JustOnSubscribe&lt;T&gt;(t))); <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">this</span>.t = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>我们创建的是 <code>ScalarSynchronousObservable</code>，一个 <code>Observable</code> 的子类。</li>
<li>我们先跳过 <code>RxJavaHooks</code>，从名字可以得知它是用来做一些 hook 的工作的，那我们就先认为它什么也不做。所以我们传给父类构造函数的就是 <code>JustOnSubscribe</code>，一个 <code>OnSubscribe</code> 的实现类。</li>
</ol>
<p><code>Observable</code> 的构造函数接受一个 <code>OnSubscribe</code>，它是一个回调，会在 <code>Observable#subscribe</code> 中使用，用于通知 <code>observable</code> 自己被订阅, 进入<code>subscribe</code>方法</p>
<h3 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe"></a>subscribe</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Subscription <span class="title">subscribe</span><span class="params">(<span class="keyword">final</span> Action1&lt;? <span class="keyword">super</span> T&gt; onNext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 省略参数检查代码</span></span><br><span class="line">    Action1&lt;Throwable&gt; onError = </span><br><span class="line">        InternalObservableUtils.ERROR_NOT_IMPLEMENTED;</span><br><span class="line">    Action0 onCompleted = Actions.empty();</span><br><span class="line">    <span class="keyword">return</span> subscribe(<span class="keyword">new</span> ActionSubscriber&lt;T&gt;(onNext, </span><br><span class="line">        onError, onCompleted));                             <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Subscription <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.subscribe(subscriber, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &lt;T&gt; <span class="function">Subscription <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber, </span></span></span><br><span class="line"><span class="function"><span class="params">      Observable&lt;T&gt; observable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 省略参数检查代码</span></span><br><span class="line">    subscriber.onStart();                                   <span class="comment">// 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!(subscriber <span class="keyword">instanceof</span> SafeSubscriber)) &#123;</span><br><span class="line">        subscriber = <span class="keyword">new</span> SafeSubscriber&lt;T&gt;(subscriber);     <span class="comment">// 3</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        RxJavaHooks.onObservableStart(observable, </span><br><span class="line">            observable.onSubscribe).call(subscriber);       <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">return</span> RxJavaHooks.onObservableReturn(subscriber);  <span class="comment">// 5</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// 省略错误处理代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<ol>
<li>我们首先对传入的 Action 进行包装，包装为 <code>ActionSubscriber</code>，一个 <code>Subscriber</code> 的实现类。</li>
<li>调用 <code>subscriber.onStart()</code> 通知 <code>subscriber</code> 它已经和 <code>observable</code> 连接起来了。这里我们就知道，<code>onStart()</code> 就是在我们调用 <code>subscribe()</code> 的线程执行的。</li>
<li>如果传入的 <code>subscriber</code> 不是 <code>SafeSubscriber</code>，那就把它包装为一个 <code>SafeSubscriber</code>。</li>
<li>我们再次跳过<code>hook</code>，认为它什么也没做，那这里我们调用的其实就是 <code>observable.onSubscribe.call(subscriber)</code>。这里我们就看到了前面提到的 <code>onSubscribe</code> 的使用代码，在我们调用 <code>subscribe()</code> 的线程执行这个回调。</li>
<li>跳过 <code>hook</code>，那么这里就是直接返回了 <code>subscriber</code>。<code>Subscriber</code> 继承了 <code>Subscription</code>，用于取消订阅。</li>
</ol>
<p>但是 Hello world 是怎么被传递到打印的代码里的呢？就在 observable.onSubscribe.call(subscriber) 中。</p>
<h3 id="OnSubscribe"><a href="#OnSubscribe" class="headerlink" title="OnSubscribe"></a>OnSubscribe</h3><p>在just() 的实现中，我们创建了一个 <code>JustOnSubscribe</code> 吗？这里我们执行的就是它实现的 <code>call()</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ScalarSynchronousObservable.java</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JustOnSubscribe</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        s.setProducer(createProducer(s, value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &lt;T&gt; <span class="function">Producer <span class="title">createProducer</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; s, T v)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WeakSingleProducer&lt;T&gt;(s, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为 <code>subscriber</code> 设置了一个 <code>WeakSingleProducer</code>。</p>
<p>在 RxJava 1.x 中，数据都是从 observable push 到 subscriber 的，但要是 observable 发得太快，subscriber 处理不过来，该怎么办？一种办法是，把数据保存起来，但这显然可能导致内存耗尽；另一种办法是，多余的数据来了之后就丢掉，至于丢掉和保留的策略可以按需制定；还有一种办法就是让 subscriber 向 observable 主动请求数据，subscriber 不请求，observable 就不发出数据。它俩相互协调，避免出现过多的数据，而协调的桥梁，就是 producer。producer 的内容这里不展开。</p>
<h3 id="request"><a href="#request" class="headerlink" title="request"></a>request</h3><p>进入 WeakSingleProducer#request() 的实现：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ScalarSynchronousObservable.java</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakSingleProducer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 省略状态检查代码</span></span><br><span class="line">        Subscriber&lt;? <span class="keyword">super</span> T&gt; a = actual;</span><br><span class="line">        <span class="keyword">if</span> (a.isUnsubscribed()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        T v = value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            a.onNext(v);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            Exceptions.throwOrReport(e, a, v);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a.isUnsubscribed()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        a.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 request() 中，终于调用了 subscriber 的 onNext() 和 onCompleted()，那么，Hello world 就传递到了我们的 Action 中，并被打印出来了。</p>
<h3 id="完整过程"><a href="#完整过程" class="headerlink" title="完整过程"></a>完整过程</h3><p><img src="/images/RxJava_call_stack_just.png" alt="rxjava_call_stack"></p>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><p>以map为例<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Observable.just(<span class="string">"Hello world"</span>)</span><br><span class="line">        .map(String::length)</span><br><span class="line">        .subscribe(word -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"got "</span> + word + <span class="string">" @ "</span></span><br><span class="line">                    + Thread.currentThread().getName());</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<p>进入map方法</p>
<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Observable.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">map</span><span class="params">(Func1&lt;? <span class="keyword">super</span> T, ? extends R&gt; func)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> OnSubscribeMap&lt;T, R&gt;(<span class="keyword">this</span>, func));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observable&lt;T&gt;(RxJavaHooks.onCreate(f));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <code>map</code> 的实现采用了 <code>create + OnSubscribe（RxJava #4097）</code>；<br>这里实际上是 <code>OnSubscribeMap</code> 干活了。</p>
<h3 id="OnSubscribeMap"><a href="#OnSubscribeMap" class="headerlink" title="OnSubscribeMap"></a>OnSubscribeMap</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSubscribeMap</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Observable&lt;T&gt; source;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> Func1&lt;? <span class="keyword">super</span> T, ? extends R&gt; transformer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnSubscribeMap</span><span class="params">(Observable&lt;T&gt; source, </span></span></span><br><span class="line"><span class="function"><span class="params">            Func1&lt;? <span class="keyword">super</span> T, ? extends R&gt; transformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> R&gt; o)</span> </span>&#123;</span><br><span class="line">        MapSubscriber&lt;T, R&gt; parent = </span><br><span class="line">            <span class="keyword">new</span> MapSubscriber&lt;T, R&gt;(o, transformer);   <span class="comment">// 1</span></span><br><span class="line">        o.add(parent);                                 <span class="comment">// 2</span></span><br><span class="line">        source.unsafeSubscribe(parent);                <span class="comment">// 3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>利用传入的 subscriber 以及我们进行转换的 Func1 构造一个 MapSubscriber。</li>
<li>把一个 subscriber 加入到另一个 subscriber 中，是为了让它们可以一起取消订阅。</li>
<li>unsafeSubscribe 相较于前面的 subscribe，可想而知就是少了一层 SafeSubscriber 的包装。为什么不要包装？因为我们会在最后调用 Observable#subscribe 时进行包装，只需要包装一次即可。</li>
</ol>
<p>转换的代码依然没有出现，它在 MapSubscriber 中。</p>
<h3 id="MapSubscriber"><a href="#MapSubscriber" class="headerlink" title="MapSubscriber"></a>MapSubscriber</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapSubscriber</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> R&gt; actual;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> Func1&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> done;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapSubscriber</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> R&gt; actual, </span></span></span><br><span class="line"><span class="function"><span class="params">            Func1&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.actual = actual;</span><br><span class="line">        <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        R result;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = mapper.call(t);        <span class="comment">// 1</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(ex);</span><br><span class="line">            unsubscribe();</span><br><span class="line">            onError(OnErrorThrowable.addValueAsLastCause(ex, t));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        actual.onNext(result);              <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略 onError，onCompleted 和 setProducer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MapSubscriber 依然很直观：</p>
<ol>
<li>上游每新来一个数据，就用我们给的 <code>mapper</code> 进行数据转换。</li>
<li>再把转换之后的数据发送给下游。<br>这里要解释一下“上游”和“下游”的概念：按照我们写的代码顺序，just 在 map 的上面，Action1 在 map 的下面，数据从 just 传递到 map 再传递到 Action1，所以对于 map 来说，just 就是上游，Action1 就是下游。数据是从上游（Observable）一路传递到下游（Subscriber）的，<code>请求则相反，从下游传递到上游。</code></li>
</ol>
<h3 id="完整过程-1"><a href="#完整过程-1" class="headerlink" title="完整过程"></a>完整过程</h3><p><img src="/images/RxJava_call_stack_just_map.png" alt="enter description here"></p>
<h2 id="线程调度"><a href="#线程调度" class="headerlink" title="线程调度"></a>线程调度</h2><p>我们所有的过程都是通过函数调用完成的，都在 <code>subscribe</code> 所在的线程执行。<code>RxJava</code> 进行异步非常简单，只需要使用 <code>subscribeOn</code> 和 <code>observeOn</code> 这两个操作符即可。既然它俩都是操作符，那流程上就是和 <code>map</code> 差不多的，这里我们主要关注线程调度的实现原理。<br>demo:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Observable.just(<span class="string">"Hello world"</span>)</span><br><span class="line">        .map(String::length)</span><br><span class="line">        .subscribeOn(Schedulers.computation())</span><br><span class="line">        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .subscribe(len -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"got "</span> + len + <span class="string">" @ "</span> </span><br><span class="line">                    + Thread.currentThread().getName());</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="subscribeOn"><a href="#subscribeOn" class="headerlink" title="subscribeOn"></a>subscribeOn</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">subscribeOn</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">instanceof</span> ScalarSynchronousObservable) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ScalarSynchronousObservable&lt;T&gt;)<span class="keyword">this</span>)</span><br><span class="line">                .scalarScheduleOn(scheduler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> OperatorSubscribeOn&lt;T&gt;(<span class="keyword">this</span>, scheduler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还记得上面的 just 吗？它创建的就是 <code>ScalarSynchronousObservable</code>，但是这个特殊情况我们先跳过，我们看普通的情况：通过 <code>create + OperatorSubscribeOn</code> 实现。</p>
<h3 id="OperatorSubscribeOn"><a href="#OperatorSubscribeOn" class="headerlink" title="OperatorSubscribeOn"></a>OperatorSubscribeOn</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorSubscribeOn</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> Observable&lt;T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OperatorSubscribeOn</span><span class="params">(Observable&lt;T&gt; source, Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Worker inner = scheduler.createWorker();</span><br><span class="line">        subscriber.add(inner); <span class="comment">//  1</span></span><br><span class="line"></span><br><span class="line">        inner.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> Thread t = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">                Subscriber&lt;T&gt; s = <span class="keyword">new</span> Subscriber&lt;T&gt;(subscriber) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">                        subscriber.onNext(t); <span class="comment">// 2</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            subscriber.onError(e);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            inner.unsubscribe();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            subscriber.onCompleted();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            inner.unsubscribe();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(<span class="keyword">final</span> Producer p)</span> </span>&#123;</span><br><span class="line">                        subscriber.setProducer(<span class="keyword">new</span> Producer() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (t == Thread.currentThread()) &#123;</span><br><span class="line">                                    p.request(n);<span class="comment">// 3</span></span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    inner.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">                                        <span class="meta">@Override</span></span><br><span class="line">                                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                            p.request(n);<span class="comment">// 4</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                source.unsafeSubscribe(s);<span class="comment">// 5</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>Worker</code> 也实现了 <code>Subscription</code>，所以可以加入到 <code>Subscriber</code> 中，用于集体取消订阅。</li>
<li>在匿名 <code>Subscriber</code> 中，收到上游的数据后，转发给下游。</li>
<li><code>Producer#request</code> 被调用时，如果调用线程就是 <code>worker</code> 的线程（t），就直接把请求转发给上游。</li>
<li>否则还需要进行一次调度，确保调用上游的 <code>request</code> 一定是在 <code>worker</code> 的线程。</li>
<li>在 <code>worker</code> 线程中，把自己（匿名 <code>Subscriber</code>）和上游连接起来。</li>
</ol>
<p>连接上游（可能会触发请求）、向上游发请求，都是在 worker 的线程上执行的，所以如果上游处理请求的代码没有进行异步操作，那上游的代码就是在 subscribeOn 指定的线程上执行的。这就解释了网上随处可见的一个结论：</p>
<blockquote>
<p>subscribeOn 影响它上面的调用执行时所在的线程。</p>
</blockquote>
<p>但如果仅仅是记住这么一句话，情况稍微一复杂，就必然蒙圈，所以一定要理解它的工作原理。</p>
<p>另外关于使用多次调用 subscribeOn 的效果，我们这里也就很清楚了，后面的 subscribeOn 只会改变前面的 subscribeOn 调度操作所在的线程，并不能改变最终被调度的代码执行的线程，但对于中途的代码执行的线程，还是会影响到的。</p>
<p>在上面的代码中，收到上游发来的数据之后，我们直接发给了下游，并没有进行线程切换，所以 <code>subscribeOn</code> 并不会改变数据向下游传递时的线程，这一工作由它的搭档 <code>observeOn</code> 完成。</p>
<h3 id="observeOn"><a href="#observeOn" class="headerlink" title="observeOn"></a>observeOn</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">observeOn</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> observeOn(scheduler, RxRingBuffer.SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">observeOn</span><span class="params">(Scheduler scheduler, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> bufferSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> observeOn(scheduler, <span class="keyword">false</span>, bufferSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">observeOn</span><span class="params">(Scheduler scheduler, </span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> delayError, <span class="keyword">int</span> bufferSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">instanceof</span> ScalarSynchronousObservable) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ScalarSynchronousObservable&lt;T&gt;)<span class="keyword">this</span>)</span><br><span class="line">            .scalarScheduleOn(scheduler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lift(<span class="keyword">new</span> OperatorObserveOn&lt;T&gt;(scheduler, </span><br><span class="line">        delayError, bufferSize));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">lift</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> OnSubscribeLift&lt;T, R&gt;(onSubscribe, </span><br><span class="line">        operator));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关注 lift + operator 实现的情况。进入onSubscribeLift</p>
<h3 id="OnSubscribeLift"><a href="#OnSubscribeLift" class="headerlink" title="OnSubscribeLift"></a>OnSubscribeLift</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSubscribeLift</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">OnSubscribe</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> OnSubscribe&lt;T&gt; parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnSubscribeLift</span><span class="params">(OnSubscribe&lt;T&gt; parent, </span></span></span><br><span class="line"><span class="function"><span class="params">          Operator&lt;? extends R, ? <span class="keyword">super</span> T&gt; operator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        <span class="keyword">this</span>.operator = operator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> R&gt; o)</span> </span>&#123;</span><br><span class="line">        Subscriber&lt;? <span class="keyword">super</span> T&gt; st = RxJavaHooks</span><br><span class="line">            .onObservableLift(operator).call(o);</span><br><span class="line">        st.onStart();</span><br><span class="line">        parent.call(st);</span><br><span class="line">        <span class="comment">// 省略了异常处理代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先对下游 <code>subscriber</code> 用操作符进行处理（跳过 hook），然后通知处理后的 <code>subscriber</code>，它将要和 <code>observable</code> 连接起来了，最后把它和上游连接起来。</p>
<p>这里并没有线程调度的逻辑，所以我们看 <code>OperatorObserveOn。</code></p>
<h3 id="OperatorObserveOn"><a href="#OperatorObserveOn" class="headerlink" title="OperatorObserveOn"></a>OperatorObserveOn</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorObserveOn</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Operator</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; call(Subscriber&lt;? <span class="keyword">super</span> T&gt; child) &#123;</span><br><span class="line">        <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> ImmediateScheduler) &#123;</span><br><span class="line">            <span class="comment">// avoid overhead, execute directly</span></span><br><span class="line">            <span class="keyword">return</span> child;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> TrampolineScheduler) &#123;</span><br><span class="line">            <span class="comment">// avoid overhead, execute directly</span></span><br><span class="line">            <span class="keyword">return</span> child;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ObserveOnSubscriber&lt;T&gt; parent = <span class="keyword">new</span> ObserveOnSubscriber&lt;T&gt;(</span><br><span class="line">                scheduler, child, delayError, bufferSize);</span><br><span class="line">            parent.init();</span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 <code>scheduler</code> 是 ImmediateScheduler/TrampolineScheduler，就什么也不做，否则就把 subscriber 包装为 <code>ObserveOnSubscriber</code>，看来脏活累活都是 ObserveOnSubscriber 干的了。</p>
<h3 id="ObserveOnSubscriber"><a href="#ObserveOnSubscriber" class="headerlink" title="ObserveOnSubscriber"></a>ObserveOnSubscriber</h3><p><code>ObserveOnSubscriber</code> 除了负责把向下游发送数据的操作调度到指定的线程，还负责 <code>backpressure</code> 支持，这导致它的实现比较复杂，所以这里只展示和分析最简单的调度功能。完整代码的分析大家可以自行阅读源码，其中还会涉及到串行访问相关的内容<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Observable.create(subscriber -&gt; &#123;</span><br><span class="line">    Worker worker = scheduler.createWorker();</span><br><span class="line">    subscriber.add(worker);</span><br><span class="line"> </span><br><span class="line">    source.unsafeSubscribe(<span class="keyword">new</span> Subscriber&lt;T&gt;(subscriber) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            worker.schedule(() -&gt; subscriber.onNext(t));</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            worker.schedule(() -&gt; subscriber.onError(e));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            worker.schedule(() -&gt; subscriber.onCompleted());</span><br><span class="line">        &#125;            </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><code>observeOn</code> 调度了每个单独的 <code>subscriber.onXXX()</code> 调用，使得数据向下游传递的时候可以切换到指定的线程。这也同样解释了网上随处可见的另一个结论</p>
<blockquote>
<p>observeOn 影响它下面的调用执行时所在的线程。</p>
</blockquote>
<h3 id="完整过程-2"><a href="#完整过程-2" class="headerlink" title="完整过程"></a>完整过程</h3><p><img src="/images/RxJava_call_stack_just_map_subscribeOn_observeOn.png" alt="enter description here"></p>
<h2 id="backpressure"><a href="#backpressure" class="headerlink" title="backpressure"></a>backpressure</h2><p>在前面我们讲 just 时，就已经讲过了 <code>backpressure</code>：</p>
<blockquote>
<p>在 RxJava 1.x 中，数据都是从 observable push 到 subscriber 的，但要是 observable 发得太快，subscriber 处理不过来，该怎么办？一种办法是，把数据保存起来，但这显然可能导致内存耗尽；另一种办法是，多余的数据来了之后就丢掉，至于丢掉和保留的策略可以按需制定；还有一种办法就是让 subscriber 向 observable 主动请求数据，subscriber 不请求，observable 就不发出数据。它俩相互协调，避免出现过多的数据，而协调的桥梁，就是 producer。</p>
</blockquote>
<p>rxjava2.x的Observable是不存在背压的概念的，背压是下游控制上游流速的一种手段。在rxjava1.x的时代，上游会给下游set一个producer，下游通过producer向上游请求n个数据，这样上游就有记录下游请求了多少个数据，然后下游请求多少个上游就给多少个，这个就是背压。一般来讲，每个节点都有缓存，比如说缓存的大小是64，这个时候下游可以一次性向上游request 64个数据。rxjava1.x的有些操作符不支持背压，也就是说这些操作符不会给下游set一个producer，也就是上游根本不理会下游的请求，一直向下游丢数据，如果下游的缓存爆了，那么下游就会抛出MissingBackpressureException，也就是背压失效了。</p>
<p>在rxjava2.x时代，上述的背压逻辑全部挪到Flowable里了，所以说Flowable支持背压。而2.x时代的Observable是没有背压的概念的，Observable如果来不及消费会死命的缓存直到OOM，所以rxjava2.x的官方文档里面有讲，大数据流用Flowable，小数据流用Observable。</p>
<h2 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h2><p>我们多次遇见了 <code>hook</code>，为了简化逻辑，也多次跳过了 hook，这里我们就看看 hook 有什么用，工作原理是什么。</p>
<p>利用 hook 我们可以站在“上帝视角”，多种重要的节点上，都有 hook。例如创建 <code>Observable（create）</code>时，有 <code>onCreate</code>，我们可以进行任意想要的操作，记录、修饰、甚至抛出异常；以及和 scheduler 相关的内容，获取 scheduler 时，我们都可以进行想要的操作，例如让 Scheduler.io() 返回立即执行的 scheduler。</p>
<p>这些内容让我们可以执行高度自定义的操作，其中就包括便于测试。</p>
<p>其实 hook 的原理并不复杂，在关心的节点（hook point）插桩，让我们可以操控（manipulate）程序在这些节点的行为，至于操控的策略，有一系列函数进行设置、以及清理。</p>
<p>目前和 hook 相关的内容主要在 RxJavaPlugins 和 RxJavaHooks 这两个类中，后者在 v1.1.7 引入，功能更加强大，使用更加方便。</p>
]]></content>
      <categories>
        <category>Android进阶之光</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码解析</tag>
      </tags>
  </entry>
  <entry>
    <title>手势密码源码解析</title>
    <url>/2019/02/28/%E6%89%8B%E5%8A%BF%E5%AF%86%E7%A0%81%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>参考自<a href="https://github.com/sym900728/LockPattern" target="_blank" rel="noopener">高仿支付宝解锁</a></p>
<h2 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h2><p>一个九宫格View + View的指示器标识已选单元</p>
<h2 id="LockPatternView"><a href="#LockPatternView" class="headerlink" title="LockPatternView"></a>LockPatternView</h2><h3 id="构造函数以及成员变量"><a href="#构造函数以及成员变量" class="headerlink" title="构造函数以及成员变量"></a>构造函数以及成员变量</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">float</span> movingX, movingY;<span class="comment">//记录移动x,y</span></span><br><span class="line">  <span class="comment">//onTouchEvent中记录当前状态</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isActionMove = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isActionDown = <span class="keyword">false</span>;<span class="comment">//default action down is false</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isActionUp = <span class="keyword">true</span>;<span class="comment">//default action up is true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> width, height;<span class="comment">//onMeasure中获取View的宽和高</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> cellRadius, cellInnerRadius;<span class="comment">//单个点的外圆半径以及内圆半径</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> cellBoxWidth, cellBoxHeight;<span class="comment">//单个宽和高</span></span><br><span class="line">  <span class="comment">//in stealth mode (default is false)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> mInStealthMode = <span class="keyword">false</span>;<span class="comment">//隐藏模式</span></span><br><span class="line">  <span class="comment">//haptic feed back (default is false)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> mEnableHapticFeedback = <span class="keyword">false</span>;<span class="comment">//震动反馈</span></span><br><span class="line">  <span class="comment">//set delay time</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> delayTime = <span class="number">600L</span>;<span class="comment">//重绘延迟事件</span></span><br><span class="line">  <span class="comment">//set lock</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isLock = <span class="keyword">false</span>;<span class="comment">//锁定画布，禁止绘制</span></span><br><span class="line">  <span class="comment">//set offset to the boundary</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> offset = <span class="number">10</span>;<span class="comment">//外边距，相当于margin = 5</span></span><br><span class="line">  <span class="comment">//draw view used paint</span></span><br><span class="line">  <span class="keyword">private</span> Paint defaultPaint, selectPaint, errorPaint;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//draw triangle</span></span><br><span class="line">  <span class="keyword">private</span> Path trianglePath;<span class="comment">//三角形绘制</span></span><br><span class="line">  <span class="keyword">private</span> Matrix triangleMatrix;</span><br><span class="line"><span class="comment">//Key object, which are used for drawing circle ,line ,and triangle</span></span><br><span class="line">  <span class="keyword">private</span> Cell[][] mCells = <span class="keyword">new</span> Cell[<span class="number">3</span>][<span class="number">3</span>];<span class="comment">// 九宫格九个对象</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;Cell&gt; sCells = <span class="keyword">new</span> ArrayList&lt;Cell&gt;();<span class="comment">//记录选中单元</span></span><br><span class="line">  <span class="keyword">private</span> OnPatternListener patterListener;<span class="comment">// 实现Indicator与View的绑定</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> CONSTANT_COS_30 = Math.cos(Math.toRadians(<span class="number">30</span>));<span class="comment">// cos(/Π / 6)</span></span><br><span class="line"><span class="comment">//The runnable used for clear pattern mode</span></span><br><span class="line">  <span class="keyword">private</span> Runnable mClearPatternRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      isLock = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="主要类和成员方法"><a href="#主要类和成员方法" class="headerlink" title="主要类和成员方法"></a>主要类和成员方法</h3><p>Cell类<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;<span class="comment">// the x position of circle's center point</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;<span class="comment">// the y position of circle's center point</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> row;<span class="comment">// the cell in which row</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> column;<span class="comment">// the cell in which column</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;<span class="comment">// the cell value(1-9)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status = STATE_NORMAL;<span class="comment">//default status</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//default status</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_NORMAL = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//checked status</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_CHECK = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//checked error status</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_CHECK_ERROR = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PRESSED = <span class="number">3</span>;</span><br><span class="line">...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>手势密码状态<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * the display mode of the pattern</span></span><br><span class="line"><span class="comment">  * 手势密码状态</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">enum</span> DisplayMode &#123;</span><br><span class="line">   <span class="comment">//show default pattern (the default pattern is initialize status)</span></span><br><span class="line">   DEFAULT,</span><br><span class="line">   <span class="comment">//show selected pattern normal</span></span><br><span class="line">   NORMAL,</span><br><span class="line">   <span class="comment">//show selected pattern error</span></span><br><span class="line">   ERROR;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * initialize cell size (include circle radius, inner circle radius,</span></span><br><span class="line"><span class="comment"> * cell box width, cell box height)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initCellSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.cellRadius = (<span class="keyword">this</span>.width - offset * <span class="number">2</span>) / <span class="number">4</span> / <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">this</span>.cellInnerRadius = <span class="keyword">this</span>.cellRadius / <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">this</span>.cellBoxWidth = (<span class="keyword">this</span>.width - offset * <span class="number">2</span>) / <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">this</span>.cellBoxHeight = (<span class="keyword">this</span>.height - offset * <span class="number">2</span>) / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * initialize nine cells</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init9Cells</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//the distance between the center of two circles</span></span><br><span class="line">  <span class="keyword">int</span> distance = <span class="keyword">this</span>.cellBoxWidth + <span class="keyword">this</span>.cellBoxWidth / <span class="number">2</span> - <span class="keyword">this</span>.cellRadius;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">      mCells[i][j] = <span class="keyword">new</span> Cell(distance * j + cellRadius + offset,</span><br><span class="line">          distance * i + cellRadius + offset, i, j, <span class="number">3</span> * i + j + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>九宫格中的每一个点的半径相当于 （宽度 - 外边距 ）/ 8，为什么处以8呢？因为水平上有三个圆，每个圆有两条半径，共有6条，再加上三个圆中间两个间距。故8条，其余同理</p>
<p>onMeasure方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//必须重写onMeasured获得正确的宽高，再重绘</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    getMeasuredHeight();</span><br><span class="line">    <span class="keyword">this</span>.width = getMeasuredWidth();</span><br><span class="line">    <span class="keyword">this</span>.height = getMeasuredHeight();</span><br><span class="line">    <span class="keyword">if</span> (width != height) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"the width must be equals height"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.initCellSize();</span><br><span class="line">    <span class="keyword">this</span>.set9CellsSize();</span><br><span class="line">    <span class="keyword">this</span>.invalidate();</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * set nine cells size</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set9CellsSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> distance = <span class="keyword">this</span>.cellBoxWidth + <span class="keyword">this</span>.cellBoxWidth / <span class="number">2</span> - <span class="keyword">this</span>.cellRadius;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">        mCells[i][j].setX(distance * j + cellRadius + offset);</span><br><span class="line">        mCells[i][j].setY(distance * i + cellRadius + offset);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>绘制三角形<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawTriangle</span><span class="params">(Cell preCell, Cell nextCell, Canvas canvas, Paint paint)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">float</span> distance = LockPatternUtil.getDistanceBetweenTwoPoints</span><br><span class="line">      (preCell.getX(), preCell.getY(), nextCell.getX(), nextCell.getY());</span><br><span class="line">  <span class="keyword">float</span> x = <span class="keyword">this</span>.cellInnerRadius * <span class="number">2</span> / distance * (nextCell.getX() - preCell.getX()) + preCell.getX();<span class="comment">//(2/3 * R)*cosθ + x</span></span><br><span class="line">  <span class="keyword">float</span> y = <span class="keyword">this</span>.cellInnerRadius * <span class="number">2</span> / distance * (nextCell.getY() - preCell.getY()) + preCell.getY();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">float</span> angleX = LockPatternUtil.getAngleLineIntersectX(</span><br><span class="line">      preCell.getX(), preCell.getY(), nextCell.getX(), nextCell.getY(), distance);</span><br><span class="line">  <span class="keyword">float</span> angleY = LockPatternUtil.getAngleLineIntersectY(</span><br><span class="line">      preCell.getX(), preCell.getY(), nextCell.getX(), nextCell.getY(), distance);</span><br><span class="line">  <span class="keyword">float</span> x1, y1, x2, y2;</span><br><span class="line">  <span class="comment">//slide right down</span></span><br><span class="line">  <span class="keyword">if</span> (angleX &gt;= <span class="number">0</span> &amp;&amp; angleX &lt;= <span class="number">90</span> &amp;&amp; angleY &gt;= <span class="number">0</span> &amp;&amp; angleY &lt;= <span class="number">90</span>) &#123;</span><br><span class="line">    x1 = x - (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(angleX - <span class="number">30</span>)));</span><br><span class="line">    y1 = y - (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(angleX - <span class="number">30</span>)));</span><br><span class="line">    x2 = x - (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(angleY - <span class="number">30</span>)));</span><br><span class="line">    y2 = y - (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(angleY - <span class="number">30</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//slide right up</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (angleX &gt;= <span class="number">0</span> &amp;&amp; angleX &lt;= <span class="number">90</span> &amp;&amp; angleY &gt; <span class="number">90</span> &amp;&amp; angleY &lt;= <span class="number">180</span>) &#123;</span><br><span class="line">    x1 = x - (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(angleX + <span class="number">30</span>)));</span><br><span class="line">    y1 = y + (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(angleX + <span class="number">30</span>)));</span><br><span class="line">    x2 = x - (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(<span class="number">180</span> - angleY + <span class="number">30</span>)));</span><br><span class="line">    y2 = y + (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(<span class="number">180</span> - angleY + <span class="number">30</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//slide left up</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (angleX &gt; <span class="number">90</span> &amp;&amp; angleX &lt;= <span class="number">180</span> &amp;&amp; angleY &gt;= <span class="number">90</span> &amp;&amp; angleY &lt; <span class="number">180</span>) &#123;</span><br><span class="line">    x1 = x + (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(<span class="number">180</span> - angleX - <span class="number">30</span>)));</span><br><span class="line">    y1 = y + (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(<span class="number">180</span> - angleX - <span class="number">30</span>)));</span><br><span class="line">    x2 = x + (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(<span class="number">180</span> - angleY - <span class="number">30</span>)));</span><br><span class="line">    y2 = y + (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(<span class="number">180</span> - angleY - <span class="number">30</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//slide left down</span></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    x1 = x + (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(<span class="number">180</span> - angleX + <span class="number">30</span>)));</span><br><span class="line">    y1 = y - (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(<span class="number">180</span> - angleX + <span class="number">30</span>)));</span><br><span class="line">    x2 = x + (<span class="keyword">float</span>) (cellInnerRadius * Math.sin(Math.toRadians(angleY + <span class="number">30</span>)));</span><br><span class="line">    y2 = y - (<span class="keyword">float</span>) (cellInnerRadius * Math.cos(Math.toRadians(angleY + <span class="number">30</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  trianglePath.reset();</span><br><span class="line">  trianglePath.moveTo(x, y);</span><br><span class="line">  trianglePath.lineTo(x1, y1);</span><br><span class="line">  trianglePath.lineTo(x2, y2);</span><br><span class="line">  trianglePath.close();</span><br><span class="line">  canvas.drawPath(trianglePath, paint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>先求出两点之间距离distance</li>
<li>定出三角形起始 x,y 。 x =   float x = this.cellInnerRadius <em> 2 / distance </em> (nextCell.getX() - preCell.getX()) + preCell.getX();//(2/3 <em> R) </em> cosθ,θ为直线与x轴夹角。y同理</li>
<li>获得直线与x轴，y轴的夹角θ与δ，从而定出方向</li>
<li>根据方向，定出其余两个点</li>
<li>连接线段，绘制三角形</li>
</ol>
<p>根据两点之间距离与半径关系判断是否选中某个点<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Cell <span class="title">checkSelectCell</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mCells.length; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mCells[i].length; j++) &#123;</span><br><span class="line">      Cell cell = mCells[i][j];</span><br><span class="line">      <span class="keyword">if</span> (LockPatternUtil.checkInRound(cell.x, cell.y, <span class="keyword">this</span>.cellRadius, x, y, -<span class="number">10</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> cell;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="核心算法"><a href="#核心算法" class="headerlink" title="核心算法"></a>核心算法</h3><p>在onTouchEvent中监听事件，进行对应处理<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"ClickableViewAccessibility"</span>)</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    getParent().requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">float</span> ex = event.getX();</span><br><span class="line">    <span class="keyword">float</span> ey = event.getY();</span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">          handleActionDown(ex, ey);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">          handleActionMove(ex, ey);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">          handleActionUp();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="down"><a href="#down" class="headerlink" title="down"></a>down</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleActionDown</span><span class="params">(<span class="keyword">float</span> ex, <span class="keyword">float</span> ey)</span> </span>&#123;</span><br><span class="line">    isActionMove = <span class="keyword">false</span>;</span><br><span class="line">    isActionDown = <span class="keyword">true</span>;</span><br><span class="line">    isActionUp = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setPattern(DisplayMode.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.patterListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.patterListener.onPatternStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Cell cell = checkSelectCell(ex, ey);</span><br><span class="line">    <span class="keyword">if</span> (cell != <span class="keyword">null</span>) &#123;</span><br><span class="line">      addSelectedCell(cell);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>置标志位</li>
<li>设置当前模式为默认</li>
<li>回调监听器预处理</li>
<li>加入起始点</li>
<li>重绘</li>
</ol>
<h4 id="move"><a href="#move" class="headerlink" title="move"></a>move</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleActionMove</span><span class="params">(<span class="keyword">float</span> ex, <span class="keyword">float</span> ey)</span> </span>&#123;</span><br><span class="line">  isActionMove = <span class="keyword">true</span>;</span><br><span class="line">  movingX = ex;</span><br><span class="line">  movingY = ey;</span><br><span class="line">  Cell cell = checkSelectCell(ex, ey);</span><br><span class="line">  <span class="keyword">if</span> (cell != <span class="keyword">null</span>) &#123;</span><br><span class="line">    addSelectedCell(cell);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.setPattern(DisplayMode.NORMAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>置标志位</li>
<li>判断是否选中该点，是则加入该点</li>
<li>设置当前模式为常规状态并开始重绘</li>
</ol>
<h4 id="up"><a href="#up" class="headerlink" title="up"></a>up</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleActionUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    isActionMove = <span class="keyword">false</span>;</span><br><span class="line">    isActionUp = <span class="keyword">true</span>;</span><br><span class="line">    isActionDown = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setPattern(DisplayMode.NORMAL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.patterListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.patterListener.onPatternComplete(sCells);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="重绘"><a href="#重绘" class="headerlink" title="重绘"></a>重绘</h4><p>每次设置模式后自动重绘，如果设置隐藏路径，即不重绘。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPattern</span><span class="params">(DisplayMode mode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">    <span class="keyword">case</span> DEFAULT:</span><br><span class="line">      <span class="keyword">for</span> (Cell cell : sCells) &#123;</span><br><span class="line">        cell.setStatus(Cell.STATE_NORMAL);</span><br><span class="line">      &#125;</span><br><span class="line">      sCells.clear();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> NORMAL:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ERROR:</span><br><span class="line">      <span class="keyword">for</span> (Cell cell : sCells) &#123;</span><br><span class="line">        cell.setStatus(Cell.STATE_CHECK_ERROR);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.handleStealthMode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * handle the stealth mode (if true: do not post invalidate; false: post invalidate)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleStealthMode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!mInStealthMode) &#123;</span><br><span class="line">    <span class="keyword">this</span>.postInvalidate();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">  <span class="keyword">this</span>.drawToCanvas(canvas);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawToCanvas</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mCells.length; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mCells[i].length; j++) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (mCells[i][j].getStatus()) &#123;</span><br><span class="line">        <span class="keyword">case</span> Cell.STATE_CHECK: &#123;</span><br><span class="line">          selectPaint.setStyle(Style.FILL);</span><br><span class="line">          selectPaint.setColor(getResources().getColor(R.color.color_red_fde7ec));</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellRadius, <span class="keyword">this</span>.selectPaint);</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellRadius, <span class="keyword">this</span>.defaultPaint);</span><br><span class="line">          selectPaint.setColor(getResources().getColor(R.color.pink));</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellInnerRadius / <span class="number">3</span>, <span class="keyword">this</span>.selectPaint);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Cell.STATE_NORMAL: &#123;</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellRadius, <span class="keyword">this</span>.defaultPaint);</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellInnerRadius / <span class="number">3</span>, <span class="keyword">this</span>.selectPaint);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Cell.STATE_CHECK_ERROR: &#123;</span><br><span class="line">          errorPaint.setStyle(Style.STROKE);</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellRadius, <span class="keyword">this</span>.errorPaint);</span><br><span class="line">          errorPaint.setStyle(Style.FILL);</span><br><span class="line">          canvas.drawCircle(mCells[i][j].getX(), mCells[i][j].getY(),</span><br><span class="line">              <span class="keyword">this</span>.cellInnerRadius / <span class="number">3</span>, <span class="keyword">this</span>.errorPaint);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sCells.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//temporary cell: at the beginning the cell is the first of sCells</span></span><br><span class="line">    Cell tempCell = sCells.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; sCells.size(); i++) &#123;</span><br><span class="line">      Cell cell = sCells.get(i);</span><br><span class="line">      <span class="keyword">if</span> (cell.getStatus() == Cell.STATE_CHECK) &#123;</span><br><span class="line">        drawLineIncludeCircle(tempCell, cell, canvas, selectPaint);</span><br><span class="line">        drawTriangle(tempCell, cell, canvas, selectPaint);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cell.getStatus() == Cell.STATE_CHECK_ERROR) &#123;</span><br><span class="line">        drawLineIncludeCircle(tempCell, cell, canvas, errorPaint);</span><br><span class="line">        drawTriangle(tempCell, cell, canvas, selectPaint);</span><br><span class="line">      &#125;</span><br><span class="line">      tempCell = cell;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isActionMove &amp;&amp; !isActionUp) &#123;</span><br><span class="line">      <span class="keyword">this</span>.drawLineFollowFinger(tempCell, canvas, selectPaint);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>根据mCells状态绘制点</li>
<li>按照sCells依次重绘线和三角形</li>
<li>若正在滑动，取出最后一个连接上的点与正常滑动的点划线</li>
</ol>
<h2 id="LockPatternIndicator"><a href="#LockPatternIndicator" class="headerlink" title="LockPatternIndicator"></a>LockPatternIndicator</h2><p>刷新状态，更新UI<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndicator</span><span class="params">(List&lt;LockPatternView.Cell&gt; cells)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(LockPatternView.Cell cell : cells) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mIndicatorCells.length; i++) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mIndicatorCells[i].length; j++) &#123;</span><br><span class="line">				<span class="keyword">if</span> (cell.getIndex() == mIndicatorCells[i][j].getIndex()) &#123;</span><br><span class="line">				</span><br><span class="line">					mIndicatorCells[i][j].setStatus(IndicatorCell.STATE_CHECK);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">this</span>.postInvalidate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawToCanvas</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mIndicatorCells.length; i++) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mIndicatorCells[i].length; j++) &#123;</span><br><span class="line">			<span class="keyword">if</span>(mIndicatorCells[i][j].getStatus() == IndicatorCell.STATE_NORMAL) &#123;</span><br><span class="line">				canvas.drawCircle(mIndicatorCells[i][j].getX(), mIndicatorCells[i][j].getY(), radius, defaultPaint);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(mIndicatorCells[i][j].getStatus() == IndicatorCell.STATE_CHECK) &#123;</span><br><span class="line">				canvas.drawCircle(mIndicatorCells[i][j].getX(), mIndicatorCells[i][j].getY(), radius, selectPaint);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>根据传入的Cells设置自己的mIndicatorCells状态</li>
<li>重绘</li>
</ol>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码解析</tag>
        <tag>自定义View</tag>
      </tags>
  </entry>
  <entry>
    <title>数组中重复的数字</title>
    <url>/2019/02/28/%E6%95%B0%E7%BB%84%E4%B8%AD%E9%87%8D%E5%A4%8D%E7%9A%84%E6%95%B0%E5%AD%97/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="在一个长度为-n-的数组里的所有数字都在-0-到-n-1-的范围内。数组中某些数字是重复的，但不知道有几个数字是重复的，也不知道每个数字重复几次。请找出数组中任意一个重复的数字。"><a href="#在一个长度为-n-的数组里的所有数字都在-0-到-n-1-的范围内。数组中某些数字是重复的，但不知道有几个数字是重复的，也不知道每个数字重复几次。请找出数组中任意一个重复的数字。" class="headerlink" title="在一个长度为 n 的数组里的所有数字都在 0 到 n-1 的范围内。数组中某些数字是重复的，但不知道有几个数字是重复的，也不知道每个数字重复几次。请找出数组中任意一个重复的数字。"></a>在一个长度为 n 的数组里的所有数字都在 0 到 n-1 的范围内。数组中某些数字是重复的，但不知道有几个数字是重复的，也不知道每个数字重复几次。请找出数组中任意一个重复的数字。</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:</span><br><span class="line">&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">5</span>&#125;</span><br><span class="line">Output:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>要求是时间复杂度 O(N)，空间复杂度 O(1)。因此不能使用排序的方法，也不能使用额外的标记数组。</p>
<p>对于这种数组元素在 [0, n-1] 范围内的问题，可以将值为 i 的元素调整到第 i 个位置上进行求解。这样就可以重复的元素必然会多次调整至同一位置。有并查集的思想。</p>
<p>以 (2, 3, 1, 0, 2, 5) 为例，遍历到位置 4 时，该位置上的数为 2，但是第 2 个位置上已经有一个 2 的值了，因此可以知道 2 重复：</p>
<p><img src="/images/dupilicate_num.gif" alt="enter description here"></p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">duplicate</span><span class="params">( <span class="keyword">int</span>[] nums, <span class="keyword">int</span> length, <span class="keyword">int</span>[] duplication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nums == <span class="keyword">null</span> || length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (nums[i] != i) &#123;<span class="comment">//Traverse nums[i] == i</span></span><br><span class="line">            <span class="keyword">if</span> (nums[i] == nums[nums[i]]) &#123;</span><br><span class="line">                duplication[<span class="number">0</span>] = nums[i];</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            swap(nums,i, nums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t = nums[i];</span><br><span class="line">    nums[i] = nums[j];</span><br><span class="line">    nums[j] = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>把数组排成最小的数</title>
    <url>/2019/02/27/%E6%8A%8A%E6%95%B0%E7%BB%84%E6%8E%92%E6%88%90%E6%9C%80%E5%B0%8F%E7%9A%84%E6%95%B0/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组-3，32，321-，则打印出这三个数字能排成的最小数字为-321323。"><a href="#输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组-3，32，321-，则打印出这三个数字能排成的最小数字为-321323。" class="headerlink" title="输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组 {3，32，321}，则打印出这三个数字能排成的最小数字为 321323。"></a>输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组 {3，32，321}，则打印出这三个数字能排成的最小数字为 321323。</h3><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>直接拼接数字的话比较会存在溢出问题，曲线解决。转换为字符串。比较时用comparator。关于comparator的compare（）正常s1 &gt; s2返回大于0的数，这是递增排序。若s1 &gt; s2返回小于0 的数，递减排列。<br>关于lambda表达式： x -&gt; 2 * x  接收一个参数(数字类型),返回其2倍的值  只有一行代码时省略了</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">PrintMinNumber</span><span class="params">(<span class="keyword">int</span>[] numbers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (numbers == <span class="keyword">null</span> || numbers.length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">int</span> n = numbers.length;</span><br><span class="line">    String[] nums = <span class="keyword">new</span> String[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        nums[i] = numbers[i] + <span class="string">""</span>;</span><br><span class="line">    Arrays.sort(nums, (s1, s2) -&gt; (s1 + s2).compareTo(s2 + s1));</span><br><span class="line">    StringBuilder ret = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (String str : nums)</span><br><span class="line">        ret.append(str);</span><br><span class="line">    <span class="keyword">return</span> ret.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>DTO与VO辨析</title>
    <url>/2019/02/26/DTO%E4%B8%8EVO%E8%BE%A8%E6%9E%90/</url>
    <content><![CDATA[<h2 id="VO-与-DTO概念"><a href="#VO-与-DTO概念" class="headerlink" title="VO 与 DTO概念"></a>VO 与 DTO概念</h2><p>VO: ViewObject表现层对象。通俗地说即UI层的View需要的对象。<br>DTO：Data Transfer Object数据传输对象。通俗地说即用于展示层与服务层之间的数据传输对象。</p>
<h2 id="加入VO原因"><a href="#加入VO原因" class="headerlink" title="加入VO原因"></a>加入VO原因</h2><p>在学校的时候，开发中我一直使用的都是单DTO层。View展示的Model对象和接口返回的Model是同一个对象。<br>进入公司后，发现这样的代码存在四个问题</p>
<ol>
<li>ViewModel绑定时，无休止的判空操作</li>
<li>接口返回的数据结构或字段改变啦</li>
<li>接口返回的数据结构不是我在View中显示想要的啊</li>
<li>姗姗来迟的接口文档</li>
</ol>
<p>迫于此情此景，VO应运而生啦。采用VO + Mapper转换接口。模拟场景在Retrofit请求访问网络数据下进行转换。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>Mapper接口 + listHelper转换接口<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformable1</span>&lt;<span class="title">VO</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">VO <span class="title">dto2vo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ListTransformHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">ListTransformHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Transformable1, VO&gt; List&lt;VO&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  dto2vo(List&lt;T&gt; dtoList) &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;VO&gt; voList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (T dto : dtoList) &#123;</span><br><span class="line"></span><br><span class="line">      voList.add((VO) dto.dto2vo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> voList;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Module层：DTO + VO<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorksGroupDTO</span> <span class="keyword">implements</span> <span class="title">Transformable1</span>&lt;<span class="title">WorksGroupVO</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String groupTitle;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> List&lt;PostDTO&gt; posts;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> WorksGroupVO <span class="title">dto2vo</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WorksGroupVO.Builder().setGroupTitle(groupTitle)</span><br><span class="line">        .setPostVOList(translatePosts())</span><br><span class="line">        .setExpand(<span class="keyword">false</span>)</span><br><span class="line">        .build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> List&lt;PostVO&gt; <span class="title">translatePosts</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ListTransformHelper.dto2vo(posts);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorksGroupVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String mGroupTitle;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> List&lt;PostVO&gt; mPostVOList;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> List&lt;PostVO&gt; mMorePostVOList;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> mExpand;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> mIsLoading; </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">WorksGroupVO</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mGroupTitle = builder.mGroupTitle;</span><br><span class="line">    mPostVOList = builder.mPostVOList;</span><br><span class="line">    mMorePostVOList = builder.mMorePostVOList;</span><br><span class="line">    mExpand = builder.mExpand;</span><br><span class="line">    mIsLoading = builder.mIsLoading;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getGroupTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mGroupTitle;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;PostVO&gt; <span class="title">getPostVOList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mPostVOList;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;PostVO&gt; <span class="title">getMorePostVOList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mMorePostVOList;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mExpand;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLoading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mIsLoading;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String mGroupTitle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;PostVO&gt; mPostVOList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;PostVO&gt; mMorePostVOList; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mExpand;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsLoading; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(WorksGroupVO worksGroupVO)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      mGroupTitle = worksGroupVO.mGroupTitle;</span><br><span class="line">      mPostVOList = worksGroupVO.mPostVOList;</span><br><span class="line">      mMorePostVOList = worksGroupVO.mMorePostVOList;</span><br><span class="line">      mExpand = worksGroupVO.mExpand;</span><br><span class="line">      mIsLoading = worksGroupVO.mIsLoading;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">setGroupTitle</span><span class="params">(String groupTitle)</span> </span>&#123;</span><br><span class="line">      mGroupTitle = groupTitle  == <span class="keyword">null</span> ? <span class="string">""</span> : groupTitle;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">setPostVOList</span><span class="params">(List&lt;PostVO&gt; postVOList)</span> </span>&#123;</span><br><span class="line">      mPostVOList = postVOList == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;PostVo&gt;()  : postVOList;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">setMorePostVOList</span><span class="params">(List&lt;PostVO&gt; morePostVOList)</span> </span>&#123;</span><br><span class="line">      mMorePostVOList = morePostVOList == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;PostVo&gt;() : morePostVOList;;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">setExpand</span><span class="params">(<span class="keyword">boolean</span> expand)</span> </span>&#123;</span><br><span class="line">      mExpand = expand;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">setLoading</span><span class="params">(<span class="keyword">boolean</span> loading)</span> </span>&#123;</span><br><span class="line">      mIsLoading = loading;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WorksGroupVO <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> WorksGroupVO(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewModule层<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Observable&lt;List&lt;WorksGroupVO&gt;&gt; fetchWorksGroupList(String groupId, <span class="keyword">int</span> pageNum) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RetrofitWrapperStore.getInstance()</span><br><span class="line">      .provideApi(Api<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">fetchWorksGroupList</span>(<span class="title">groupId</span>, <span class="title">pageNum</span>)</span></span><br><span class="line"><span class="class">      .<span class="title">compose</span>(<span class="title">RxServerResultTransformer</span>.&lt;<span class="title">List</span>&lt;<span class="title">WorksGroupDTO</span>&gt;&gt;<span class="title">transform</span>())</span></span><br><span class="line"><span class="class">      .<span class="title">map</span>(<span class="title">new</span> <span class="title">Func1</span>&lt;<span class="title">List</span>&lt;<span class="title">WorksGroupDTO</span>&gt;, <span class="title">List</span>&lt;<span class="title">WorksGroupVO</span>&gt;&gt;() </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;WorksGroupVO&gt; <span class="title">call</span><span class="params">(List&lt;WorksGroupDTO&gt; worksGroupDTOs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> ListTransformHelper.dto2vo(worksGroupDTOs);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .subscribeOn(Schedulers.io());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="解决痛点"><a href="#解决痛点" class="headerlink" title="解决痛点"></a>解决痛点</h2><ol>
<li>后台返回数据为null，在dto2vo()中已经进行了处理。</li>
<li>接口返回的数据结构或字段突然变更，使用这种Mappe之后，大多数情况，只需要更改DTO里的dto2vo()的实现即可</li>
<li>接口返回的数据结构不是我想要的？把它转成我们想要的VO对象即可如int形的gender转换成boolean形的isMale.又比如在RecyclerView中显示的View不同，即属于不同的ItemType。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">   WorksGroupVO worksgroup = mDatas.get(position);</span><br><span class="line">   <span class="keyword">return</span> worksgroup.isExpand() ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样增加了View层的逻辑判断。可在Bean中增加itemType<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorksGroupVO</span></span>&#123;</span><br><span class="line">   ...</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">int</span> itemType;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> WorksGroupVO <span class="title">dto2vo</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WorksGroupVO.Builder().setGroupTitle(groupTitle)</span><br><span class="line">        .setPostVOList(translatePosts())</span><br><span class="line">        .setExpand(mExpand)</span><br><span class="line">		.setItemType(mExpand ? <span class="number">0</span> : <span class="number">1</span>)</span><br><span class="line">        .build();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>V层应该专注V应该做的事，而不是数据的处理、业务逻辑！</p>
<p>4 接口文档迟迟没有,在事先拿到设计稿时，可以在VO中先把数据结构搭好，利用VO模拟数据。后台好了后直接dto2vo()</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从实用角度出发：Mapper可以让开发过程更高效，更从容面对需求变更、接口变更等外在因素。</p>
<p>从架构角度出发：Mapper的出现可以让M层可以承担更多的职责，来减轻中间层的压力，更利于构造一个V，M的分离的架构。</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Otto源码剖析</title>
    <url>/2019/02/26/Otto%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/</url>
    <content><![CDATA[<h2 id="有意思的单例"><a href="#有意思的单例" class="headerlink" title="有意思的单例"></a>有意思的单例</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LovelyBus &#123;</span><br><span class="line"></span><br><span class="line">  INSTANCE; <span class="comment">// 优雅的单例</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Bus mBus;</span><br><span class="line"></span><br><span class="line">  LovelyBus() &#123;</span><br><span class="line"></span><br><span class="line">    mBus = <span class="keyword">new</span> Bus();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mBus.register(object);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mBus.unregister(object);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mBus.post(event);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Bus的构造函数"><a href="#Bus的构造函数" class="headerlink" title="Bus的构造函数"></a>Bus的构造函数</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Bus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(DEFAULT_IDENTIFIER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Bus</span><span class="params">(String identifier)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(ThreadEnforcer.MAIN, identifier);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Bus</span><span class="params">(ThreadEnforcer enforcer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(enforcer, DEFAULT_IDENTIFIER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Bus</span><span class="params">(ThreadEnforcer enforcer, String identifier)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(enforcer, identifier, HandlerFinder.ANNOTATED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Bus(ThreadEnforcer enforcer, String identifier, HandlerFinder handlerFinder) &#123;</span><br><span class="line">  <span class="keyword">this</span>.enforcer =  enforcer;</span><br><span class="line">  <span class="keyword">this</span>.identifier = identifier;</span><br><span class="line">  <span class="keyword">this</span>.handlerFinder = handlerFinder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThreadEnforcer.MAIN表示默认在主线程调度事件。handlerFinder(HandlerFinder.ANNOTATED)则是查找订阅者和订阅者。</p>
<h2 id="register"><a href="#register" class="headerlink" title="register"></a>register</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Object to register must not be null."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  enforcer.enforce(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  Map&lt;Class&lt;?&gt;, EventProducer&gt; foundProducers = handlerFinder.findAllProducers(object);</span><br></pre></td></tr></table></figure>
<p>获取这个被注册对象的所有生产者方法，可以对应于多个事件的生产者方法。一个被注册对象，同一个事件只能注册一个生产者方法。如@Produce注解的方法只能有一个参数为String的方法。再看接下来的register方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//key是事件的class对象</span></span><br><span class="line">    Map&lt;Class&lt;?&gt;, EventProducer&gt; foundProducers = handlerFinder.findAllProducers(object);</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; type : foundProducers.keySet()) &#123;</span><br><span class="line">          </span><br><span class="line">     <span class="comment">//下面几行代码用来检查，事件是否已经注册过了，一个类一个事件只能注册一次</span></span><br><span class="line">      <span class="keyword">final</span> EventProducer producer = foundProducers.get(type);</span><br><span class="line">      EventProducer previousProducer = producersByType.putIfAbsent(type, producer);</span><br><span class="line">      <span class="comment">//checking if the previous producer existed</span></span><br><span class="line">      <span class="keyword">if</span> (previousProducer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Producer method for type "</span> + type</span><br><span class="line">          + <span class="string">" found on type "</span> + producer.target.getClass()</span><br><span class="line">          + <span class="string">", but already registered by type "</span> + previousProducer.target.getClass() + <span class="string">"."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//检查一下注册这个事件的订阅者是否存在，存在就回调一下订阅者</span></span><br><span class="line">      Set&lt;EventHandler&gt; handlers = handlersByType.get(type);</span><br><span class="line">      <span class="keyword">if</span> (handlers != <span class="keyword">null</span> &amp;&amp; !handlers.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (EventHandler handler : handlers) &#123;</span><br><span class="line">          dispatchProducerResultToHandler(handler, producer);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>dispatchProducerResultToHandler(handler, producer);<br>具体实现就是通过反射去调用producer生产出事件，把事件传递给handler，再通过反射回调注册的方法。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   Map&lt;Class&lt;?&gt;, Set&lt;EventHandler&gt;&gt; foundHandlersMap = handlerFinder.findAllSubscribers(object);</span><br><span class="line">   <span class="keyword">for</span> (Class&lt;?&gt; type : foundHandlersMap.keySet()) &#123;</span><br><span class="line"><span class="comment">////type是事件的class对象</span></span><br><span class="line">     Set&lt;EventHandler&gt; handlers = handlersByType.get(type);</span><br><span class="line">     <span class="keyword">if</span> (handlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="comment">//concurrent put if absent</span></span><br><span class="line">       Set&lt;EventHandler&gt; handlersCreation = <span class="keyword">new</span> CopyOnWriteArraySet&lt;EventHandler&gt;();</span><br><span class="line">       handlers = handlersByType.putIfAbsent(type, handlersCreation);</span><br><span class="line">       <span class="keyword">if</span> (handlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">           handlers = handlersCreation;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">final</span> Set&lt;EventHandler&gt; foundHandlers = foundHandlersMap.get(type);</span><br><span class="line">     <span class="keyword">if</span> (!handlers.addAll(foundHandlers)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Object already registered."</span>);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Set&lt;EventHandler&gt;&gt; entry : foundHandlersMap.entrySet()) &#123;</span><br><span class="line">     Class&lt;?&gt; type = entry.getKey();</span><br><span class="line">     EventProducer producer = producersByType.get(type);</span><br><span class="line">     <span class="keyword">if</span> (producer != <span class="keyword">null</span> &amp;&amp; producer.isValid()) &#123;</span><br><span class="line">       Set&lt;EventHandler&gt; foundHandlers = entry.getValue();</span><br><span class="line">       <span class="keyword">for</span> (EventHandler foundHandler : foundHandlers) &#123;</span><br><span class="line">         <span class="keyword">if</span> (!producer.isValid()) &#123;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (foundHandler.isValid()) &#123;</span><br><span class="line">           dispatchProducerResultToHandler(foundHandler, producer);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>获取所有订阅者，如果有与订阅者对应的发布者，则触发对应的订阅者处理事件。</p>
<h2 id="post"><a href="#post" class="headerlink" title="post"></a>post</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Event to post must not be null."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    enforcer.enforce(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//返回这个event的所有继承关系链的所有class对象（父类class对象和自己）</span></span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; dispatchTypes = flattenHierarchy(event.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> dispatched = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">//遍历集合对even的所有类的相关注册方法加入队列</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; eventType : dispatchTypes) &#123;</span><br><span class="line">      Set&lt;EventHandler&gt; wrappers = getHandlersForEventType(eventType);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (wrappers != <span class="keyword">null</span> &amp;&amp; !wrappers.isEmpty()) &#123;</span><br><span class="line">        dispatched = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (EventHandler wrapper : wrappers) &#123;</span><br><span class="line">		 <span class="comment">//把需要回调处理的订阅者方法的包装类塞进当前线程处理的队列中去。queue是一个ThreadLocal对象</span></span><br><span class="line">          enqueueEvent(event, wrapper);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dispatched &amp;&amp; !(event <span class="keyword">instanceof</span> DeadEvent)) &#123;</span><br><span class="line">      post(<span class="keyword">new</span> DeadEvent(<span class="keyword">this</span>, event));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//取出队列中的对象执行订阅者方法</span></span><br><span class="line">    dispatchQueuedEvents();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="unregister"><a href="#unregister" class="headerlink" title="unregister"></a>unregister</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Object to unregister must not be null."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    enforcer.enforce(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//发布者取消注册</span></span><br><span class="line">    Map&lt;Class&lt;?&gt;, EventProducer&gt; producersInListener = handlerFinder.findAllProducers(object);</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, EventProducer&gt; entry : producersInListener.entrySet()) &#123;</span><br><span class="line">      <span class="keyword">final</span> Class&lt;?&gt; key = entry.getKey();</span><br><span class="line">      EventProducer producer = getProducerForEventType(key);</span><br><span class="line">      EventProducer value = entry.getValue();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span> || !value.equals(producer)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">"Missing event producer for an annotated method. Is "</span> + object.getClass()</span><br><span class="line">                + <span class="string">" registered?"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      producersByType.remove(key).invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//订阅者取消注册</span></span><br><span class="line">    Map&lt;Class&lt;?&gt;, Set&lt;EventHandler&gt;&gt; handlersInListener = handlerFinder.findAllSubscribers(object);</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Set&lt;EventHandler&gt;&gt; entry : handlersInListener.entrySet()) &#123;</span><br><span class="line">      Set&lt;EventHandler&gt; currentHandlers = getHandlersForEventType(entry.getKey());</span><br><span class="line">      Collection&lt;EventHandler&gt; eventMethodsInListener = entry.getValue();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentHandlers == <span class="keyword">null</span> || !currentHandlers.containsAll(eventMethodsInListener)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">"Missing event handler for an annotated method. Is "</span> + object.getClass()</span><br><span class="line">                + <span class="string">" registered?"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (EventHandler handler : currentHandlers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventMethodsInListener.contains(handler)) &#123;</span><br><span class="line">          handler.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      currentHandlers.removeAll(eventMethodsInListener);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码解析</tag>
        <tag>事件总线</tag>
      </tags>
  </entry>
  <entry>
    <title>AsyncTask Mechanism</title>
    <url>/2019/02/24/AnsyncTask%20Mechanism/</url>
    <content><![CDATA[<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>((Looper) <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">(@Nullable Looper callbackLooper)</span> </span>&#123;</span><br><span class="line">        mHandler = callbackLooper == <span class="keyword">null</span> || callbackLooper == Looper.getMainLooper()</span><br><span class="line">            ? getMainHandler()</span><br><span class="line">            : <span class="keyword">new</span> Handler(callbackLooper);</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由此可看出默认AsyncTask是在主线程运行的。且onPreExecute、onPostExecute也定义了@MainThread</p>
<h3 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h3><p>进入AsyncTask的execute（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);<span class="comment">//sDefaultExecutor is a sreial executor</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></span><br><span class="line"><span class="function"><span class="params">        Params... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mStatus) &#123;</span><br><span class="line">            <span class="keyword">case</span> RUNNING:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                        + <span class="string">" the task is already running."</span>);</span><br><span class="line">            <span class="keyword">case</span> FINISHED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                        + <span class="string">" the task has already been executed "</span></span><br><span class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mStatus = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    onPreExecute();</span><br><span class="line"></span><br><span class="line">    mWorker.mParams = params;</span><br><span class="line">    exec.execute(mFuture);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>sDefaultExecutor是一个串行的线程池，先执行onPreExecute().然后将params封装到mWorker(WorkerRunnable)中.而mWorker又是被封装到mFuture(FutureTask也是个Runnable)中的。然后sDefaultExecutor线程池开始执行FututreTask。进入sDefaultExecutor<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</span><br><span class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">  ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,</span><br><span class="line">                sPoolWorkQueue, sThreadFactory);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</span><br><span class="line">        Runnable mActive;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">            mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        r.run();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        scheduleNext();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduleNext();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                THREAD_POOL_EXECUTOR.execute(mActive);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>execute()首先会将FutureTask对象插入到任务队列mTasks上，如果此时没有正在执行的任务，则调用scheduleNext()让THREAD_POOL_EXECUTOR执行任务。同时一个任务执行结束后，会自动地调度下一个任务开始执行。</p>
<p>AsyncTask中有两个线程池sDefaultExecutor（SerialExecutor:内部封装了ArrayDequeue）和 THREAD_POOL_EXECUTOR (Customized Executor:内部封装了BlockingQueue) 和一个InternalHandler(Handler).SerialExecutor用于任务的排队，而 THREAD_POOL_EXECUTOR 用于执行任务。IntenalHandler用于子线程切换主线程。进入mFurue的run方法。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">            !U.compareAndSwapObject(<span class="keyword">this</span>, RUNNER, <span class="keyword">null</span>, Thread.currentThread()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Callable&lt;V&gt; c = callable;</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">                V result;</span><br><span class="line">                <span class="keyword">boolean</span> ran;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    result = c.call();</span><br><span class="line">                    ran = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    result = <span class="keyword">null</span>;</span><br><span class="line">                    ran = <span class="keyword">false</span>;</span><br><span class="line">                    setException(ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ran)</span><br><span class="line">                    set(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// runner must be non-null until state is settled to</span></span><br><span class="line">            <span class="comment">// prevent concurrent calls to run()</span></span><br><span class="line">            runner = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// state must be re-read after nulling runner to prevent</span></span><br><span class="line">            <span class="comment">// leaked interrupts</span></span><br><span class="line">            <span class="keyword">int</span> s = state;</span><br><span class="line">            <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">                handlePossibleCancellationInterrupt(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中callable即为封装的mWorker(WorkerRunnable).进入构造方法中定义WorkerRunnable的call方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mTaskInvoked.set(<span class="keyword">true</span>);</span><br><span class="line">        Result result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">            <span class="comment">//noinspection unchecked</span></span><br><span class="line">            result = doInBackground(mParams);</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable tr) &#123;</span><br><span class="line">            mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">throw</span> tr;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            postResult(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mTaskInvoked设为true，表示任务已被调用过。再执行doInBackGround.将返回值传给postResult().进入postResult()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</span><br><span class="line">            <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</span><br><span class="line">    message.sendToTarget();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> postResult（）会通过sHandler发送一个MESSAGE_POST_RESULT的消息。进入sHandler<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InternalHandler sHandler;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_POST_RESULT:</span><br><span class="line">                    <span class="comment">// There is only one result</span></span><br><span class="line">                    result.mTask.finish(result.mData[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</span><br><span class="line">                    result.mTask.onProgressUpdate(result.mData);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">            onCancelled(result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onPostExecute(result);</span><br><span class="line">        &#125;</span><br><span class="line">        mStatus = Status.FINISHED;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>sHadler在收到MESSAGE_POST_RESULT执行AsyncTasl。finish()，而在finish()中，若AsyncTask是被取消执行，则调用onCancelled(result),否则调用onPostExecutor(result).将doInBackGround()的返回值传给了主线程。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>先执行onPreExecute. 将传入params封装到mWorker中，而mWorker是封装到mFuture中的。</li>
<li>将mFuture压入SerialExecutor任务队列，若队列空，让THREAD_POOL_EXECUTOR开始执行mFuture. 执行mFuture的run()会调用mWorker的call（）</li>
<li>在call()调用doInBackGround()获得返回值，并将返回值传给sHandler</li>
<li>sHandler接到消息调用AsyncTask的finish()</li>
<li>在finish()中调用onPostExecute()</li>
</ol>
<h2 id="小心翻车"><a href="#小心翻车" class="headerlink" title="小心翻车"></a>小心翻车</h2><ul>
<li>AsyncTask不必在主线程定义</li>
<li>execute不必在主线程调用</li>
<li>不能自己直接调用onPre/onPost/doInBackGround/onProgressUpdated</li>
<li>一个AsyncTask对象只能执行一次（否则会抛出异常IllegalStateException）</li>
</ul>
<p>之前在开发者艺术探索中读到不能在子线程中定义AsyncTask定义和使用execute。但是经过实践，发现从sdk22以后，是可以在子线程中进行定义和execute的。因为Handler默认是使用MainLooper，无论在子线程中是否定义Looper。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>((Looper) <span class="keyword">null</span>);<span class="comment">//1</span></span><br><span class="line"> &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">(@Nullable Looper callbackLooper)</span> </span>&#123;</span><br><span class="line">     mHandler = callbackLooper == <span class="keyword">null</span> || callbackLooper == Looper.getMainLooper()</span><br><span class="line">         ? getMainHandler()<span class="comment">//2</span></span><br><span class="line">         : <span class="keyword">new</span> Handler(callbackLooper);</span><br><span class="line">....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getMainHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (AsyncTask<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (sHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">             sHandler = <span class="keyword">new</span> InternalHandler(Looper.getMainLooper());<span class="comment">//3</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> sHandler;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>直接new AsyncTask会调用Looper为空的重载方法</li>
<li>Handler = getMainHandler</li>
<li>Looper = sMainLooper</li>
</ol>
<p>测试代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               MyAsync myAsync = <span class="keyword">new</span> MyAsync();</span><br><span class="line">               myAsync.execute();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).start();</span><br><span class="line">	    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAsync</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Log.i(<span class="string">"TAG"</span>, <span class="string">"onPreExecute: "</span>);</span><br><span class="line">           <span class="keyword">super</span>.onPreExecute();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Object <span class="title">doInBackground</span><span class="params">(Object[] objects)</span> </span>&#123;</span><br><span class="line">           Log.i(<span class="string">"TAG"</span>, <span class="string">"doInBackground: "</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>当然子线程中使用AsyncTask不能在onPreExecute,onPostExecute中进行UI操作，因为AsyncTask的实例创建在子线程，onPreExecute,onPostExecute也都运行在子线程。</p>
<p>在</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>HandlerThread和IntentService源码解析</title>
    <url>/2019/02/24/HandlerThread%E5%92%8CIntentService%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread"></a>HandlerThread</h2><p>类如其名 类 = Handler + Thread.HandlerThread继承自Thread,且HandlerThread包含Handler成员变量。进入run（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mTid = Process.myTid();</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            mLooper = Looper.myLooper();</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Process.setThreadPriority(mPriority);</span><br><span class="line">        onLooperPrepared();</span><br><span class="line">        Looper.loop();</span><br><span class="line">        mTid = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在run()内创建了一个Looper，并开启了轮询，这注定了HandlerThread继承自Thread，毕竟主线程已经由了MainLooper,一个线程只能有一个Looper,否则就会抛出异常。此外run()是无限循环的，当明确不再使用HandlerThread时需要调用quit()或quitSafely()</p>
<h2 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h2><p>IntentService是继承于Service并处理异步请求的一个类。IntentService继承了Service且是一个抽象类，故必须创建其子类进行使用。<br>IntentService用于后台执行任务，执行完毕它就会自动停止.封装了HandlerThread和Handler的特殊Service。进入IntentService的onCreate()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> It would be nice to have an option to hold a partial wakelock</span></span><br><span class="line">        <span class="comment">// during processing, and to have a static startService(Context, Intent)</span></span><br><span class="line">        <span class="comment">// method that would launch the service &amp; hand off a wakelock.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"IntentService["</span> + mName + <span class="string">"]"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        mServiceLooper = thread.getLooper();</span><br><span class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>初始化HandlerThread.并用HandlerThread的Looper构造了mServiceHandler.mServiceHandler发送的消息最终会在HandlerThread中执行。故mServiceHandler始终运行在子线程。IntentService每启动一次，它就会调用onStartCommand()处理Intent.而onStartCommand（）又会调用.onStart()。<br>其实mServiceHandler可直接当成HandlerThread中的Handler。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(@Nullable Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">        msg.arg1 = startId;</span><br><span class="line">        msg.obj = intent;</span><br><span class="line">        mServiceHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>进入mServiceHandler的handleMessage()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            onHandleIntent((Intent)msg.obj);</span><br><span class="line">            stopSelf(msg.arg1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>onHandleIntent（）是一个抽象方法，需要我们自己在其中定义耗时操作。stopSelf（）会停止服务；如果存在多个后台任务。onHandlerIntent（）执行完最后一个才会调用stopSelf().每执行一个后台任务就需要启动一次IntentService。而IntentService则通过向HandlerThread发送消息执行任务。而HandlerThread中的Looper按顺序排队执行任务。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalIntentService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LocalIntentService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"sdd"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates an IntentService.  Invoked by your subclass's constructor.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> name Used to name the worker thread, important only for debugging.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LocalIntentService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(@Nullable Intent intent)</span> </span>&#123;</span><br><span class="line">    String action = intent.getAction();</span><br><span class="line">    Log.i(<span class="string">"TAG"</span>, <span class="string">"onHandleIntent: "</span> + action);</span><br><span class="line">    SystemClock.sleep(<span class="number">3000</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"night"</span>.equals(action)) &#123;</span><br><span class="line">      Log.i(<span class="string">"TAG"</span>, <span class="string">"handle "</span> + action);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Log.i(<span class="string">"TAG"</span>, <span class="string">"onDestroy: "</span>);</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_personal_view);</span><br><span class="line">    Intent service = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalIntentService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    service.setAction(<span class="string">"night"</span>);</span><br><span class="line">    startService(service);</span><br><span class="line">    service.setAction(<span class="string">"sdf"</span>);</span><br><span class="line">    startService(service);</span><br><span class="line">    service.setAction(<span class="string">",poop"</span>);</span><br><span class="line">    startService(service);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>线程</tag>
      </tags>
  </entry>
  <entry>
    <title>Bitmap的高效加载</title>
    <url>/2019/02/23/Bitmap%E7%9A%84%E9%AB%98%E6%95%88%E5%8A%A0%E8%BD%BD/</url>
    <content><![CDATA[<h2 id="降低加载Bitmap的内存"><a href="#降低加载Bitmap的内存" class="headerlink" title="降低加载Bitmap的内存"></a>降低加载Bitmap的内存</h2><p>一言以蔽之：加载Bitmap前将Bitmap压缩至ImageView大小。<br>实现：利用BitmapFactory.Options加载所需尺寸图片。通过BitmapFactory.Options来缩放图片，主要利用了他的inSampleSize参数，即采用率。当inSampleSize为1时，采样后的图片大小为原始图片的原始大小；当imSampleSize大于1时，比如为2，那么采样后的图片其宽/高均为原图大小的1/2，而像素为原图的1/4，其占有的内存大小也为原图的1/4.拿一张1024 <em> 1024像素的图片来说，假定采用ARGB8888格式存储，那么他占有的内存为1024</em>1024<em>4，即4MB，如果imSampleSIze为2，那么采样后的图片其内存占用只有512</em> 512 * 4，即1MB。可以发现采样率imSampleSize必须是大于1的整数才会有缩小的效果，并且采样率同时作用于宽、高，这导致缩放后的图片大小以采用率的2次方递减，即缩放比例为1/(imSamolSize的2次方)，比如inSamoleSize为4，那么缩放比例就是1/16。</p>
<p>获取采样率遵循如下流程：</p>
<p>1）将BitmapFactoryFactory.Optiobs的inJustDecodeBounds参数设为true并加载图片。（为了获取图片宽高）</p>
<p>2）从BitmapFactory.Options中取出图片的原始宽高信息，他们对应于outWidth和outHeight参数。</p>
<p>3）根据采样率的规则并结合目标View的所需大小计算出采样率inSampleSize.</p>
<p>4）将BirmipFactory.Options的inJustDecodeBounds参数设为false，然后重新加载图片。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Bitmap <span class="title">decodeSampledBitmapFromResource</span><span class="params">(Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">int</span> resId, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// First decode with inJustDecodeBounds=true to check dimensions</span></span><br><span class="line">     <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">     options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">     BitmapFactory.decodeResource(res, resId, options);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Calculate inSampleSize</span></span><br><span class="line">     options.inSampleSize = calculateInSampleSize(options, reqWidth,</span><br><span class="line">             reqHeight);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Decode bitmap with inSampleSize set</span></span><br><span class="line">     options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line">     <span class="keyword">return</span> BitmapFactory.decodeResource(res, resId, options);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculateInSampleSize</span><span class="params">(BitmapFactory.Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (reqWidth == <span class="number">0</span> || reqHeight == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Raw height and width of image</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> height = options.outHeight;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> width = options.outWidth;</span><br><span class="line">     Log.d(TAG, <span class="string">"origin, w= "</span> + width + <span class="string">" h="</span> + height);</span><br><span class="line">     <span class="keyword">int</span> inSampleSize = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (height &gt; reqHeight || width &gt; reqWidth) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">int</span> halfHeight = height / <span class="number">2</span>;</span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">int</span> halfWidth = width / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Calculate the largest inSampleSize value that is a power of 2 and</span></span><br><span class="line">         <span class="comment">// keeps both</span></span><br><span class="line">         <span class="comment">// height and width larger than the requested height and width.</span></span><br><span class="line">         <span class="keyword">while</span> ((halfHeight / inSampleSize) &gt;= reqHeight</span><br><span class="line">                 &amp;&amp; (halfWidth / inSampleSize) &gt;= reqWidth) &#123;</span><br><span class="line">             inSampleSize *= <span class="number">2</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Log.d(TAG, <span class="string">"sampleSize:"</span> + inSampleSize);</span><br><span class="line">     <span class="keyword">return</span> inSampleSize;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>二叉搜索树转换双向链表</title>
    <url>/2019/02/23/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E8%BD%AC%E6%8D%A2%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="输入一棵二叉搜索树，现在要将该二叉搜索树转换成一个排序的双向链表。而且在转换的过程中，不能创建任何新的结点，只能调整树中的结点指针的指向来实现。"><a href="#输入一棵二叉搜索树，现在要将该二叉搜索树转换成一个排序的双向链表。而且在转换的过程中，不能创建任何新的结点，只能调整树中的结点指针的指向来实现。" class="headerlink" title="输入一棵二叉搜索树，现在要将该二叉搜索树转换成一个排序的双向链表。而且在转换的过程中，不能创建任何新的结点，只能调整树中的结点指针的指向来实现。"></a>输入一棵二叉搜索树，现在要将该二叉搜索树转换成一个排序的双向链表。而且在转换的过程中，不能创建任何新的结点，只能调整树中的结点指针的指向来实现。</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><p>Input:<br><img src="/images/AVL.jpg" alt="enter description here"><br>Output:<br><img src="/images/B_T_D.jpg" alt="enter description here"></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　采用分治的思想，假设根节点的左右子树已被排成了双向链表，只需要把根节点left指针指向左子树所构成的双向链表末尾节点leftLast（即中序遍历左子树的最后一个节点）。若leftLast非空则leftLast.right = root.<br>  右子树操作类似。找到右子树的中序遍历的第一个节点root .right = rightFirst; 若rightFirst非空则rightFirst.left = root;<br>  此外一个值得注意的问题是Java中的拷贝问题。在记录左右侧中序遍历最后一个节点和第一个节点时。在函数调用后，leftLast仍旧为空。事实上root.left != null..下一篇博文会给出答案。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TreeNode mLastNode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val;</span><br><span class="line">        TreeNode left;</span><br><span class="line">        TreeNode right;</span><br><span class="line"></span><br><span class="line">        TreeNode(<span class="keyword">int</span> x) &#123;</span><br><span class="line">            val = x;</span><br><span class="line">            left = <span class="keyword">null</span>;</span><br><span class="line">            right = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">convert</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line">        mLastNode = <span class="keyword">null</span>;</span><br><span class="line">        convertNode(root);</span><br><span class="line"></span><br><span class="line">        root = mLastNode;</span><br><span class="line">        <span class="keyword">while</span> (root != <span class="keyword">null</span> &amp;&amp; root.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">            root = root.left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">convertNode</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">            convertNode(root.left);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        root.left = mLastNode;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLastNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mLastNode.right = root;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLastNode = root;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">            convertNode(root.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TreeNode root = <span class="keyword">new</span> TreeNode(<span class="number">2</span>);</span><br><span class="line">        root.left = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">        root.right = <span class="keyword">new</span> TreeNode(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">new</span> Solution().convert(root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>对象拷贝</title>
    <url>/2019/02/23/%E5%AF%B9%E8%B1%A1%E6%8B%B7%E8%B4%9D/</url>
    <content><![CDATA[<h2 id="对象拷贝"><a href="#对象拷贝" class="headerlink" title="对象拷贝"></a>对象拷贝</h2><p>对象拷贝(Object Copy)就是将一个对象的属性拷贝到另一个有着相同类类型的对象中去。在程序中拷贝对象是很常见的，主要是为了在新的上下文环境中复用对象的部分或全部数据。Java中有三种类型的对象拷贝：浅拷贝(Shallow Copy)、深拷贝(Deep Copy)、延迟拷贝(Lazy Copy)。</p>
<h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><p>浅拷贝是按位拷贝对象，它会创建一个新对象，这个对象有着原始对象属性值的一份精确拷贝。如果属性是基本类型，拷贝的就是基本类型的值；如果属性是内存地址（引用类型），拷贝的就是内存地址 ，因此如果其中一个对象改变了这个地址，就会影响到另一个对象。<br><img src="/images/shallow_copy.png" alt="enter description here"><br>在上图中，SourceObject有一个int类型的属性 “field1”和一个引用类型属性”refObj”（引用ContainedObject类型的对象）。当对SourceObject做浅拷贝时，创建了CopiedObject，它有一个包含”field1”拷贝值的属性”field2”以及仍指向refObj本身的引用。由于”field1”是基本类型，所以只是将它的值拷贝给”field2”，但是由于”refObj”是一个引用类型, 所以CopiedObject指向”refObj”相同的地址。因此对SourceObject中的”refObj”所做的任何改变都会影响到CopiedObject。<br>实现浅拷贝：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123; </span><br><span class="line">   <span class="comment">// 对象引用 </span></span><br><span class="line">   <span class="keyword">private</span> Subject subj; </span><br><span class="line">   <span class="keyword">private</span> String name; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String s, String sub)</span> </span>&#123; </span><br><span class="line">      name = s; </span><br><span class="line">      subj = <span class="keyword">new</span> Subject(sub); </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> Subject <span class="title">getSubj</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> subj; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> name; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String s)</span> </span>&#123; </span><br><span class="line">      name = s; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="comment">/** </span></span><br><span class="line"><span class="comment">    *  重写clone()方法 </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">    */</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      <span class="comment">//浅拷贝 </span></span><br><span class="line">      <span class="keyword">try</span> &#123; </span><br><span class="line">         <span class="comment">// 直接调用父类的clone()方法</span></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">super</span>.clone(); </span><br><span class="line">      &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123; </span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">      &#125; </span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h3><p>深拷贝会拷贝所有的属性,并拷贝属性指向的动态分配的内存。当对象和它所引用的对象一起拷贝时即发生深拷贝。深拷贝相比于浅拷贝速度较慢并且花销较大。<br><img src="/images/Deep_copy.png" alt="enter description here"><br>实现深拷贝：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123; </span><br><span class="line">   <span class="comment">// 对象引用 </span></span><br><span class="line">   <span class="keyword">private</span> Subject subj; </span><br><span class="line">   <span class="keyword">private</span> String name; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String s, String sub)</span> </span>&#123; </span><br><span class="line">      name = s; </span><br><span class="line">      subj = <span class="keyword">new</span> Subject(sub); </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> Subject <span class="title">getSubj</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> subj; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> name; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String s)</span> </span>&#123; </span><br><span class="line">      name = s; </span><br><span class="line">   &#125; </span><br><span class="line">   <span class="comment">/** </span></span><br><span class="line"><span class="comment">    * 重写clone()方法 </span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">    */</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      <span class="comment">// 深拷贝，创建拷贝类的一个新对象，这样就和原始对象相互独立</span></span><br><span class="line">      Student s = <span class="keyword">new</span> Student(name, subj.getName()); </span><br><span class="line">      <span class="keyword">return</span> s; </span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="对象和对象的引用"><a href="#对象和对象的引用" class="headerlink" title="对象和对象的引用"></a>对象和对象的引用</h2><p>对象一般存储在堆中，而引用存储在速度更快的堆栈中。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> passengers;      </span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> fuelcap;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> mpg;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用这个类创建对象，   Vehicle veh1 = new Vehicle();<br>上述操作分为四步</p>
<ol>
<li>“new Vehicle”，是以Vehicle类为模板，在堆空间里创建一个Vehicle对象</li>
<li>末尾的()意味着，在对象创建后，立即调用Vehicle类的构造函数，对刚生成的对象进行初始化。</li>
<li>左边的“Vehicle veh 1”在栈内创建了一个Vehicle类引用变量。所谓Vehicle类引用，就是可以用来指向Vehicle对象的对象引用。</li>
<li>=”操作符使对象引用指向刚创建的那个Vehicle对象。</li>
</ol>
<p>上述操作等价于Vehicle veh1; veh1 = new Vehicle();</p>
<p>那么 Vehicle veh2；  veh2 = veh1;首先创建一个Vehicle对象引用vehicle，然后将veh1引用复制给veh2引用。veh2就指向veh1所指向的对象。那么问题是第一个new Vehicle对象呢？它已成为垃圾回收机制的处理对象。至于什么时候真正被回收，那要看垃圾回收机制的心情了。</p>
<h2 id="引用引发的问题"><a href="#引用引发的问题" class="headerlink" title="引用引发的问题"></a>引用引发的问题</h2><p>回到上篇博文的问题，首先为了简化理解用String进行等价替换复现问题。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">app</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">       String str = <span class="string">"sdf"</span>;</span><br><span class="line">       s = str;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       String s = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">new</span> Solution().app(s);</span><br><span class="line">       System.out.println(s);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>猜猜输出是什么？sdf吗？天真。还是null.<br>真是哔了。。为囊子呢？这个就是因为引用引发的问题。<br>用图来说明。<br>开始传参后，创建了S(形)引用并指向null关键字。<br><img src="/images/copy_start.PNG" alt="enter description here"><br>执行S(形) = str后<br><img src="/images/copy_then.PNG" alt="enter description here"><br>可以看出执行 S(形) = str 操作后， S(形）引用指向了“sdf”。而S(实)仍坚定的指向null。=号操作会复制引用，S(形)会指向str所指向的对象。<br>在JAVA里，“=”不能被看成是一个赋值语句，它不是在把一个对象赋给另外一个对象，它的执行过程实质上是将右边对象的地址传给了左边的引用，使得左边的引用指向了右边的对象。JAVA表面上看起来没有指针，但它的引用其实质就是一个指针，引用里面存放的并不是对象，而是该对象的地址，使得该引用指向了对象。在JAVA里，“=”语句不应该被翻译成赋值语句，因为它所执行的确实不是一个赋值的过程，而是一个传地址的过程，被译成赋值语句会造成很多误解，译得不准确。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Java传参的问题，并且它的标准答案是Java只有一种参数传递方式：那就是按值传递，即Java中传递任何东西都是传值。如果传入方法的是基本类型的东西，你就得到此基本类型的一份拷贝。如果是传递引用，就得到引用的拷贝。</p>
]]></content>
      <categories>
        <category>Java编程思想</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>二叉树中和为某一特定值的路径</title>
    <url>/2019/02/22/%E4%BA%8C%E5%8F%89%E6%A0%91%E4%B8%AD%E5%92%8C%E4%B8%BA%E6%9F%90%E4%B8%80%E7%89%B9%E5%AE%9A%E5%80%BC%E7%9A%84%E8%B7%AF%E5%BE%84/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="题目：输入一棵二叉树和一个整数-打印出二叉树中结点值的和为输入整数的所有路径-从树的根结点开始往下一直到叶结点所经过的结点形成一条路径"><a href="#题目：输入一棵二叉树和一个整数-打印出二叉树中结点值的和为输入整数的所有路径-从树的根结点开始往下一直到叶结点所经过的结点形成一条路径" class="headerlink" title="题目：输入一棵二叉树和一个整数,打印出二叉树中结点值的和为输入整数的所有路径.从树的根结点开始往下一直到叶结点所经过的结点形成一条路径."></a>题目：输入一棵二叉树和一个整数,打印出二叉树中结点值的和为输入整数的所有路径.从树的根结点开始往下一直到叶结点所经过的结点形成一条路径.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:</span><br><span class="line">          <span class="number">1</span></span><br><span class="line">      /         \</span><br><span class="line">	  <span class="number">2</span>          <span class="number">3</span></span><br><span class="line">       \</span><br><span class="line">        <span class="number">5</span>                       ,        <span class="number">8</span></span><br><span class="line">Output:[<span class="string">"1-&gt;2-&gt;5"</span>]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　采用递归的方法，在字符串中处理-&gt;注意可以先增加数字，再当左子树或右子树不为空时，增加-&gt;.</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">binaryTreePaths</span><span class="params">(TreeNode root, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binaryTreepath(list, root, <span class="string">""</span>, <span class="number">0</span>, sum);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binaryTreepath</span><span class="params">(List&lt;String&gt; list, TreeNode root, String s, <span class="keyword">int</span> curSum, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    curSum += root.val;</span><br><span class="line">    s += root.val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">        binaryTreepath(list, root.left, s + <span class="string">"-&gt;"</span>, curSum, sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (root.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">        binaryTreepath(list, root.right, s + <span class="string">"-&gt;"</span>, curSum, sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (root.left == <span class="keyword">null</span> &amp;&amp; root.right == <span class="keyword">null</span> &amp;&amp; curSum == sum) &#123;</span><br><span class="line">        list.add(s);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>Valid  sequence of Binary Tree‘s post order</title>
    <url>/2019/02/21/Valid%20%20sequence%20of%20Binary%20Tree%E2%80%98s%20post%20order/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="输入一个整形数组，判断该数组是不是某二叉搜索树的后序遍历的结果。如果是则返回true-否则返回false-假设输入的数组的数字都不相同"><a href="#输入一个整形数组，判断该数组是不是某二叉搜索树的后序遍历的结果。如果是则返回true-否则返回false-假设输入的数组的数字都不相同" class="headerlink" title="输入一个整形数组，判断该数组是不是某二叉搜索树的后序遍历的结果。如果是则返回true,否则返回false.假设输入的数组的数字都不相同"></a>输入一个整形数组，判断该数组是不是某二叉搜索树的后序遍历的结果。如果是则返回true,否则返回false.假设输入的数组的数字都不相同</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:&#123;<span class="number">5</span>，<span class="number">7</span>，<span class="number">6</span>，<span class="number">9</span>，<span class="number">11</span>，<span class="number">10</span>，<span class="number">8</span>&#125;</span><br><span class="line">output:<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input:&#123;<span class="number">4</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="number">7</span>&#125;</span><br><span class="line">output: <span class="keyword">false</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>在后序遍历得到的序列中，最后一个数字是树的根结点的值。数组中前面的数字可以分为两部分：第一部分是左子树结点的值，它们都比根结点的值小；第二部分是右子树结点的值，它们都比根结点的值大。 以数组{5，7，6，9，11，10，8）为例，后序遍历结果的最后一个数字8就是根结点的值。在这个数组中，前3个数字5、7和6都比8小，是值为8的结点的左子树结点；后3个数字9、11和10都比8大，是值为8的结点的右子树结点。 我们接下来用同样的方法确定与数组每一部分对应的子树的结构。这其实就是一个递归的过程。再来分析另一个整数数组{4，8，1，7）。后序遍历的最后一个数是根结点，因此根结点的值是7。故左子树为4，右子树的根节点为1.不大于7故返回false.</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifySequenceOfBST</span><span class="params">(<span class="keyword">int</span>[] sequence, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sequence == <span class="keyword">null</span> || low &gt; high) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sequence.length == <span class="number">0</span> || high == low) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> root = sequence[high - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = low; i &lt; high - <span class="number">1</span>; i++) &#123;<span class="comment">//Remember to exclude the last one root node</span></span><br><span class="line">        <span class="keyword">if</span> (sequence[i] &gt; root) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = i; j &lt; high - <span class="number">1</span>; j++) &#123;<span class="comment">//Remember to exclude the last one root node</span></span><br><span class="line">        <span class="keyword">if</span> (sequence[j] &lt; root) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> left = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt; low) &#123;<span class="comment">//Remember to exclude the last one root node</span></span><br><span class="line">        left = verifySequenceOfBST(sequence, low, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> right = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; high - <span class="number">1</span>) &#123;<span class="comment">//Remember to exclude the last one root node</span></span><br><span class="line">        right = verifySequenceOfBST(sequence, i, high - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> left &amp;&amp; right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>剑指Offer</tag>
      </tags>
  </entry>
  <entry>
    <title>View的工作原理</title>
    <url>/2019/02/21/View%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="ViewRoot和DecorView之间的交易"><a href="#ViewRoot和DecorView之间的交易" class="headerlink" title="ViewRoot和DecorView之间的交易"></a>ViewRoot和DecorView之间的交易</h2><p>ViewRoot对应于ViewRootImpl类，它是连接Window和DecorView（FrameLayout）的纽带，View的三大流程是通过VeiwRoot来完成的。在ActivityThread中，当Activity对象被创建完毕后，会将DecorVeiw添加到Window中，同时会创建ViewRootImpl对象，并将ViewRootImpl对象和DecorView建立关联。</p>
<p>View的绘制流程是从ViewRoot的performTraversals方法开始的，它经过measure、layout和draw三个过程才能最终将一个View绘制出来。如图：<br><img src="/images/performTraversals.png" alt="enter description here"><br>performTraversals会依次调用performMeasure、performLayout、performDraw三个方法，这个三个方法分别完成顶级View的measure、layout、draw这三大方法，performMeasure调用measure(),measure()调用onMeasure().在onMeasure方法中则会对所有的子元素进行measure过程，这个时候measure流程就从父容器传递到子元素中了，这样就完成一次measure过程，接着子元素会重复父容器的过程，如此反复就完成了整个View树的遍历。同理，其他两个步骤也是类似的过程。</p>
<p>measure过程决定了View的宽和高，Measure完成以后，可以通过getMeasureWidth和getMeasureHeight方法来获取到View的测量后的宽和高。</p>
<h2 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h2><p>MeasureSpec:测量规格，在很大程度上决定了一个View的尺寸规格，之所以说是很大程度上是因为这个过程还是受父容器的影响，因为父容器影响View的MeasureSpec的创建过程。在测量过程中，系统会将View的LayoutParams根据父容器所施加的规则转换成对应的MeasureSpec，然后再根据这个measureSpec来测量出View的宽和高。</p>
<p>MeasureSpec代表一个32位int值，高2位代表SpecMode，低30位代表SpecSize，SpecMode是指测量模式，而SpecSize是指在某种测量模式下的规格大小。MeasureSpec通过将SpecMode（int）和SpecSize(int)打包成一个int值来避免过多的对象内存分配，为了方便操作，其提供了打包和解包的方法。</p>
<h3 id="SpecMode"><a href="#SpecMode" class="headerlink" title="SpecMode"></a>SpecMode</h3><ul>
<li><strong>Exactly</strong>: 父容器已经检测出View所需要的精确大小，这个时候View的最终大小就是SpecSize所指定的值。它对应于LayoutParams中的match_parent和具体的数值这两种模式。</li>
<li><strong>AT_MOST</strong>:父容器指定了一个可用大小即SpecSize，View的大小不能大于这个值，具体是什么值要看不同的View的具体实现。它对应于LayoutParams中的wrap_content。</li>
<li><strong>UNSPECIFIED</strong>:不指定大小测量模式 View任意大小，通常在自定义View时会使用。</li>
</ul>
<p>当View采用固定宽/高的时候，不管父容器的MeasureSpec是什么，View的MeasureSpec都是EXACTLY模式并且大小遵循LayoutParams中的大小</p>
<p>当View的宽/高是match_parent时，如果父容器的模式是EXACTLY，那么View也是精确模式并且其大小是父容器的剩余空间，如果父容器是最大模式，那么View也是最大模式并且其大小不会超过父容器的剩余空间</p>
<p>当View的宽/高是wrap_content时，不管父容器的模式是精确还是最大化，View的模式总是最大化并且大小不能超过父容器的剩余空间。</p>
<h3 id="MeasureSpec与layoutParams关系"><a href="#MeasureSpec与layoutParams关系" class="headerlink" title="MeasureSpec与layoutParams关系"></a>MeasureSpec与layoutParams关系</h3><ul>
<li>DecorView: MeasureSpec是由窗口的尺寸和其自身的LayoutParams确定</li>
<li>普通View:MeasureSpec是由父容器的MeasureSpec和自身的LayoutParams共同确定。</li>
</ul>
<h2 id="View的工作流程"><a href="#View的工作流程" class="headerlink" title="View的工作流程"></a>View的工作流程</h2><p>View的工作流程主要是指measure、layout、draw这三大流程，即测量、布局、绘制，其中measure确定View的测量宽高，layout确定View的最终宽高和四个顶点的位置，而draw则将View绘制到屏幕上。</p>
<h3 id="measure过程"><a href="#measure过程" class="headerlink" title="measure过程"></a>measure过程</h3><p>一个原始的View，那么通过measure方法就完成了其测量过程，如果是一个ViewGroup，除了完成自己的测量过程外，还会遍历去调用所有子元素的measure方法，各个子元素再递归去执行这个流程。</p>
<h4 id="View的measure"><a href="#View的measure" class="headerlink" title="View的measure()"></a>View的measure()</h4><p>View的measure过程由其measure()完成，measure()是一个final方法（不能被子类重写）。measure()中会调用onMeasure()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">                getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = size;</span><br><span class="line">        <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">        <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">            result = size;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">            result = specSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>getDefaultSize方法返回的大小就是MeasureSpec中的specSize，而这个specSize就是View测量后的大小，但View的最终大小是在layout阶段确定的，几乎所有情况下的View的测量大小和最终大小是相等的。</p>
<p>同时，直接继承View的自定义控件需要重写onMeasure方法并设置wrap_content时的自身大小，否则在布局中使用wrap_content就相当于使用match_parent。如果View在布局中使用wrap_content，那么它的specMode是AT_MOST模式，在这种模式下，它的宽/高等于specSize，也就是说，这种情况下的View的specSize是parentSize，而parentSize是父容器中目前当前剩余使用的大小，也就是父容器当前剩余的空间大小。<br>TextView、ImageView等解决方法是重写onMeasure()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">     <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">     <span class="keyword">int</span> widthSpecSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">     <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">     <span class="keyword">int</span> heightSpecSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">     <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; heightSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">         setMeasuredDimension(<span class="number">200</span>, <span class="number">200</span>);<span class="comment">//Default width and height</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">         setMeasuredDimension(<span class="number">200</span>, heightSpecSize);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">         setMeasuredDimension(widthSpecSize, <span class="number">200</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="ViewGroup的measure"><a href="#ViewGroup的measure" class="headerlink" title="ViewGroup的measure"></a>ViewGroup的measure</h4><p>ViewGroup是一个抽象类，因此它没有重写View的onMeasure方法，但是它提供了一个叫measureChildren的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> size = mChildrenCount;</span><br><span class="line">       <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">           <span class="keyword">final</span> View child = children[i];</span><br><span class="line">           <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;</span><br><span class="line">               measureChild(child, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChild</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec,<span class="keyword">int</span> parentHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> LayoutParams lp = child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,mPaddingLeft + mPaddingRight, lp.width);</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,mPaddingTop + mPaddingBottom, lp.height);</span><br><span class="line"></span><br><span class="line">       child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>measureChild的思想就是取出子元素的LayoutParams，结合父容器的MeasureSpec共同确定子View的MeasureSpec.ViewGroup并未定义onMeasure(),因为不同ViewGroup如LinearLayout与FrameLayout有不同的布局特性。不同布局需要实现自己的onMeasure()具体测量方法。</p>
<ul>
<li>在View中正确的获得View的测量宽高：onLayout()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">  view.getMeasuredWidth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Activity中获取View的宽和高：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.onWindowFocusChanged(hasFocus);</span><br><span class="line">  <span class="keyword">if</span> (hasFocus) &#123;</span><br><span class="line">    <span class="keyword">int</span> width = view.getMeasuredWidth();</span><br><span class="line">    <span class="keyword">int</span> height = view.getMeasuredHeight();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="layout过程"><a href="#layout过程" class="headerlink" title="layout过程"></a>layout过程</h3><p>Layout的作用是ViewGroup用来确定子元素的位置，当ViewGroup的位置被确定后，它在onLayout中会遍历所有的子元素并调用其layout方法，在layout方法中onLayout方法又会被调用。先看下View中的layout方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">        onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</span><br><span class="line">        mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldL = mLeft;</span><br><span class="line">    <span class="keyword">int</span> oldT = mTop;</span><br><span class="line">    <span class="keyword">int</span> oldB = mBottom;</span><br><span class="line">    <span class="keyword">int</span> oldR = mRight;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</span><br><span class="line">            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">        onLayout(changed, l, t, r, b);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldDrawRoundScrollbar()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(mRoundScrollbarRenderer == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mRoundScrollbarRenderer = <span class="keyword">new</span> RoundScrollbarRenderer(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mRoundScrollbarRenderer = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</span><br><span class="line"></span><br><span class="line">        ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</span><br><span class="line">                    (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</span><br><span class="line">            <span class="keyword">int</span> numListeners = listenersCopy.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">    mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">        mPrivateFlags3 &amp;= ~PFLAG3_NOTIFY_AUTOFILL_ENTER_ON_LAYOUT;</span><br><span class="line">        notifyEnterOrExitForAutoFillIfNeeded(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>layout方法的大致流程：首先会通过setFrame方法来设定View的四个顶点的位置，即初始化mLeft、mRight、mTop和mBottom这四个值，View的四个顶点一旦确定，那么View在父容器中的位置也就确定了，接着就会调用onLayout方法，这个方法用途是父容器确定子元素的位置，和onMeasure方法类似，onLayout的具体实现同样和具体的布局有关，所以View和ViewGroup均没有真正实现onLayout方法。</p>
<p>关于getMeasuredWIdth()和getWidth()差异：在最终情况即在测量完毕后，是相同的。但在测量过程中可能不同。</p>
<h3 id="draw过程"><a href="#draw过程" class="headerlink" title="draw过程"></a>draw过程</h3><ol>
<li>绘制背景background.draw(canvas)</li>
<li>绘制自己(onDraw)</li>
<li>绘制children(dispatchDraw)</li>
<li>绘制装饰(onDrawScrollBars)<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClipBounds != <span class="keyword">null</span>) &#123;</span><br><span class="line">            canvas.clipRect(mClipBounds);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</span><br><span class="line">                (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</span><br><span class="line">        mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Draw traversal performs several drawing steps which must be executed</span></span><br><span class="line"><span class="comment">         * in the appropriate order:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *      1. Draw the background</span></span><br><span class="line"><span class="comment">         *      2. If necessary, save the canvas' layers to prepare for fading</span></span><br><span class="line"><span class="comment">         *      3. Draw view's content</span></span><br><span class="line"><span class="comment">         *      4. Draw children</span></span><br><span class="line"><span class="comment">         *      5. If necessary, draw the fading edges and restore layers</span></span><br><span class="line"><span class="comment">         *      6. Draw decorations (scrollbars for instance)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 1, draw the background, if needed</span></span><br><span class="line">        <span class="keyword">int</span> saveCount;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) &#123;</span><br><span class="line">         ...</span><br><span class="line">                <span class="keyword">if</span> ((scrollX | scrollY) == <span class="number">0</span>) &#123;</span><br><span class="line">                    background.draw(canvas);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    canvas.translate(scrollX, scrollY);</span><br><span class="line">                    background.draw(canvas);</span><br><span class="line">                    canvas.translate(-scrollX, -scrollY);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</span><br><span class="line">        <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</span><br><span class="line">            <span class="comment">// Step 3, draw the content</span></span><br><span class="line">            <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Step 4, draw the children</span></span><br><span class="line">            dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Step 6, draw decorations (scrollbars)</span></span><br><span class="line">            onDrawScrollBars(canvas);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">                mOverlay.getOverlayView().dispatchDraw(canvas);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// we're done...</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View的工作原理</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义View</title>
    <url>/2019/02/21/%E8%87%AA%E5%AE%9A%E4%B9%89View/</url>
    <content><![CDATA[<h2 id="自定义View的分类"><a href="#自定义View的分类" class="headerlink" title="自定义View的分类"></a>自定义View的分类</h2><ol>
<li>继承View重写onDraw方法。这种方法主要用于实现一些不规则的效果，即这种效果不方便通过布局的组合方式来达到，往往需要静态或者动态地显示一些不规则的图形。这种方式需要重写onDraw方法，同时需要自己支持wrap_content，并且padding也需要自己处理。</li>
<li>继承ViewGroup派生特殊的Layout。这种方法主要用于实现自定义的布局。需要处理ViewGroup和子View的测量和布局。</li>
<li>继承特定的View(比如TextView)。这种方法比较常见，一般是用于扩展某种已有的View的功能，比如TextView。</li>
<li>继承特定的ViewGroup(比如LinearLayout)。这种效果看起来很像几种View组合在一起的时候，可以采用这种方法实现，不用处理ViewGroup的测量和布局。</li>
</ol>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li>让View支持wrap_content.在onMeasure()中对MeasureSpec.AT_MOST进行处理</li>
<li>如果有必要，让你的View支持padding。在onDraw（）中考虑padding.</li>
<li>尽量不要在View中使用Handler，View.post（）可替代</li>
<li>View中如果有线程或者动画，需要及时在View#onDetachedFromWindow停止</li>
<li>View带有滑动嵌套情形时，需要处理好滑动冲突</li>
</ol>
<h2 id="继承View重写onDraw方法"><a href="#继承View重写onDraw方法" class="headerlink" title="继承View重写onDraw方法"></a>继承View重写onDraw方法</h2><p>实例. CircleView:wrap_content与padding适配<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mColor = Color.RED;</span><br><span class="line">  <span class="keyword">private</span> Paint mPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CircleView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CircleView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CircleView</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.CircleView);</span><br><span class="line">    mColor = a.getColor(R.styleable.CircleView_circle_color, Color.RED);</span><br><span class="line">    a.recycle();</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CircleView</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes);</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mPaint.setColor(mColor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> paddingLeft = getPaddingLeft();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> paddingRight = getPaddingRight();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> paddingTop = getPaddingTop();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> paddingBottom = getPaddingBottom();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> width = getWidth() - paddingLeft - paddingRight;</span><br><span class="line">    <span class="keyword">int</span> height = getHeight() - paddingBottom - paddingTop;</span><br><span class="line">    <span class="keyword">int</span> radius = Math.min(width, height) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    canvas.drawCircle(paddingLeft + width / <span class="number">2</span>, paddingTop + height / <span class="number">2</span>, radius, mPaint);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; heightSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">      setMeasuredDimension(<span class="number">200</span>, <span class="number">200</span>);<span class="comment">//Default width and height</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">      setMeasuredDimension(<span class="number">200</span>, heightSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">      setMeasuredDimension(widthSize, <span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.hdu.night.scrollconflicts.CircleView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_margin</span>=<span class="string">"20dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:padding</span>=<span class="string">"20dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:background</span>=<span class="string">"#000000"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">app:circle_color</span>=<span class="string">"@color/colorPrimary"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">//attrs.xml</span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"CircleView"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"circle_color"</span> <span class="attr">format</span>=<span class="string">"color"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="继承特定的ViewGroup派生特殊的Layout"><a href="#继承特定的ViewGroup派生特殊的Layout" class="headerlink" title="继承特定的ViewGroup派生特殊的Layout"></a>继承特定的ViewGroup派生特殊的Layout</h2><p>实例2. HorizontalViewEx再回顾：onMeasure() + onDraw()<br>先假设所有子View都是等宽高的。</p>
<h3 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure()"></a>onMeasure()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> measuredWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> measuredHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    measureChildren(widthMeasureSpec, heightMeasureSpec);<span class="comment">////measure all children view width and height.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> widthSpaceSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpaceSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;<span class="comment">// If ViewGroup has not  child, the size of viewGroup will be 0  </span></span><br><span class="line">      setMeasuredDimension(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; heightSpecMode == MeasureSpec.AT_MOST) &#123;<span class="comment">//Handle wrap_content</span></span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(<span class="number">0</span>);</span><br><span class="line">      measuredWidth = childView.getMeasuredWidth() * childCount;</span><br><span class="line">      measuredHeight = childView.getMeasuredHeight();</span><br><span class="line">      setMeasuredDimension(measuredWidth, measuredHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(<span class="number">0</span>);</span><br><span class="line">      measuredWidth = childView.getMeasuredWidth() * childCount;</span><br><span class="line">      setMeasuredDimension(measuredWidth, heightSpaceSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(heightSpecMode == MeasureSpec.AT_MOST)&#123;</span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(<span class="number">0</span>);</span><br><span class="line">      measuredHeight = childView.getMeasuredHeight();</span><br><span class="line">      setMeasuredDimension(widthSpaceSize, measuredHeight);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="onLayout"><a href="#onLayout" class="headerlink" title="onLayout()"></a>onLayout()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> childLeft = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    mChildrenSize = childCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;<span class="comment">//Traverse all child and put them at a right place</span></span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(i);</span><br><span class="line">      <span class="keyword">if</span> (childView.getVisibility() != View.GONE) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childWidth = childView.getMeasuredWidth();</span><br><span class="line">        mChildWidth = childWidth;</span><br><span class="line">        childView.layout(childLeft, <span class="number">0</span>, childLeft + childWidth,</span><br><span class="line">            childView.getMeasuredHeight());<span class="comment">//(l,t,r,b)</span></span><br><span class="line">        childLeft += childWidth;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View的工作原理</tag>
      </tags>
  </entry>
  <entry>
    <title>View的滑动冲突</title>
    <url>/2019/02/18/View%E7%9A%84%E6%BB%91%E5%8A%A8%E5%86%B2%E7%AA%81/</url>
    <content><![CDATA[<h2 id="外部滑动与内部滑动不一致"><a href="#外部滑动与内部滑动不一致" class="headerlink" title="外部滑动与内部滑动不一致"></a>外部滑动与内部滑动不一致</h2><p>如在HorizontalScrollView中嵌套RecycleView.</p>
<h3 id="外部拦截法"><a href="#外部拦截法" class="headerlink" title="外部拦截法"></a>外部拦截法</h3><p>外部拦截就是点击事件先经过父容器的拦截处理，如果父容器需要此事件就拦截，如果不需要就不拦截。<br> 外部拦截法需要重写父容器的onInterceptTouchEvent（）方法。<br> 伪代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"><span class="keyword">boolean</span> intercepted=<span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">int</span> x= (<span class="keyword">int</span>) event.getX();</span><br><span class="line"><span class="keyword">int</span> y= (<span class="keyword">int</span>) event.getY();</span><br><span class="line"><span class="keyword">switch</span> (event.getAction())&#123;</span><br><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">intercepted=<span class="keyword">false</span>;<span class="comment">//必须不能拦截，否则后续的ACTION_MOME和ACTION_UP事件都会拦截。</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line"><span class="keyword">if</span> (父容器需要当前点击事件)&#123;</span><br><span class="line">intercepted=<span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">intercepted=<span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">intercepted=<span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">mLastXIntercept=x;</span><br><span class="line">mLastXIntercept=y;</span><br><span class="line"><span class="keyword">return</span> intercepted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实例：重写HorizontalScrollView<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.MotionEvent;</span><br><span class="line"><span class="keyword">import</span> android.view.VelocityTracker;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.Scroller;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by night on 2019/2/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HorizontalScrollViewEx</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"HorizontalScrollViewEx"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mChildrenSize;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mChildWidth;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mChildIndex;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分别记录上次滑动的坐标</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mLastX = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mLastY = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 分别记录上次滑动的坐标(onInterceptTouchEvent)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mLastXIntercept = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mLastYIntercept = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Scroller mScroller;</span><br><span class="line">  <span class="keyword">private</span> VelocityTracker mVelocityTracker;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HorizontalScrollViewEx</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HorizontalScrollViewEx</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, attrs);</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HorizontalScrollViewEx</span><span class="params">(Context context, AttributeSet attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">    init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mScroller = <span class="keyword">new</span> Scroller(getContext());</span><br><span class="line">    mVelocityTracker = VelocityTracker.obtain();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> intercepted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</span><br><span class="line">        intercepted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mScroller.isFinished()) &#123;</span><br><span class="line">          mScroller.abortAnimation();</span><br><span class="line">          intercepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">        <span class="keyword">int</span> deltaX = x - mLastXIntercept;</span><br><span class="line">        <span class="keyword">int</span> deltaY = y - mLastYIntercept;</span><br><span class="line">        <span class="keyword">if</span> (Math.abs(deltaX) &gt; Math.abs(deltaY)) &#123;</span><br><span class="line">          intercepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          intercepted = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</span><br><span class="line">        intercepted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log.d(TAG, <span class="string">"intercepted="</span> + intercepted);</span><br><span class="line">    mLastX = x;</span><br><span class="line">    mLastY = y;</span><br><span class="line">    mLastXIntercept = x;</span><br><span class="line">    mLastYIntercept = y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> intercepted;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    mVelocityTracker.addMovement(event);</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line">    <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mScroller.isFinished()) &#123;</span><br><span class="line">          mScroller.abortAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">        <span class="keyword">int</span> deltaX = x - mLastX;</span><br><span class="line">        <span class="keyword">int</span> deltaY = y - mLastY;</span><br><span class="line">        scrollBy(-deltaX, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</span><br><span class="line">        <span class="keyword">int</span> scrollX = getScrollX();</span><br><span class="line">        <span class="keyword">int</span> scrollToChildIndex = scrollX / mChildWidth;</span><br><span class="line">        mVelocityTracker.computeCurrentVelocity(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">float</span> xVelocity = mVelocityTracker.getXVelocity();</span><br><span class="line">        <span class="keyword">if</span> (Math.abs(xVelocity) &gt;= <span class="number">50</span>) &#123;</span><br><span class="line">          mChildIndex = xVelocity &gt; <span class="number">0</span> ? mChildIndex - <span class="number">1</span> : mChildIndex + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          mChildIndex = (scrollX + mChildWidth / <span class="number">2</span>) / mChildWidth;</span><br><span class="line">        &#125;</span><br><span class="line">        mChildIndex = Math.max(<span class="number">0</span>, Math.min(mChildIndex, mChildrenSize - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">int</span> dx = mChildIndex * mChildWidth - scrollX;</span><br><span class="line">        smoothScrollBy(dx, <span class="number">0</span>);</span><br><span class="line">        mVelocityTracker.clear();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLastX = x;</span><br><span class="line">    mLastY = y;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> measuredWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> measuredHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    measureChildren(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> widthSpaceSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpaceSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</span><br><span class="line">      setMeasuredDimension(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(<span class="number">0</span>);</span><br><span class="line">      measuredHeight = childView.getMeasuredHeight();</span><br><span class="line">      setMeasuredDimension(widthSpaceSize, childView.getMeasuredHeight());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(<span class="number">0</span>);</span><br><span class="line">      measuredWidth = childView.getMeasuredWidth() * childCount;</span><br><span class="line">      setMeasuredDimension(measuredWidth, heightSpaceSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(<span class="number">0</span>);</span><br><span class="line">      measuredWidth = childView.getMeasuredWidth() * childCount;</span><br><span class="line">      measuredHeight = childView.getMeasuredHeight();</span><br><span class="line">      setMeasuredDimension(measuredWidth, measuredHeight);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> childLeft = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">    mChildrenSize = childCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> View childView = getChildAt(i);</span><br><span class="line">      <span class="keyword">if</span> (childView.getVisibility() != View.GONE) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childWidth = childView.getMeasuredWidth();</span><br><span class="line">        mChildWidth = childWidth;</span><br><span class="line">        childView.layout(childLeft, <span class="number">0</span>, childLeft + childWidth,</span><br><span class="line">            childView.getMeasuredHeight());</span><br><span class="line">        childLeft += childWidth;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">smoothScrollBy</span><span class="params">(<span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">    mScroller.startScroll(getScrollX(), <span class="number">0</span>, dx, <span class="number">0</span>, <span class="number">500</span>);</span><br><span class="line">    invalidate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class="line">      scrollTo(mScroller.getCurrX(), mScroller.getCurrY());</span><br><span class="line">      postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDetachedFromWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mVelocityTracker.recycle();</span><br><span class="line">    <span class="keyword">super</span>.onDetachedFromWindow();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.hdu.night.scrollconflicts.HorizontalScrollViewEx</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"com.hdu.night.scrollconflicts.MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span> <span class="attr">android:id</span>=<span class="string">"@+id/rv_test1"</span></span></span><br><span class="line"><span class="tag">                                                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                                                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span> <span class="attr">android:id</span>=<span class="string">"@+id/rv_test"</span></span></span><br><span class="line"><span class="tag">                                                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                                                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span> <span class="attr">android:id</span>=<span class="string">"@+id/rv_test2"</span></span></span><br><span class="line"><span class="tag">                                                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                                                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.hdu.night.scrollconflicts.HorizontalScrollViewEx</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="内部拦截法"><a href="#内部拦截法" class="headerlink" title="内部拦截法"></a>内部拦截法</h3><p>在子view中拦截事件，父viewGroup默认是不拦截任何事件的，所以，当事件传递到子view时。根据偏移方向和速度，如果该事件是需要子view来处理的，那么子view就自己消耗处理，如果该事件不需要由子view来处理，那么就调用getParent().requestDisallowInterceptTouchEvent()方法来通知父viewgroup来拦截 。<br>伪代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//重写子View</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</span><br><span class="line">        parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">        <span class="keyword">int</span> deltaX = x - mLastX;</span><br><span class="line">        <span class="keyword">int</span> deltaY = y - mLastY;</span><br><span class="line">        <span class="keyword">if</span> (父容器需要此类点击事件) &#123;</span><br><span class="line">          parent.requestDisallowInterceptTouchEvent(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLastX = x;</span><br><span class="line">    mLastY = y;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//重写父View</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> action = event.getAction();</span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></p>
<p>实例：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HorizontalEx2</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> intercepted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY();</span><br><span class="line">    <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">      mLastX = x;</span><br><span class="line">      mLastY = y;</span><br><span class="line">      <span class="keyword">if</span> (!mScroller.isFinished()) &#123;</span><br><span class="line">        mScroller.abortAnimation();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerViewEv</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mLastX = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> mLastY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY();</span><br><span class="line">    <span class="keyword">switch</span> (ev.getAction()) &#123;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">        getParent().requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">        <span class="keyword">int</span> dx = x - mLastX;</span><br><span class="line">        <span class="keyword">int</span> dy = y - mLastY;</span><br><span class="line">        <span class="keyword">if</span> (Math.abs(dx) &gt; Math.abs(dy)) &#123;</span><br><span class="line">          getParent().requestDisallowInterceptTouchEvent(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mLastX = x;</span><br><span class="line">    mLastY = y;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="外部滑动与内部滑动一致"><a href="#外部滑动与内部滑动一致" class="headerlink" title="外部滑动与内部滑动一致"></a>外部滑动与内部滑动一致</h2><p>可以采取嵌套滑动机制解决。Android 的事件分发机制中，只要有一个控件消费了事件，其他控件就没办法在接收到这个事件了。因此，当有嵌套滑动场景时，我们都需要自己手动解决事件冲突。而在 Android 5.0 Lollipop 之后，Google 官方通过 嵌套滑动机制 解决了传统 Android 事件分发无法共享事件这个问题。</p>
<p>嵌套滑动机制 的基本原理可以认为是事件共享，即当子控件接收到滑动事件，准备要滑动时，会先通知父控件(startNestedScroll）；然后在滑动之前，会先询问父控件是否要滑动（dispatchNestedPreScroll)；如果父控件响应该事件进行了滑动，那么就会通知子控件它具体消耗了多少滑动距离；然后交由子控件处理剩余的滑动距离；最后子控件滑动结束后，如果滑动距离还有剩余，就会再问一下父控件是否需要在继续滑动剩下的距离（dispatchNestedScroll)…</p>
<p>如在ScrollVIew中嵌套RecyclerView。直接ScrollView进行拦截的话会出现RecyclerView内容显示不全。<br>可以将ScrollView换为NestScrollView，并将RecyclerView的nestedScrollingEnabled设为false。即RecyclerView不参加嵌套滑动，滑动交由NestScrollView负责。享受丝滑般的触感。</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>View事件分发</tag>
      </tags>
  </entry>
  <entry>
    <title>卷积神经网络工作原理</title>
    <url>/2019/02/15/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><img src="/images/CNN.PNG" alt="enter description here"><br>卷积神经网络即根据一张输入图片进行判断输出结果的中间黑箱。<br><img src="/images/CNN-2.PNG" alt="enter description here"><br>无论其经过若干次基本处理，仍旧能识别出对应图像</p>
<h2 id="提取原图特征——卷积"><a href="#提取原图特征——卷积" class="headerlink" title="提取原图特征——卷积"></a>提取原图特征——卷积</h2><p><img src="/images/feature-1.PNG" alt="enter description here"><br>以灰度图像为例亮的地方为1，暗的为-1.那么计算机是如何识别即使是旋转过的X呢？这就是卷积的操作了。<br>用卷积核在原图上滑动，进行卷积运算，得到特征图feature map。<br>卷积的本质：将原图中符合卷积核特征的特征提取出来，展示在feature map里面。卷积核进行卷积可以得到与卷积核特征一致的featuremap。<br>如果原图是X，卷积核是X，那么卷积核在原图上卷积运算之后生成的feature map也是X。<br>如果原图是O，卷积核是O，那么卷积核在原图上卷积运算之后生成的feature map也是O。<br>如果原图是O，卷积核是X，那么卷积核在原图上卷积运算之后生成的feature map就是乱码。<br>权值共享：卷积核扫过整张图片的过程中，卷积核参数不变。</p>
<p>下图的动画中，绿色表示原图像素值，红色数字表示卷积核中的参数，黄色表示卷积核在原图上滑动。右图表示卷积运算之后生成的feature map。<br><img src="/images/feature-2.gif" alt="enter description here"><br>下图展示了RGB三个通道图片的卷积运算过程，共有两组卷积核，每组卷积核都有三个filter分别与原图的RGB三个通道进行卷积。每组卷积核各自生成一个feature map。<br><img src="/images/feature-3.jpg" alt="enter description here"></p>
<blockquote>
<p>原图最外圈补0：zero padding,便于提取图像边缘的特征</p>
</blockquote>
<p>局部连接：feature map上每个值仅对应着原图的一小块区域，原图上的这块局部区域称作感受野（receptive field）。局部连接的思想，受启发于生物学里面的视觉系统，视觉皮层的神经元就是局部接受信息的。<br><img src="/images/feature-4.jpg" alt="enter description here"></p>
<h2 id="池化（下采样）：保留特征的同时压缩数据量"><a href="#池化（下采样）：保留特征的同时压缩数据量" class="headerlink" title="池化（下采样）：保留特征的同时压缩数据量"></a>池化（下采样）：保留特征的同时压缩数据量</h2><p>池化（Pooling）也叫做下采样（subsampling），用一个像素代替原图上邻近的若干像素，在保留feature map特征的同时压缩其大小。<br>池化的作用：</p>
<ul>
<li>防止数据爆炸，节省运算量和运算时间。</li>
<li>防止过拟合、过学习。<br>池化可采取最大值和平均值来压缩大小<br><img src="/images/pooling.jpg" alt="enter description here"></li>
</ul>
<h2 id="正则化：降低复杂模型的复杂度"><a href="#正则化：降低复杂模型的复杂度" class="headerlink" title="正则化：降低复杂模型的复杂度"></a>正则化：降低复杂模型的复杂度</h2><p>在这里字符识别中采用relu激活函数max(0,x)进行抹零操作。因为矩阵中有较多的0可以方便运算。</p>
<h2 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h2><p><img src="/images/layer.PNG" alt="enter description here"><br>将上述三个操作排列组合后重复若干次</p>
<h2 id="全连接：最终通过加权计算得出结果"><a href="#全连接：最终通过加权计算得出结果" class="headerlink" title="全连接：最终通过加权计算得出结果"></a>全连接：最终通过加权计算得出结果</h2><p>全连接层（可多层）：输出的每个神经元都和上一层每一个神经元连接。</p>
<p>卷积核的数量、大小、移动步长、补0的圈数是事先人为根据经验指定的，全连接层隐藏层的层数、神经元个数也是人为根据经验指定的（这叫做超参数），但其内部的参数是训练出来的。<br><img src="/images/all-connection.PNG" alt="enter description here"></p>
<h2 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h2><p>计算神经网络的推测结果与图片真实标签的差距，构造损失函数，训练的目标就是将找到损失函数的最小值。</p>
<h2 id="随机梯度下降"><a href="#随机梯度下降" class="headerlink" title="随机梯度下降"></a>随机梯度下降</h2><p>在减小损失函数的过程中，采用步步为营的方法，单个样本单个样本输入进行优化，而不是将全部样本计算之后再统一优化。虽然个别样本会出偏差，但随着样本数量增加，仍旧能够逐渐逼近损失函数最小值。</p>
<h2 id="反向传播（Backpropagation）"><a href="#反向传播（Backpropagation）" class="headerlink" title="反向传播（Backpropagation）"></a>反向传播（Backpropagation）</h2><p>通过求导找到损失函数的最小值，再一层一层反馈回去修改卷积核参数和全连接参数。</p>
]]></content>
      <categories>
        <category>Machine Learning</category>
      </categories>
      <tags>
        <tag>Machine Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Symmetric Tree</title>
    <url>/2019/02/14/Symmetric%20Tree/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-binary-tree-check-whether-it-is-a-mirror-of-itself-ie-symmetric-around-its-center"><a href="#Given-a-binary-tree-check-whether-it-is-a-mirror-of-itself-ie-symmetric-around-its-center" class="headerlink" title="Given a binary tree, check whether it is a mirror of itself (ie, symmetric around its center)."></a>Given a binary tree, check whether it is a mirror of itself (ie, symmetric around its center).</h3><p>For example, this binary tree [1,2,2,3,4,4,3] is symmetric:</p>
<p>　　1<br>   /　 　\<br>  2 　 　2<br> /　\  　/ 　\<br>3　4 4　　3<br>But the following [1,2,2,null,3,null,3] is not:<br>　1<br>   /　\<br>  2　2<br>   \　　\<br>   3　　3</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　对称条件是每个节点（左子树的右孩子）和（右子树的左孩子）以及（左子树的左孩子）和（右子树的右孩子）相等。但没有写出代码怎么递归表示。采用了复制一颗同样的树p。将p树交换左右子树。再判断root和p是否相等。一定要复制同样的树，否则root会跟着p同时变化。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**recursively </span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode left;</span></span><br><span class="line"><span class="comment"> *     TreeNode right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSymmetric</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isSymmetrics(root.left, root.right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSymmetrics</span><span class="params">(TreeNode left, TreeNode right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left == <span class="keyword">null</span> &amp;&amp; right == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left == <span class="keyword">null</span> || right == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left.val == right.val) &#123;</span><br><span class="line">            <span class="keyword">return</span> isSymmetrics(left.left, right.right) &amp;&amp; isSymmetrics(left.right, right.left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**swap</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode left;</span></span><br><span class="line"><span class="comment"> *     TreeNode right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSymmetric</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        TreeNode p = cloneTree(root);</span><br><span class="line">        swapNode(p);</span><br><span class="line">        <span class="keyword">return</span> isSame(p, root);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TreeNode <span class="title">cloneTree</span><span class="params">(TreeNode root)</span></span>&#123;</span><br><span class="line">        TreeNode node=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        node=<span class="keyword">new</span> TreeNode(root.val);</span><br><span class="line">        node.left=cloneTree(root.left);</span><br><span class="line">        node.right=cloneTree(root.right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSame</span><span class="params">(TreeNode s, TreeNode t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> &amp;&amp; t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s.val != t.val) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isSame(s.left, t.left) &amp;&amp; isSame(s.right, t.right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swapNode</span><span class="params">(TreeNode p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || (p.left == <span class="keyword">null</span> &amp;&amp; p.right == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode t = p.left;</span><br><span class="line">        p.left = p.right;</span><br><span class="line">        p.right = t;</span><br><span class="line">        <span class="keyword">if</span> (p.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">            swapNode(p.left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (p.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">            swapNode(p.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>事件分发源码解析</title>
    <url>/2019/02/04/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="Activity分发"><a href="#Activity分发" class="headerlink" title="Activity分发"></a>Activity分发</h2><p>事件最先传递给Activity，Activity通过dispatchTouchEvent分发出去<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        onUserInteraction();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> onTouchEvent(ev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Activity将事件交由window分发。若返回true，表明事件已被处理，否则调用Activity自己的onTouchEvent().Window是个抽象类，PhoneWindow是其唯一的实现类。</p>
<h2 id="Window分发"><a href="#Window分发" class="headerlink" title="Window分发"></a>Window分发</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Window分发给了顶层DecorView。</p>
<h2 id="顶级View的分发"><a href="#顶级View的分发" class="headerlink" title="顶级View的分发"></a>顶级View的分发</h2><p>DecorView 是FrameLayout，会将事件分发给ViewGroup<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span>, <span class="title">WindowCallbacks</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);<span class="comment">//Invoke ViewGroup's dispatchTouchEvent()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对ViewGroup 的dispatchTouchEvent逐段分析<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">     <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Handle an initial down.</span></span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">                <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></span><br><span class="line">                <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></span><br><span class="line">                <span class="comment">// due to an app switch, ANR, or some other state change.</span></span><br><span class="line">                cancelAndClearTouchTargets(ev);</span><br><span class="line">                resetTouchState();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Check for interception.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                    intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                    ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    intercepted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">                <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">                intercepted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>ViewGroup会在ACTION_DOWN到来时做重置操作resetTouchState()重置FLAG_DISALLOW_INTERCEPT.   因而当子View设置了FLAG_DISALLOW_INTERCEPT，ViewGroup仅可以拦截到ACTION_DOWN点击事件,ViewGroup会在两种情况决定拦截事件actionMasked == MotionEvent.ACTION_DOWN  || mFirstTouchTarget != null。 mFirstTouchTarget是 First touch target in the linked list of touch targets. ;TouchTarget是一个View的链表，用来记录TouchView事件涉及的View链表。而mFirstTouchTarget是记录首次Touch事件涉及的View。那就好理解啦。如果触摸的那个位置没有子View则mFirstTouchTarget为null，那么ViewGroup处理当前事件。且同一序列的其它事件亦交由它处理。因为actionMasked == MotionEvent.ACTION_DOWN.<br>由此可得出ViewGroup在拦截事件后，后续的点击事件会默认交由它处理，不再调用onInterceptTouchEvent。<br>故 onInterceptTouchEvent并非每次都会调用，而dispatchTouchEvent会<br>当ViewGroup不拦截时，事件向下分发给子View<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</span><br><span class="line">                    <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</span><br><span class="line">                        <span class="comment">// Find a child that can receive the event.</span></span><br><span class="line">                        <span class="comment">// Scan children from front to back.</span></span><br><span class="line">                        <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">                        <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = getAndVerifyPreorderedIndex(</span><br><span class="line">                                    childrenCount, i, customOrder);</span><br><span class="line">                            <span class="keyword">final</span> View child = getAndVerifyPreorderedView(</span><br><span class="line">                                    preorderedList, children, childIndex);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// If there is a view that has accessibility focus we want it</span></span><br><span class="line">                            <span class="comment">// to get the event first and if not handled we will perform a</span></span><br><span class="line">                            <span class="comment">// normal dispatch. We may do a double iteration but this is</span></span><br><span class="line">                            <span class="comment">// safer given the timeframe.</span></span><br><span class="line">                            <span class="keyword">if</span> (childWithAccessibilityFocus != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (childWithAccessibilityFocus != child) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                childWithAccessibilityFocus = <span class="keyword">null</span>;</span><br><span class="line">                                i = childrenCount - <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!canViewReceivePointerEvents(child)</span><br><span class="line">                                    || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                                ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            newTouchTarget = getTouchTarget(child);</span><br><span class="line">                            <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// Child is already receiving touch within its bounds.</span></span><br><span class="line">                                <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></span><br><span class="line">                                newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            resetCancelNextUpFlag(child);</span><br><span class="line">                            <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">                                <span class="comment">// Child wants to receive touch within its bounds.</span></span><br><span class="line">                                mLastTouchDownTime = ev.getDownTime();</span><br><span class="line">                                <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="comment">// childIndex points into presorted list, find original index</span></span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</span><br><span class="line">                                            mLastTouchDownIndex = j;</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    mLastTouchDownIndex = childIndex;</span><br><span class="line">                                &#125;</span><br><span class="line">                                mLastTouchDownX = ev.getX();</span><br><span class="line">                                mLastTouchDownY = ev.getY();</span><br><span class="line">                                newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                                alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// The accessibility focus didn't handle the event, so clear</span></span><br><span class="line">                            <span class="comment">// the flag and do a normal dispatch to all children.</span></span><br><span class="line">                            ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</span><br><span class="line">                    &#125;</span><br><span class="line">					...</span><br><span class="line">			｝</span><br></pre></td></tr></table></figure></p>
<p>遍历所有子View，判断其是否能够收到点击事件——1. 子View能否收到点击事件 2. 点击事件的坐标是否落在子View的区域内。在如下的dispatchTransformedTouchEvent中实际调用的就是子View的dispatchEvent<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transforms a motion event into the coordinate space of a particular child view,</span></span><br><span class="line"><span class="comment"> * filters out irrelevant pointer ids, and overrides its action if necessary.</span></span><br><span class="line"><span class="comment"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></span><br><span class="line"><span class="function"><span class="params">        View child, <span class="keyword">int</span> desiredPointerIdBits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> handled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></span><br><span class="line">    <span class="comment">// or filtering.  The important part is the action, not the contents.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</span><br><span class="line">    <span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</span><br><span class="line">        event.setAction(MotionEvent.ACTION_CANCEL);</span><br><span class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">            handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handled = child.dispatchTouchEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">        event.setAction(oldAction);</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>若子View的dispatchTouchEvent返回true，mFirstTouchEvent会被赋值，然后break。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                                alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> TouchTarget <span class="title">addTouchTarget</span><span class="params">(@NonNull View child, <span class="keyword">int</span> pointerIdBits)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> TouchTarget target = TouchTarget.obtain(child, pointerIdBits);</span><br><span class="line">        target.next = mFirstTouchTarget;</span><br><span class="line">        mFirstTouchTarget = target;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>当该事件最终未被子View合适地的处理有两种情况。</p>
<ol>
<li>ViewGroup没有子View</li>
<li>子View的dispatchTouchEvent()返回了false(常见)<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">         <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">// No touch targets so treat this as an ordinary view.</span></span><br><span class="line">             handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</span><br><span class="line">                     TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">         &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">             handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>将事件重新交由父元素View处理，且同一事件序列的后续事件不会再交给它处理。下面看View是如何处理</p>
<h2 id="View对点击事件的处理"><a href="#View对点击事件的处理" class="headerlink" title="View对点击事件的处理"></a>View对点击事件的处理</h2><p>这里View不包含ViewGroup<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">                &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> ...</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现判断onTouchListener中的onTouch（）若返回为true,就不会调用onTouchEvent()，这样可以方便在Activity等外界直接setOnTouchListener().进入onTouchEvent()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">                || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">                || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">                setPressed(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">            <span class="comment">// A disabled view that is clickable still consumes the touch</span></span><br><span class="line">            <span class="comment">// events, it just doesn't respond to them.</span></span><br><span class="line">            <span class="keyword">return</span> clickable;</span><br><span class="line">        ｝</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>注释解释了在View不可用状态下，但View是可点击的，View仍旧会消耗这个事件。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">        || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">        || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">            <span class="keyword">if</span> ((viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">                handleTooltipUp();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!clickable) &#123;</span><br><span class="line">                removeTapCallback();</span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                mInContextButtonPress = <span class="keyword">false</span>;</span><br><span class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</span><br><span class="line">                <span class="comment">// take focus if we don't have it already and we should in</span></span><br><span class="line">                <span class="comment">// touch mode.</span></span><br><span class="line">                <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                    focusTaken = requestFocus();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                    <span class="comment">// The button is being released before we actually</span></span><br><span class="line">                    <span class="comment">// showed it as pressed.  Make it show the pressed</span></span><br><span class="line">                    <span class="comment">// state now (before scheduling the click) to ensure</span></span><br><span class="line">                    <span class="comment">// the user sees it.</span></span><br><span class="line">                    setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                    <span class="comment">// This is a tap, so remove the longpress check</span></span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Only perform take click actions if we were in the pressed state</span></span><br><span class="line">                    <span class="keyword">if</span> (!focusTaken) &#123;</span><br><span class="line">                        <span class="comment">// Use a Runnable and post this rather than calling</span></span><br><span class="line">                        <span class="comment">// performClick directly. This lets other visual state</span></span><br><span class="line">                        <span class="comment">// of the view update before click actions start.</span></span><br><span class="line">                        <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            mPerformClick = <span class="keyword">new</span> PerformClick();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!post(mPerformClick)) &#123;</span><br><span class="line">                            performClick();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">break</span>;              </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只有子View的CLICKABLE、LONG_CLICKABLE，CONTEXT_CLICKABLE，TOOLTIP有一个为true它就会返回true消耗该事件。当ACTION_UP时会调用performClick().<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> result;</span><br><span class="line">    <span class="keyword">final</span> ListenerInfo li = mListenerInfo;</span><br><span class="line">    <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">        playSoundEffect(SoundEffectConstants.CLICK);</span><br><span class="line">        li.mOnClickListener.onClick(<span class="keyword">this</span>);</span><br><span class="line">        result = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</span><br><span class="line"></span><br><span class="line">    notifyEnterOrExitForAutoFillIfNeeded(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在performClick()若onClickListener不为空，则调用onClick()</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码解析</tag>
        <tag>View事件分发</tag>
      </tags>
  </entry>
  <entry>
    <title>ValidSudoku</title>
    <url>/2019/02/03/ValidSudoku/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Determine-if-a-9x9-Sudoku-board-is-valid-Only-the-filled-cells-need-to-be-validated-according-to-the-following-rules"><a href="#Determine-if-a-9x9-Sudoku-board-is-valid-Only-the-filled-cells-need-to-be-validated-according-to-the-following-rules" class="headerlink" title="Determine if a 9x9 Sudoku board is valid. Only the filled cells need to be validated according to the following rules:"></a>Determine if a 9x9 Sudoku board is valid. Only the filled cells need to be validated according to the following rules:</h3><ol>
<li>Each row must contain the digits 1-9 without repetition.</li>
<li>Each column must contain the digits 1-9 without repetition.</li>
<li>Each of the 9 3x3 sub-boxes of the grid must contain the digits 1-9 without repetition.</li>
</ol>
<p><img src="/images/sudu.png" alt="sudo"><br>The Sudoku board could be partially filled, where empty cells are filled with the character ‘.’.</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  [<span class="string">"5"</span>,<span class="string">"3"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"7"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"6"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"1"</span>,<span class="string">"9"</span>,<span class="string">"5"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"9"</span>,<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"6"</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"6"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"3"</span>],</span><br><span class="line">  [<span class="string">"4"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"3"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"1"</span>],</span><br><span class="line">  [<span class="string">"7"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"2"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"6"</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"6"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"2"</span>,<span class="string">"8"</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"4"</span>,<span class="string">"1"</span>,<span class="string">"9"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"5"</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"7"</span>,<span class="string">"9"</span>]</span><br><span class="line">]</span><br><span class="line">Output: <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  [<span class="string">"8"</span>,<span class="string">"3"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"7"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"6"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"1"</span>,<span class="string">"9"</span>,<span class="string">"5"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"9"</span>,<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"6"</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"6"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"3"</span>],</span><br><span class="line">  [<span class="string">"4"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"3"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"1"</span>],</span><br><span class="line">  [<span class="string">"7"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"2"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"6"</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"6"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"2"</span>,<span class="string">"8"</span>,<span class="string">"."</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"4"</span>,<span class="string">"1"</span>,<span class="string">"9"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"5"</span>],</span><br><span class="line">  [<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"8"</span>,<span class="string">"."</span>,<span class="string">"."</span>,<span class="string">"7"</span>,<span class="string">"9"</span>]</span><br><span class="line">]</span><br><span class="line">Output: <span class="keyword">false</span></span><br><span class="line">Explanation: Same as Example <span class="number">1</span>, except with the <span class="number">5</span> in the top left corner being </span><br><span class="line">    modified to <span class="number">8</span>. Since there are two <span class="number">8</span><span class="string">'s in the top left 3x3 sub-box, it is invalid.</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　用3个HashSet，分别保存第i行、第i列和第i个3x3的九宫格（i个九宫格也是从0开始）中的元素，每处理一个元素，若不为空，将正在处理的当前元素，添加到所属的行、列以及3x3的九宫格中，若添加失败，表明所属的行、列或者3x3九宫格中有重复元素，返回false；若全部扫描完，返回true。九宫格的行列转换代码没想出来。</p>
<p>  （ i / 3 ） x 3 得到九宫格的起始行数即九宫格左上角块所处行。（ i / 3 ） * 3  + j / 3得到九宫格中任一对应行（PS: 0 &lt;= j &lt;= 8）。</p>
<p> ( i % 3)  x 3 得到九宫格起始列数即九宫格左上角所处列。i % 3 * 3 + j % 3得到九宫格中任一对应列（PS: 0 &lt;= j &lt;= 8）。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValidSudoku</span><span class="params">(<span class="keyword">char</span>[][] board)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//最外层循环，每次循环并非只是处理第i行，而是处理第i行、第i列以及第i个3x3的九宫格</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        HashSet&lt;Character&gt; row = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        HashSet&lt;Character&gt; col = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        HashSet&lt;Character&gt; subBoxes = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">9</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'.'</span> != board[i][j] &amp;&amp; !row.add(board[i][j]))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'.'</span> != board[j][i] &amp;&amp; !col.add(board[j][i]))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> m = i / <span class="number">3</span> * <span class="number">3</span> + j / <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">int</span> n = i % <span class="number">3</span> * <span class="number">3</span> + j % <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'.'</span> != board[m][n] &amp;&amp; !subBoxes.add(board[m][n]))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Move 0</title>
    <url>/2019/02/02/Move%200/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-array-nums-write-a-function-to-move-all-0’s-to-the-end-of-it-while-maintaining-the-relative-order-of-the-non-zero-elements-You-must-do-this-in-place-without-making-a-copy-of-the-array-Minimize-the-total-number-of-operations"><a href="#Given-an-array-nums-write-a-function-to-move-all-0’s-to-the-end-of-it-while-maintaining-the-relative-order-of-the-non-zero-elements-You-must-do-this-in-place-without-making-a-copy-of-the-array-Minimize-the-total-number-of-operations" class="headerlink" title="Given an array nums, write a function to move all 0’s to the end of it while maintaining the relative order of the non-zero elements.You must do this in-place without making a copy of the array.Minimize the total number of operations."></a>Given an array nums, write a function to move all 0’s to the end of it while maintaining the relative order of the non-zero elements.You must do this in-place without making a copy of the array.Minimize the total number of operations.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">12</span>]</span><br><span class="line">Output: [<span class="number">1</span>,<span class="number">3</span>,<span class="number">12</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　总觉得在哪见过这道题的解法思想。但自己解出来的却不尽人意。起初是求出每个非元素i前有count个为0的元素。交换nums[i] 与 nums[i - count]两个元素。可以维护两个索引，一个是新数组维护非零元素索引，一个是旧元素中非零元素索引。遍历旧数组，遇到非零元素就添加到新数组中。最后令新数组的末尾全为0.其实剑指Offer中的奇偶数组排序有异曲同工之妙。不过那道题是从两端逼近。一个索引是奇数，另一个是偶数索引。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">moveZeroes</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nonzeroIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] != <span class="number">0</span>) &#123;</span><br><span class="line">                nums[nonzeroIndex++] = nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> zeroIndex = nonzeroIndex;</span><br><span class="line">        <span class="keyword">for</span> (; zeroIndex &lt; nums.length; zeroIndex++) &#123;</span><br><span class="line">            nums[zeroIndex] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] sortArrayByParity(<span class="keyword">int</span>[] A) &#123;</span><br><span class="line">        <span class="keyword">int</span> oddIndex = <span class="number">0</span>, evenIndex = A.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (oddIndex &lt; evenIndex) &#123;</span><br><span class="line">            <span class="keyword">while</span> (oddIndex &lt; A.length - <span class="number">1</span> &amp;&amp; (A[oddIndex] &amp; <span class="number">0x1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                oddIndex++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (evenIndex &gt; <span class="number">0</span> &amp;&amp; (A[evenIndex] &amp; <span class="number">0x1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                evenIndex--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (oddIndex &lt; evenIndex) &#123;</span><br><span class="line">                swap(A, oddIndex, evenIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> A;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] data, <span class="keyword">int</span> index, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> t = data[index];</span><br><span class="line">        data[index] = data[end];</span><br><span class="line">        data[end] = t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Scroller、ScrollTo、ScrollBy源码解析</title>
    <url>/2019/02/02/Scroller%E3%80%81ScrollTo%E3%80%81ScrollBy%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p> 　　本着写了忘，忘了写。还是写篇博文分析了工作流程加深记忆，滑动方向每次都出错。</p>
<h2 id="ScrollTo与ScrollBy两兄弟"><a href="#ScrollTo与ScrollBy两兄弟" class="headerlink" title="ScrollTo与ScrollBy两兄弟"></a>ScrollTo与ScrollBy两兄弟</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*Set scrollX,scrollY.inValidate </span></span><br><span class="line"><span class="comment">   mSrollX:The offset, in pixels, by which the content of this view is scrolled horizontally.</span></span><br><span class="line"><span class="comment">   mSrollY:The offset, in pixels, by which the content of this view is scrolled</span></span><br><span class="line"><span class="comment">vertically.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollTo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mScrollX != x || mScrollY != y) &#123;</span><br><span class="line">            <span class="keyword">int</span> oldX = mScrollX;</span><br><span class="line">            <span class="keyword">int</span> oldY = mScrollY;</span><br><span class="line">            mScrollX = x;</span><br><span class="line">            mScrollY = y;</span><br><span class="line">            invalidateParentCaches();</span><br><span class="line">            onScrollChanged(mScrollX, mScrollY, oldX, oldY);</span><br><span class="line">            <span class="keyword">if</span> (!awakenScrollBars()) &#123;</span><br><span class="line">                postInvalidateOnAnimation();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollBy</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        scrollTo(mScrollX + x, mScrollY + y);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来ScrollBy是调用scrollTo.这样只需要分析scrollTo源码即可。先设置mScrollX,mScrollY.而ScrollX，Y是View内容的滑动距离。所以这就解释为什么只能ViewGroup调用该方法有效。Scroll传入偏移距离加上起始滑动距离 = 绝对距离。进入onScrollChanged方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onScrollChanged</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> oldl, <span class="keyword">int</span> oldt)</span> </span>&#123;</span><br><span class="line">        notifySubtreeAccessibilityStateChangedIfNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</span><br><span class="line">            postSendViewScrolledAccessibilityEventCallback();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mBackgroundSizeChanged = <span class="keyword">true</span>;</span><br><span class="line">        mDefaultFocusHighlightSizeChanged = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mForegroundInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mForegroundInfo.mBoundsChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AttachInfo ai = mAttachInfo;</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ai.mViewScrollChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mListenerInfo != <span class="keyword">null</span> &amp;&amp; mListenerInfo.mOnScrollChangeListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mListenerInfo.mOnScrollChangeListener.onScrollChange(<span class="keyword">this</span>, l, t, oldl, oldt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>当View注册了OnScrollChangeListener，onScrollChange才会被调用。在onScrollChanged()后调用了postInvalidateOnAnimation（）。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postInvalidateOnAnimation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// We try only with the AttachInfo because there's no point in invalidating</span></span><br><span class="line">      <span class="comment">// if we are not attached to our window</span></span><br><span class="line">      <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">      <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">          attachInfo.mViewRootImpl.dispatchInvalidateOnAnimation(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchInvalidateOnAnimation</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">      mInvalidateOnAnimationRunnable.addView(view);</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InvalidateOnAnimationRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">boolean</span> mPosted;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;AttachInfo.InvalidateInfo&gt; mViewRects =</span><br><span class="line">              <span class="keyword">new</span> ArrayList&lt;AttachInfo.InvalidateInfo&gt;();</span><br><span class="line">      <span class="keyword">private</span> View[] mTempViews;</span><br><span class="line">      <span class="keyword">private</span> AttachInfo.InvalidateInfo[] mTempViewRects;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">              mViews.add(view);</span><br><span class="line">              postIfNeededLocked();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewRect</span><span class="params">(AttachInfo.InvalidateInfo info)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">              mViewRects.add(info);</span><br><span class="line">              postIfNeededLocked();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">              mViews.remove(view);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = mViewRects.size(); i-- &gt; <span class="number">0</span>; ) &#123;</span><br><span class="line">                  AttachInfo.InvalidateInfo info = mViewRects.get(i);</span><br><span class="line">                  <span class="keyword">if</span> (info.target == view) &#123;</span><br><span class="line">                      mViewRects.remove(i);</span><br><span class="line">                      info.recycle();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (mPosted &amp;&amp; mViews.isEmpty() &amp;&amp; mViewRects.isEmpty()) &#123;</span><br><span class="line">                  mChoreographer.removeCallbacks(Choreographer.CALLBACK_ANIMATION, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">                  mPosted = <span class="keyword">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> viewCount;</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> viewRectCount;</span><br><span class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">              mPosted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">              viewCount = mViews.size();</span><br><span class="line">              <span class="keyword">if</span> (viewCount != <span class="number">0</span>) &#123;</span><br><span class="line">                  mTempViews = mViews.toArray(mTempViews != <span class="keyword">null</span></span><br><span class="line">                          ? mTempViews : <span class="keyword">new</span> View[viewCount]);</span><br><span class="line">                  mViews.clear();</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              viewRectCount = mViewRects.size();</span><br><span class="line">              <span class="keyword">if</span> (viewRectCount != <span class="number">0</span>) &#123;</span><br><span class="line">                  mTempViewRects = mViewRects.toArray(mTempViewRects != <span class="keyword">null</span></span><br><span class="line">                          ? mTempViewRects : <span class="keyword">new</span> AttachInfo.InvalidateInfo[viewRectCount]);</span><br><span class="line">                  mViewRects.clear();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewCount; i++) &#123;</span><br><span class="line">              mTempViews[i].invalidate();</span><br><span class="line">              mTempViews[i] = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewRectCount; i++) &#123;</span><br><span class="line">              <span class="keyword">final</span> View.AttachInfo.InvalidateInfo info = mTempViewRects[i];</span><br><span class="line">              info.target.invalidate(info.left, info.top, info.right, info.bottom);</span><br><span class="line">              info.recycle();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postIfNeededLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (!mPosted) &#123;</span><br><span class="line">              mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">              mPosted = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>在addView中postIfNeededLocked()会调用到run(),在run()里遍历所有添加进去的View，然后对每个View调用invalidate()，<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        invalidate(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(<span class="keyword">boolean</span> invalidateCache)</span> </span>&#123;</span><br><span class="line">        invalidateInternal(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> fullInvalidate)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">            <span class="comment">// Propagate the damage rectangle to the parent view.</span></span><br><span class="line">            <span class="keyword">final</span> AttachInfo ai = mAttachInfo;</span><br><span class="line">            <span class="keyword">final</span> ViewParent p = mParent;</span><br><span class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; ai != <span class="keyword">null</span> &amp;&amp; l &lt; r &amp;&amp; t &lt; b) &#123;</span><br><span class="line">                <span class="keyword">final</span> Rect damage = ai.mTmpInvalRect;</span><br><span class="line">                damage.set(l, t, r, b);</span><br><span class="line">                p.invalidateChild(<span class="keyword">this</span>, damage);<span class="comment">// Invalidate child</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Damage the entire projection receiver, if necessary.</span></span><br><span class="line">            <span class="keyword">if</span> (mBackground != <span class="keyword">null</span> &amp;&amp; mBackground.isProjected()) &#123;</span><br><span class="line">                <span class="keyword">final</span> View receiver = getProjectionReceiver();</span><br><span class="line">                <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    receiver.damageInParent();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>p.invalidateChild()这就是scrollTo移动的是View的内容的真相。再来揭示为何方向相反呢?进入ViewGroup的invalidateChild().<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    ···</span><br><span class="line">                parent = parent.invalidateChildInParent(location, dirty);</span><br><span class="line">                <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Account for transform on current parent</span></span><br><span class="line">                    Matrix m = view.getMatrix();</span><br><span class="line">                    <span class="keyword">if</span> (!m.isIdentity()) &#123;</span><br><span class="line">                        RectF boundingRect = attachInfo.mTmpTransformRect;</span><br><span class="line">                        boundingRect.set(dirty);</span><br><span class="line">                        m.mapRect(boundingRect);</span><br><span class="line">                        dirty.set((<span class="keyword">int</span>) Math.floor(boundingRect.left),</span><br><span class="line">                                (<span class="keyword">int</span>) Math.floor(boundingRect.top),</span><br><span class="line">                                (<span class="keyword">int</span>) Math.ceil(boundingRect.right),</span><br><span class="line">                                (<span class="keyword">int</span>) Math.ceil(boundingRect.bottom));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (parent != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>里面有一行代码parent = parent.invalidateChildInParent(location, dirty);进去invalidateChildInParent（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> ViewParent <span class="title">invalidateChildInParent</span><span class="params">(<span class="keyword">int</span>[] location, Rect dirty)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (mHostView != <span class="keyword">null</span>) &#123;</span><br><span class="line">              dirty.offset(location[<span class="number">0</span>], location[<span class="number">1</span>]);</span><br><span class="line">              <span class="keyword">if</span> (mHostView <span class="keyword">instanceof</span> ViewGroup) &#123;</span><br><span class="line">                  location[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">                  location[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                  <span class="keyword">super</span>.invalidateChildInParent(location, dirty);</span><br><span class="line">                  <span class="keyword">return</span> ((ViewGroup) mHostView).invalidateChildInParent(location, dirty);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  invalidate(dirty);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>进入 invalidate(dirty);<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> scrollX = mScrollX;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> scrollY = mScrollY;</span><br><span class="line">    invalidateInternal(dirty.left - scrollX, dirty.top - scrollY,</span><br><span class="line">            dirty.right - scrollX, dirty.bottom - scrollY, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这就是为什么方向会相反的原因啦。整个scrollTo透露着一股观察者模式的气味，当调用scrollTo（）时，InvalidateOnAnimationRunnable中的run()会通知所有子View。让其重绘。</p>
<h2 id="Scroller源码"><a href="#Scroller源码" class="headerlink" title="Scroller源码"></a>Scroller源码</h2><p>Scroller典型用法：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.computeScroll();</span><br><span class="line">    <span class="comment">// 判断Scroller是否执行完毕</span></span><br><span class="line">    <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class="line">        ((View) getParent()).scrollTo(</span><br><span class="line">                mScroller.getCurrX(),<span class="comment">//获取当前的滑动坐标</span></span><br><span class="line">                mScroller.getCurrY());</span><br><span class="line">        <span class="comment">// 通过重绘来不断调用computeScroll</span></span><br><span class="line">        postInvalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line">    <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            lastX = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">            lastY = (<span class="keyword">int</span>) event.getY();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            <span class="keyword">int</span> offsetX = x - lastX;</span><br><span class="line">            <span class="keyword">int</span> offsetY = y - lastY;</span><br><span class="line">            ((View) getParent()).scrollBy(-offsetX, -offsetY);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="comment">// 手指离开时，执行滑动过程</span></span><br><span class="line">            View viewGroup = ((View) getParent());</span><br><span class="line">            mScroller.startScroll(</span><br><span class="line">                    viewGroup.getScrollX(),</span><br><span class="line">                    viewGroup.getScrollY(),</span><br><span class="line">                    -viewGroup.getScrollX(),</span><br><span class="line">                    -viewGroup.getScrollY());</span><br><span class="line">            invalidate();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>与scrollTo（）、scrollBy（）同样，滑动的是View的内容。首先进入startScroll（）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startScroll</span><span class="params">(<span class="keyword">int</span> startX, <span class="keyword">int</span> startY, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, <span class="keyword">int</span> duration)</span> </span>&#123;</span><br><span class="line">    mMode = SCROLL_MODE;</span><br><span class="line">    mFinished = <span class="keyword">false</span>;</span><br><span class="line">    mDuration = duration;</span><br><span class="line">    mStartTime = AnimationUtils.currentAnimationTimeMillis();</span><br><span class="line">    mStartX = startX;</span><br><span class="line">    mStartY = startY;</span><br><span class="line">    mFinalX = startX + dx;</span><br><span class="line">    mFinalY = startY + dy;</span><br><span class="line">    mDeltaX = dx;</span><br><span class="line">    mDeltaY = dy;</span><br><span class="line">    mDurationReciprocal = <span class="number">1.0f</span> / (<span class="keyword">float</span>) mDuration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面除了设值什么也没做，那Scroller是怎么让View滑起来的呢？秘密就在startScroll（）的下一行invalidate()重绘中调用View中的draw()<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">draw</span><span class="params">(Canvas canvas, ViewGroup parent, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line"><span class="keyword">if</span> (!drawingWithRenderNode) &#123;</span><br><span class="line">          computeScroll();</span><br><span class="line">          sx = mScrollX;</span><br><span class="line">          sy = mScrollY;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p>  里面会调用我们重写的computeScroll(),而在我们重写的computeScroll()里我们利用scrollTo完成了滑动操作。并同时启动了postInvalidate();开启了第二次重绘。反复直至滑动结束。最后再看看computeScrollOffset（）<br> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">computeScrollOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (mFinished) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> timePassed = (<span class="keyword">int</span>)(AnimationUtils.currentAnimationTimeMillis() - mStartTime);</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (timePassed &lt; mDuration) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (mMode) &#123;</span><br><span class="line">          <span class="keyword">case</span> SCROLL_MODE:</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = mInterpolator.getInterpolation(timePassed * mDurationReciprocal);</span><br><span class="line">              mCurrX = mStartX + Math.round(x * mDeltaX);</span><br><span class="line">              mCurrY = mStartY + Math.round(x * mDeltaY);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">...</span><br><span class="line">  &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure></p>
<p>根据时间流逝的百分比算出scrollX和scrollY。返回为true意味着滑动还未结束，false：滑动已结束</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码解析</tag>
        <tag>View事件体系</tag>
      </tags>
  </entry>
  <entry>
    <title>Pow(x, n)</title>
    <url>/2019/02/01/Pow(x,%20n)/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Implement-pow-x-n-which-calculates-x-raised-to-the-power-n-xn"><a href="#Implement-pow-x-n-which-calculates-x-raised-to-the-power-n-xn" class="headerlink" title="Implement pow(x, n), which calculates x raised to the power n (xn)."></a>Implement pow(x, n), which calculates x raised to the power n (xn).</h3><h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>  -100.0 &lt; x &lt; 100.0<br>n is a 32-bit signed integer, within the range [−2^31, 2^31 − 1]</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">2.00000</span>, <span class="number">10</span></span><br><span class="line">Output: <span class="number">1024.00000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="number">2.10000</span>, <span class="number">3</span></span><br><span class="line">Output: <span class="number">9.26100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input: <span class="number">2.00000</span>, -<span class="number">2</span></span><br><span class="line">Output: <span class="number">0.25000</span></span><br><span class="line">Explanation: <span class="number">2</span>-<span class="number">2</span> = <span class="number">1</span>/<span class="number">22</span> = <span class="number">1</span>/<span class="number">4</span> = <span class="number">0.25</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>这道题有个坑的地方，当 x = 2时，n = -2^31时。超时了，在这一行代码上超时了，n &gt;&gt; = 1;  自己用了右移运算反而超时了.百思不得其解。当求一个数的负数次方时，可以采取1 / pow(x, -n);转换为求倒数。这么一转换对于这个样例刚好出问题了。出在哪了呢？1. 当对-2^31取负数时，该数仍旧是负数。因为int的最大值是2^31 - 1超过了最大值。 2. 对负数进行右移&gt;&gt;高位补符号位。这样得到的结果就会出错，而且会超时。<br>解决方案：1. 采用 /        2. 采取无符号右移&gt;&gt;&gt;<br>-5 / 2 = -2，5 / 2 = 2。这表明除二是向零取整<br>-5 （1011）&gt;&gt; 1 =（1101） -3，5 &gt;&gt; 1 = 2。这补码表示表明右移一位是向下取整</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">myPow</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span> / pow(x, -n);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pow(x, n);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">pow</span><span class="params">(<span class="keyword">double</span> base, <span class="keyword">int</span> exponent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (exponent == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (exponent == <span class="number">1</span> || base == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> base;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> res = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (exponent != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((exponent &amp; <span class="number">0x1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                res *= base;</span><br><span class="line">            &#125;</span><br><span class="line">            base *= base;</span><br><span class="line">            exponent &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>利用队列实现栈</title>
    <url>/2019/01/31/queue%20implement%20stack/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Implement-the-following-operations-of-a-stack-using-queues"><a href="#Implement-the-following-operations-of-a-stack-using-queues" class="headerlink" title="Implement the following operations of a stack using queues."></a>Implement the following operations of a stack using queues.</h3><p>push(x) – Push element x onto stack.<br>pop() – Removes the element on top of the stack.<br>top() – Get the top element.<br>empty() – Return whether the stack is empty.</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">MyStack stack = <span class="keyword">new</span> MyStack();</span><br><span class="line"></span><br><span class="line">stack.push(<span class="number">1</span>);</span><br><span class="line">stack.push(<span class="number">2</span>);  </span><br><span class="line">stack.top();   <span class="comment">// returns 2</span></span><br><span class="line">stack.pop();   <span class="comment">// returns 2</span></span><br><span class="line">stack.empty(); <span class="comment">// returns false</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　起初采取是剑指Offer上常规的做法，插入时根据turn的值插到对应队列，pop和peek时将n - 1个元素转移到另一个队列。再返回最后一个元素。参考了别人的代码。原来可以不用turn记录插入弹出队列。如果可以维护一个出队顺序 = 出栈顺序的队列的话那多方便啊。可这是队列呀，不一样对吧。所以用两个栈维护入栈顺序，每添加一个元素x前，先将queue1中的元素先转移到queue2中，再添加x（这时queue1中只有一个元素x）。最后将queue2中的元素转移回来，这样queue1的出队列顺序即是出栈顺序。降低了pop、peek时间复杂度。整个过程入栈和出栈最终都是在queue1中，queue2只是作为一个中转栈。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">MyStack</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Queue&lt;Integer&gt; q1, q2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initialize your data structure here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        q1 = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line">        q2 = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Push element x to the back of queue.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!q1.isEmpty()) &#123;</span><br><span class="line">            q2.offer(q1.poll());</span><br><span class="line">        &#125;</span><br><span class="line">        q1.offer(x);</span><br><span class="line">        <span class="keyword">while</span> (!q2.isEmpty()) &#123;</span><br><span class="line">            q1.offer(q2.poll());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Removes the element from in front of queue and returns that element.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> q1.isEmpty() ? -<span class="number">1</span> : q1.poll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the front element.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> q1.isEmpty() ? -<span class="number">1</span> : q1.peek();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns whether the queue is empty.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> q2.isEmpty() &amp;&amp; q1.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Message Mechanism</title>
    <url>/2019/01/30/Message%20Mechanism/</url>
    <content><![CDATA[<h2 id="Message-Queue"><a href="#Message-Queue" class="headerlink" title="Message Queue"></a>Message Queue</h2><p>　　MessageQueue主要包含两个操作。1. 插入enqueueMessage(Message message);  2. 读取 消息next()<br>  MessageQueue虽然名字中含有Queue，但实际上并没有用队列实现。而是使用Message自带的单链表。</p>
<h3 id="enqueueMessage"><a href="#enqueueMessage" class="headerlink" title="enqueueMessage"></a>enqueueMessage</h3>  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;<span class="comment">//单链表插入</span></span><br><span class="line"> 	 ...</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</span><br><span class="line">            Log.w(TAG, e.getMessage(), e);</span><br><span class="line">            msg.recycle();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        msg.markInUse();</span><br><span class="line">        msg.when = when;</span><br><span class="line">        Message p = mMessages;</span><br><span class="line">        <span class="keyword">boolean</span> needWake;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</span><br><span class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;</span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don't have to wake</span></span><br><span class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                    needWake = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">            prev.next = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">        <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="next（）"><a href="#next（）" class="headerlink" title="next（）"></a>next（）</h3>  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;<span class="comment">//获取下一条msg，MessageQueue中没有msg则阻塞轮询Poll。</span></span><br><span class="line">    <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">    <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">    <span class="comment">// which is not supported.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Looper"><a href="#Looper" class="headerlink" title="Looper"></a>Looper</h2><p>  　　Looper:轮询器，它会不停从MessageQueue中查看是否有新消息，如果有则立即处理，否则就一直阻塞。Handler必须配合Looper使用，之所以平常使用没用创建Looper，是因为在UI线程ActivityThread创建时就会初始化Looper。在Looper初始化的同时也会初始化MessageQueue.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the message queue in this thread. Be sure to call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">    Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">        <span class="keyword">final</span> Printer logging = me.mLogging;</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</span><br><span class="line">                    msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</span><br><span class="line">        <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">            Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> start = (slowDispatchThresholdMs == <span class="number">0</span>) ? <span class="number">0</span> : SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> end;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            msg.target.dispatchMessage(msg);</span><br><span class="line">            end = (slowDispatchThresholdMs == <span class="number">0</span>) ? <span class="number">0</span> : SystemClock.uptimeMillis();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                Trace.traceEnd(traceTag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (slowDispatchThresholdMs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> time = end - start;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; slowDispatchThresholdMs) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Dispatch took "</span> + time + <span class="string">"ms on "</span></span><br><span class="line">                        + Thread.currentThread().getName() + <span class="string">", h="</span> +</span><br><span class="line">                        msg.target + <span class="string">" cb="</span> + msg.callback + <span class="string">" msg="</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">        <span class="comment">// identity of the thread wasn't corrupted.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">            Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></span><br><span class="line">                    + Long.toHexString(ident) + <span class="string">" to 0x"</span></span><br><span class="line">                    + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></span><br><span class="line">                    + msg.target.getClass().getName() + <span class="string">" "</span></span><br><span class="line">                    + msg.callback + <span class="string">" what="</span> + msg.what);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loop方法是一个死循环，唯一可以跳出循环的方式是MessageQueue的next()返回了null，而只有当Looper被设置为退出时，MessageQueue的next()才会返回null。若MessageQueue的next()返回一条新消息，Looper就会调用msg.target.dispatchMessage(msg);处理。msg.target是Handler。故Handler发送的消息被Looper原封不动的交由Handler的dispatchMessager（）处理。原封不动指的是dispatchMessage（）会在创建Handler的线程下运行回调handleMessage().</p>
<h2 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h2><p><img src="/images/message_mechanism.PNG" alt="send_message"></p>
<ol>
<li>在A线程中创建Looper（创建MessageQueue）， Handler</li>
<li>Handler在B线程中发送消息，消息会插入到A线程中的MessageQueue中</li>
<li>Looper从MessageQueue中取出消息回调Handler的dispatchMessage处理消息</li>
<li>dispatchMessage中会调用Handler的handleMessage方法</li>
</ol>
<h3 id="sendMessage"><a href="#sendMessage" class="headerlink" title="sendMessage()"></a>sendMessage()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Handler将消息传到MessageQueue中，Looper通过MessageQueue。next()获取消息，Looper再将消息交由Handler的dispatchMessage()处理</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessage</span><span class="params">(Message msg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sendMessageDelayed(msg, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessageDelayed</span><span class="params">(Message msg, <span class="keyword">long</span> delayMillis)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            delayMillis = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</span><br><span class="line">    &#125;</span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">        MessageQueue queue = mQueue;</span><br><span class="line">        <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            RuntimeException e = <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</span><br><span class="line">            Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">        msg.target = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatchMessage"><a href="#dispatchMessage" class="headerlink" title="dispatchMessage()"></a>dispatchMessage()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle system messages here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;<span class="comment">//msg.callback  is a runnable</span></span><br><span class="line">        handleCallback(msg);<span class="comment">//Run callback(Handler.post(Runnable r))</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;<span class="comment">//mCallback is a interface that has handdleMessage method.(We can init Handler by invoking Handler handler = new Handler(Callback call))</span></span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于Handler-postdelayed-一个消息阻塞中，又来个消息"><a href="#关于Handler-postdelayed-一个消息阻塞中，又来个消息" class="headerlink" title="关于Handler.postdelayed()一个消息阻塞中，又来个消息"></a>关于Handler.postdelayed()一个消息阻塞中，又来个消息</h2><p>首先在next()方法中消息A处于阻塞状态（没有消息了或者只有Delay的消息），会把mBlocked这个变量标记为true<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Got a message.</span></span><br><span class="line">            mBlocked = <span class="keyword">false</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">        mBlocked = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">｝    ...</span><br></pre></td></tr></table></figure></p>
<p>当新消息B到来时，进入enqueueMessage（）<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">msg.markInUse();</span><br><span class="line">msg.when = when;</span><br><span class="line">Message p = mMessages;</span><br><span class="line"><span class="keyword">boolean</span> needWake;</span><br><span class="line"><span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</span><br><span class="line">    <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">    msg.next = p;</span><br><span class="line">    mMessages = msg;</span><br><span class="line">    needWake = mBlocked;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">    <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">          nativeWake(mPtr);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新到消息B的延迟时间 &lt; 阻塞消息A的延迟时间。则会将B放在队列头部，A放在B的后面执行。needWake置为true。调用nativeWake()方法唤醒线程</p>
<p>整个调用流程：</p>
<ol>
<li>postDelay()一个10秒钟的Runnable A、消息进队，MessageQueue调用nativePollOnce()阻塞，Looper阻塞；</li>
<li>紧接着post()一个Runnable B、消息进队，判断现在A时间还没到、正在阻塞，把B插入消息队列的头部（A的前面），然后调用nativeWake()方法唤醒线程；</li>
<li>MessageQueue.next()方法被唤醒后，重新开始读取消息链表，第一个消息B无延时，直接返回给Looper；</li>
<li>Looper处理完这个消息再次调用next()方法，MessageQueue继续读取消息链表，第二个消息A还没到时间，计算一下剩余时间（假如还剩9秒）继续调用nativePollOnce()阻塞；</li>
<li>直到阻塞时间到或者下一次有Message进队；</li>
</ol>
<p>题外话：MessageQueue会根据post delay的时间排序放入到链表中，链表头的时间小，尾部时间最大。因此能保证时间Delay最长的不会block住时间短的。当每次post message的时候会进入到MessageQueue的next()方法，会根据其delay时间和链表头的比较，如果更短则，放入链表头，并且看时间是否有delay，如果有，则block，等待时间到来唤醒执行，否则将唤醒立即执行。</p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>CountDownLatch的使用</title>
    <url>/2019/01/29/CountDownLatch/</url>
    <content><![CDATA[<p>　　在BInderPool中有用到countdownLatch.整理如下：</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>  　　CountDownLatch是一个倒计数的同步锁存器。它和信号量有些差异。CountDownLatch是通过先调用await()阻塞当前进程，在其它线程中一直调用countdown（）减小锁存器中的值count。当其它线程任务完成。count减至0.await()释放锁。而信号量则是信号量大于０时，可正常并发。而小于等于０时阻塞.CountDownLatch不支持重置count。如需重置count，可采用CyclicBarrier。</p>
<h2 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PLAYER_AMOUNT = <span class="number">5</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CountDownLatchDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub    </span></span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//对于每位运动员，CountDownLatch减1后即结束比赛</span></span><br><span class="line">        CountDownLatch begin = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//对于整个比赛，所有运动员结束后才算结束</span></span><br><span class="line">        CountDownLatch end = <span class="keyword">new</span> CountDownLatch(PLAYER_AMOUNT);</span><br><span class="line">        Player[] plays = <span class="keyword">new</span> Player[PLAYER_AMOUNT];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;PLAYER_AMOUNT;i++)</span><br><span class="line">            plays[i] = <span class="keyword">new</span> Player(i+<span class="number">1</span>,begin,end);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置特定的线程池，大小为5</span></span><br><span class="line">        ExecutorService exe = Executors.newFixedThreadPool(PLAYER_AMOUNT);</span><br><span class="line">        <span class="keyword">for</span>(Player p:plays)</span><br><span class="line">            exe.execute(p);            <span class="comment">//分配线程</span></span><br><span class="line">        System.out.println(<span class="string">"Race begins!"</span>);</span><br><span class="line">        begin.countDown();<span class="comment">//比赛开始</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            end.await();            <span class="comment">//等待end状态变为0，即为比赛结束</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Race ends!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exe.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch begin;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch end;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Player</span><span class="params">(<span class="keyword">int</span> i, CountDownLatch begin, CountDownLatch end)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.id = i;</span><br><span class="line">        <span class="keyword">this</span>.begin = begin;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            begin.await();        <span class="comment">//等待哨响，等待begin的状态为0</span></span><br><span class="line">            Thread.sleep((<span class="keyword">long</span>)(Math.random()*<span class="number">100</span>));    <span class="comment">//随机分配时间，即运动员完成时间</span></span><br><span class="line">            System.out.println(<span class="string">"Play"</span>+id+<span class="string">" arrived."</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            end.countDown();    <span class="comment">//跑到终点使end状态减1，最终减至0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="生产者消费者"><a href="#生产者消费者" class="headerlink" title="生产者消费者"></a>生产者消费者</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingQueueTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ArrayBlockingQueue&lt;Integer&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;Integer&gt;(<span class="number">5</span>, <span class="keyword">true</span>); <span class="comment">//最大容量为5的数组堵塞队列</span></span><br><span class="line">    <span class="comment">//private static LinkedBlockingQueue&lt;Integer&gt; queue = new LinkedBlockingQueue&lt;Integer&gt;(5);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch producerLatch; <span class="comment">//倒计时计数器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch consumerLatch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BlockingQueueTest queueTest = <span class="keyword">new</span> BlockingQueueTest();</span><br><span class="line">        queueTest.test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        producerLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>); <span class="comment">//state值为10</span></span><br><span class="line">        consumerLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>); <span class="comment">//state值为10</span></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ProducerTask());</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ConsumerTask());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动线程</span></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"producer zero..."</span>);</span><br><span class="line">            producerLatch.await(); <span class="comment">//main线程进入producerLatch倒计时等待状态，直到state值为0，再继续往下执行</span></span><br><span class="line">            System.out.println(<span class="string">"producer end"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"consumer waiting..."</span>);</span><br><span class="line">            consumerLatch.await(); <span class="comment">//main线程进入consumerLatch倒计时等待状态，直到state值为0，再继续往下执行</span></span><br><span class="line">            System.out.println(<span class="string">"consumer end"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//结束线程</span></span><br><span class="line">        t1.interrupt();</span><br><span class="line">        t2.interrupt();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生产者</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ProducerTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                    queue.put(rnd.nextInt(<span class="number">100</span>)); <span class="comment">//如果queue容量已满，则当前线程会堵塞，直到有空间再继续</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//offer方法为非堵塞的</span></span><br><span class="line">                    <span class="comment">//queue.offer(rnd.nextInt(100), 1, TimeUnit.SECONDS); //等待1秒后还不能加入队列则返回失败，放弃加入</span></span><br><span class="line">                    <span class="comment">//queue.offer(rnd.nextInt(100));</span></span><br><span class="line"></span><br><span class="line">                    producerLatch.countDown(); <span class="comment">//state值减1</span></span><br><span class="line">                    <span class="comment">//TimeUnit.SECONDS.sleep(2); //线程休眠2秒</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">//e.printStackTrace();</span></span><br><span class="line">            &#125;  <span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消费者</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConsumerTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                    Integer value = queue.take(); <span class="comment">//如果queue为空，则当前线程会堵塞，直到有新数据加入</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//poll方法为非堵塞的</span></span><br><span class="line">                    <span class="comment">//Integer value = queue.poll(1, TimeUnit.SECONDS); //等待1秒后还没有数据可取则返回失败，放弃获取</span></span><br><span class="line">                    <span class="comment">//Integer value = queue.poll();</span></span><br><span class="line"></span><br><span class="line">                    System.out.println(<span class="string">"value = "</span> + value);</span><br><span class="line"></span><br><span class="line">                    consumerLatch.countDown(); <span class="comment">//state值减1</span></span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>); <span class="comment">//线程休眠2秒</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">//e.printStackTrace();</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ArrayBlockingQueue和LinkedBlockingQueue的区别：</p>
<ol>
<li><p>队列中锁的实现不同</p>
<p> ArrayBlockingQueue实现的队列中的锁是没有分离的，即生产和消费用的是同一个锁；</p>
<p> LinkedBlockingQueue实现的队列中的锁是分离的，即生产用的是putLock，消费是takeLock</p>
</li>
<li><p>在生产或消费时操作不同</p>
<p> ArrayBlockingQueue实现的队列中在生产和消费的时候，是直接将枚举对象插入或移除的；</p>
<p> LinkedBlockingQueue实现的队列中在生产和消费的时候，需要把枚举对象转换为Node<e>进行插入或移除，会影响性能</e></p>
</li>
<li><p>队列大小初始化方式不同</p>
<p> ArrayBlockingQueue实现的队列中必须指定队列的大小；</p>
<p> LinkedBlockingQueue实现的队列中可以不指定队列的大小，但是默认是Integer.MAX_VALUE</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Java API</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Replace Blank</title>
    <url>/2019/01/29/Replace%20Blank/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="将字符串中每个空格替换成“can”"><a href="#将字符串中每个空格替换成“can”" class="headerlink" title="将字符串中每个空格替换成“can”"></a>将字符串中每个空格替换成“can”</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:sdf sddsf sef</span><br><span class="line">Output:sdfcansddsfcansef</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　首先遍历一遍数组得到空格数目。每替换一个空格，字符串长度增加2.替换后的字符串长度为原来的长度乘以2.<br>  　　从字符串的末尾开始向头移动复制替换。indexOfOriginal指向原始字符串的末尾，indexOfNew指向替换之后的字符串末尾。遇到空格时，indexOfNew前插入can.indexOfOrigin–；否则将indexOfOriginal所指向的值复制进入indexOfNew指向位置。直至indexOfOriginal &lt; 0 或者indexOriginal &gt;= indexOfNew结束。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReplaceBlank</span><span class="params">(<span class="keyword">char</span>[] s, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (s == <span class="keyword">null</span> &amp;&amp; s.length == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> numberOfBlank = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">           <span class="keyword">if</span> (s[i] == <span class="string">' '</span>) &#123;</span><br><span class="line">               numberOfBlank++;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> newLength = length + numberOfBlank * <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span>（newLength &gt; length）&#123;</span><br><span class="line">	　　<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">       <span class="keyword">int</span> indexOfOriginal = length;</span><br><span class="line">       <span class="keyword">int</span> indexOfNew = newLength;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (indexOfOriginal &gt;= <span class="number">0</span> &amp;&amp; indexOfNew &gt; indexOfOriginal) &#123;</span><br><span class="line">           <span class="keyword">if</span> (s[indexOfOriginal] == <span class="string">' '</span>) &#123;</span><br><span class="line">               s[indexOfNew--] = <span class="string">'n'</span>;</span><br><span class="line">               s[indexOfNew--] = <span class="string">'a'</span>;</span><br><span class="line">               s[indexOfNew--] = <span class="string">'c'</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               s[indexOfNew--] = s[indexOfOriginal];</span><br><span class="line">           &#125;</span><br><span class="line">           --indexOfOriginal;</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">""</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>字符串</tag>
        <tag>剑指Offer</tag>
      </tags>
  </entry>
  <entry>
    <title>手撕HashMap</title>
    <url>/2019/01/29/%E6%89%8B%E6%92%95HashMap/</url>
    <content><![CDATA[<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="位桶-链表-红黑树"><a href="#位桶-链表-红黑树" class="headerlink" title="位桶 + 链表 + 红黑树"></a>位桶 + 链表 + 红黑树</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Node是单向链表，它实现了Map.Entry接口</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">k</span>,<span class="title">v</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">k</span>,<span class="title">v</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;k,v&gt; next;</span><br><span class="line">    <span class="comment">//构造函数Hash值 键 值 下一个节点</span></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;k,v&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + = + value; &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</span><br><span class="line">        V oldValue = value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断两个node是否相等,若key和value都相等，返回true。可以与自身比较为true</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">            Map.Entry&lt;!--?,?--&gt; e = (Map.Entry&lt;!--?,?--&gt;)o;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                Objects.equals(value, e.getValue()))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">transient</span> Node&lt;k,v&gt;[] table;<span class="comment">//存储位桶的数组。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//红黑树</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">k</span>,<span class="title">v</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">LinkedHashMapEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;<span class="comment">//LinkedHashMap.LinkedHashMapEntry&lt;K,V&gt;  继承 Node&lt;K,V&gt;</span></span><br><span class="line">    TreeNode&lt;k,v&gt; parent;  <span class="comment">// 父节点</span></span><br><span class="line">    TreeNode&lt;k,v&gt; left; <span class="comment">//左子树</span></span><br><span class="line">    TreeNode&lt;k,v&gt; right;<span class="comment">//右子树</span></span><br><span class="line">    TreeNode&lt;k,v&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">    <span class="keyword">boolean</span> red;    <span class="comment">//颜色属性</span></span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;k,v&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//返回当前节点的根节点</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> TreeNode&lt;k,v&gt; <span class="title">root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (TreeNode&lt;k,v&gt; r = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((p = r.parent) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            r = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h2><p><img src="/images/HashMap.png" alt="hashMap"><br>Bucket为Hash值相同的元素集合。通过Hash函数计算出元素放置位置。若无冲突直接插入。有冲突则当桶的上的结点数大于TREEIFY_THRESHOLD时且table中结点数目大于MIN_TREEIFY_CAPACITY会转成红黑树。当桶上的结点数小于UNTREEIFY_THRESHOLD时树转链表。再插入结点。 数据结构转换时，是以table中hash函数所在的第一个节点开始转换。</p>
<h2 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 默认的初始容量是16</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>;   </span><br><span class="line">    <span class="comment">// 最大容量</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>; </span><br><span class="line">    <span class="comment">// 默认的填充因子</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line">    <span class="comment">// 当桶(bucket)上的结点数大于这个值时会转成红黑树</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>; </span><br><span class="line">    <span class="comment">// 当桶(bucket)上的结点数小于这个值时树转链表</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line">    <span class="comment">// 桶中结构转化为红黑树对应的table的最小大小</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line">    <span class="comment">// 存储元素的数组，总是2的幂次倍</span></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;k,v&gt;[] table; </span><br><span class="line">    <span class="comment">// 存放具体元素的集</span></span><br><span class="line">    <span class="keyword">transient</span> Set&lt;map.entry&lt;k,v&gt;&gt; entrySet;</span><br><span class="line">    <span class="comment">// 存放元素的个数，注意这个不等于数组的长度。</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">// 每次扩容和更改map结构的计数器</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">int</span> modCount;   </span><br><span class="line">    <span class="comment">// 临界值 当实际大小(容量*填充因子)超过临界值时，会进行扩容</span></span><br><span class="line">    <span class="keyword">int</span> threshold;</span><br><span class="line">    <span class="comment">// 填充因子</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始容量不能小于0，否则报错</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                            initialCapacity);</span><br><span class="line">    <span class="comment">// 初始容量不能大于最大值，否则为最大值</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="comment">// 填充因子不能小于或等于0，不能为非数字</span></span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                            loadFactor);</span><br><span class="line">    <span class="comment">// 初始化填充因子                                        </span></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="comment">// 初始化threshold大小</span></span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//构造函数3</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//构造函数4用m的元素初始化散列映射</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;!--? extends K, ? extends V--&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">    putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tableSizeFor(initialCapacity)返回大于等于initialCapacity的最小的二次幂数值。如capacity为9.返回16.<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;<span class="comment">//&gt;&gt;&gt; 操作符表示无符号右移，高位取0。</span></span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="重要成员函数"><a href="#重要成员函数" class="headerlink" title="重要成员函数"></a>重要成员函数</h2> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取key对应所在tab的位置</span></span><br><span class="line">i = (n - <span class="number">1</span>) &amp; hash（key）</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;k,v&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;k,v&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;k,v&gt;[] tab; Node&lt;k,v&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">//hash &amp; (length-1)得到对象的保存位</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果第一个节点是TreeNode,说明采用的是数组+红黑树结构处理冲突</span></span><br><span class="line">            <span class="comment">//遍历红黑树，得到节点值</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;k,v&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">//链表结构处理</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> <span class="comment">/* putVal</span></span><br><span class="line"><span class="comment"> 1判断键值对数组tab[]是否为空或为null，否则resize()；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2根据键值key计算hash值得到插入的数组索引i，如果tab[i]==null，直接新建节点添加，否则转入3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">3判断当前数组中处理hash冲突的方式为链表还是红黑树(check第一个节点类型即可),分别处理。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">       Node&lt;k,v&gt;[] tab; Node&lt;k,v&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">       <span class="comment">//如果tab为空或长度为0，则分配内存resize()</span></span><br><span class="line">       <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">           n = (tab = resize()).length;</span><br><span class="line">       <span class="comment">//(n - 1) &amp; hash找到put位置，如果为空,则直接put</span></span><br><span class="line">       <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">           tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           Node&lt;k,v&gt; e; K k;</span><br><span class="line">           <span class="comment">//第一节节点hash值同，且key值与插入key相同</span></span><br><span class="line">           <span class="keyword">if</span> (p.hash == hash &amp;&amp;((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">               e = p;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)<span class="comment">//属于红黑树处理冲突</span></span><br><span class="line">               e = ((TreeNode&lt;k,v&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//链表处理冲突</span></span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                   <span class="comment">//p第一次指向表头,以后依次后移</span></span><br><span class="line">                   <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="comment">//e为空，表示已到表尾也没有找到key值相同节点，则新建节点</span></span><br><span class="line">                       p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                       <span class="comment">//新增节点后如果节点个数到达阈值，则将链表转换为红黑树</span></span><br><span class="line">                       <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                           treeifyBin(tab, hash);</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">//容许null==null</span></span><br><span class="line">                   <span class="keyword">if</span> (e.hash == hash &amp;&amp;((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   p = e;<span class="comment">//更新p指向下一个节点</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//更新hash值和key值均相同的节点Value值</span></span><br><span class="line">           <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">               V oldValue = e.value;</span><br><span class="line">               <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                   e.value = value;</span><br><span class="line">               afterNodeAccess(e);</span><br><span class="line">               <span class="keyword">return</span> oldValue;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ++modCount;</span><br><span class="line">       <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">           resize();</span><br><span class="line">       afterNodeInsertion(evict);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>resize分为两步:(oldCap：原数组长度， newCap：新数组长度)</p>
<ol>
<li>将newTable扩充为两倍的table</li>
<li>重新计算index，把节点再放到新的bucket中<br>之所以重新计算index，是因为数组长度变化可能导致元素的所在index变化<br>若仅有一个节点，则index = e.hash &amp; (newCap - 1);<br>若多于一个节点，以链表为例，<br>获取每个bucket中的节点e, 判断（e.hash &amp; oldCap) == 0，是的话则放置在原索引位置 j ，否则放置到 j + oldCap;</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">// 当前table保存</span></span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">// 保存table大小</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="comment">// 保存当前阈值 </span></span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 之前table大小大于0</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 之前table大于最大容量</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">// 阈值为最大整形</span></span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 容量翻倍，使用左移，效率更高</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">            oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            <span class="comment">// 阈值翻倍</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 之前阈值大于0</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>)</span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="comment">// oldCap = 0并且oldThr = 0，使用缺省值（如使用HashMap()构造函数，之后再插入一个元素会调用resize函数，会进入这一步）</span></span><br><span class="line">    <span class="keyword">else</span> &#123;           </span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 新阈值为0</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    <span class="comment">// 初始化table</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="comment">// 之前的table已经初始化过</span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 复制元素，重新进行hash</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="comment">// 将同一桶中的元素根据(e.hash &amp; oldCap)是否为0进行分割，分成两个不同的链表，完成rehash</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>JavaAPI</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Binder Pool</title>
    <url>/2019/01/28/Binder%20Pool/</url>
    <content><![CDATA[<p><img src="/images/binder_pool.png" alt="binder_pool"><br>从图中可知，每个aidl在Binder连接池中都有一个对应的Binder实例。在BinderPool中提供一个根据code查询对应Binder的query方法。</p>
<ol>
<li><p>服务端创建三个aidl文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ISecurityCenter.aidl</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISecurityCenter</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">encrypt</span><span class="params">(String content)</span></span>;</span><br><span class="line">  <span class="function">String <span class="title">decrypt</span><span class="params">(String password)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ICompute.aidl</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICompute</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// IBinderPool.aidl</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBinderPool</span> </span>&#123;</span><br><span class="line">   <span class="function">IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> binderCode)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端实现对应Binder实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityCenterImpl</span> <span class="keyword">extends</span> <span class="title">ISecurityCenter</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span> SECRET_CODE = <span class="string">'^'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">encrypt</span><span class="params">(String content)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] chars = content.toCharArray();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">      chars[i] ^= SECRET_CODE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(chars);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">decrypt</span><span class="params">(String password)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> encrypt(password);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComputeImpl</span> <span class="keyword">extends</span> <span class="title">ICompute</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_NONE = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_COMPUTE = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_SECURITY_CENTER = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Context mContext;</span><br><span class="line">  <span class="keyword">private</span> IBinderPool mBinderPool;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> BinderPool sInstance;</span><br><span class="line">  <span class="keyword">private</span> CountDownLatch mConnectBinderPoolCountDownLatch;</span><br><span class="line">  <span class="comment">//sync operation,Prevent the conflicts of binding.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ServiceConnection mBinderPoolConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">      mBinderPool = IBinderPool.Stub.asInterface(service);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        mBinderPool.asBinder().linkToDeath(mBinderDeathRecipient, <span class="number">0</span>);<span class="comment">//Prevent unexpected exit</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      mConnectBinderPoolCountDownLatch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">private</span> IBinder.DeathRecipient mBinderDeathRecipient = <span class="keyword">new</span> IBinder.DeathRecipient() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Log.i(<span class="string">"TAG"</span>, <span class="string">"binderDied: "</span>);</span><br><span class="line">      mBinderPool.asBinder().unlinkToDeath(mBinderDeathRecipient, <span class="number">0</span>);</span><br><span class="line">      mBinderPool = <span class="keyword">null</span>;</span><br><span class="line">      connectBinderPoolService();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">BinderPool</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    mContext = context.getApplicationContext();</span><br><span class="line">    connectBinderPoolService();<span class="comment">//Begin conncect service</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BinderPool <span class="title">getInsance</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (BinderPool<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">          sInstance = <span class="keyword">new</span> BinderPool(context);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sInstance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">connectBinderPoolService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mConnectBinderPoolCountDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);<span class="comment">//Only one client can bind service</span></span><br><span class="line">    Intent service = <span class="keyword">new</span> Intent(mContext, BinderPoolService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    mContext.bindService(service, mBinderPoolConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      mConnectBinderPoolCountDownLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> bindCode)</span> </span>&#123;</span><br><span class="line">    IBinder binder = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mBinderPool != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        binder = mBinderPool.queryBinder(bindCode);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> binder;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolImpl</span> <span class="keyword">extends</span> <span class="title">IBinderPool</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinderPoolImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> binderCode)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">      IBinder binder = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">switch</span> (binderCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> BINDER_SECURITY_CENTER:</span><br><span class="line">          binder = <span class="keyword">new</span> SecurityCenterImpl();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BINDER_COMPUTE:</span><br><span class="line">          binder = <span class="keyword">new</span> ComputeImpl();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> binder;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>服务端返回Binder连接池<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Binder mBinderPool = <span class="keyword">new</span> BinderPool.BinderPoolImpl();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Log.i(<span class="string">"TAG"</span>, <span class="string">"service:onCreate: "</span>);</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    Log.d(<span class="string">"TAG"</span>, <span class="string">"onBind"</span>);</span><br><span class="line">    <span class="keyword">return</span> mBinderPool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>4.客户端通过BinderPool获得对应Binder。再从Binder中获取已被服务器实现了的接口。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> ISecurityCenter mSecurityCenter;</span><br><span class="line">  <span class="keyword">private</span> ICompute mCompute;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doWork();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BinderPool binderPool = BinderPool.getInsance(BinderPoolActivity.<span class="keyword">this</span>);</span><br><span class="line">    IBinder securityBinder = binderPool</span><br><span class="line">        .queryBinder(BinderPool.BINDER_SECURITY_CENTER);</span><br><span class="line">    ;</span><br><span class="line">    mSecurityCenter = (ISecurityCenter) SecurityCenterImpl</span><br><span class="line">        .asInterface(securityBinder);<span class="comment">//Get implemented interface</span></span><br><span class="line">    Log.d(<span class="string">"TAG"</span>, <span class="string">"visit ISecurityCenter"</span>);</span><br><span class="line">    String msg = <span class="string">"helloworld-安卓"</span>;</span><br><span class="line">    System.out.println(<span class="string">"content:"</span> + msg);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String password = mSecurityCenter.encrypt(msg);</span><br><span class="line">      System.out.println(<span class="string">"encrypt:"</span> + password);</span><br><span class="line">      System.out.println(<span class="string">"decrypt:"</span> + mSecurityCenter.decrypt(password));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log.d(<span class="string">"TAG"</span>, <span class="string">"visit ICompute"</span>);</span><br><span class="line">    IBinder computeBinder = binderPool</span><br><span class="line">        .queryBinder(BinderPool.BINDER_COMPUTE);</span><br><span class="line">    ;</span><br><span class="line">    mCompute = ComputeImpl.asInterface(computeBinder);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">"3+5="</span> + mCompute.add(<span class="number">3</span>, <span class="number">5</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>IPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Unique paths</title>
    <url>/2019/01/28/Unique%20paths/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="A-robot-is-located-at-the-top-left-corner-of-a-m-x-n-grid-marked-‘Start’-in-the-diagram-below-The-robot-can-only-move-either-down-or-right-at-any-point-in-time-The-robot-is-trying-to-reach-the-bottom-right-corner-of-the-grid-marked-‘Finish’-in-the-diagram-below-How-many-possible-unique-paths-are-there"><a href="#A-robot-is-located-at-the-top-left-corner-of-a-m-x-n-grid-marked-‘Start’-in-the-diagram-below-The-robot-can-only-move-either-down-or-right-at-any-point-in-time-The-robot-is-trying-to-reach-the-bottom-right-corner-of-the-grid-marked-‘Finish’-in-the-diagram-below-How-many-possible-unique-paths-are-there" class="headerlink" title="A robot is located at the top-left corner of a m x n grid (marked ‘Start’ in the diagram below).The robot can only move either down or right at any point in time. The robot is trying to reach the bottom-right corner of the grid (marked ‘Finish’ in the diagram below).How many possible unique paths are there?"></a>A robot is located at the top-left corner of a m x n grid (marked ‘Start’ in the diagram below).The robot can only move either down or right at any point in time. The robot is trying to reach the bottom-right corner of the grid (marked ‘Finish’ in the diagram below).How many possible unique paths are there?</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: m = <span class="number">3</span>, n = <span class="number">2</span></span><br><span class="line">Output: <span class="number">3</span></span><br><span class="line">Explanation:</span><br><span class="line">From the top-left corner, there are a total of <span class="number">3</span> ways to reach the bottom-right corner:</span><br><span class="line"><span class="number">1</span>. Right -&gt; Right -&gt; Down</span><br><span class="line"><span class="number">2</span>. Right -&gt; Down -&gt; Right</span><br><span class="line"><span class="number">3</span>. Down -&gt; Right -&gt; Right</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: m = <span class="number">7</span>, n = <span class="number">3</span></span><br><span class="line">Output: <span class="number">28</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　模拟做出来了，但超时了。试图剪枝，仍无果。网上参考了别人的思路。<br>  　　1. 数学法：机器人总共走m+n-2步，其中m-1步往下走，n-1步往右走，本质上就是一个组合问题，也就是从m+n-2个不同元素中每次取出min(m-1, n -1)个元素的组合数。根据组合的计算公式，可以写代码来求解即可。有个小技巧；$$ {m \choose n}  =  {n - m \choose n}$$<br>　　故而可取较小的m计算阶乘，降低时间复杂度<br>  　　2. 动态规划法：维护一个二维数组dp初始化为1，其中dp[i][j]表示到当前位置不同的走法的个数，然后可以得到递推式为:$$ dp[i][j] = dp[i - 1][j] + dp[i][j - 1]$$，这里为了节省空间，我们使用一维数组dp逐行刷新模拟，即$$dp[i] = dp[i] + dp[i - 1]$$</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//OverTime</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> row, col;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uniquePaths</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="number">1</span> &amp;&amp; n == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        col = m;</span><br><span class="line">        row = n;</span><br><span class="line">        path(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">path</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (col - <span class="number">1</span> == m &amp;&amp; row - <span class="number">1</span> == n) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (col - <span class="number">1</span> == m &amp;&amp; row - <span class="number">1</span> != n)</span><br><span class="line">            path(m, n + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (row - <span class="number">1</span> == n &amp;&amp; col - <span class="number">1</span> != m)</span><br><span class="line">            path(m + <span class="number">1</span>, n);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            path(m + <span class="number">1</span>, n);</span><br><span class="line">            path(m, n + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Math</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uniquePaths</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="number">1</span> &amp;&amp; n == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> numerator = <span class="number">1</span>, denominator = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> small = (m &gt; n) ? n - <span class="number">1</span> : m - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= small; i++) &#123;</span><br><span class="line">            denominator *= i;</span><br><span class="line">            numerator *= m + n - <span class="number">1</span> - i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (numerator / denominator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uniquePaths</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] a = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">            a[i] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">                a[j] += a[j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a[n - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Climbing a stair</title>
    <url>/2019/01/27/Climbing%20a%20stair/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="You-are-climbing-a-stair-case-It-takes-n-steps-to-reach-to-the-top-Each-time-you-can-either-climb-1-or-2-steps-In-how-many-distinct-ways-can-you-climb-to-the-top-Note-Given-n-will-be-a-positive-integer"><a href="#You-are-climbing-a-stair-case-It-takes-n-steps-to-reach-to-the-top-Each-time-you-can-either-climb-1-or-2-steps-In-how-many-distinct-ways-can-you-climb-to-the-top-Note-Given-n-will-be-a-positive-integer" class="headerlink" title="You are climbing a stair case. It takes n steps to reach to the top.Each time you can either climb 1 or 2 steps. In how many distinct ways can you climb to the top?Note: Given n will be a positive integer."></a>You are climbing a stair case. It takes n steps to reach to the top.Each time you can either climb 1 or 2 steps. In how many distinct ways can you climb to the top?Note: Given n will be a positive integer.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">2</span></span><br><span class="line">Output: <span class="number">2</span></span><br><span class="line">Explanation: There are two ways to climb to the top.</span><br><span class="line"><span class="number">1</span>. <span class="number">1</span> step + <span class="number">1</span> step</span><br><span class="line"><span class="number">2</span>. <span class="number">2</span> steps</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="number">3</span></span><br><span class="line">Output: <span class="number">3</span></span><br><span class="line">Explanation: There are three ways to climb to the top.</span><br><span class="line"><span class="number">1</span>. <span class="number">1</span> step + <span class="number">1</span> step + <span class="number">1</span> step</span><br><span class="line"><span class="number">2</span>. <span class="number">1</span> step + <span class="number">2</span> steps</span><br><span class="line"><span class="number">3</span>. <span class="number">2</span> steps + <span class="number">1</span> step</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　剑指Offer上的青蛙跳台阶翻版，即斐波那契数列。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">climbStairs</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] res = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res[n];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> fibMinTwo = <span class="number">1</span>,fibMinOne = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> fibN = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</span><br><span class="line">            fibN = fibMinOne + fibMinTwo;</span><br><span class="line">            fibMinTwo = fibMinOne;</span><br><span class="line">            fibMinOne = fibN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fibN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Gray code</title>
    <url>/2019/01/27/Gray%20code/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="The-gray-code-is-a-binary-numeral-system-where-two-successive-values-differ-in-only-one-bit-Given-a-non-negative-integer-n-representing-the-total-number-of-bits-in-the-code-print-the-sequence-of-gray-code-A-gray-code-sequence-must-begin-with-0"><a href="#The-gray-code-is-a-binary-numeral-system-where-two-successive-values-differ-in-only-one-bit-Given-a-non-negative-integer-n-representing-the-total-number-of-bits-in-the-code-print-the-sequence-of-gray-code-A-gray-code-sequence-must-begin-with-0" class="headerlink" title="The gray code is a binary numeral system where two successive values differ in only one bit.Given a non-negative integer n representing the total number of bits in the code, print the sequence of gray code. A gray code sequence must begin with 0."></a>The gray code is a binary numeral system where two successive values differ in only one bit.Given a non-negative integer n representing the total number of bits in the code, print the sequence of gray code. A gray code sequence must begin with 0.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">2</span></span><br><span class="line">Output: [<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>]</span><br><span class="line">Explanation:</span><br><span class="line"><span class="number">00</span> - <span class="number">0</span></span><br><span class="line"><span class="number">01</span> - <span class="number">1</span></span><br><span class="line"><span class="number">11</span> - <span class="number">3</span></span><br><span class="line"><span class="number">10</span> - <span class="number">2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="number">0</span></span><br><span class="line">Output: [<span class="number">0</span>]</span><br><span class="line">Explanation: We define the gray code sequence to begin with <span class="number">0</span>.</span><br><span class="line">             A gray code sequence of n has size = <span class="number">2</span>n, which <span class="keyword">for</span> n = <span class="number">0</span> the size is <span class="number">20</span> = <span class="number">1</span>.</span><br><span class="line">             Therefore, <span class="keyword">for</span> n = <span class="number">0</span> the gray code sequence is [<span class="number">0</span>].</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　两种做法，一种是回溯，另一种是找规律（对于编程技术提高然并卵）。<br>　　找规律格雷编码与二进制的关系： 从最右边一位起，依次将每一位与左边一位异或(XOR)，作为对应格雷码该位的值，最左边一位不变(相当于左边是0)。如 6(0110) 与3( 0011) 异或得到格雷编码0101.<br>　　回溯法：也有点找规律的意思，长度为n的格雷编码 = 长度为 n - 1的格雷编码每个编码前加0,再逆序对每个编码前加1.如长度为1的编码为0 ，1.而长度为2的编码为00，01，11，10.</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">grayCode</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        n = <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            list.add(i ^ (i &gt;&gt; <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">grayCode</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        dfs(list, <span class="number">1</span>, n);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(List&lt;Integer&gt; list, <span class="keyword">int</span> cur, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            list.add(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cur &gt; n) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cur == <span class="number">1</span>) &#123;</span><br><span class="line">            list.add(<span class="number">0</span>);</span><br><span class="line">            list.add(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> len = list.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                list.add((<span class="keyword">int</span>) (list.get(len - i - <span class="number">1</span>) + Math.pow(<span class="number">2</span>, cur - <span class="number">1</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dfs(list, cur + <span class="number">1</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Find all possible permutations</title>
    <url>/2019/01/26/Find%20all%20possible%20permutations/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-collection-of-distinct-integers-return-all-possible-permutations-The-order-of-list-doesn’t-matter"><a href="#Given-a-collection-of-distinct-integers-return-all-possible-permutations-The-order-of-list-doesn’t-matter" class="headerlink" title="Given a collection of distinct integers, return all possible permutations.The order of list doesn’t matter."></a>Given a collection of distinct integers, return all possible permutations.The order of list doesn’t matter.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">Output:</span><br><span class="line">[</span><br><span class="line">  [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],</span><br><span class="line">  [<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>],</span><br><span class="line">  [<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>],</span><br><span class="line">  [<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>],</span><br><span class="line">  [<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>],</span><br><span class="line">  [<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　一种解法两种出发角度：</p>
<ol>
<li>第一次见到的交换+回溯。遍历数组，每遇到一个元素nums[i]，将其与nums[start]交换，再对 i 之后的元素递归执行深搜。找到长度为length - 1的集合后加入结果集。再将 nums[i] 与 nums[start] 交换回来，否则会出现重复集合。</li>
<li>分治思想将该字符串分为两部分：第一部分为它的第一个字符，第二部分为剩余所有字符。假设第二部分已找到全排列，加上第一部分。就得到以该字符为头的全排列。将剩余所有字符与首字符交换。即可得到所有字符的全排列.如下图所示，字符串划分为两部分：红色首字符和蓝色剩余字符。</li>
</ol>
<p><img src="/images/all_permutations.png" alt="enter description here"><br>    遍历所有字符<br>（1）将当前字符i与第一个字符交换<br>（2）再求出i之后剩余字符的全排列(递归)<br>（3）再将当前字符与首字符交换回来</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; permute(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; lists = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        DFS(nums, <span class="number">0</span>, lists);</span><br><span class="line">        <span class="keyword">return</span> lists;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = nums[m];</span><br><span class="line">        nums[m] = nums[n];</span><br><span class="line">        nums[n] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> start, List&lt;List&lt;Integer&gt;&gt; lists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start == nums.length) &#123;</span><br><span class="line">            List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> num : nums) &#123;</span><br><span class="line">                list.add(num);</span><br><span class="line">            &#125;</span><br><span class="line">            lists.add(list);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; nums.length; i++) &#123;</span><br><span class="line">            swap(nums, start, i);</span><br><span class="line">            DFS(nums, start + <span class="number">1</span>, lists);</span><br><span class="line">            swap(nums, start, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Find all possible subsets</title>
    <url>/2019/01/26/Find%20all%20possible%20subsets/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-set-of-distinct-integers-nums-return-all-possible-subsets-the-power-set-Note-The-solution-set-must-not-contain-duplicate-subsets"><a href="#Given-a-set-of-distinct-integers-nums-return-all-possible-subsets-the-power-set-Note-The-solution-set-must-not-contain-duplicate-subsets" class="headerlink" title="Given a set of distinct integers, nums, return all possible subsets (the power set).Note: The solution set must not contain duplicate subsets."></a>Given a set of distinct integers, nums, return all possible subsets (the power set).Note: The solution set must not contain duplicate subsets.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: nums = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">Output:</span><br><span class="line">[</span><br><span class="line">  [<span class="number">3</span>],</span><br><span class="line">  [<span class="number">1</span>],</span><br><span class="line">  [<span class="number">2</span>],</span><br><span class="line">  [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],</span><br><span class="line">  [<span class="number">1</span>,<span class="number">3</span>],</span><br><span class="line">  [<span class="number">2</span>,<span class="number">3</span>],</span><br><span class="line">  [<span class="number">1</span>,<span class="number">2</span>],</span><br><span class="line">  []</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　和上一道 Find all possible permutations 类似，先将空集添入集合。<br>  再遍历数组：</p>
<ol>
<li>将nums[i]添入list</li>
<li>再以每个元素nums[i]为头深搜出 nums[i] 与 nums[i] 元素之后构成的子集</li>
<li>再从list中删除nums[i]元素。<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; subsets(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; lists = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        DFS(nums, <span class="number">0</span>, lists, list);</span><br><span class="line">        <span class="keyword">return</span> lists;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> start, List&lt;List&lt;Integer&gt;&gt; lists, List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; integers = <span class="keyword">new</span> ArrayList&lt;&gt;(list);</span><br><span class="line">        lists.add(integers);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; nums.length; i++) &#123;</span><br><span class="line">            integers.add(nums[i]);</span><br><span class="line">            DFS(nums, i + <span class="number">1</span>, lists, integers);</span><br><span class="line">            integers.remove(integers.size() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Generate all combinations of well-formed parentheses.</title>
    <url>/2019/01/25/generate%20all%20combinations%20of%20well-formed%20parentheses/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-n-pairs-of-parentheses（括号）-write-a-function-to-generate-all-combinations-of-well-formed-parentheses"><a href="#Given-n-pairs-of-parentheses（括号）-write-a-function-to-generate-all-combinations-of-well-formed-parentheses" class="headerlink" title="Given n pairs of parentheses（括号）, write a function to generate all combinations of well-formed parentheses."></a>Given n pairs of parentheses（括号）, write a function to generate all combinations of well-formed parentheses.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">3</span></span><br><span class="line">Output: </span><br><span class="line">[</span><br><span class="line">  <span class="string">"((()))"</span>,</span><br><span class="line">  <span class="string">"(()())"</span>,</span><br><span class="line">  <span class="string">"(())()"</span>,</span><br><span class="line">  <span class="string">"()(())"</span>,</span><br><span class="line">  <span class="string">"()()()"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　和Combinations of a Phone Number类似，都是用回溯法，不过具体运用有些差异。如需要左右指针确定添加左括号还是右括号。先添加左括号深搜下去，直至left == n(PS:左右括号数目均为n)，再回溯添加右括号。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">generateParenthesis</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; strings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        group(strings, <span class="string">""</span>, <span class="number">0</span>, <span class="number">0</span>, n);</span><br><span class="line">        <span class="keyword">return</span> strings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">group</span><span class="params">(List&lt;String&gt; strings, String str, <span class="keyword">int</span> left, <span class="keyword">int</span> right, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (str.length() == n * <span class="number">2</span>) &#123;</span><br><span class="line">            strings.add(str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left &lt; n) &#123;</span><br><span class="line">            group(strings, str + <span class="string">'('</span>, left + <span class="number">1</span>, right, n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; left) &#123;</span><br><span class="line">            group(strings, str + <span class="string">')'</span>, left, right + <span class="number">1</span>, n);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the maximum path sum</title>
    <url>/2019/01/24/Find%20the%20maximum%20path%20sum/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-non-empty-binary-tree-find-the-maximum-path-sum-For-this-problem-a-path-is-defined-as-any-sequence-of-nodes-from-some-starting-node-to-any-node-in-the-tree-along-the-parent-child-connections-The-path-must-contain-at-least-one-node-and-does-not-need-to-go-through-the-root"><a href="#Given-a-non-empty-binary-tree-find-the-maximum-path-sum-For-this-problem-a-path-is-defined-as-any-sequence-of-nodes-from-some-starting-node-to-any-node-in-the-tree-along-the-parent-child-connections-The-path-must-contain-at-least-one-node-and-does-not-need-to-go-through-the-root" class="headerlink" title="Given a non-empty binary tree, find the maximum path sum.For this problem, a path is defined as any sequence of nodes from some starting node to any node in the tree along the parent-child connections. The path must contain at least one node and does not need to go through the root."></a>Given a non-empty binary tree, find the maximum path sum.For this problem, a path is defined as any sequence of nodes from some starting node to any node in the tree along the parent-child connections. The path must contain at least one node and does not need to go through the root.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">       <span class="number">1</span></span><br><span class="line">      / \</span><br><span class="line">     <span class="number">2</span>   <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Output: <span class="number">6</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: [-<span class="number">10</span>,<span class="number">9</span>,<span class="number">20</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="number">15</span>,<span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">   -<span class="number">10</span></span><br><span class="line">   / \</span><br><span class="line">  <span class="number">9</span>  <span class="number">20</span></span><br><span class="line">    /  \</span><br><span class="line">   <span class="number">15</span>   <span class="number">7</span></span><br><span class="line"></span><br><span class="line">Output: <span class="number">42</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　每个节点的左右子树的最大路径和为左右子树的最大路径和的最大值加上当前节点值。取其中最大值即为二叉树的路径和。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = Integer.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxPathSum</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        findMaxPath(root);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findMaxPath</span><span class="params">(TreeNode node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> left = findMaxPath(node.left);</span><br><span class="line">        <span class="keyword">int</span> right = findMaxPath(node.right);</span><br><span class="line">        res = Math.max(res, Math.max(<span class="number">0</span>, left) + Math.max(<span class="number">0</span>, right) + node.val);</span><br><span class="line">        <span class="keyword">return</span> Math.max(<span class="number">0</span>, Math.max(left, right)) + node.val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Determine if it is a power of two</title>
    <url>/2019/01/23/Determine%20if%20it%20is%20a%20power%20of%20two/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-integer-write-a-function-to-determine-if-it-is-a-power-of-two"><a href="#Given-an-integer-write-a-function-to-determine-if-it-is-a-power-of-two" class="headerlink" title="Given an integer, write a function to determine if it is a power of two."></a>Given an integer, write a function to determine if it is a power of two.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">1</span></span><br><span class="line">Output: <span class="keyword">true</span> </span><br><span class="line">Explanation: <span class="number">20</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="number">16</span></span><br><span class="line">Output: <span class="keyword">true</span></span><br><span class="line">Explanation: <span class="number">24</span> = <span class="number">16</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input: <span class="number">218</span></span><br><span class="line">Output: <span class="keyword">false</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　这道题在剑指Offer上的“二进制中1的个数”的封装。首先可以确定的是2的幂的二进制中最左端只有1，其余为0。若如此，可将n = （n - 1）&amp; n，这样会将n二进制中最右端的1赋值为0.。若n为2的幂的话，进行与运算后，n 会等于0。否则不等于 0.</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerOfTwo</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ((n - <span class="number">1</span>) &amp; n) == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Messenger Again</title>
    <url>/2019/01/20/Messenger%20Again/</url>
    <content><![CDATA[<h2 id="Messenger-与-AIDL的前世今生"><a href="#Messenger-与-AIDL的前世今生" class="headerlink" title="Messenger 与 AIDL的前世今生"></a>Messenger 与 AIDL的前世今生</h2><p>　　Messenger这个信使呀，每天东奔西走的传递各个Message对象。咦，是不是好熟悉。传递Message的信使，哎呀不还有个Handler老哥吗？关于消息机制会在下一章消息机制进行解析。说了也巧，Messenger中Handler也插足了。但不是负责传递消息。而是负责接受处理。简单的说就是受了。而Messenger负责传。Messenger的底层实现是aidl。但又不同于aidl。Messenger只能串行传递消息，即一次一个消息。而aidl可以并发执行。</p>
<h2 id="传递原理"><a href="#传递原理" class="headerlink" title="传递原理"></a>传递原理</h2><p>  <img src="/images/Messenger.png" alt="Messenger"><br>  盗自Hyman大佬。<br>  前提：C/S都维护着一个Messenger和Handler。</p>
<ol>
<li>客户端连接建立时获取到服务器Messenger发送客户端消息请求时，并将自己的Messenger 作为回复Messenger（msg.replyTo）传入。</li>
<li>服务端的Handler收到消息后会取出客户端的Messenger.发送服务端消息回复。并将自己的Messenger 作为回复Messenger（msg.replyTo）传入。</li>
<li>客户端的Handler收到消息处理。</li>
</ol>
<p>局部代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Client</span></span><br><span class="line">  <span class="keyword">private</span> Messenger mReplyMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> MessengerHandler());</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MessengerService.MSG_FROM_SERVICE:</span><br><span class="line">          Log.i(<span class="string">"NightXLT"</span>, <span class="string">"Receive: "</span> + msg.getData().getString(<span class="string">"reply"</span>));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span> ServiceConnection mServiceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">      mService = <span class="keyword">new</span> Messenger(service);</span><br><span class="line">      Message msg = Message.obtain(<span class="keyword">null</span>, MessengerService.MSG_FROM_CLIENT);</span><br><span class="line">      Bundle data = <span class="keyword">new</span> Bundle();</span><br><span class="line">      data.putString(<span class="string">"msg"</span>, <span class="string">"sdfsdfsdf"</span>);</span><br><span class="line">      <span class="comment">/*Book boo = new Book(0, "the spirit of Chinese");</span></span><br><span class="line"><span class="comment">      data.putParcelable("Book", boo);*/</span></span><br><span class="line">      msg.setData(data);</span><br><span class="line">      msg.replyTo = mReplyMessenger;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.send(msg);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.i(<span class="string">"NightXLT"</span>, <span class="string">"happen e"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Service</span></span><br><span class="line"><span class="keyword">public</span> Messenger messenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> MyHandler());</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">Log.i(<span class="string">"Ser---TAG"</span>, <span class="string">"msg::"</span>+msg.arg1+<span class="string">"want :"</span>+msg.getData().getString(<span class="string">"msg"</span>));</span><br><span class="line">Messenger messenger = msg.replyTo;</span><br><span class="line">Message message = Message.obtain(<span class="keyword">null</span>, MSG_FROM_SERVICE);</span><br><span class="line">Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">bundle.putString(<span class="string">"reply"</span>, <span class="string">"嗯,你的消息我已经收到,稍后回复你!"</span>);</span><br><span class="line">message.setData(bundle);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">messenger.send(message);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>IPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Rotate the list</title>
    <url>/2019/01/20/Rotate%20the%20list/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-linked-list-rotate-the-list-to-the-right-by-k-places-where-k-is-non-negative"><a href="#Given-a-linked-list-rotate-the-list-to-the-right-by-k-places-where-k-is-non-negative" class="headerlink" title="Given a linked list, rotate the list to the right by k places, where k is non-negative."></a>Given a linked list, rotate the list to the right by k places, where k is non-negative.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span>-&gt;<span class="number">5</span>-&gt;NULL, k = <span class="number">2</span></span><br><span class="line">Output: <span class="number">4</span>-&gt;<span class="number">5</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">3</span>-&gt;NULL</span><br><span class="line">Explanation:</span><br><span class="line">rotate <span class="number">1</span> steps to the right: <span class="number">5</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">2</span> steps to the right: <span class="number">4</span>-&gt;<span class="number">5</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">3</span>-&gt;NULL</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="number">0</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;NULL, k = <span class="number">4</span></span><br><span class="line">Output: <span class="number">2</span>-&gt;<span class="number">0</span>-&gt;<span class="number">1</span>-&gt;NULL</span><br><span class="line">Explanation:</span><br><span class="line">rotate <span class="number">1</span> steps to the right: <span class="number">2</span>-&gt;<span class="number">0</span>-&gt;<span class="number">1</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">2</span> steps to the right: <span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">0</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">3</span> steps to the right: <span class="number">0</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;NULL</span><br><span class="line">rotate <span class="number">4</span> steps to the right: <span class="number">2</span>-&gt;<span class="number">0</span>-&gt;<span class="number">1</span>-&gt;NULL</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　陷入了惯性思维，以为不能修改链表。然后暴力解决。啊~差点超时。看了解析。我擦，原来可以操作链表<img src="/images/1547971023240.png" alt="enter description here">。</p>
<p>  将单链表变为单循环链表，同时记录链表元素个数num。只需要移动 num - k个元素即为所求。咦~是不是漏了什么？k &gt; num？  不存在的。安排的妥妥的。  k = k % num.每逆序num个不是和没逆序一样吗？hhhhhhhhhhhhhh</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> ListNode <span class="title">rotateRight</span><span class="params">(ListNode head, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    ListNode p = head;</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (p.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">        p = p.next;</span><br><span class="line">        num++;</span><br><span class="line">    &#125;</span><br><span class="line">    p.next = head;</span><br><span class="line">    k %= num;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num - k; i++) &#123;</span><br><span class="line">        p = p.next;</span><br><span class="line">    &#125;</span><br><span class="line">    head = p.next;</span><br><span class="line">    p.next = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Product of all the elements of nums except nums[i]</title>
    <url>/2019/01/19/Product%20of%20all%20the%20elements%20of%20nums%20except%20nums%5Bi%5D/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-array-nums-of-n-integers-where-n-gt-1-return-an-array-output-such-that-output-i-is-equal-to-the-product-of-all-the-elements-of-nums-except-nums-i-Please-solve-it-without-division-and-in-O-n"><a href="#Given-an-array-nums-of-n-integers-where-n-gt-1-return-an-array-output-such-that-output-i-is-equal-to-the-product-of-all-the-elements-of-nums-except-nums-i-Please-solve-it-without-division-and-in-O-n" class="headerlink" title="Given an array nums of n integers where n &gt; 1,  return an array output such that output[i] is equal to the product of all the elements of nums except nums[i].Please solve it without division and in O(n)."></a>Given an array nums of n integers where n &gt; 1,  return an array output such that output[i] is equal to the product of all the elements of nums except nums[i].Please solve it without division and in O(n).</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:  [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">Output: [<span class="number">24</span>,<span class="number">12</span>,<span class="number">8</span>,<span class="number">6</span>]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　一开始用除法试了下，发现有含0的样例，然后用了O(n^2)过了。自己思考过正向遍历记录每一个元素左侧的元素累积。但是这样原数组也变了。无法进行逆向遍历。只能采取O(n)的空间复杂度。新建一个数组先记录正向乘积。再逆向遍历一次乘以每个元素右侧的累积</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">int</span>[] productExceptSelf(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> result[] = <span class="keyword">new</span> <span class="keyword">int</span>[nums.length];</span><br><span class="line">    result[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        result[i] = result[i - <span class="number">1</span>] * nums[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> mul = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = nums.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        result[i] *= mul;</span><br><span class="line">        mul *= nums[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>盛最多水的容器</title>
    <url>/2019/01/18/%E7%9B%9B%E6%9C%80%E5%A4%9A%E6%B0%B4%E7%9A%84%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-n-non-negative-integers-a1-a2-…-an-where-each-represents-a-point-at-coordinate-i-ai-n-vertical-lines-are-drawn-such-that-the-two-endpoints-of-line-i-is-at-i-ai-and-i-0-Find-two-lines-which-together-with-x-axis-forms-a-container-such-that-the-container-contains-the-most-water"><a href="#Given-n-non-negative-integers-a1-a2-…-an-where-each-represents-a-point-at-coordinate-i-ai-n-vertical-lines-are-drawn-such-that-the-two-endpoints-of-line-i-is-at-i-ai-and-i-0-Find-two-lines-which-together-with-x-axis-forms-a-container-such-that-the-container-contains-the-most-water" class="headerlink" title="Given n non-negative integers a1, a2, …, an , where each represents a point at coordinate (i, ai). n vertical lines are drawn such that the two endpoints of line i is at (i, ai) and (i, 0). Find two lines, which together with x-axis forms a container, such that the container contains the most water."></a>Given n non-negative integers a1, a2, …, an , where each represents a point at coordinate (i, ai). n vertical lines are drawn such that the two endpoints of line i is at (i, ai) and (i, 0). Find two lines, which together with x-axis forms a container, such that the container contains the most water.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">1</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">3</span>,<span class="number">7</span>]</span><br><span class="line">Output: <span class="number">49</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　自己起初想以双指针从两头向中间逼近。但困惑于low、high的指针移动。我知道面积取决与最短板的长度。但是也还有宽度不是……..然后用了双层遍历，做是做出来了，但是特别耗时。参考网上代码，与我起初想法一致，向中间逼近，在指针移动时，采取移动最短指针，尽管面积 = 长度 * 宽度，但是面积取决于最短板，而且在移动过程中我们维护一个最大面积变量记录最大面积。可将宽度考虑其中。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxArea</span><span class="params">(<span class="keyword">int</span>[] height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> maxArea = Integer.MIN_VALUE;</span><br><span class="line">    <span class="keyword">int</span> low = <span class="number">0</span>, high = height.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        <span class="keyword">int</span> area = Math.min(height[low], height[high]) * (high - low);</span><br><span class="line">        maxArea = Math.max(area, maxArea);</span><br><span class="line">        <span class="keyword">if</span> (height[low] &lt;= height[high]) &#123;</span><br><span class="line">            low++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            high--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> maxArea;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>腾讯</tag>
      </tags>
  </entry>
  <entry>
    <title>Binder Resolve</title>
    <url>/2019/01/17/Binder%20Resolve/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> String DESCRIPTOR = <span class="string">"com.hdu.test.IBookManager"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getBOOKLIST = IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>;<span class="comment">// Flag the method invoked</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addBook = IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;<span class="comment">// method </span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookManagetImpl</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IBookManager</span> </span>&#123;<span class="comment">//The concrete  implementation  of Binder</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookManagetImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);<span class="comment">// Register this IInterface,so that queryLocalInterface would use DESCRIPTOR to get IInterface.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBookManager <span class="title">asInterface</span><span class="params">(IBinder binder)</span> </span>&#123;<span class="comment">// Client invoke this method to obtain IBookManager inteface</span></span><br><span class="line">      <span class="keyword">if</span> (binder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      IInterface iin = binder.queryLocalInterface(DESCRIPTOR);<span class="comment">// Obtain IInterface by DESCRIPTOR.</span></span><br><span class="line">      <span class="keyword">if</span> ((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> IBookManager)) &#123;</span><br><span class="line">        <span class="keyword">return</span> (IBookManager) iin;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> BookManagetImpl.Proxy(binder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;<span class="comment">//server would progress RPC</span></span><br><span class="line">      <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">          reply.writeString(DESCRIPTOR);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">case</span> TRANSACTION_getBOOKLIST:</span><br><span class="line">          data.enforceInterface(DESCRIPTOR);</span><br><span class="line">          List&lt;Book&gt; books = <span class="keyword">this</span>.getBookList();</span><br><span class="line">          reply.writeNoException();</span><br><span class="line">          reply.writeTypedList(books);<span class="comment">//write reslut into reply</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">case</span> TRANSACTION_addBook:</span><br><span class="line">          data.enforceInterface(DESCRIPTOR);</span><br><span class="line">          Book book = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (<span class="number">0</span> != data.readInt()) &#123;</span><br><span class="line">            book = Book.CREATOR.createFromParcel(data);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.addBook(book);</span><br><span class="line">          reply.writeNoException();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">IBookManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> IBinder mRemote;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">(IBinder remote)</span> </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;<span class="comment">// Client would invoke these method  as follows</span></span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        List&lt;Book&gt; books;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">          mRemote.transact(TRANSACTION_getBOOKLIST, data, reply, <span class="number">0</span>);</span><br><span class="line">          data.readException();</span><br><span class="line">          books = reply.createTypedArrayList(Book.CREATOR);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          data.recycle();</span><br><span class="line">          reply.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> books;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;  </span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">          <span class="keyword">if</span> (book != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            book.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          mRemote.transact(TRANSACTION_addBook, data, reply, <span class="number">0</span>);</span><br><span class="line">          reply.readException();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">          reply.recycle();</span><br><span class="line">          data.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个Binder运行机制如下图所示：<br><img src="/images/Binder.png" alt="Binder"></p>
<ol>
<li>首先客户端通过IBookManager.asInteface()获得IBookManager中的Binder中的Proxy实例</li>
<li>客户端调用Proxy的getBookList()，通过调用transcation()传入code、输入data、输出reply。发起了RPC请求。</li>
<li>服务端通过onTranscation()处理RPC请求，根据传入的code值进行响应处理。若需要返回值，并将返回值写入reply.</li>
<li>客户端若需要返回值则从reply中取出。</li>
</ol>
]]></content>
      <categories>
        <category>Android开发艺术探索</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Delete the duplicates in a sorted array</title>
    <url>/2019/01/17/Delete%20the%20duplicates%20in%20a%20sorted%20array/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-sorted-array-nums-remove-the-duplicates-in-place-such-that-each-element-appear-only-once-and-return-the-new-length-Do-not-allocate-extra-space-for-another-array-you-must-do-this-by-modifying-the-input-array-in-place-with-O-1-extra-memory"><a href="#Given-a-sorted-array-nums-remove-the-duplicates-in-place-such-that-each-element-appear-only-once-and-return-the-new-length-Do-not-allocate-extra-space-for-another-array-you-must-do-this-by-modifying-the-input-array-in-place-with-O-1-extra-memory" class="headerlink" title="Given a sorted array nums, remove the duplicates in-place such that each element appear only once and return the new length.Do not allocate extra space for another array, you must do this by modifying the input array in-place with O(1) extra memory."></a>Given a sorted array nums, remove the duplicates in-place such that each element appear only once and return the new length.Do not allocate extra space for another array, you must do this by modifying the input array in-place with O(1) extra memory.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Given nums = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>],</span><br><span class="line"></span><br><span class="line">Your function should <span class="keyword">return</span> length = <span class="number">2</span>, with the first two elements of nums being <span class="number">1</span> and <span class="number">2</span> respectively.</span><br><span class="line"></span><br><span class="line">It doesn<span class="string">'t matter what you leave beyond the returned length.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Given nums = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>],</span><br><span class="line"></span><br><span class="line">Your function should <span class="keyword">return</span> length = <span class="number">5</span>, with the first five elements of nums being modified to <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, and <span class="number">4</span> respectively.</span><br><span class="line"></span><br><span class="line">It doesn<span class="string">'t matter what values are set beyond the returned length.</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　(。﹏。*)意识到要紧抓排序这个特征，但一味想着找到不同的两个，然后整个数组往前移然后循环套循环立即推懵B状态。参考了别人的思路。牛皮。竟然用到了快慢指针。是在下庸俗了，总以为是用在链表找中间节点或环形链表。用快慢指针找到最近两个不相等的元素，然后直接赋值。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">removeDuplicates</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> slow = <span class="number">0</span>, count = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> fast = <span class="number">0</span>; fast &lt; nums.length; fast++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[slow] != nums[fast]) &#123;</span><br><span class="line">                slow++;</span><br><span class="line">                count++;</span><br><span class="line">                nums[slow] = nums[fast];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>灵通关于Function thinking的一些思考</title>
    <url>/2019/01/17/Think%20about%20FP/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文源自对Neal Ford所著的函数式编程思维一书的一些思考记录。自己也曾写过RX全家桶，Java8的函数式表达式。直观感受是简洁。只为简洁Java单独用一个版本推出这个表达式吗？在Java8之前Java是不支持函数式编程的。Java要实现函数式编程必须要借助Function Java第三方库。那么为何众多语言都加入了对函数式编程的支持呢？函数式编程的背后又是什么呢？</p>
<h2 id="思维转变"><a href="#思维转变" class="headerlink" title="思维转变"></a>思维转变</h2><blockquote>
<p>函数式编程中粒度最小的重用单元是函数（一等公民），并具备值不可变性</p>
</blockquote>
<p>命令式编程风格是按照“程序是一系列改变状态的命令”来建模，即解决问题的步骤。如典型的for循环。而函数式编程则是基于表达式和变换，即数据的映射，更类似一种数学建模的思想。用map、filter这些高阶函数把我们解放出来，让我们站在更高的抽象层次上去考虑问题 ，把问题看得更清楚。</p>
<h2 id="值不可变"><a href="#值不可变" class="headerlink" title="值不可变"></a>值不可变</h2><blockquote>
<p>OOP通过封装不确定因素使代码让人理解。而函数式编程通过减少使代码让人理解。                                   ——Michael Feathers</p>
</blockquote>
<p>不确定因素：变量值，函数值等状态。OOP在竭力控制这些状态得出正确的结果。而函数式编程(FP)则恰恰相反。FP则是尽可能消灭可变的状态。如果一门语言没有那么多容易掉进去的坑，那么开发者就不会容易犯错。所以有函数式编程中数据不可变性（immutable data）一说，多有的变量只可以赋值一次，变量不可变，如果想改变变量就创建一个新的变量。</p>
<h2 id="缓求值"><a href="#缓求值" class="headerlink" title="缓求值"></a>缓求值</h2><p>缓求值的好处：昂贵的运算只有到了绝对必要的时候才执行；可以建立无限大的集合，只要一接到请求就一直送出元素；按缓求值的方式使用map、filter等，可以产生更高效的代码。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> springapp.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Night on 2018/12/28.</span></span><br><span class="line"><span class="comment"> * Desc:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> asd = <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line">        list.add(<span class="number">4</span>);</span><br><span class="line">        asd = <span class="number">4</span>;</span><br><span class="line">        System.out.println(list.parallelStream()</span><br><span class="line">                .filter(n -&gt; n &gt; <span class="number">1</span>)</span><br><span class="line">                .map(s -&gt; s = s * asd)</span><br><span class="line">                .collect(toList()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">new</span> Solution().print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在lambda表达式中引入了状态变量asd。在map映射时其并未真正执行乘法操作。而是直至调用collect（）方才执行。这也就是FP中的缓求值的概念。在这其中我们交出了对状态的管理权让运行时去管理状态。推迟执行是FP中一个及其重要的思想。无论缓求值亦或闭包都是基于这个思想。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Function Programming</tag>
      </tags>
  </entry>
  <entry>
    <title>Combinations of a Phone Number</title>
    <url>/2019/01/16/Combinations%20of%20a%20Phone%20Number/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-string-containing-digits-from-2-9-inclusive-return-all-possible-letter-combinations-that-the-number-could-represent-Although-the-above-answer-is-in-lexicographical-order-your-answer-could-be-in-any-order-you-want"><a href="#Given-a-string-containing-digits-from-2-9-inclusive-return-all-possible-letter-combinations-that-the-number-could-represent-Although-the-above-answer-is-in-lexicographical-order-your-answer-could-be-in-any-order-you-want" class="headerlink" title="Given a string containing digits from 2-9 inclusive, return all possible letter combinations that the number could represent.Although the above answer is in lexicographical order, your answer could be in any order you want."></a>Given a string containing digits from 2-9 inclusive, return all possible letter combinations that the number could represent.Although the above answer is in lexicographical order, your answer could be in any order you want.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="string">"23"</span></span><br><span class="line">Output: [<span class="string">"ad"</span>, <span class="string">"ae"</span>, <span class="string">"af"</span>, <span class="string">"bd"</span>, <span class="string">"be"</span>, <span class="string">"bf"</span>, <span class="string">"cd"</span>, <span class="string">"ce"</span>, <span class="string">"cf"</span>].</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　起初是通过HashMap存储数字和拼音映射，但深搜那里实在搞不定，检索了相关算法发现参考算法是回溯。那回溯和DFS有什么差异呢？<br>  　　其实回溯就是深搜的一种实现，深搜是无序的，而回溯是有序的。比如这道题必须是2对应的字符在前面，3的字符在后面。深搜已访问过的节点不再访问，所有点仅访问一次。而回溯不一样，已访问过的节点可能会再次访问，也可能存在未曾访问过的节点。这道题一个值得注意的点是拼接字符串不能用stringBuilder,其会将一次深搜的结果拼在一起，如第一个ex中，结果会变为ad,ade,adef…这不是我需要的结果。所以必须使用string。每次拼接会new一次。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">letterCombinations</span><span class="params">(String digits)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; strings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (digits == <span class="keyword">null</span> || digits.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> strings;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> len = digits.length();</span><br><span class="line">        String[] dict = &#123;<span class="string">"abc"</span>, <span class="string">"def"</span>, <span class="string">"ghi"</span>, <span class="string">"jkl"</span>, <span class="string">"mno"</span>, <span class="string">"pqrs"</span>, <span class="string">"tuv"</span>, <span class="string">"wxyz"</span>&#125;;</span><br><span class="line">        String arr[] = <span class="keyword">new</span> String[len];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            arr[i] = dict[digits.charAt(i) - <span class="string">'0'</span> - <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        group(arr, <span class="number">0</span>, <span class="string">""</span>, strings);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> strings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">group</span><span class="params">(String[] arr, <span class="keyword">int</span> startIndex, String stringCombination, List&lt;String&gt; strings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] chars = arr[startIndex].toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (startIndex == arr.length - <span class="number">1</span>) &#123;</span><br><span class="line">                strings.add(stringCombination + chars[i]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                group(arr, startIndex + <span class="number">1</span>, stringCombination + chars[i], strings);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringCombination;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Find three integers in nums such that the sum is closest to target</title>
    <url>/2019/01/16/Find%20three%20integers%20in%20nums%20such%20that%20the%20sum%20is%20closest%20to%20target/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-array-nums-of-n-integers-and-an-integer-target-find-three-integers-in-nums-such-that-the-sum-is-closest-to-target-Return-the-sum-of-the-three-integers-You-may-assume-that-each-input-would-have-exactly-one-solution"><a href="#Given-an-array-nums-of-n-integers-and-an-integer-target-find-three-integers-in-nums-such-that-the-sum-is-closest-to-target-Return-the-sum-of-the-three-integers-You-may-assume-that-each-input-would-have-exactly-one-solution" class="headerlink" title="Given an array nums of n integers and an integer target, find three integers in nums such that the sum is closest to target. Return the sum of the three integers. You may assume that each input would have exactly one solution."></a>Given an array nums of n integers and an integer target, find three integers in nums such that the sum is closest to target. Return the sum of the three integers. You may assume that each input would have exactly one solution.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Given array nums = [-<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, -<span class="number">4</span>], and target = <span class="number">1</span>.</span><br><span class="line">The sum that is closest to the target is <span class="number">2</span>. (-<span class="number">1</span> + <span class="number">2</span> + <span class="number">1</span> = <span class="number">2</span>).</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　知识迁移能力，一开始仅是在上道题<a href="https://nightxlt.github.io/%2F2018%2F12%2F30%2FThe%20sum%20of%20three%20elements%20is%20zero%2F" target="_blank" rel="noopener">The sum of three elements is zero</a>加了个判断，找到最小偏差。但是这样直接用是不对的.因为找到最小偏差时，不能同时移动j,k要判断才能移动索引。若sum &gt; target,k–;sum &lt; target,j++;sum == target ,return target;矛盾的特殊性啊~~~ 具体情况具体分析。不要死板。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">threeSumClosest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">       Arrays.sort(nums);</span><br><span class="line">       <span class="keyword">int</span> j, k;</span><br><span class="line">       <span class="keyword">int</span> closetSum = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> minOffset = Integer.MAX_VALUE;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length - <span class="number">2</span>; i++) &#123;</span><br><span class="line">           <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; nums[i] == nums[i - <span class="number">1</span>]) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           j = i + <span class="number">1</span>;</span><br><span class="line">           k = nums.length - <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">while</span> (j &lt; k) &#123;</span><br><span class="line">               <span class="keyword">int</span> sum = nums[i] + nums[j] + nums[k];</span><br><span class="line">               <span class="keyword">int</span> offset = Math.abs(sum - target);</span><br><span class="line">               <span class="keyword">if</span> (sum &gt; target) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (offset &lt; minOffset) &#123;</span><br><span class="line">                       minOffset = offset;</span><br><span class="line">                       closetSum = sum;</span><br><span class="line">                       <span class="keyword">while</span> (j &lt; k &amp;&amp; nums[k - <span class="number">1</span>] == nums[k]) &#123;</span><br><span class="line">                           k--;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   k--;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sum &lt; target) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (offset &lt; minOffset) &#123;</span><br><span class="line">                       minOffset = offset;</span><br><span class="line">                       closetSum = sum;</span><br><span class="line">                       <span class="keyword">while</span> (j &lt; k &amp;&amp; nums[j + <span class="number">1</span>] == nums[j]) &#123;</span><br><span class="line">                           j++;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   j++;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> target;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> closetSum;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Find longest palindromic substring</title>
    <url>/2019/01/15/Find%20longest%20palindromic%20substring/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-string-s-find-the-longest-palindromic-substring-in-s-You-may-assume-that-the-maximum-length-of-s-is-1000"><a href="#Given-a-string-s-find-the-longest-palindromic-substring-in-s-You-may-assume-that-the-maximum-length-of-s-is-1000" class="headerlink" title="Given a string s, find the longest palindromic substring in s. You may assume that the maximum length of s is 1000."></a>Given a string s, find the longest palindromic substring in s. You may assume that the maximum length of s is 1000.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="string">"babad"</span></span><br><span class="line">Output: <span class="string">"bab"</span></span><br><span class="line">Note: <span class="string">"aba"</span> is also a valid answer.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="string">"cbbd"</span></span><br><span class="line">Output: <span class="string">"bb"</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　参考至<a href="https://blog.csdn.net/qq_32354501/article/details/80084325" target="_blank" rel="noopener">https://blog.csdn.net/qq_32354501/article/details/80084325</a><br>  　　1. 采取从中心向外扩散方法，根据子串长度分为奇数和偶数情况<br>  　　2. 遍历每个除最后一个位置的字符index(字符位置)，奇数：初始low = 初始high = index，low和high均不超过原字符串的下限和上限；判断low和high处的字符是否相等，相等则low–、high++（偶数：初始high = 初始low+1 = index + 1）；<br>  　　3. 每次low与high处的字符相等时，都将当前最长的回文子串长度与high-low+1比较。后者大时，记录两端索引<br>  　　4. 重复执行2）、3），直至high-low+1 等于原字符串长度或者遍历到最后一个字符，取当前截取到的回文子串，该子串即为最长的回文子串。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> sMaxLength, leftIndex, rightIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">longestPalindrome</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        sMaxLength = <span class="number">0</span>;</span><br><span class="line">        leftIndex = <span class="number">0</span>;</span><br><span class="line">        rightIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.length() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">            findLongestPalindromic(s, i, i);<span class="comment">//odd</span></span><br><span class="line">            findLongestPalindromic(s, i, i + <span class="number">1</span>);<span class="comment">//even</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.substring(leftIndex, rightIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findLongestPalindromic</span><span class="params">(String s, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (low &gt;= <span class="number">0</span> &amp;&amp; high &lt;= s.length() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(low) == s.charAt(high)) &#123;</span><br><span class="line">                <span class="keyword">int</span> len = high - low + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (len &gt; sMaxLength) &#123;</span><br><span class="line">                    sMaxLength = len;</span><br><span class="line">                    leftIndex = low;</span><br><span class="line">                    rightIndex = high + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                low--;<span class="comment">//Bear in mind that changing index</span></span><br><span class="line">                high++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the median of the two sorted arrays</title>
    <url>/2019/01/14/Find%20the%20median%20of%20the%20two%20sorted%20arrays/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="There-are-two-sorted-arrays-nums1-and-nums2-of-size-m-and-n-respectively-Find-the-median-of-the-two-sorted-arrays-The-overall-run-time-complexity-should-be-O-log-m-n-You-may-assume-nums1-and-nums2-cannot-be-both-empty"><a href="#There-are-two-sorted-arrays-nums1-and-nums2-of-size-m-and-n-respectively-Find-the-median-of-the-two-sorted-arrays-The-overall-run-time-complexity-should-be-O-log-m-n-You-may-assume-nums1-and-nums2-cannot-be-both-empty" class="headerlink" title="There are two sorted arrays nums1 and nums2 of size m and n respectively.Find the median of the two sorted arrays. The overall run time complexity should be O(log (m+n)).You may assume nums1 and nums2 cannot be both empty."></a>There are two sorted arrays nums1 and nums2 of size m and n respectively.Find the median of the two sorted arrays. The overall run time complexity should be O(log (m+n)).You may assume nums1 and nums2 cannot be both empty.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">nums1 = [<span class="number">1</span>, <span class="number">3</span>]</span><br><span class="line">nums2 = [<span class="number">2</span>]</span><br><span class="line">The median is <span class="number">2.0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">nums1 = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">nums2 = [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="function">The median <span class="title">is</span> <span class="params">(<span class="number">2</span> + <span class="number">3</span>)</span>/2 </span>= <span class="number">2.5</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><blockquote>
<p>中位数是用来将一个集合划分为两个长度相等的子集，其中一个子集中的元素总是大于另一个子集中的元素。</p>
</blockquote>
<p>  1.两个长度相等的子集<br>   2.一个子集中的元素总是大于另一个子集中的元素。</p>
<p>在这道题目中始终注意两个数组均为<strong>有序</strong>数组。</p>
<p>首先在任一位置 i 将A数组 划分成两个部分：<br><img src="/images/partitionA.PNG" alt="partitionA"></p>
<p>len(left_A)=i,len(right_A)=m−i.</p>
<p>注意：当 i = 0 时，left_A 为空集， 而当 i =m 时, right_A 为空集。</p>
<p>同理在任一位置 j 将B数组 划分成两个部分：<br><img src="/images/partitionB.PNG" alt="partitionB"></p>
<p>将left_A 和left_B 放入一个集合，并将 right_A 和right_B 放入另一个集合。 再把这两个新的集合分别命名为left_part 和right_part：<br><img src="/images/partitionAB.PNG" alt="partitionAB"></p>
<p>只要满足 </p>
<ol>
<li>len(left_part)=len(right_part)</li>
<li>max(left_part) &lt; min(right_part)</li>
</ol>
<p>要确保这两个条件，只需要保证：<br><img src="/images/par_condition.PNG" alt></p>
<p>我们可以按照以下步骤来进行二叉树搜索保证B[j - 1] &lt;= A[i] &amp;&amp; A[i - 1] &lt;=  B[j]：<br>设 iMin = 0, iMax = m，在[iMin, iMax]中搜索<br>令i = (iMax + iMin)  / 2, j = (m + n + 1) / 2 - i  （保证len(left_part) = len(right_part)  ）。接下来会遇到三种情况。</p>
<ol>
<li>B[j - 1 ] &lt;= A[i] &amp;&amp; A[i - 1] &lt;=  B[j]时，找到对应i</li>
<li>B[j - 1] &gt; A[i]时，i小了， iMin  =  i + 1</li>
<li>A[i - 1] &gt; B[j], iMax = i - 1</li>
</ol>
<p>此外，难处理的就是边界问题，i = 0,m; j = 0,n.当 i, j 为临界值时，只需要判断B[j - 1] &lt;= A[i] &amp; A[i - 1] &lt;=  B[j]：一半即可。即i = 0时，A[i - 1]不存在，只需判断B[j - 1] 即可</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span>[] nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums1.length &gt; nums2.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> findMedianSortedArrays(nums2, nums1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> S1Len = nums1.length;</span><br><span class="line">        <span class="keyword">int</span> S2Len = nums2.length;</span><br><span class="line">        <span class="keyword">int</span> iMin = <span class="number">0</span>, iMax = S1Len, halfLen = (S1Len + S2Len + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (iMin &lt;= iMax) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = (iMin + iMax) / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> j = halfLen - i;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; iMax &amp;&amp; nums1[i] &lt; nums2[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                iMin = i + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iMin &lt; i &amp;&amp; nums2[j] &lt; nums1[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                iMax = i - <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> maxLeft = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                    maxLeft = nums2[j - <span class="number">1</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == <span class="number">0</span>) &#123;</span><br><span class="line">                    maxLeft = nums1[i - <span class="number">1</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    maxLeft = Math.max(nums1[i - <span class="number">1</span>], nums2[j - <span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (((S1Len + S2Len) &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> maxLeft;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> minRight = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (i == S1Len) &#123;</span><br><span class="line">                    minRight = nums2[j];</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == S2Len) &#123;</span><br><span class="line">                    minRight = nums1[i];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    minRight = Math.min(nums1[i], nums2[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> (maxLeft + minRight) / <span class="number">2.0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Recylerview多布局显示</title>
    <url>/2019/01/14/Recylerview%E5%A4%9A%E5%B8%83%E5%B1%80%E6%98%BE%E7%A4%BA/</url>
    <content><![CDATA[<h2 id="重写getItemViewType方法"><a href="#重写getItemViewType方法" class="headerlink" title="重写getItemViewType方法"></a>重写getItemViewType方法</h2><p>重写getItemViewType方法,根据条件返回条目的类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MoreTypeBean moreTypeBean = mData.get(position);</span><br><span class="line">        <span class="keyword">if</span> (moreTypeBean.type == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> TYPE_PULL_IMAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (moreTypeBean.type == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> TYPE_RIGHT_IMAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> TYPE_THREE_IMAGE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="新建对应数目的ViewHolder"><a href="#新建对应数目的ViewHolder" class="headerlink" title="新建对应数目的ViewHolder"></a>新建对应数目的ViewHolder</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PullImageHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">PullImageHolder</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">super</span>(itemView);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RightImageHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RightImageHolder</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">super</span>(itemView);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeImageHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">ThreeImageHolder</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">super</span>(itemView);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="在onCreateViewHolder里根据viewtype来判断-所引用的item布局类型"><a href="#在onCreateViewHolder里根据viewtype来判断-所引用的item布局类型" class="headerlink" title="在onCreateViewHolder里根据viewtype来判断 所引用的item布局类型"></a>在onCreateViewHolder里根据viewtype来判断 所引用的item布局类型</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建不同的 ViewHolder</span></span><br><span class="line">        View view;</span><br><span class="line">        <span class="comment">//根据viewtype来判断</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (viewType == TYPE_PULL_IMAGE) &#123;</span><br><span class="line">            view =View.inflate(parent.getContext(),R.layout.item_pull_img,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PullImageHolder(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (viewType == TYPE_RIGHT_IMAGE) &#123;</span><br><span class="line">            view =View.inflate(parent.getContext(),R.layout.item_right_img,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RightImageHolder(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            view =View.inflate(parent.getContext(),R.layout.item_three_img,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ThreeImageHolder(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the single one number</title>
    <url>/2019/01/13/Find%20the%20single%20one%20number/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-non-empty-array-of-integers-every-element-appears-twice-except-for-one-Find-that-single-one-Your-algorithm-should-have-a-linear-runtime-complexity-Could-you-implement-it-without-using-extra-memory"><a href="#Given-a-non-empty-array-of-integers-every-element-appears-twice-except-for-one-Find-that-single-one-Your-algorithm-should-have-a-linear-runtime-complexity-Could-you-implement-it-without-using-extra-memory" class="headerlink" title="Given a non-empty array of integers, every element appears twice except for one. Find that single one.Your algorithm should have a linear runtime complexity. Could you implement it without using extra memory?"></a>Given a non-empty array of integers, every element appears twice except for one. Find that single one.Your algorithm should have a linear runtime complexity. Could you implement it without using extra memory?</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">Output: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: [<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">Output: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　异或概念：
  　</p>
<table>
<thead>
<tr>
<th>&amp;&amp;</th>
<th>一假则假，短路</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>全判断</td>
</tr>
<tr>
<td>&#124;&#124;</td>
<td>一真则真，短路</td>
</tr>
<tr>
<td>&#124;</td>
<td>全判断</td>
</tr>
<tr>
<td>^(异或)</td>
<td>相异为真</td>
</tr>
</tbody>
</table>
<p>　　剑指Offer的一道题，采用异或的方法。异或可以实现在不使用临时变量的情况下，交换两个值。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">a = a ^ b</span><br><span class="line">b = a ^ b <span class="comment">// a ^ b ^ b = a ^ 0 = a</span></span><br><span class="line">a = a ^ b <span class="comment">// a ^ b ^ a = b ^ 0 = b</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">singleNumber</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            result = result ^ nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Russian doll envelopes</title>
    <url>/2019/01/10/Russian%20doll%20envelopes/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="You-have-a-number-of-envelopes-with-widths-and-heights-given-as-a-pair-of-integers-w-h-One-envelope-can-fit-into-another-if-and-only-if-both-the-width-and-height-of-one-envelope-is-greater-than-the-width-and-height-of-the-other-envelope"><a href="#You-have-a-number-of-envelopes-with-widths-and-heights-given-as-a-pair-of-integers-w-h-One-envelope-can-fit-into-another-if-and-only-if-both-the-width-and-height-of-one-envelope-is-greater-than-the-width-and-height-of-the-other-envelope" class="headerlink" title="You have a number of envelopes with widths and heights given as a pair of integers (w, h). One envelope can fit into another if and only if both the width and height of one envelope is greater than the width and height of the other envelope."></a>You have a number of envelopes with widths and heights given as a pair of integers (w, h). One envelope can fit into another if and only if both the width and height of one envelope is greater than the width and height of the other envelope.</h3><h3 id="What-is-the-maximum-number-of-envelopes-can-you-Russian-doll-put-one-inside-other"><a href="#What-is-the-maximum-number-of-envelopes-can-you-Russian-doll-put-one-inside-other" class="headerlink" title="What is the maximum number of envelopes can you Russian doll? (put one inside other)"></a>What is the maximum number of envelopes can you Russian doll? (put one inside other)</h3><h3 id="Note-Rotation-is-not-allowed"><a href="#Note-Rotation-is-not-allowed" class="headerlink" title="Note:Rotation is not allowed."></a>Note:Rotation is not allowed.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [[<span class="number">5</span>,<span class="number">4</span>],[<span class="number">6</span>,<span class="number">4</span>],[<span class="number">6</span>,<span class="number">7</span>],[<span class="number">2</span>,<span class="number">3</span>]]</span><br><span class="line">Output: <span class="number">3</span> </span><br><span class="line">Explanation: The maximum number of envelopes you can Russian doll is <span class="number">3</span> ([<span class="number">2</span>,<span class="number">3</span>] =&gt; [<span class="number">5</span>,<span class="number">4</span>] =&gt; [<span class="number">6</span>,<span class="number">7</span>]).</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　 这是一个二维LIS（Longest Increasing Subsequence）问题，可以通过先以宽度进行递增排序从而降维处理，即宽度有序仅需处理长度即可。再求长度最长递增子序列，注意的是当宽度相同时，要取长度最小的序列。有一点贪心的思想。长度越小，可放入的信封相应的也就越多。<br>　　求递增子序列长度时不能直接双层遍历O(n^2)，可通过二分查找来查找降低为O(nlogn). 这里二分的思想有些奥妙。先是创建H数组存储”子序列的”最大递增子序列的末尾元素。通过二分查找H数组中元素（原数组中的最大递增子序列的最末元素）小于ai的长度最大的最大递增子序列；再令H[low] = ai.将长度为low的最大递增子序列的末尾元素置为ai。如果low 等于lenth的话，意味着最长递增序列的长度为 low + 1，所以length++。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxEnvelopes</span><span class="params">(<span class="keyword">int</span>[][] envelopes)</span> </span>&#123;</span><br><span class="line">        Arrays.sort(envelopes, ((o1, o2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (o1[<span class="number">0</span>] != o2[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="keyword">return</span> o1[<span class="number">0</span>] - o2[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> o2[<span class="number">1</span>] - o1[<span class="number">1</span>];<span class="comment">//select lower height</span></span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span>[] h = <span class="keyword">new</span> <span class="keyword">int</span>[envelopes.length];</span><br><span class="line">        <span class="keyword">int</span> low, high ,m;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] envelope : envelopes) &#123;</span><br><span class="line">            low = <span class="number">0</span>;</span><br><span class="line">            high = len - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">                m = (low + high) / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> ((h[m] &lt; envelope[<span class="number">1</span>])) &#123;</span><br><span class="line">                    low = m + <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    high = m - <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            h[low] = envelope[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (low == len) &#123;</span><br><span class="line">                len++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>UTF-8 validation</title>
    <url>/2019/01/09/UTF-8%20validation/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="A-character-in-UTF8-can-be-from-1-to-4-bytes-long-subjected-to-the-following-rules-For-1-byte-character-the-first-bit-is-a-0-followed-by-its-unicode-code-For-n-bytes-character-the-first-n-bits-are-all-one’s-the-n-1-bit-is-0-followed-by-n-1-bytes-with-most-significant-2-bits-being-10"><a href="#A-character-in-UTF8-can-be-from-1-to-4-bytes-long-subjected-to-the-following-rules-For-1-byte-character-the-first-bit-is-a-0-followed-by-its-unicode-code-For-n-bytes-character-the-first-n-bits-are-all-one’s-the-n-1-bit-is-0-followed-by-n-1-bytes-with-most-significant-2-bits-being-10" class="headerlink" title="A character in UTF8 can be from 1 to 4 bytes long, subjected to the following rules:For 1-byte character, the first bit is a 0, followed by its unicode code.For n-bytes character, the first n-bits are all one’s, the n+1 bit is 0, followed by n-1 bytes with most significant 2 bits being 10."></a>A character in UTF8 can be from 1 to 4 bytes long, subjected to the following rules:For 1-byte character, the first bit is a 0, followed by its unicode code.For n-bytes character, the first n-bits are all one’s, the n+1 bit is 0, followed by n-1 bytes with most significant 2 bits being 10.</h3><table>
<thead>
<tr>
<th>Char. number range(hexadecimal)</th>
<th>UTF-8 octet sequence (binary)</th>
</tr>
</thead>
<tbody>
<tr>
<td>0000 0000-0000 007F</td>
<td>0xxxxxxx</td>
</tr>
<tr>
<td>0000 0080-0000 07FF</td>
<td>110xxxxx 10xxxxxx</td>
</tr>
<tr>
<td>0000 0800-0000 FFFF</td>
<td>1110xxxx 10xxxxxx 10xxxxxx</td>
</tr>
<tr>
<td>0001 0000-0010 FFFF</td>
<td>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</td>
</tr>
</tbody>
</table>
<p> is how the UTF-8 encoding would work:</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">data = [<span class="number">197</span>, <span class="number">130</span>, <span class="number">1</span>], which represents the octet sequence: <span class="number">11000101</span> <span class="number">10000010</span> <span class="number">00000001</span>.</span><br><span class="line"></span><br><span class="line">Return <span class="keyword">true</span>.</span><br><span class="line">It is a valid utf-<span class="number">8</span> encoding <span class="keyword">for</span> a <span class="number">2</span>-bytes character followed by a <span class="number">1</span>-<span class="keyword">byte</span> character.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">data = [<span class="number">235</span>, <span class="number">140</span>, <span class="number">4</span>], which represented the octet sequence: <span class="number">11101011</span> <span class="number">10001100</span> <span class="number">00000100</span>.</span><br><span class="line"></span><br><span class="line">Return <span class="keyword">false</span>.</span><br><span class="line">The first <span class="number">3</span> bits are all one<span class="string">'s and the 4th bit is 0 means it is a 3-bytes character.</span></span><br><span class="line"><span class="string">The next byte is a continuation byte which starts with 10 and that'</span>s correct.</span><br><span class="line">But the second continuation <span class="keyword">byte</span> does not start with <span class="number">10</span>, so it is invalid.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　看着题目发了好久的呆，实在读不懂题目，UTF-8 编码的意思是读懂了，可是感觉给的样例对应不起来。看着解析的代码一步步分析终于得出意思了。样例中数组的每个数值x的二进制若以0开头，<br>则x表示一个unicode码。若以110开头，接下来的一个数字都必须以10开头。若以1110开头，接下来的两个数字都必须以10开头。若以11110开头，接下来的三个数字都必须以10开头。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validUtf8</span><span class="params">(<span class="keyword">int</span>[] data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(data[i] &gt;&gt; <span class="number">5</span> == <span class="number">0b110</span>)</span><br><span class="line">                count = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(data[i] &gt;&gt; <span class="number">4</span> == <span class="number">0b1110</span>)</span><br><span class="line">                count = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(data[i] &gt;&gt; <span class="number">3</span> == <span class="number">0b11110</span>)</span><br><span class="line">                count = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(data[i] &gt;&gt; <span class="number">7</span> != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(data[i] &gt;&gt; <span class="number">6</span> != <span class="number">0b10</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Tensorflow的迭代方法</title>
    <url>/2019/01/08/Tensorflow%E7%9A%84%E8%BF%AD%E4%BB%A3%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p><a href="https://developers.google.com/machine-learning/crash-course/reducing-loss/an-iterative-approach" target="_blank" rel="noopener">官方学习链接</a></p>
<h2 id="迭代过程"><a href="#迭代过程" class="headerlink" title="迭代过程"></a>迭代过程</h2><p><img src="/images/Tensorflow迭代过程.png" alt="Tensorflow迭代"></p>
<p>　　将一群有标签样本传入模型训练，执行预测得到预测标签。通过损失函数比较实际标签与预测标签差异。再更新参数迭代直至发现损失可能最低的模型参数。</p>
<p>　　梯度下降法：梯度下降法首先选择一个任意起始值（起点）。然后计算损失曲线在起点处的梯度。（模长为最大方向导数）它可以让我们了解哪个方向距离目标“更近”或“更远”。值得注意的是，损失相对于单个权重的梯度（如下图）就等于导数。用梯度乘以一个称为学习速率（有时也称为步长）的标量，以确定下一个负梯度方向点的位置。来逼近最低点。当降到最低点时，模型即收敛。<br>  <img src="/images/GradientDescentNegativeGradient.png" alt="梯度下降法"></p>
]]></content>
      <categories>
        <category>Machine Learning</category>
      </categories>
      <tags>
        <tag>tensorflow</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the contiguous subarray which has the largest sum</title>
    <url>/2019/01/08/the%20contiguous%20subarray%20which%20has%20the%20largest%20sum/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-integer-array-nums-find-the-contiguous-subarray-containing-at-least-one-number-which-has-the-largest-sum-and-return-its-sum"><a href="#Given-an-integer-array-nums-find-the-contiguous-subarray-containing-at-least-one-number-which-has-the-largest-sum-and-return-its-sum" class="headerlink" title="Given an integer array nums, find the contiguous subarray (containing at least one number) which has the largest sum and return its sum."></a>Given an integer array nums, find the contiguous subarray (containing at least one number) which has the largest sum and return its sum.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [-<span class="number">2</span>,<span class="number">1</span>,-<span class="number">3</span>,<span class="number">4</span>,-<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,-<span class="number">5</span>,<span class="number">4</span>],</span><br><span class="line">Output: <span class="number">6</span></span><br><span class="line">Explanation: [<span class="number">4</span>,-<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>] has the largest sum = <span class="number">6</span>.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　这道题曾在剑指Offer上看过解法，有两种解法<br>　　1. DP，做过最直观的DP啦~_~   $$ dp[i] =\left{<br>\begin{aligned}<br>dp[i - 1] + nums[i] &amp;&amp; \ f(i - 1)  &gt;= 0 \&amp;\&amp; i != 0 \<br>nums[i] &amp;&amp; \ f[i - 1] &lt; 0 ||  i == 0 \<br>\end{aligned}<br>\right.<br>$$<br>　　2. 找规律，记录累加和，当累加和小于0时，说明前面的子数组已构成一个最大和（听着有点别扭哈）。令累加和等于当前值，重新开始累加。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**DP</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the max sum of sub array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dp[] = <span class="keyword">new</span> <span class="keyword">int</span>[nums.length];</span><br><span class="line">        dp[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> maxSum = dp[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dp[i - <span class="number">1</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                dp[i] = dp[i - <span class="number">1</span>] + nums[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i] = nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">            maxSum = Math.max(dp[i], maxSum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxSum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**Find the law </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nums</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the max sum of sub array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> maxSum = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">int</span> curSum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            curSum = (curSum &lt;= <span class="number">0</span>) ? nums[i] : (nums[i] + curSum);</span><br><span class="line">            maxSum = Math.max(maxSum, curSum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxSum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the largest square area</title>
    <url>/2019/01/07/Find%20the%20largest%20square%20area/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-2D-binary-matrix-filled-with-0’s-and-1’s-find-the-largest-square-containing-only-1’s-and-return-its-area"><a href="#Given-a-2D-binary-matrix-filled-with-0’s-and-1’s-find-the-largest-square-containing-only-1’s-and-return-its-area" class="headerlink" title="Given a 2D binary matrix filled with 0’s and 1’s, find the largest square containing only 1’s and return its area."></a>Given a 2D binary matrix filled with 0’s and 1’s, find the largest square containing only 1’s and return its area.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: </span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Output: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　方向是确定的，DP，但总是想不出来状态方程出来。图是个好东西。<br>  <img src="/images/Find the largest square area dp1.jpg" alt="dp1"><br>  dp[i][j]表示以matrix[i][j]为右下角的正方形最大边长（1.保证一定是正方形 2.保证边长为最大边长）。为什么可以做到保证为正方形呢？当matrix[2][2] = 1时，从图中观察可知当dp[1][1]、dp[1][2] 、dp[2][1]但凡只要有一个为0，必然构不成正方形。<br>  所以状态方程为：<br>  $$ dp[i][j] =\left{<br>\begin{aligned}<br>min(dp[i-1][j-1], dp[i-1][j], dp[i][j-1]) + 1 &amp;&amp; \ matrix[i][j] = 1 \<br>0 &amp;&amp; \ matrix[i][j] = 0 \<br>\end{aligned}<br>\right.<br>$$</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximalSquare</span><span class="params">(<span class="keyword">char</span>[][] matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (matrix.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> max = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">int</span> row = matrix.length;</span><br><span class="line">        <span class="keyword">int</span> column = matrix[<span class="number">0</span>].length;</span><br><span class="line">        <span class="keyword">int</span> f[][] = <span class="keyword">new</span> <span class="keyword">int</span>[row][column ];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matrix[i][<span class="number">0</span>] == <span class="string">'1'</span>) &#123;</span><br><span class="line">                f[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">                max = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; column; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matrix[<span class="number">0</span>][i] == <span class="string">'1'</span>) &#123;</span><br><span class="line">                f[<span class="number">0</span>][i] = <span class="number">1</span>;</span><br><span class="line">                max = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; row; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; column; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (matrix[i][j] == <span class="string">'1'</span>) &#123;</span><br><span class="line">                    f[i][j] = Math.min(f[i - <span class="number">1</span>][j - <span class="number">1</span>], Math.min(f[i][j - <span class="number">1</span>], f[i - <span class="number">1</span>][j])) + <span class="number">1</span>;</span><br><span class="line">                    max = Math.max(max, f[i][j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max * max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>LRU</title>
    <url>/2019/01/07/LRU/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Design-and-implement-a-data-structure-for-Least-Recently-Used-LRU-cache-It-should-support-the-following-operations-get-and-put-get-key-Get-the-value-will-always-be-positive-of-the-key-if-the-key-exists-in-the-cache-otherwise-return-1-put-key-value-Set-or-insert-the-value-if-the-key-is-not-already-present-When-the-cache-reached-its-capacity-it-should-invalidate-the-least-recently-used-item-before-inserting-a-new-item-Could-you-do-both-operations-in-O-1-time-complexity"><a href="#Design-and-implement-a-data-structure-for-Least-Recently-Used-LRU-cache-It-should-support-the-following-operations-get-and-put-get-key-Get-the-value-will-always-be-positive-of-the-key-if-the-key-exists-in-the-cache-otherwise-return-1-put-key-value-Set-or-insert-the-value-if-the-key-is-not-already-present-When-the-cache-reached-its-capacity-it-should-invalidate-the-least-recently-used-item-before-inserting-a-new-item-Could-you-do-both-operations-in-O-1-time-complexity" class="headerlink" title="Design and implement a data structure for Least Recently Used (LRU) cache. It should support the following operations: get and put.get(key) - Get the value (will always be positive) of the key if the key exists in the cache, otherwise return -1.put(key, value) - Set or insert the value if the key is not already present. When the cache reached its capacity, it should invalidate the least recently used item before inserting a new item.Could you do both operations in O(1) time complexity?"></a>Design and implement a data structure for Least Recently Used (LRU) cache. It should support the following operations: get and put.get(key) - Get the value (will always be positive) of the key if the key exists in the cache, otherwise return -1.put(key, value) - Set or insert the value if the key is not already present. When the cache reached its capacity, it should invalidate the least recently used item before inserting a new item.Could you do both operations in O(1) time complexity?</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">LRUCache cache = <span class="keyword">new</span> LRUCache( <span class="number">2</span> <span class="comment">/* capacity */</span> );</span><br><span class="line"></span><br><span class="line">cache.put(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">cache.put(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">cache.get(<span class="number">1</span>);       <span class="comment">// returns 1</span></span><br><span class="line">cache.put(<span class="number">3</span>, <span class="number">3</span>);    <span class="comment">// evicts key 2</span></span><br><span class="line">cache.get(<span class="number">2</span>);       <span class="comment">// returns -1 (not found)</span></span><br><span class="line">cache.put(<span class="number">4</span>, <span class="number">4</span>);    <span class="comment">// evicts key 1</span></span><br><span class="line">cache.get(<span class="number">1</span>);       <span class="comment">// returns -1 (not found)</span></span><br><span class="line">cache.get(<span class="number">3</span>);       <span class="comment">// returns 3</span></span><br><span class="line">cache.get(<span class="number">4</span>);       <span class="comment">// returns 4</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　一开始选取HashMap，但因为HashMap无序只能放弃。最终选取了LinkedHashMap,但在使用过程中，无法remove指定index元素。差点手写。幸而搜到了LInkedHashMap的一个构造函数可以实现LRU。还需要重写removeEldestEntry方法，LInkedHashMap在添加元素后会调用removeEldestEntry方法检查是否需要移出最久未使用元素。<br> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor, <span class="keyword">boolean</span> accessOrder)</span> </span>&#123;<span class="comment">//accessOrder：true采取LRU淘汰算法</span></span><br><span class="line">       <span class="keyword">super</span>(initialCapacity, loadFactor);</span><br><span class="line">       <span class="keyword">this</span>.accessOrder = accessOrder;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight plain"><figcaption><span>LRUCache &#123;</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">     LinkedHashMap mCacheMap;</span><br><span class="line">    int mCapacity;</span><br><span class="line">    public LRUCache(int capacity) &#123;</span><br><span class="line">        mCapacity = capacity;</span><br><span class="line">        mCacheMap = new LinkedHashMap(capacity, 0.75F, true)&#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected boolean removeEldestEntry(Map.Entry eldest) &#123;</span><br><span class="line">                if (mCapacity + 1 == mCacheMap.size()) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int get(int key) &#123;</span><br><span class="line">        if (mCacheMap.containsKey(key)) &#123;</span><br><span class="line">            return (int) mCacheMap.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void put(int key, int value) &#123;</span><br><span class="line">        mCacheMap.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Best Time to Buy and Sell Stock</title>
    <url>/2019/01/06/Best%20Time%20to%20Buy%20and%20Sell%20Stock/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Say-you-have-an-array-for-which-the-ith-element-is-the-price-of-a-given-stock-on-day-i-If-you-were-only-permitted-to-complete-at-most-one-transaction-i-e-buy-one-and-sell-one-share-of-the-stock-design-an-algorithm-to-find-the-maximum-profit-Note-that-you-cannot-sell-a-stock-before-you-buy-one"><a href="#Say-you-have-an-array-for-which-the-ith-element-is-the-price-of-a-given-stock-on-day-i-If-you-were-only-permitted-to-complete-at-most-one-transaction-i-e-buy-one-and-sell-one-share-of-the-stock-design-an-algorithm-to-find-the-maximum-profit-Note-that-you-cannot-sell-a-stock-before-you-buy-one" class="headerlink" title="Say you have an array for which the ith element is the price of a given stock on day i.If you were only permitted to complete at most one transaction (i.e., buy one and sell one share of the stock), design an algorithm to find the maximum profit.Note that you cannot sell a stock before you buy one."></a>Say you have an array for which the ith element is the price of a given stock on day i.If you were only permitted to complete at most one transaction (i.e., buy one and sell one share of the stock), design an algorithm to find the maximum profit.Note that you cannot sell a stock before you buy one.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">7</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">4</span>]</span><br><span class="line">Output: <span class="number">5</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: [<span class="number">7</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">1</span>]</span><br><span class="line">Output: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　这道贪心的题关键在于找到前面n个的最小，不需要用Treeset排序。只需要记录前i个的最小。以及后面的多笔交易也与之类似。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Single transaction</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (prices.length == <span class="number">0</span> || prices.length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> maxProfit = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> min = prices[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">            min = Math.min(min, prices[i]);</span><br><span class="line">            maxProfit = Math.max(maxProfit, prices[i] - min);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxProfit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Multiple transaction</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (prices.length == <span class="number">0</span> || prices.length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> maxProfit = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> min = prices[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prices[i] - min &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                maxProfit += prices[i] - min;</span><br><span class="line">            &#125;</span><br><span class="line">            min = prices[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxProfit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The min stack</title>
    <url>/2019/01/06/The%20min%20stack/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Design-a-stack-that-supports-push-pop-top-and-retrieving-the-minimum-element-in-constant-time"><a href="#Design-a-stack-that-supports-push-pop-top-and-retrieving-the-minimum-element-in-constant-time" class="headerlink" title="Design a stack that supports push, pop, top, and retrieving the minimum element in constant time."></a>Design a stack that supports push, pop, top, and retrieving the minimum element in constant time.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">MinStack minStack = <span class="keyword">new</span> MinStack();</span><br><span class="line">minStack.push(-<span class="number">2</span>);</span><br><span class="line">minStack.push(<span class="number">0</span>);</span><br><span class="line">minStack.push(-<span class="number">3</span>);</span><br><span class="line">minStack.getMin();   --&gt; Returns -<span class="number">3</span>.</span><br><span class="line">minStack.pop();</span><br><span class="line">minStack.top();      --&gt; Returns <span class="number">0</span>.</span><br><span class="line">minStack.getMin();   --&gt; Returns -<span class="number">2</span>.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　逻辑没问题，但就是怎么就AC不了。还是那个老问题。以前是list里添加list要new。这道题是同样问题。List添加对象时，也要每次new，每次靠 = 修改对象再添加。这样list内的对象会都一样。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">MinStack</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Stack&lt;Integer&gt; mStack;</span><br><span class="line">    Stack&lt;Integer&gt; mMinStack;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MinStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mStack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        mMinStack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        mStack.push(x);</span><br><span class="line">        <span class="keyword">if</span> (mMinStack.size() == <span class="number">0</span> || x &lt; mMinStack.peek()) &#123;</span><br><span class="line">            mMinStack.push(x);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mMinStack.push(mMinStack.peek());</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mStack.isEmpty()) &#123;</span><br><span class="line">            mStack.pop();</span><br><span class="line">            mMinStack.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mStack.peek();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMinStack.peek();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Jupyter配置</title>
    <url>/2019/01/05/Jupyter%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>　　看了网上很多配置工作路径的，全坑人的呀，每一个配上了，最后还是靠自己丰衣足食。一步步看cmd命令解释生生一次次试错试出来啦。<br> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Jupyter-notebook --generate-config</span><br></pre></td></tr></table></figure></p>
<p>再将生成文件的目录的工作路径改了即可。以及右击Jupyter快捷方式中的属性（起始位置%HOMEPATH%后的东西全删掉）</p>
]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the lowest common ancestor (LCA)</title>
    <url>/2019/01/05/LCA/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-binary-tree-find-the-lowest-common-ancestor-LCA-of-two-given-nodes-in-the-tree-According-to-the-definition-of-LCA-on-Wikipedia-“The-lowest-common-ancestor-is-defined-between-two-nodes-p-and-q-as-the-lowest-node-in-T-that-has-both-p-and-q-as-descendants-where-we-allow-a-node-to-be-a-descendant-of-itself-”-All-of-the-nodes’-values-will-be-unique-p-and-q-are-different-and-both-values-will-exist-in-the-binary-tree"><a href="#Given-a-binary-tree-find-the-lowest-common-ancestor-LCA-of-two-given-nodes-in-the-tree-According-to-the-definition-of-LCA-on-Wikipedia-“The-lowest-common-ancestor-is-defined-between-two-nodes-p-and-q-as-the-lowest-node-in-T-that-has-both-p-and-q-as-descendants-where-we-allow-a-node-to-be-a-descendant-of-itself-”-All-of-the-nodes’-values-will-be-unique-p-and-q-are-different-and-both-values-will-exist-in-the-binary-tree" class="headerlink" title="Given a binary tree, find the lowest common ancestor (LCA) of two given nodes in the tree.According to the definition of LCA on Wikipedia: “The lowest common ancestor is defined between two nodes p and q as the lowest node in T that has both p and q as descendants (where we allow a node to be a descendant of itself).” All of the nodes’ values will be unique.p and q are different and both values will exist in the binary tree."></a>Given a binary tree, find the lowest common ancestor (LCA) of two given nodes in the tree.According to the definition of LCA on Wikipedia: “The lowest common ancestor is defined between two nodes p and q as the lowest node in T that has both p and q as descendants (where we allow a node to be a descendant of itself).” All of the nodes’ values will be unique.p and q are different and both values will exist in the binary tree.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: root = [<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="number">7</span>,<span class="number">4</span>], p = <span class="number">5</span>, q = <span class="number">1</span></span><br><span class="line">Output: <span class="number">3</span></span><br><span class="line">Explanation: The LCA of nodes <span class="number">5</span> and <span class="number">1</span> is <span class="number">3</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: root = [<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="number">7</span>,<span class="number">4</span>], p = <span class="number">5</span>, q = <span class="number">4</span></span><br><span class="line">Output: <span class="number">5</span></span><br><span class="line">Explanation: The LCA of nodes <span class="number">5</span> and <span class="number">4</span> is <span class="number">5</span>, since a node can be a descendant of itself according to the LCA definition.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　思路是先找到根节点到两个节点的路径，转换为求两个链表的公共节点。代码量不少啊…<br>  　　看了解析，有一个时间复杂度和该方法一致，但更为简介的算法。自底向上遍历结点，一旦遇到结点等于p或者q，则将其向上传递给它的父结点。父结点会判断它的左右子树是否都包含其中一个结点，如果是，则父结点一定是这两个节点p和q的LCA（前提是p,q唯一），传递父结点到root。如果不是，我们向上传递其中的包含结点p或者q的子结点，或者NULL(如果子结点不包含任何一个)。该方法时间复杂度为O(N)。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode left;</span></span><br><span class="line"><span class="comment"> *     TreeNode right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">getPath</span><span class="params">(TreeNode root, TreeNode target, List&lt;TreeNode&gt; path)</span> </span>&#123;</span><br><span class="line">        path.add(root);</span><br><span class="line">        <span class="keyword">if</span> (root.val == target.val) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (root.left != <span class="keyword">null</span>)</span><br><span class="line">            found = getPath(root.left, target, path);</span><br><span class="line">        <span class="keyword">if</span> (!found &amp;&amp; root.right != <span class="keyword">null</span>)</span><br><span class="line">            found = getPath(root.right, target, path);</span><br><span class="line">        <span class="keyword">if</span> (!found)</span><br><span class="line">            path.remove(root);</span><br><span class="line">        <span class="keyword">return</span> found;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">getLastAncestor</span><span class="params">(List&lt;TreeNode&gt; listP, List&lt;TreeNode&gt; listQ)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pLength = listP.size();</span><br><span class="line">        <span class="keyword">int</span> qLength = listQ.size();</span><br><span class="line">        TreeNode pNode = <span class="keyword">null</span>;</span><br><span class="line">        TreeNode qNode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = Math.min(pLength,qLength) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            pNode = listP.get(i);</span><br><span class="line">            qNode = listQ.get(i);</span><br><span class="line">            <span class="keyword">if</span> (pNode == qNode) &#123;</span><br><span class="line">                <span class="keyword">return</span> pNode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> qNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode root, TreeNode p, TreeNode q)</span> </span>&#123;</span><br><span class="line">        List&lt;TreeNode&gt; listP = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;TreeNode&gt; listQ = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        getPath(root, p, listP);</span><br><span class="line">        getPath(root, q, listQ);</span><br><span class="line">        <span class="keyword">return</span> getLastAncestor(listP, listQ);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode left;</span></span><br><span class="line"><span class="comment"> *     TreeNode right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode root, TreeNode p, TreeNode q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="keyword">null</span> || root == p || root == q) <span class="keyword">return</span> root;</span><br><span class="line">        </span><br><span class="line">        TreeNode l = lowestCommonAncestor(root.left, p, q);</span><br><span class="line">        TreeNode r = lowestCommonAncestor(root.right, p, q);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(l == <span class="keyword">null</span> &amp;&amp; r == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(l != <span class="keyword">null</span> &amp;&amp; r != <span class="keyword">null</span>) <span class="keyword">return</span> root;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> l = (l != <span class="keyword">null</span>)? l:r; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Merge K linked list</title>
    <url>/2019/01/05/Merge%20K%20linked%20list/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Merge-k-sorted-linked-lists-and-return-it-as-one-sorted-list-Analyze-and-describe-its-complexity"><a href="#Merge-k-sorted-linked-lists-and-return-it-as-one-sorted-list-Analyze-and-describe-its-complexity" class="headerlink" title="Merge k sorted linked lists and return it as one sorted list. Analyze and describe its complexity."></a>Merge k sorted linked lists and return it as one sorted list. Analyze and describe its complexity.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  <span class="number">1</span>-&gt;<span class="number">4</span>-&gt;<span class="number">5</span>,</span><br><span class="line">  <span class="number">1</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span>,</span><br><span class="line">  <span class="number">2</span>-&gt;<span class="number">6</span></span><br><span class="line">]</span><br><span class="line">Output: <span class="number">1</span>-&gt;<span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span>-&gt;<span class="number">4</span>-&gt;<span class="number">5</span>-&gt;<span class="number">6</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　暴力解决，先比较出两个，再比剩下的。虽然过了。但时间惨不忍睹。这样时间复杂度为O(n^2)<br>　　<img src="/images/mergesort.png" alt="merge_sort"><br>  　　这张图是不是很像哈希表的链地址解决冲突呀～，每个索引对应一个链表，果然画图还是解决算法最高效的方法。接下来一趟归并操作猛如虎，注意的是归并排序中的一个小细节，排序中只剩两个元素时，归并（这两个元素所指的链表）。一个元素时，直接返回。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l1 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> l2;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (l2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> l1;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode mergeNode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (l1.val &lt;= l2.val) &#123;</span><br><span class="line">            mergeNode = l1;</span><br><span class="line">            mergeNode.next = mergeTwoLists(l1.next, l2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mergeNode = l2;</span><br><span class="line">            mergeNode.next = mergeTwoLists(l1, l2.next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mergeNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeSort</span><span class="params">(ListNode[] lists, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left &lt; right) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">            ListNode leftNode = mergeSort(lists, left, mid);</span><br><span class="line">            ListNode rightNode = mergeSort(lists, mid + <span class="number">1</span>, right);</span><br><span class="line">            <span class="keyword">return</span> mergeTwoLists(leftNode, rightNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lists[left];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeKLists</span><span class="params">(ListNode[] lists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lists.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mergeSort(lists, <span class="number">0</span>, lists.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The zigzag level order traversal</title>
    <url>/2019/01/05/The%20zigzag%20level%20order%20traversal/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-binary-tree-return-the-zigzag-level-order-traversal-of-its-nodes’-values-ie-from-left-to-right-then-right-to-left-for-the-next-level-and-alternate-between"><a href="#Given-a-binary-tree-return-the-zigzag-level-order-traversal-of-its-nodes’-values-ie-from-left-to-right-then-right-to-left-for-the-next-level-and-alternate-between" class="headerlink" title="Given a binary tree, return the zigzag level order traversal of its nodes’ values. (ie, from left to right, then right to left for the next level and alternate between)."></a>Given a binary tree, return the zigzag level order traversal of its nodes’ values. (ie, from left to right, then right to left for the next level and alternate between).</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">3</span>,<span class="number">9</span>,<span class="number">20</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="number">15</span>,<span class="number">7</span>]</span><br><span class="line">Output:: [</span><br><span class="line">  [<span class="number">3</span>],</span><br><span class="line">  [<span class="number">20</span>,<span class="number">9</span>],</span><br><span class="line">  [<span class="number">15</span>,<span class="number">7</span>]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　层次遍历的封装吧，层次遍历细节处理注意，起初分为奇偶层处理，奇数层：先加入左子树，后加入右子树。偶数层：先加入右子树，后加入左子树。但没有意识到偶数层逆序加入后，它下面的奇数层无法再顺序访问。<br> 　　无需在加入队列中特殊化处理，在加入List时做顺序逆序处理。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode left;</span></span><br><span class="line"><span class="comment"> *     TreeNode right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; zigzagLevelOrder(TreeNode root) &#123;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; treeNodes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> treeNodes;</span><br><span class="line">        &#125;</span><br><span class="line">        Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line">        queue.add(root);</span><br><span class="line">        TreeNode p;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isReverse = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">int</span> size = queue.size();</span><br><span class="line">            List&lt;Integer&gt; treeNode = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (size-- != <span class="number">0</span>) &#123;</span><br><span class="line">                p = queue.poll();</span><br><span class="line">                <span class="keyword">if</span> (p.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    queue.add(p.left);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    queue.add(p.right);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!isReverse) &#123;</span><br><span class="line">                    treeNode.add(p.val);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    treeNode.add(<span class="number">0</span>, p.val);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            isReverse = !isReverse;</span><br><span class="line">            treeNodes.add(treeNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> treeNodes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Add the two non-negative numbers</title>
    <url>/2019/01/04/Add%20the%20two%20non-negative%20numbers/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="You-are-given-two-non-empty-linked-lists-representing-two-non-negative-integers-The-digits-are-stored-in-reverse-order-and-each-of-their-nodes-contain-a-single-digit-Add-the-two-numbers-and-return-it-as-a-linked-list-You-may-assume-the-two-numbers-do-not-contain-any-leading-zero-except-the-number-0-itself"><a href="#You-are-given-two-non-empty-linked-lists-representing-two-non-negative-integers-The-digits-are-stored-in-reverse-order-and-each-of-their-nodes-contain-a-single-digit-Add-the-two-numbers-and-return-it-as-a-linked-list-You-may-assume-the-two-numbers-do-not-contain-any-leading-zero-except-the-number-0-itself" class="headerlink" title="You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.You may assume the two numbers do not contain any leading zero, except the number 0 itself."></a>You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.You may assume the two numbers do not contain any leading zero, except the number 0 itself.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: (<span class="number">2</span> -&gt; <span class="number">4</span> -&gt; <span class="number">3</span>) + (<span class="number">5</span> -&gt; <span class="number">6</span> -&gt; <span class="number">4</span>)</span><br><span class="line">Output: <span class="number">7</span> -&gt; <span class="number">0</span> -&gt; <span class="number">8</span></span><br><span class="line">Explanation: <span class="number">342</span> + <span class="number">465</span> = <span class="number">807</span>.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　看到这道超级熟悉的题目，写两个点。1：看清题目，一开始以为是正序的单链表，就觉得直接算不好算必须放到数组中。后来再看了下题目是逆序，这就好处理啦。2：还是循环少套if的问题，降低时间复杂度。创立一个头结点，省去判断，返回时，返回其next.效率提升了一半。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        ListNode result = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        ListNode p = result;</span><br><span class="line">        <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (l1 != <span class="keyword">null</span> || l2 != <span class="keyword">null</span> || carry != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> sum = ((l1 == <span class="keyword">null</span>) ? <span class="number">0</span> : l1.val) + ((l2 == <span class="keyword">null</span>) ? <span class="number">0</span> : l2.val) + carry;</span><br><span class="line">            carry = sum / <span class="number">10</span>;</span><br><span class="line">            sum = sum % <span class="number">10</span>;</span><br><span class="line">            ListNode node = <span class="keyword">new</span> ListNode(sum);</span><br><span class="line">            node.next = <span class="keyword">null</span>;</span><br><span class="line">            p.next = node;</span><br><span class="line">            p = node;</span><br><span class="line">            l1 = (l1 == <span class="keyword">null</span>) ? <span class="keyword">null</span> : l1.next;</span><br><span class="line">            l2 = (l2 == <span class="keyword">null</span>) ? <span class="keyword">null</span> : l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Find  the cycle begins node</title>
    <url>/2019/01/04/Find%20the%20cycle%20begins%20node/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-linked-list-return-the-node-where-the-cycle-begins-If-there-is-no-cycle-return-null-To-represent-a-cycle-in-the-given-linked-list-we-use-an-integer-pos-which-represents-the-position-0-indexed-in-the-linked-list-where-tail-connects-to-If-pos-is-1-then-there-is-no-cycle-in-the-linked-list"><a href="#Given-a-linked-list-return-the-node-where-the-cycle-begins-If-there-is-no-cycle-return-null-To-represent-a-cycle-in-the-given-linked-list-we-use-an-integer-pos-which-represents-the-position-0-indexed-in-the-linked-list-where-tail-connects-to-If-pos-is-1-then-there-is-no-cycle-in-the-linked-list" class="headerlink" title="Given a linked list, return the node where the cycle begins. If there is no cycle, return null. To represent a cycle in the given linked list, we use an integer pos which represents the position (0-indexed) in the linked list where tail connects to. If pos is -1, then there is no cycle in the linked list."></a>Given a linked list, return the node where the cycle begins. If there is no cycle, return null. To represent a cycle in the given linked list, we use an integer pos which represents the position (0-indexed) in the linked list where tail connects to. If pos is -1, then there is no cycle in the linked list.</h3><h3 id="Note-Do-not-modify-the-linked-list-Solve-it-without-using-extra-space"><a href="#Note-Do-not-modify-the-linked-list-Solve-it-without-using-extra-space" class="headerlink" title="Note: Do not modify the linked list.Solve it without using extra space?"></a>Note: Do not modify the linked list.Solve it without using extra space?</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: head = [<span class="number">3</span>,<span class="number">2</span>,<span class="number">0</span>,-<span class="number">4</span>], pos = <span class="number">1</span></span><br><span class="line">Output: tail connects to node index <span class="number">1</span></span><br><span class="line">Explanation: There is a cycle in the linked list, where tail connects to the second n</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: head = [<span class="number">1</span>,<span class="number">2</span>], pos = <span class="number">0</span></span><br><span class="line">Output: tail connects to node index <span class="number">0</span></span><br><span class="line">Explanation: There is a cycle in the linked list, where tail connects to the first node.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input: head = [<span class="number">1</span>], pos = -<span class="number">1</span></span><br><span class="line">Output: no cycle</span><br><span class="line">Explanation: There is no cycle in the linked list.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　<img src="/images/cycle_list.PNG" alt="cycle_list"><br>  Y为环的起点，Z为slow走一步与fast走两步的第一次相遇之点。当第一次相遇时slow走过的距离：a+b，fast走过的距离：a+b+c+b。因为fast的速度是slow的两倍，所以fast走的距离是slow的两倍，有 2(a+b) = a+b+c+b，可以得到a=c。所以先找到slow与fast相遇的Z点。在令slow从X开始走，fast从Z点同步走相遇即为Y点<br>  一个小细节与上道题的差异：在第一次相遇之点的判断与上题不同。while (fastNode != null &amp;&amp; fastNode.next != null) 与上题的while (fastNode.next != null &amp;&amp; fastNode.next.next != null) 不同。而且都不能随意替换。这道题如果换成后者会结果出错。要具体问题具体分析条件，差异主要体现在链表结点数目为偶数时，前者会取到length / 2 + 1,后者会取到 length/2 - 1. </p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) &#123;</span></span><br><span class="line"><span class="comment"> *         val = x;</span></span><br><span class="line"><span class="comment"> *         next = null;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> ListNode <span class="title">detectCycle</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode fastNode = head, slowNode = head;</span><br><span class="line">        <span class="keyword">while</span> (fastNode != <span class="keyword">null</span> &amp;&amp; fastNode.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fastNode = fastNode.next.next;</span><br><span class="line">            slowNode = slowNode.next;</span><br><span class="line">            <span class="keyword">if</span> (fastNode == slowNode) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fastNode == slowNode &amp;&amp; fastNode.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">            slowNode = head;</span><br><span class="line">            <span class="keyword">while</span> (slowNode != fastNode) &#123;</span><br><span class="line">                slowNode = slowNode.next;</span><br><span class="line">                fastNode = fastNode.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fastNode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Sort a linked list</title>
    <url>/2019/01/04/Sort%20a%20linked%20list/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Sort-a-linked-list-in-O-n-log-n-time-using-constant-space-complexity"><a href="#Sort-a-linked-list-in-O-n-log-n-time-using-constant-space-complexity" class="headerlink" title="Sort a linked list in O(n log n) time using constant space complexity."></a>Sort a linked list in O(n log n) time using constant space complexity.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="number">4</span>-&gt;<span class="number">2</span>-&gt;<span class="number">1</span>-&gt;<span class="number">3</span></span><br><span class="line">Output: <span class="number">1</span>-&gt;<span class="number">2</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: -<span class="number">1</span>-&gt;<span class="number">5</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span>-&gt;<span class="number">0</span></span><br><span class="line">Output: -<span class="number">1</span>-&gt;<span class="number">0</span>-&gt;<span class="number">3</span>-&gt;<span class="number">4</span>-&gt;<span class="number">5</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　O(nlogn)用归并排序，快排一开始自己以为简单单链表是无法实现的,后来发现也是可以实现的。先说归并，先通过快慢指针找到中间节点，切记要将中间节点的next域设为null，再分别分治处理。值得一提的是归并的时间复杂度在链表的存储结构中降为了O(1),好神奇，有木有.快排则是采用了类似剑指Offer上的快排写法。这种写法避免了传统严奶奶版的双向移动，毕竟单链表往前动不了。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Merge_Sort</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> ListNode <span class="title">sortList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> head;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ListNode fastNode = head, slowNode = head;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (fastNode.next != <span class="keyword">null</span> &amp;&amp; fastNode.next.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//cannot use while (fastNode != null &amp;&amp; fastNode.next.!= null) &#123;</span></span><br><span class="line">		<span class="comment">//This would be a stack overflow error when node number are even.</span></span><br><span class="line">            fastNode = fastNode.next.next;</span><br><span class="line">            slowNode = slowNode.next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fastNode = slowNode;</span><br><span class="line">        slowNode = slowNode.next;</span><br><span class="line">        fastNode.next = <span class="keyword">null</span>;</span><br><span class="line">        head = sortList(head);</span><br><span class="line">        slowNode = sortList(slowNode);</span><br><span class="line">        <span class="keyword">return</span> mergeTwoLists(head, slowNode);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l1 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> l2;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (l2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> l1;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode mergeNode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (l1.val &lt;= l2.val) &#123;</span><br><span class="line">            mergeNode = l1;</span><br><span class="line">            mergeNode.next = mergeTwoLists(l1.next, l2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mergeNode = l2;</span><br><span class="line">            mergeNode.next = mergeTwoLists(l1, l2.next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mergeNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  Quick_Sort</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode *<span class="title">quickSortList</span><span class="params">(ListNode *head)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// IMPORTANT: Please reset any member data you declared, as</span></span><br><span class="line">        <span class="comment">// the same Solution instance will be reused for each test case.</span></span><br><span class="line">        <span class="comment">//链表快速排序</span></span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">NULL</span> || head-&gt;next == <span class="literal">NULL</span>)<span class="keyword">return</span> head;</span><br><span class="line">        qsortList(head, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">qsortList</span><span class="params">(ListNode*head, ListNode*tail)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//链表范围是[low, high)</span></span><br><span class="line">        <span class="keyword">if</span>(head != tail &amp;&amp; head-&gt;next != tail)</span><br><span class="line">        &#123;</span><br><span class="line">            ListNode* mid = partitionList(head, tail);</span><br><span class="line">            qsortList(head, mid);</span><br><span class="line">            qsortList(mid-&gt;next, tail);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ListNode* <span class="title">partitionList</span><span class="params">(ListNode*low, ListNode*high)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//链表范围是[low, high)</span></span><br><span class="line">        <span class="keyword">int</span> key = low-&gt;val;</span><br><span class="line">        ListNode* loc = low;</span><br><span class="line">        <span class="keyword">for</span>(ListNode*i = low-&gt;next; i != high; i = i-&gt;next)</span><br><span class="line">            <span class="keyword">if</span>(i-&gt;val &lt; key)</span><br><span class="line">            &#123;</span><br><span class="line">                loc = loc-&gt;next;</span><br><span class="line">                swap(i-&gt;val, loc-&gt;val);</span><br><span class="line">            &#125;</span><br><span class="line">        swap(loc-&gt;val, low-&gt;val);</span><br><span class="line">        <span class="keyword">return</span> loc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>android studio build成功，build app时报illegalStateException</title>
    <url>/2019/01/03/Build%20apk%20with%20an%20illegal%20state%20exception/</url>
    <content><![CDATA[<h3 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Error:beta&lt;build&gt;|]</span><br><span class="line">Error:java.lang.RuntimeException: com.android.build.api.transform.TransformException: java.lang.IllegalStateException: java.lang.IllegalStateException</span><br><span class="line">Error:java.lang.IllegalStateException: java.lang.IllegalStateException</span><br><span class="line">Error:com.android.build.api.transform.TransformException: java.lang.IllegalStateException: java.lang.IllegalStateException</span><br><span class="line">Error:java.lang.IllegalStateException</span><br></pre></td></tr></table></figure>
<h3 id="日志信息"><a href="#日志信息" class="headerlink" title="日志信息"></a>日志信息</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">org.gradle.api.tasks.TaskExecutionException: Execution failed <span class="keyword">for</span> <span class="keyword">task</span> <span class="string">':AnkiDroid:transformClassesWithInstantRunForDebug'</span>.</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.executeActions(ExecuteActionsTaskExecuter.java:<span class="number">110</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.execute(ExecuteActionsTaskExecuter.java:<span class="number">77</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.OutputDirectoryCreatingTaskExecuter.execute(OutputDirectoryCreatingTaskExecuter.java:<span class="number">51</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.SkipUpToDateTaskExecuter.execute(SkipUpToDateTaskExecuter.java:<span class="number">59</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ResolveTaskOutputCachingStateExecuter.execute(ResolveTaskOutputCachingStateExecuter.java:<span class="number">54</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ValidatingTaskExecuter.execute(ValidatingTaskExecuter.java:<span class="number">59</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.SkipEmptySourceFilesTaskExecuter.execute(SkipEmptySourceFilesTaskExecuter.java:<span class="number">101</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.FinalizeInputFilePropertiesTaskExecuter.execute(FinalizeInputFilePropertiesTaskExecuter.java:<span class="number">44</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.CleanupStaleOutputsExecuter.execute(CleanupStaleOutputsExecuter.java:<span class="number">91</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ResolveTaskArtifactStateTaskExecuter.execute(ResolveTaskArtifactStateTaskExecuter.java:<span class="number">62</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.SkipTaskWithNoActionsExecuter.execute(SkipTaskWithNoActionsExecuter.java:<span class="number">59</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.SkipOnlyIfTaskExecuter.execute(SkipOnlyIfTaskExecuter.java:<span class="number">54</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ExecuteAtMostOnceTaskExecuter.execute(ExecuteAtMostOnceTaskExecuter.java:<span class="number">43</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.CatchExceptionTaskExecuter.execute(CatchExceptionTaskExecuter.java:<span class="number">34</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.EventFiringTaskExecuter$<span class="number">1</span>.run(EventFiringTaskExecuter.java:<span class="number">51</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor$RunnableBuildOperationWorker.execute(DefaultBuildOperationExecutor.java:<span class="number">300</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor$RunnableBuildOperationWorker.execute(DefaultBuildOperationExecutor.java:<span class="number">292</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor.execute(DefaultBuildOperationExecutor.java:<span class="number">174</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor.run(DefaultBuildOperationExecutor.java:<span class="number">90</span>)</span><br><span class="line">	at org.gradle.internal.operations.DelegatingBuildOperationExecutor.run(DelegatingBuildOperationExecutor.java:<span class="number">31</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.EventFiringTaskExecuter.execute(EventFiringTaskExecuter.java:<span class="number">46</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.LocalTaskInfoExecutor.execute(LocalTaskInfoExecutor.java:<span class="number">42</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$BuildOperationAwareWorkItemExecutor.execute(DefaultTaskExecutionGraph.java:<span class="number">277</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$BuildOperationAwareWorkItemExecutor.execute(DefaultTaskExecutionGraph.java:<span class="number">262</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskPlanExecutor$ExecutorWorker$<span class="number">1</span>.execute(DefaultTaskPlanExecutor.java:<span class="number">135</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskPlanExecutor$ExecutorWorker$<span class="number">1</span>.execute(DefaultTaskPlanExecutor.java:<span class="number">130</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskPlanExecutor$ExecutorWorker.execute(DefaultTaskPlanExecutor.java:<span class="number">200</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskPlanExecutor$ExecutorWorker.executeWithWork(DefaultTaskPlanExecutor.java:<span class="number">191</span>)</span><br><span class="line">	at org.gradle.execution.taskgraph.DefaultTaskPlanExecutor$ExecutorWorker.run(DefaultTaskPlanExecutor.java:<span class="number">130</span>)</span><br><span class="line">	at org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:<span class="number">63</span>)</span><br><span class="line">	at org.gradle.internal.concurrent.ManagedExecutorImpl$<span class="number">1</span>.run(ManagedExecutorImpl.java:<span class="number">46</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">	at org.gradle.internal.concurrent.ThreadFactoryImpl$ManagedThreadRunnable.run(ThreadFactoryImpl.java:<span class="number">55</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line">Caused by: java.lang.RuntimeException: com.android.build.api.transform.TransformException: java.lang.IllegalStateException: java.lang.IllegalStateException</span><br><span class="line">	at com.android.builder.profile.Recorder$Block.handleException(Recorder.java:<span class="number">55</span>)</span><br><span class="line">	at com.android.builder.profile.ThreadRecorder.record(ThreadRecorder.java:<span class="number">104</span>)</span><br><span class="line">	at com.android.build.gradle.internal.pipeline.TransformTask.transform(TransformTask.java:<span class="number">230</span>)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(<span class="keyword">Native</span> Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">497</span>)</span><br><span class="line">	at org.gradle.internal.reflect.JavaMethod.invoke(JavaMethod.java:<span class="number">73</span>)</span><br><span class="line">	at org.gradle.api.internal.<span class="keyword">project</span>.taskfactory.IncrementalTaskAction.doExecute(IncrementalTaskAction.java:<span class="number">50</span>)</span><br><span class="line">	at org.gradle.api.internal.<span class="keyword">project</span>.taskfactory.StandardTaskAction.execute(StandardTaskAction.java:<span class="number">39</span>)</span><br><span class="line">	at org.gradle.api.internal.<span class="keyword">project</span>.taskfactory.StandardTaskAction.execute(StandardTaskAction.java:<span class="number">26</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter$<span class="number">1</span>.run(ExecuteActionsTaskExecuter.java:<span class="number">131</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor$RunnableBuildOperationWorker.execute(DefaultBuildOperationExecutor.java:<span class="number">300</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor$RunnableBuildOperationWorker.execute(DefaultBuildOperationExecutor.java:<span class="number">292</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor.execute(DefaultBuildOperationExecutor.java:<span class="number">174</span>)</span><br><span class="line">	at org.gradle.internal.operations.DefaultBuildOperationExecutor.run(DefaultBuildOperationExecutor.java:<span class="number">90</span>)</span><br><span class="line">	at org.gradle.internal.operations.DelegatingBuildOperationExecutor.run(DelegatingBuildOperationExecutor.java:<span class="number">31</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.executeAction(ExecuteActionsTaskExecuter.java:<span class="number">120</span>)</span><br><span class="line">	at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.executeActions(ExecuteActionsTaskExecuter.java:<span class="number">99</span>)</span><br><span class="line">	... <span class="number">34</span> more</span><br><span class="line">Caused by: com.android.build.api.transform.TransformException: java.lang.IllegalStateException: java.lang.IllegalStateException</span><br><span class="line">	at com.android.build.gradle.internal.transforms.InstantRunTransform.doTransform(InstantRunTransform.java:<span class="number">320</span>)</span><br><span class="line">	at com.android.build.gradle.internal.transforms.InstantRunTransform.transform(InstantRunTransform.java:<span class="number">186</span>)</span><br><span class="line">	at com.android.build.gradle.internal.pipeline.TransformTask$<span class="number">2</span>.<span class="keyword">call</span>(TransformTask.java:<span class="number">239</span>)</span><br><span class="line">	at com.android.build.gradle.internal.pipeline.TransformTask$<span class="number">2</span>.<span class="keyword">call</span>(TransformTask.java:<span class="number">235</span>)</span><br><span class="line">	at com.android.builder.profile.ThreadRecorder.record(ThreadRecorder.java:<span class="number">102</span>)</span><br><span class="line">	... <span class="number">51</span> more</span><br><span class="line">Caused by: java.lang.IllegalStateException: java.lang.IllegalStateException</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(<span class="keyword">Native</span> Method)</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:<span class="number">45</span>)</span><br><span class="line">	at java.lang.reflect.Constructor.newInstance(Constructor.java:<span class="number">422</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask.getThrowableException(ForkJoinTask.java:<span class="number">593</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask.reportException(ForkJoinTask.java:<span class="number">677</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask.<span class="keyword">join</span>(ForkJoinTask.java:<span class="number">720</span>)</span><br><span class="line">	at com.android.ide.common.internal.WaitableExecutor.waitForTasksWithQuickFail(WaitableExecutor.java:<span class="number">146</span>)</span><br><span class="line">	at com.android.build.gradle.internal.transforms.InstantRunTransform.doTransform(InstantRunTransform.java:<span class="number">315</span>)</span><br><span class="line">	... <span class="number">55</span> more</span><br><span class="line">Caused by: java.lang.IllegalStateException</span><br><span class="line">	at org.objectweb.asm.tree.analysis.BasicInterpreter.&lt;init&gt;(BasicInterpreter.java:<span class="number">66</span>)</span><br><span class="line">	at com.android.build.gradle.internal.incremental.ConstructorBuilder$<span class="number">1</span>.&lt;init&gt;(ConstructorBuilder.java:<span class="number">127</span>)</span><br><span class="line">	at com.android.build.gradle.internal.incremental.ConstructorBuilder.build(ConstructorBuilder.java:<span class="number">127</span>)</span><br><span class="line">	at com.android.build.gradle.internal.incremental.IncrementalSupportVisitor.visitMethod(IncrementalSupportVisitor.java:<span class="number">223</span>)</span><br><span class="line">	at org.objectweb.asm.ClassVisitor.visitMethod(ClassVisitor.java:<span class="number">327</span>)</span><br><span class="line">	at org.objectweb.asm.commons.SerialVersionUIDAdder.visitMethod(SerialVersionUIDAdder.java:<span class="number">236</span>)</span><br><span class="line">	at org.objectweb.asm.tree.MethodNode.accept(MethodNode.java:<span class="number">686</span>)</span><br><span class="line">	at org.objectweb.asm.tree.ClassNode.accept(ClassNode.java:<span class="number">436</span>)</span><br><span class="line">	at com.android.build.gradle.internal.incremental.IncrementalVisitor.instrumentClass(IncrementalVisitor.java:<span class="number">365</span>)</span><br><span class="line">	at com.android.build.gradle.internal.transforms.InstantRunTransform.transformToClasses2Format(InstantRunTransform.java:<span class="number">414</span>)</span><br><span class="line">	at com.android.build.gradle.internal.transforms.InstantRunTransform.lambda$doTransform$<span class="number">4</span>(InstantRunTransform.java:<span class="number">276</span>)</span><br><span class="line">	at com.android.build.gradle.internal.transforms.InstantRunTransform.lambda$<span class="keyword">null</span>$<span class="number">5</span>(InstantRunTransform.java:<span class="number">305</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask$AdaptedCallable.exec(ForkJoinTask.java:<span class="number">1424</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:<span class="number">289</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:<span class="number">1056</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:<span class="number">1692</span>)</span><br><span class="line">	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:<span class="number">157</span>)</span><br></pre></td></tr></table></figure>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>　　关闭Instant run(Settings-&gt;Build-&gt;Instant Run).再重新安装即可成功。</p>
]]></content>
      <categories>
        <category>bug</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Get water</title>
    <url>/2019/01/03/Get%20water/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-n-non-negative-integers-representing-an-elevation-map-where-the-width-of-each-bar-is-1-compute-how-much-water-it-is-able-to-trap-after-raining"><a href="#Given-n-non-negative-integers-representing-an-elevation-map-where-the-width-of-each-bar-is-1-compute-how-much-water-it-is-able-to-trap-after-raining" class="headerlink" title="Given n non-negative integers representing an elevation map where the width of each bar is 1, compute how much water it is able to trap after raining."></a>Given n non-negative integers representing an elevation map where the width of each bar is 1, compute how much water it is able to trap after raining.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">Output: <span class="number">6</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/trap_water_example.PNG" alt="enter description here"></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　这难道就是一看就懂，一写就懵逼的题目吗？一看就知道是木桶效应，嗯问题来了，咋写呢？ 苦思良久，还是看解析吧！  发现博主和我想法不谋而合也是采取了木桶效应。取当前块的左右最大边界中的最低边界min.-当前块的高度。但这样做会超时。可以采用分治策略，先找到最高块高度和索引，分别计算左侧水面积和右侧水面积再相加。以计算左侧面积为例：判读当前块高度currentHeight是否大于maxHeight，为true的话，则累加（maxHeight - currentHeight ）;</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span>//Shortest barrel</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">trap</span><span class="params">(self, height)</span>:</span></span><br><span class="line">       <span class="string">"""</span></span><br><span class="line"><span class="string">       :type height: List[int]</span></span><br><span class="line"><span class="string">       :rtype: int</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">       res, hei_len = <span class="number">0</span>, len(height)</span><br><span class="line">       <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, hei_len<span class="number">-1</span>):</span><br><span class="line">           max_left, max_right = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">           <span class="keyword">for</span> l <span class="keyword">in</span> range(i+<span class="number">1</span>):</span><br><span class="line">               max_left = max(max_left, height[l])</span><br><span class="line">           <span class="keyword">for</span> r <span class="keyword">in</span> range(i, hei_len):</span><br><span class="line">               max_right = max(max_right, height[r])</span><br><span class="line">               </span><br><span class="line">           res += min(max_left, max_right) - height[i]</span><br><span class="line">           </span><br><span class="line">       <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">trap</span><span class="params">(<span class="keyword">int</span>[] height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (height.length == <span class="number">0</span> || height.length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> maxHeight = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; height.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (height[i] &gt; maxHeight) &#123;</span><br><span class="line">                maxHeight = height[i];</span><br><span class="line">                index = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>, currentMax = Integer.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentMax &gt;= height[i]) &#123;</span><br><span class="line">                result += currentMax - height[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                currentMax = height[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        currentMax = Integer.MIN_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = height.length - <span class="number">1</span>; i &gt; index; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentMax &gt;= height[i]) &#123;</span><br><span class="line">                result += currentMax - height[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                currentMax = height[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Merge overlapping intervals</title>
    <url>/2019/01/02/Merge%20overlapping%20intervals/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-a-collection-of-intervals-merge-all-overlapping-intervals"><a href="#Given-a-collection-of-intervals-merge-all-overlapping-intervals" class="headerlink" title="Given a collection of intervals, merge all overlapping intervals."></a>Given a collection of intervals, merge all overlapping intervals.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [[<span class="number">1</span>,<span class="number">3</span>],[<span class="number">2</span>,<span class="number">6</span>],[<span class="number">8</span>,<span class="number">10</span>],[<span class="number">15</span>,<span class="number">18</span>]]</span><br><span class="line">Output: [[<span class="number">1</span>,<span class="number">6</span>],[<span class="number">8</span>,<span class="number">10</span>],[<span class="number">15</span>,<span class="number">18</span>]]</span><br><span class="line">Explanation: Since intervals [<span class="number">1</span>,<span class="number">3</span>] and [<span class="number">2</span>,<span class="number">6</span>] overlaps, merge them into [<span class="number">1</span>,<span class="number">6</span>].</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: [[<span class="number">1</span>,<span class="number">4</span>],[<span class="number">4</span>,<span class="number">5</span>]]</span><br><span class="line">Output: [[<span class="number">1</span>,<span class="number">5</span>]]</span><br><span class="line">Explanation: Intervals [<span class="number">1</span>,<span class="number">4</span>] and [<span class="number">4</span>,<span class="number">5</span>] are considered overlapping.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　这道题和OJ上的看电视时间排序一题类似，以start递增排序，判断前一段区间的end是否大于后一段区间的start来进行合并。尽管AC了，但对象排序颇为耗时。看了解析，将start,end拆开放在两个数组。用一个索引记录区间。当 i &lt;length - 1且 start[i+1] &lt;= end[i].</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Interval</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> start;</span><br><span class="line">        <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">        Interval() &#123;</span><br><span class="line">            start = <span class="number">0</span>;</span><br><span class="line">            end = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Interval(<span class="keyword">int</span> s, <span class="keyword">int</span> e) &#123;</span><br><span class="line">            start = s;</span><br><span class="line">            end = e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Interval&gt; <span class="title">merge</span><span class="params">(List&lt;Interval&gt; intervals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lenth = intervals.size();</span><br><span class="line">        <span class="keyword">if</span> (lenth == <span class="number">0</span> || lenth == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> intervals;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> starts[] = <span class="keyword">new</span> <span class="keyword">int</span>[lenth];</span><br><span class="line">        <span class="keyword">int</span> ends[] = <span class="keyword">new</span> <span class="keyword">int</span>[lenth];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lenth; i++) &#123;</span><br><span class="line">            Interval interval = intervals.get(i);</span><br><span class="line">            starts[i] = interval.start;</span><br><span class="line">            ends[i] = interval.end;</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(starts);</span><br><span class="line">        Arrays.sort(ends);</span><br><span class="line">        List&lt;Interval&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        results.add(intervals.get(<span class="number">0</span>));</span><br><span class="line">        Interval currentInterval, nextInterval;</span><br><span class="line">        <span class="keyword">int</span> cur = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; lenth; i++) &#123;</span><br><span class="line">            currentInterval = results.get(cur);</span><br><span class="line">            nextInterval = intervals.get(i);</span><br><span class="line">            <span class="keyword">if</span> (currentInterval.end &gt;= nextInterval.start) &#123;</span><br><span class="line">                currentInterval.end = Math.max(currentInterval.end, nextInterval.end);</span><br><span class="line">                results.set(cur, currentInterval);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                results.add(nextInterval);</span><br><span class="line">                cur++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Interval&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> Interval(<span class="number">1</span>, <span class="number">3</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Interval(<span class="number">2</span>, <span class="number">6</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Interval(<span class="number">8</span>, <span class="number">10</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Interval(<span class="number">15</span>, <span class="number">18</span>));</span><br><span class="line">        <span class="keyword">new</span> Solution().merge(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The kth permutation sequence.</title>
    <url>/2019/01/02/The%20kth%20permutation%20sequence/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="The-set-1-2-3-…-n-contains-a-total-of-n-unique-permutations-By-listing-and-labeling-all-of-the-permutations-in-order-we-get-the-following-sequence-for-n-3-“123”，”132”，”213”，”231”，”312”，”321”；Given-n-and-k-return-the-kth-permutation-sequence-Note-Given-n-will-be-between-1-and-9-inclusive-Given-k-will-be-between-1-and-n-inclusive"><a href="#The-set-1-2-3-…-n-contains-a-total-of-n-unique-permutations-By-listing-and-labeling-all-of-the-permutations-in-order-we-get-the-following-sequence-for-n-3-“123”，”132”，”213”，”231”，”312”，”321”；Given-n-and-k-return-the-kth-permutation-sequence-Note-Given-n-will-be-between-1-and-9-inclusive-Given-k-will-be-between-1-and-n-inclusive" class="headerlink" title="The set [1,2,3,…,n] contains a total of n! unique permutations.By listing and labeling all of the permutations in order, we get the following sequence for n = 3:　“123”，”132”，”213”，”231”，”312”，”321”；Given n and k, return the kth permutation sequence.Note:Given n will be between 1 and 9 inclusive.Given k will be between 1 and n! inclusive."></a>The set [1,2,3,…,n] contains a total of n! unique permutations.By listing and labeling all of the permutations in order, we get the following sequence for n = 3:　“123”，”132”，”213”，”231”，”312”，”321”；Given n and k, return the kth permutation sequence.Note:Given n will be between 1 and 9 inclusive.Given k will be between 1 and n! inclusive.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: n = <span class="number">3</span>, k = <span class="number">3</span></span><br><span class="line">Output: <span class="string">"213"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: n = <span class="number">4</span>, k = <span class="number">9</span></span><br><span class="line">Output: <span class="string">"2314"</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　首先需将k–转换为从0开始计数，index = k％(n-1)!，得到的index就是当前剩余数组的index，如此就可以得到对应的元素。如此递推直到数组中没有元素结束。实现中我们要维护一个数组来记录当前的元素，每次得到一个元素加入结果数组，然后从剩余数组中移除（一定要移，而不是get），因此空间复杂度是O(n)。时间上总共需要n个回合，而每次删除元素如果是用数组需要O(n),所以总共是O(n^2)。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPermutation</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        k--;</span><br><span class="line">        List&lt;Integer&gt; integers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> factorial = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            integers.add(i);</span><br><span class="line">            factorial *= i;</span><br><span class="line">        &#125;</span><br><span class="line">        factorial /= n;</span><br><span class="line">        <span class="keyword">int</span> count = n - <span class="number">1</span>;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">while</span> (count &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(integers.remove(k / factorial));</span><br><span class="line">            k %= factorial;</span><br><span class="line">            <span class="keyword">if</span> (count != <span class="number">0</span>) &#123;</span><br><span class="line">                factorial /= count;</span><br><span class="line">            &#125;</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>DualPivotSort</title>
    <url>/2019/01/01/DualPivotSort/</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="DualPivotSort是一种双轴快排，双轴快排是基于两个轴来进行比较；JDK中选取头尾为轴；"><a href="#DualPivotSort是一种双轴快排，双轴快排是基于两个轴来进行比较；JDK中选取头尾为轴；" class="headerlink" title="DualPivotSort是一种双轴快排，双轴快排是基于两个轴来进行比较；JDK中选取头尾为轴；"></a>DualPivotSort是一种双轴快排，双轴快排是基于两个轴来进行比较；JDK中选取头尾为轴；</h3><p> 该类实现了Dual-Pivot Quicksort算法Vladimir Yaroslavskiy，Jon Bentley和Josh Bloch。 该算法在许多导致普通快排在有序的数据集上提供O（n log（n））性能,而普通快排降级为O(n^2)，通常是比传统（单枢轴）Quicksort实现更快。</p>
<p> <img src="/images/dualpivotsort.PNG" alt="DualPivotSort"></p>
<h2 id="双轴排序过程简析"><a href="#双轴排序过程简析" class="headerlink" title="双轴排序过程简析"></a>双轴排序过程简析</h2><p>1.对于很小的数组（长度小于27），会使用插入排序。<br>2.选择两个点P1,P2作为轴心，JDK中使用两端作为P1，P2.<br>3.P1必须比P2要小，否则将这两个元素交换，现在将整个数组分为四部分：<br>（1）第一部分：比P1小的元素。<br>（2）第二部分：比P1大但是比P2小的元素。<br>（3）第三部分：比P2大的元素。<br>（4）第四部分：尚未比较的部分。<br>在开始比较前，除了轴点，其余元素几乎都在第四部分，直到比较完之后第四部分没有元素。<br>4.从第四部分选出一个元素a[K]，与两个轴比较，然后放到第一二三部分中的一个。<br>5.移动L，K，G指向。<br>6.重复 4 5 步，直到第四部分没有元素。<br>7.将P1与第一部分的最后一个元素交换。将P2与第三部分的第一个元素交换。<br>8.递归的将第一二三部分排序。</p>
<h2 id="算法源码"><a href="#算法源码" class="headerlink" title="算法源码"></a>算法源码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对外公开的两个sort方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] a)</span> </span>&#123;</span><br><span class="line">	sort(a, <span class="number">0</span>, a.length);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex)</span> </span>&#123;</span><br><span class="line">	rangeCheck(a.length, fromIndex, toIndex);</span><br><span class="line">	dualPivotQuicksort(a, fromIndex, toIndex - <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//边界检测</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rangeCheck</span><span class="params">(<span class="keyword">int</span> length, <span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (fromIndex &gt; toIndex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"fromIndex &gt; toIndex"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (fromIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(fromIndex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (toIndex &gt; length) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException(toIndex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> temp = a[i];</span><br><span class="line">	a[i] = a[j];</span><br><span class="line">	a[j] = temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双轴快排的具体实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> a     待排序数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> left  数组需排序上界</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> right 数组需排序下界</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> div   理解为从何位置取轴</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dualPivotQuicksort</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> left,<span class="keyword">int</span> right, <span class="keyword">int</span> div)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len = right - left;</span><br><span class="line">	<span class="comment">//数组长度如果很小（27），则直接用插入排序对其排序</span></span><br><span class="line">	<span class="keyword">if</span> (len &lt; <span class="number">27</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = left + <span class="number">1</span>; i &lt;= right; i++) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &gt; left &amp;&amp; a[j] &lt; a[j - <span class="number">1</span>]; j--) &#123;</span><br><span class="line">				swap(a, j, j - <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//取到位于1/div和div-1/div位置的点，并用他们来做轴</span></span><br><span class="line">	<span class="keyword">int</span> third = len / div;</span><br><span class="line">	<span class="keyword">int</span> m1 = left + third;</span><br><span class="line">	<span class="keyword">int</span> m2 = right - third;</span><br><span class="line">	<span class="keyword">if</span> (m1 &lt;= left) &#123;</span><br><span class="line">		m1 = left + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (m2 &gt;= right) &#123;</span><br><span class="line">		m2 = right - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//确保left是小的，right是大的</span></span><br><span class="line">	<span class="keyword">if</span> (a[m1] &lt; a[m2]) &#123;</span><br><span class="line">		swap(a, m1, left);</span><br><span class="line">		swap(a, m2, right);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		swap(a, m1, right);</span><br><span class="line">		swap(a, m2, left);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 两个轴</span></span><br><span class="line">	<span class="keyword">int</span> pivot1 = a[left];</span><br><span class="line">	<span class="keyword">int</span> pivot2 = a[right];</span><br><span class="line">	<span class="comment">// 代表比p1小和比p2大的两个指针</span></span><br><span class="line">	<span class="keyword">int</span> less = left + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> great = right - <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// 开始取出less到great之间的未知大小数据，与两个轴比较</span></span><br><span class="line">	<span class="comment">// 并且将数据放入正确的区域后调整各个指针</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> k = less; k &lt;= great; k++) &#123;</span><br><span class="line">		<span class="comment">//如果取出的数比p1小，那么直接到less左侧，并且less右移</span></span><br><span class="line">		<span class="keyword">if</span> (a[k] &lt; pivot1) &#123;</span><br><span class="line">			swap(a, k, less++);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">//如果取出的数比p2大，那么首先确定great左侧没有比p2大的数</span></span><br><span class="line">		<span class="comment">//然后与great位置的数字交换，great左移</span></span><br><span class="line">		<span class="comment">//此时，great交换的数字肯定是比p2小或者相等的（首先确定过）</span></span><br><span class="line">		<span class="comment">//那么此时再与p1相比，处理这个数的区间</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a[k] &gt; pivot2) &#123;</span><br><span class="line">			<span class="keyword">while</span> (k &lt; great &amp;&amp; a[great] &gt; pivot2) &#123;</span><br><span class="line">				great--;</span><br><span class="line">			&#125;</span><br><span class="line">			swap(a, k, great--);</span><br><span class="line">			<span class="keyword">if</span> (a[k] &lt; pivot1) &#123;</span><br><span class="line">				swap(a, k, less++);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//如果这个数比p1大但是比p2小，则不需要交换，只需将k指针右移</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//将p1与less左侧的第一个数交换</span></span><br><span class="line">	swap(a, less - <span class="number">1</span>, left);</span><br><span class="line">	<span class="comment">//将p2与great右侧的第一个数交换</span></span><br><span class="line">	swap(a, great + <span class="number">1</span>, right);</span><br><span class="line">	<span class="comment">// 计算出在两轴大小之间的个数</span></span><br><span class="line">	<span class="keyword">int</span> dist = great - less;</span><br><span class="line">	<span class="comment">//如果这个数很小（13），那么取轴的点向两边偏</span></span><br><span class="line">	<span class="keyword">if</span> (dist &lt; <span class="number">13</span>) &#123;</span><br><span class="line">		div++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 对三个子区间分别排序，因为less-1和great+1是轴，已经排好了序</span></span><br><span class="line">	<span class="comment">// 所以不需要比较</span></span><br><span class="line">	dualPivotQuicksort(a, left, less - <span class="number">2</span>, div);</span><br><span class="line">	dualPivotQuicksort(a, great + <span class="number">2</span>, right, div);</span><br><span class="line">	<span class="comment">// 如果在中间区间的数字很多，那么排除掉一些相等的元素再进行排序</span></span><br><span class="line">	<span class="keyword">if</span> (dist &gt; len - <span class="number">13</span> &amp;&amp; pivot1 != pivot2) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> k = less; k &lt;= great; k++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (a[k] == pivot1) &#123;</span><br><span class="line">				swap(a, k, less++);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (a[k] == pivot2) &#123;</span><br><span class="line">				swap(a, k, great--);</span><br><span class="line">				<span class="keyword">if</span> (a[k] == pivot1) &#123;</span><br><span class="line">					swap(a, k, less++);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 对中间的区间排序</span></span><br><span class="line">	<span class="keyword">if</span> (pivot1 &lt; pivot2) &#123;</span><br><span class="line">		dualPivotQuicksort(a, less, great, div);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Find the length of the longest consecutive elements sequence.</title>
    <url>/2019/01/01/Find%20the%20length%20of%20the%20longest/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-unsorted-array-of-integers-find-the-length-of-the-longest-consecutive-elements-sequence-Your-algorithm-should-run-in-O-n-complexity"><a href="#Given-an-unsorted-array-of-integers-find-the-length-of-the-longest-consecutive-elements-sequence-Your-algorithm-should-run-in-O-n-complexity" class="headerlink" title="Given an unsorted array of integers, find the length of the longest consecutive elements sequence.Your algorithm should run in O(n) complexity."></a>Given an unsorted array of integers, find the length of the longest consecutive elements sequence.Your algorithm should run in O(n) complexity.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">100</span>, <span class="number">4</span>, <span class="number">200</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>]</span><br><span class="line">Output: <span class="number">4</span></span><br><span class="line">Explanation: The longest consecutive elements sequence is [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]. Therefore its length is <span class="number">4</span>.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　一开始想通过计数排序，再统计最大连续长度。忽略题目未说是正数呀。遇到负数就炸了。用HashMap来存当前值处的连续区间长度。当插入一个数时，取出当前值前后的连续区间长度left，right。当前的区间长度 = left + right. + 1。.复杂问题优先考虑分治，拆成一个个小问题。假设左边已经是排好，右边已经排好。插入中间值，仅需将左侧长度+右侧长度+1即为整块区间长度。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestConsecutive</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> low, high, sum;</span><br><span class="line">        <span class="keyword">int</span> maxLength = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (map.containsKey(nums[i])) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            low = map.containsKey(nums[i] - <span class="number">1</span>) ? map.get(nums[i] - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">            high = map.containsKey(nums[i] + <span class="number">1</span>) ? map.get(nums[i] + <span class="number">1</span>) : <span class="number">0</span>;<span class="comment">//get both sides' consecutive information.</span></span><br><span class="line">            sum = low + high + <span class="number">1</span>;</span><br><span class="line">            maxLength = Math.max(maxLength, sum);</span><br><span class="line">            map.put(nums[i], sum);</span><br><span class="line">            map.put(nums[i] - low, sum);</span><br><span class="line">            map.put(nums[i] + high, sum);<span class="comment">//merge</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxLength;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The kth largest element</title>
    <url>/2019/01/01/The%20kth%20largest%20element/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Find-the-kth-largest-element-in-an-unsorted-array-Note-that-it-is-the-kth-largest-element-in-the-sorted-order-not-the-kth-distinct-element-You-may-assume-k-is-always-valid-1-≤-k-≤-array’s-length"><a href="#Find-the-kth-largest-element-in-an-unsorted-array-Note-that-it-is-the-kth-largest-element-in-the-sorted-order-not-the-kth-distinct-element-You-may-assume-k-is-always-valid-1-≤-k-≤-array’s-length" class="headerlink" title="Find the kth largest element in an unsorted array. Note that it is the kth largest element in the sorted order, not the kth distinct element.You may assume k is always valid, 1 ≤ k ≤ array’s length."></a>Find the kth largest element in an unsorted array. Note that it is the kth largest element in the sorted order, not the kth distinct element.You may assume k is always valid, 1 ≤ k ≤ array’s length.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>] and k = <span class="number">2</span></span><br><span class="line">Output: <span class="number">5</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: [<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>] and k = <span class="number">4</span></span><br><span class="line">Output: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　思路是利用快排找到第n.length - k个枢轴即可。疑惑的是，提交上去AC了但有些耗时（32组样例跑了40ms）。复杂度为O(n)。看了4msAC的代码。真的是太简单粗暴啦。直接调用库函数排序，再取第n.length - k个元素。我对这个算法的时间复杂度产生了疑问。考虑过排序再取但太过耗时。快排时间复杂度是O（nlogn）。所以JDK用的并非快排。源码中采取的是DualPivotQuicksort方法。具体分析放在下片博文里<a href="https://nightxlt.github.io/2019/01/01/DualPivotSort/" target="_blank" rel="noopener">dualpivotsort</a>。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pivot = nums[low];</span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        <span class="keyword">while</span> (low &lt; high &amp;&amp; nums[high] &gt;= pivot) &#123;</span><br><span class="line">            high--;</span><br><span class="line">        &#125;</span><br><span class="line">        nums[low] = nums[high];</span><br><span class="line">        <span class="keyword">while</span> (low &lt; high &amp;&amp; nums[low] &lt;= pivot) &#123;</span><br><span class="line">            low++;</span><br><span class="line">        &#125;</span><br><span class="line">        nums[high] = nums[low];</span><br><span class="line">    &#125;</span><br><span class="line">    nums[low] = pivot;</span><br><span class="line">    <span class="keyword">return</span> low;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = nums.length - k;</span><br><span class="line">    <span class="keyword">int</span> pivot = partition(nums, low, high);</span><br><span class="line">    <span class="keyword">if</span> (pivot == pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> nums[pivot];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pivot &gt; pos) &#123;</span><br><span class="line">        <span class="keyword">return</span> quickSort(nums, k, low, pivot - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> quickSort(nums, k, pivot + <span class="number">1</span>, high);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nums.length == <span class="number">1</span> &amp;&amp; k == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> quickSort(nums, k, <span class="number">0</span>, nums.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Searching Rotated array</title>
    <url>/2018/12/31/Searching%20Rotated%20array/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Suppose-an-array-sorted-in-ascending-order-is-rotated-at-some-pivot-unknown-to-you-beforehand"><a href="#Suppose-an-array-sorted-in-ascending-order-is-rotated-at-some-pivot-unknown-to-you-beforehand" class="headerlink" title="Suppose an array sorted in ascending order is rotated at some pivot unknown to you beforehand."></a>Suppose an array sorted in ascending order is rotated at some pivot unknown to you beforehand.</h3><h3 id="i-e-0-1-2-4-5-6-7-might-become-4-5-6-7-0-1-2-You-are-given-a-target-value-to-search-If-found-in-the-array-return-its-index-otherwise-return-1-You-may-assume-no-duplicate-exists-in-the-array-Your-algorithm’s-runtime-complexity-must-be-in-the-order-of-O-log-n"><a href="#i-e-0-1-2-4-5-6-7-might-become-4-5-6-7-0-1-2-You-are-given-a-target-value-to-search-If-found-in-the-array-return-its-index-otherwise-return-1-You-may-assume-no-duplicate-exists-in-the-array-Your-algorithm’s-runtime-complexity-must-be-in-the-order-of-O-log-n" class="headerlink" title="(i.e., [0,1,2,4,5,6,7] might become [4,5,6,7,0,1,2]).You are given a target value to search. If found in the array return its index, otherwise return -1.You may assume no duplicate exists in the array.Your algorithm’s runtime complexity must be in the order of O(log n)."></a>(i.e., [0,1,2,4,5,6,7] might become [4,5,6,7,0,1,2]).You are given a target value to search. If found in the array return its index, otherwise return -1.You may assume no duplicate exists in the array.Your algorithm’s runtime complexity must be in the order of O(log n).</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: nums = [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>], target = <span class="number">0</span></span><br><span class="line">Output:: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: nums = [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>], target = <span class="number">3</span></span><br><span class="line">Output: -<span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input: nums = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>], target = <span class="number">1</span></span><br><span class="line">Output: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p> 　　一开始看到这道题，做过同样的找最小值问题。以为是道水题。没想到坑的一P。卡了三个小时。在判断那翻来覆去。一开始想找到最小值。再判读target是在前半段还是后半段。再二分。时间复杂度是0（logn+logn）=O(logn) . 但是蜜汁超时。嗨呀然后就开始了反复挣扎的三小时if判断挣扎。修好了一个坑又出现另一个坑。看了解析恍然大悟。这道题和最小值无关。旋转数组有一个特性。最小值前旋转数组前是递增的，最小值后旋转数组是递增的。<br>　　如果中间的值比左端的值大，则左侧数组必然有序。<br> 　　如果中间的值比左端的值小，则右侧数组必然有序。 </p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> low = <span class="number">0</span>, high = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> mid;</span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">        mid = (low + high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nums[mid] &gt;= nums[low]) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &gt; target &amp;&amp; target &gt;= nums[low]) &#123;</span><br><span class="line">                high = mid - <span class="number">1</span>;<span class="comment">//Target is in the left which is order.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                low = mid + <span class="number">1</span>;<span class="comment">//Target is in the right which may be disorder.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt; target &amp;&amp; target &lt;= nums[high]) &#123;</span><br><span class="line">                low = mid + <span class="number">1</span>;<span class="comment">//Target is in the right which is order.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                high = mid - <span class="number">1</span>;<span class="comment">//Target is in the left which may be disorder.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>maxAreaOfIsland</title>
    <url>/2018/12/31/maxAreaOfIsland%20date/</url>
    <content><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><h3 id="Given-a-non-empty-2D-array-grid-of-0’s-and-1’s-an-island-is-a-group-of-1’s-representing-land-connected-4-directionally-horizontal-or-vertical-You-may-assume-all-four-edges-of-the-grid-are-surrounded-by-water-Find-the-maximum-area-of-an-island-in-the-given-2D-array-If-there-is-no-island-the-maximum-area-is-0"><a href="#Given-a-non-empty-2D-array-grid-of-0’s-and-1’s-an-island-is-a-group-of-1’s-representing-land-connected-4-directionally-horizontal-or-vertical-You-may-assume-all-four-edges-of-the-grid-are-surrounded-by-water-Find-the-maximum-area-of-an-island-in-the-given-2D-array-If-there-is-no-island-the-maximum-area-is-0" class="headerlink" title="Given a non-empty 2D array grid of 0’s and 1’s, an island is a group of 1’s (representing land) connected 4-directionally (horizontal or vertical.) You may assume all four edges of the grid are surrounded by water.Find the maximum area of an island in the given 2D array. (If there is no island, the maximum area is 0.)"></a>Given a non-empty 2D array grid of 0’s and 1’s, an island is a group of 1’s (representing land) connected 4-directionally (horizontal or vertical.) You may assume all four edges of the grid are surrounded by water.Find the maximum area of an island in the given 2D array. (If there is no island, the maximum area is 0.)</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: </span><br><span class="line">[[<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line"> [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">Output: <span class="number">6</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: </span><br><span class="line">[[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">Output: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input : &#123;<span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">           &#123;<span class="number">1</span>, <span class="number">1</span>&#125;</span><br><span class="line">Output: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　　　注意四个方向的DP，还有DFS中为了降低空间复杂度可以置现有的grid[i][j] = 0;时间复杂度O（mn）（m:岛屿个数，n节点数） ，空间复杂度O(1)</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxAreaOfIsland</span><span class="params">(<span class="keyword">int</span>[][] grid)</span> </span>&#123;                                                     </span><br><span class="line">     <span class="keyword">int</span> maxArea = <span class="number">0</span>;                                                                           </span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid.length; i++) &#123;                                                    </span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid[i].length; j++) &#123;                                             </span><br><span class="line">             <span class="keyword">if</span> (grid[i][j] != <span class="number">0</span>) &#123;                                                             </span><br><span class="line">                 maxArea = Math.max(maxArea, DFS(grid, i, j));                                  </span><br><span class="line">             &#125;                                                                                  </span><br><span class="line">         &#125;                                                                                      </span><br><span class="line">     &#125;                                                                                          </span><br><span class="line">     <span class="keyword">return</span> maxArea;                                                                            </span><br><span class="line"> &#125;                                                                                              </span><br><span class="line">                                                                                                </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span>[][] grid, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;                                                   </span><br><span class="line">     <span class="keyword">if</span> (i &gt;= <span class="number">0</span> &amp;&amp; i &lt; grid.length &amp;&amp; j &gt;= <span class="number">0</span> &amp;&amp; j &lt; grid[i].length &amp;&amp; grid[i][j] != <span class="number">0</span>) &#123;        </span><br><span class="line">         grid[i][j] = <span class="number">0</span>;                                                                        </span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span> + DFS(grid, i + <span class="number">1</span>, j) + DFS(grid, i - <span class="number">1</span>, j) + DFS(grid, i, j - <span class="number">1</span>) + DFS(grid, i, j+<span class="number">1</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;                                                                                  </span><br><span class="line"> &#125;                                                                                              </span><br><span class="line">                                                                                                  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Restore  IP address</title>
    <url>/2018/12/30/Restore%20%20IP%20address/</url>
    <content><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><h3 id="Given-a-string-containing-only-digits-restore-it-by-returning-all-possible-valid-IP-address-combinations"><a href="#Given-a-string-containing-only-digits-restore-it-by-returning-all-possible-valid-IP-address-combinations" class="headerlink" title="Given a string containing only digits, restore it by returning all possible valid IP address combinations."></a>Given a string containing only digits, restore it by returning all possible valid IP address combinations.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="string">"25525511135"</span></span><br><span class="line">Output: [<span class="string">"255.255.11.135"</span>, <span class="string">"255.255.111.35"</span>]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　直接暴力DP<br>　　两点：<br> 　　　　1. 每个节点不能超过255<br> 　　　　2. substring（i, j）, j是取不到的<br> 　　　　3. 不允许出现以0为首长度&gt;1的IP地址，即使是03</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">restoreIpAddresses</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = s.length();</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        String s1, s2, s3, s4;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">4</span> &amp;&amp; i &lt; length - <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; i + <span class="number">4</span> &amp;&amp; j &lt; length - <span class="number">1</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = j + <span class="number">1</span>; k &lt; j + <span class="number">4</span> &amp;&amp; k &lt; length; k++) &#123;</span><br><span class="line">                    s1 = s.substring(<span class="number">0</span>, i);</span><br><span class="line">                    s2 = s.substring(i, j);</span><br><span class="line">                    s3 = s.substring(j, k);</span><br><span class="line">                    s4 = s.substring(k, length);</span><br><span class="line">                    <span class="keyword">if</span> (isValid(s1) &amp;&amp; isValid(s2) &amp;&amp; isValid(s3) &amp;&amp; isValid(s4)) &#123;</span><br><span class="line">                        s1 = s1 + <span class="string">'.'</span> + s2 + <span class="string">'.'</span> + s3 + <span class="string">'.'</span> + s4;</span><br><span class="line">                        list.add(s1);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = s.length();</span><br><span class="line">        <span class="keyword">if</span> (length &gt; <span class="number">3</span> || length == <span class="number">0</span> || Integer.parseInt(s) &gt; <span class="number">255</span> || (s.charAt(<span class="number">0</span>) == <span class="string">'0'</span> &amp;&amp; length &gt; <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Simplify path</title>
    <url>/2018/12/30/Simplify%20path/</url>
    <content><![CDATA[<h2 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h2><h3 id="Given-an-absolute-path-for-a-file-Unix-style-simplify-it"><a href="#Given-an-absolute-path-for-a-file-Unix-style-simplify-it" class="headerlink" title="Given an absolute path for a file (Unix-style), simplify it."></a>Given an absolute path for a file (Unix-style), simplify it.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input ： <span class="string">"/home/"</span></span><br><span class="line">Output ： “/home”</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input ： <span class="string">"/a/../../b/../c//.//"</span></span><br><span class="line">Output ： “/c”</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input ： <span class="string">"/a/./b/../../c/"</span></span><br><span class="line">Output ： “/c”</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>　　边界情况考虑好，当为/../，即已经访问到根目录时，再往前是无法访问的。返回“/”</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">simplifyPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        String[] strings = path.split(<span class="string">"/"</span>, <span class="number">0</span>);</span><br><span class="line">        Stack&lt;String&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; strings.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( <span class="string">"."</span>.equals(strings[i]) || <span class="string">""</span>.equals(strings[i])) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">".."</span>.equals(strings[i])) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!stack.empty()) &#123;</span><br><span class="line">                    stack.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stack.push(strings[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">            sb.insert(<span class="number">0</span>, stack.pop());</span><br><span class="line">            sb.insert(<span class="number">0</span>, <span class="string">'/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sb.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(<span class="string">'/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The sum of three elements is zero</title>
    <url>/2018/12/30/The%20sum%20of%20three%20elements%20is%20zero/</url>
    <content><![CDATA[<h2 id="Problem-Description"><a href="#Problem-Description" class="headerlink" title="Problem Description"></a>Problem Description</h2><h3 id="Given-an-array-nums-of-n-integers-are-there-elements-a-b-c-in-nums-such-that-a-b-c-0-Find-all-unique-triplets-in-the-array-which-gives-the-sum-of-zero"><a href="#Given-an-array-nums-of-n-integers-are-there-elements-a-b-c-in-nums-such-that-a-b-c-0-Find-all-unique-triplets-in-the-array-which-gives-the-sum-of-zero" class="headerlink" title="Given an array nums of n integers, are there elements a, b, c in nums such that a + b + c = 0? Find all unique triplets in the array which gives the sum of zero."></a>Given an array nums of n integers, are there elements a, b, c in nums such that a + b + c = 0? Find all unique triplets in the array which gives the sum of zero.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:[-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">4</span>]</span><br><span class="line">Output:[  [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>],[-<span class="number">1</span>, -<span class="number">1</span>, <span class="number">2</span>]]</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>   一开始，思路是   for i=0 to n/2,         for j=n-1，再在内层循环内用二分查找判断三个元素是否等于0。出现重复元素，且有遗漏的情况。为了防止遗漏，for i = 0 to n-2;  j = i + 1;(防止重复)，k = n - 1.<br>   若 nums[i] + nums[j] + nums[k] &gt; 0，说明k取大了，k–;<br>   若 nums[i] + nums[j] + nums[k] &lt; 0，说明k取小了，k++;<br>   若nums[i] + nums[j] + nums[k] = 0，将三个数加入集合，再防止重复。降低时间复杂度。</p>
<p>   一个关于Java长久的坑。存在两个listA,listB集合。 listA.add(listB); listB.clear();这样刚刚添加到listA的集合也会为空。不能clear()。为防止数据叠加。每次new listB()即可。 Android曾遇到同样问题。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; threeSum(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line"></span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; lists = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> j, k, sum;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length - <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; nums[i] == nums[i - <span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j = i + <span class="number">1</span>;</span><br><span class="line">        k = nums.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; k) &#123;</span><br><span class="line">            sum = nums[i] + nums[j] + nums[k];</span><br><span class="line">            <span class="keyword">if</span> (sum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                k--;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sum &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                j++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;Integer&gt; integers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                integers.add(nums[i]);</span><br><span class="line">                integers.add(nums[j]);</span><br><span class="line">                integers.add(nums[k]);</span><br><span class="line">                lists.add(integers);</span><br><span class="line">                <span class="keyword">while</span> (j &lt; k &amp;&amp; nums[j + <span class="number">1</span>] == nums[j]) &#123;</span><br><span class="line">                    j++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (j &lt; k &amp;&amp; nums[k - <span class="number">1</span>] == nums[k]) &#123;</span><br><span class="line">                    k--;</span><br><span class="line">                &#125;</span><br><span class="line">                j++;</span><br><span class="line">                k--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lists;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Reverse the string</title>
    <url>/2018/12/29/Reverse%20the%20string%20word%20by%20word/</url>
    <content><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><h3 id="Given-an-input-string-reverse-the-string-word-by-word-A-word-is-defined-as-a-sequence-of-non-space-characters-Input-string-may-contain-leading-or-trailing-spaces-However-your-reversed-string-should-not-contain-leading-or-trailing-spaces-You-need-to-reduce-multiple-spaces-between-two-words-to-a-single-space-in-the-reversed-string"><a href="#Given-an-input-string-reverse-the-string-word-by-word-A-word-is-defined-as-a-sequence-of-non-space-characters-Input-string-may-contain-leading-or-trailing-spaces-However-your-reversed-string-should-not-contain-leading-or-trailing-spaces-You-need-to-reduce-multiple-spaces-between-two-words-to-a-single-space-in-the-reversed-string" class="headerlink" title="Given an input string, reverse the string word by word.A word is defined as a sequence of non-space characters.Input string may contain leading or trailing spaces. However, your reversed string should not contain leading or trailing spaces.You need to reduce multiple spaces between two words to a single space in the reversed string."></a>Given an input string, reverse the string word by word.A word is defined as a sequence of non-space characters.Input string may contain leading or trailing spaces. However, your reversed string should not contain leading or trailing spaces.You need to reduce multiple spaces between two words to a single space in the reversed string.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: <span class="string">"the sky is blue"</span>,</span><br><span class="line">Output: <span class="string">"blue is sky the"</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: <span class="string">""</span>,</span><br><span class="line">Output: <span class="string">""</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input: <span class="string">"   "</span>,</span><br><span class="line">Output: <span class="string">""</span>.</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>  思路是以“ ”作为分隔符，再通过流转换消去所有“”，但这样太过耗时，总共跑了70ms，可以尝试通过拼接字符串的方式降低时间复杂度。<br>  还有个Split坑，以前用都没感觉到，这次空格数多了发现和预期有差异。进入Split源码<br> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> resultSize = list.size();</span><br><span class="line">           <span class="keyword">if</span> (limit == <span class="number">0</span>) &#123;<span class="comment">//controls the number of times the pattern is applied  </span></span><br><span class="line">		<span class="comment">// limit = n :  The pattern is applied n-1 times,limit = 0 :the pattern will be applied as many times as possible</span></span><br><span class="line">               <span class="keyword">while</span> (resultSize &gt; <span class="number">0</span> &amp;&amp; list.get(resultSize - <span class="number">1</span>).length() == <span class="number">0</span>) &#123;</span><br><span class="line">                   resultSize--;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">		String[] result = <span class="keyword">new</span> String[resultSize];</span><br><span class="line">           <span class="keyword">return</span> list.subList(<span class="number">0</span>, resultSize).toArray(result);</span><br></pre></td></tr></table></figure></p>
<p>   默认调用的split（regex）,它会调用split(regex,0).所以在list末尾处若出现 “”，就将ressultSize–;最后再截取list返回array。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">reverseWords</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">null</span> == s || s.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       String[] strings = s.split(<span class="string">" "</span>,-<span class="number">1</span>);<span class="comment">//全部split,不进行尾处理</span></span><br><span class="line">       StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = strings.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">           s = strings[i].trim();</span><br><span class="line">           <span class="keyword">if</span>(s.length() &gt; <span class="number">0</span>) sb.append(<span class="string">' '</span>);</span><br><span class="line">           sb.append(s);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> sb.toString().trim();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The permutation of string</title>
    <url>/2018/12/28/The%20permutation%20of%20string/</url>
    <content><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><h3 id="Given-two-strings-s1-and-s2-write-a-function-to-return-true-if-s2-contains-the-permutation-of-s1-In-other-words-one-of-the-first-string’s-permutations-is-the-substring-of-the-second-string"><a href="#Given-two-strings-s1-and-s2-write-a-function-to-return-true-if-s2-contains-the-permutation-of-s1-In-other-words-one-of-the-first-string’s-permutations-is-the-substring-of-the-second-string" class="headerlink" title="Given two strings s1 and s2, write a function to return true if s2 contains the permutation of s1. In other words, one of the first string’s permutations is the substring of the second string."></a>Given two strings s1 and s2, write a function to return true if s2 contains the permutation of s1. In other words, one of the first string’s permutations is the substring of the second string.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input:s1 = <span class="string">"ab"</span> s2 = <span class="string">"eidbaooo"</span></span><br><span class="line">Output:True</span><br><span class="line">Explanation: <span class="function">s2 contains one permutation of <span class="title">s1</span> <span class="params">(<span class="string">"ba"</span>)</span>.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input:s1= <span class="string">"ab"</span> s2 = <span class="string">"eidboaoo"</span></span><br><span class="line">Output: False</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input:s1= <span class="string">"abc"</span> s2 = <span class="string">"abdc"</span></span><br><span class="line">Output: True</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ol>
<li><p>一开始找不到排列和子序列的对应关系；可以通过记录两个字符串中字符出现次数countS1[],countS2[]来比较，但这样会引入一个问题可能两个子序列出现次数相等，然而出现次序不一致。为了解决这一问题，在此思路上引入滑动窗口（没错，就是计网中的流量控制中的滑动窗口协议）。</p>
</li>
<li><p>在本题中令countS2[]作为发送窗口，countS1[]作为接收窗口。先比较前s1的长度len1内的元素，再循环比较剩余s2的长度len2-len1个元素。总共比较次数len2-len1+1次。但这样写的话循环内需要加一层判断当前发送窗口是否越界，增加了时间复杂度。</p>
</li>
<li><p>可优化为先单独长度为len1的元素判断。循环（接收窗口滑动一个单位，再判断是否相等），这时第i个字符小时， i + len1个字符出现。 直至比较完毕或出现不等退出循环。这样比较剩余元素可确保发送窗口不会越界。（执行顺序注意下）切记<strong>循环内套if要三思啊，炒鸡炒鸡炒鸡耗时的。</strong></p>
</li>
</ol>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//an effective algorithm</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkInclusion</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len1 = s1.length();</span><br><span class="line">        <span class="keyword">int</span> len2 = s2.length();</span><br><span class="line">        <span class="keyword">if</span> (len1 &gt; len2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> countS1[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">int</span> countS2[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len1; i++) &#123;</span><br><span class="line">            countS1[s1.charAt(i) - <span class="string">'a'</span>]++;</span><br><span class="line">            countS2[s2.charAt(i) - <span class="string">'a'</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isEquals(countS1, countS2))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len2 - len1; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//sliding window</span></span><br><span class="line">            countS2[s2.charAt(i) - <span class="string">'a'</span>]--;</span><br><span class="line">            countS2[s2.charAt(i + len1) - <span class="string">'a'</span>]++;</span><br><span class="line">            <span class="keyword">if</span> (isEquals(countS1, countS2))<span class="comment">//Judging after sliding</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEquals</span><span class="params">(<span class="keyword">int</span> c1[], <span class="keyword">int</span> c2[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; c1.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c1[i] != c2[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//a relative slower algorithm</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkInclusion</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len1 = s1.length();</span><br><span class="line">        <span class="keyword">int</span> len2 = s2.length();</span><br><span class="line">        <span class="keyword">if</span> (len1 &gt; len2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> countS1[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">int</span> countS2[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len1; i++) &#123;</span><br><span class="line">            countS1[s1.charAt(i) - <span class="string">'a'</span>]++;</span><br><span class="line">            countS2[s2.charAt(i) - <span class="string">'a'</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len2 - len1 + <span class="number">1</span>; i++) &#123;</span><br><span class="line">  			 <span class="keyword">if</span> (isEquals(countS1, countS2))<span class="comment">//Judging after sliding</span></span><br><span class="line">               	 	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//sliding window</span></span><br><span class="line">			<span class="keyword">if</span>(i&lt; len2 - len1)&#123;</span><br><span class="line">			 	 countS2[s2.charAt(i) - <span class="string">'a'</span>]--;</span><br><span class="line">                 countS2[s2.charAt(i + len1) - <span class="string">'a'</span>]++;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEquals</span><span class="params">(<span class="keyword">int</span> c1[], <span class="keyword">int</span> c2[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; c1.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c1[i] != c2[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The longest common prefix string</title>
    <url>/2018/12/27/LongestCommonPrefix/</url>
    <content><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><h3 id="Write-a-function-to-find-the-longest-common-prefix-string-amongst-an-array-of-strings-If-there-is-no-common-prefix-return-an-empty-string-“”"><a href="#Write-a-function-to-find-the-longest-common-prefix-string-amongst-an-array-of-strings-If-there-is-no-common-prefix-return-an-empty-string-“”" class="headerlink" title="Write a function to find the longest common prefix string amongst an array of strings.If there is no common prefix, return an empty string “”."></a>Write a function to find the longest common prefix string amongst an array of strings.If there is no common prefix, return an empty string “”.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">Input: [<span class="string">"flower"</span>,<span class="string">"flow"</span>,<span class="string">"flight"</span>]</span><br><span class="line">Output: <span class="string">"fl"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line">Input: [<span class="string">"dog"</span>,<span class="string">"racecar"</span>,<span class="string">"car"</span>]</span><br><span class="line">Output: <span class="string">""</span></span><br><span class="line">Explanation: There is no common prefix among the input strings.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line">Input: [<span class="string">"aa"</span>,<span class="string">"a"</span>]</span><br><span class="line">Output: <span class="string">"a"</span></span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p> 个人思路是先比较出头两个字符串的最长公共前缀longestCommonPrefix，如果为零，则直接返回 “”，否则将longestCommonPrefix与剩余字符串比较直至longestCommonPrefix为空或与其余字符串比较完毕。想法是不错，写到一半就一百行代码啦！！！<br> 嗨呀，感觉方法有问题。横向比较行不通转成纵向比较。因为strs可看为一个二维数组。以第一行为参照，逐行比较同列元素直至一列中出现不相等情况退出循环。<front color="#00923"><strong>值得注意的Example3的情况，若第一行元素并非strs最短字符串时需要防止访问字符串越界</strong></front></p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span>  String <span class="title">longestCommonPrefix</span><span class="params">(String[] strs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (strs.length == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">char</span> c;</span><br><span class="line">     <span class="keyword">int</span> rowLength;</span><br><span class="line">     <span class="keyword">int</span> length = strs[<span class="number">0</span>].length();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">         c = strs[<span class="number">0</span>].charAt(i);<span class="comment">//c:第0行i列字符</span></span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; strs.length; j++) &#123;</span><br><span class="line">             rowLength = strs[j].length();</span><br><span class="line">             <span class="keyword">if</span> (i == rowLength || c != strs[j].charAt(i)) &#123;<span class="comment">//i == rowLength: secure  IndexInOfBounds</span></span><br><span class="line">                 <span class="keyword">return</span> strs[<span class="number">0</span>].substring(<span class="number">0</span>, i);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> strs[<span class="number">0</span>];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>The longest substring without repeating characters.</title>
    <url>/2018/12/24/LongestSubString/</url>
    <content><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><h3 id="Given-a-string-find-the-length-of-the-longest-substring-without-repeating-characters"><a href="#Given-a-string-find-the-length-of-the-longest-substring-without-repeating-characters" class="headerlink" title="Given a string, find the length of the longest substring without repeating characters."></a>Given a string, find the length of the longest substring without repeating characters.</h3><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">Input: <span class="string">"abcabcbb"</span> </span><br><span class="line">Output: <span class="number">3</span></span><br><span class="line">Explanation: The answer is <span class="string">"abc"</span>, with the length of <span class="number">3</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">Input: <span class="string">"bbbbb"</span></span><br><span class="line">Output: <span class="number">1</span></span><br><span class="line">Explanation: The answer is <span class="string">"b"</span>, with the length of <span class="number">1</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Example <span class="number">3</span>:</span><br><span class="line"></span><br><span class="line">Input: <span class="string">"pwwkew"</span></span><br><span class="line">Output: <span class="number">3</span> Explanation: </span><br><span class="line">The answer is <span class="string">"wke"</span>, with the length of <span class="number">3</span>. Note that the answer must</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>首先自己意识到了用HashSet进行添加非重复元素，但出现元素重复时应该删除哪一个却不确定。当出现重复元素时画图分析可知，当前记录String的leftIndex至rightIndex区间内子序列可能并非最长，这时应删除l当前leftIndex所指向元素。让leftIndex++,重新开始计算。</p>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> lIndex = <span class="number">0</span>, rIndex = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> n = s.length();</span><br><span class="line">      Set&lt;Character&gt; characterSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">      <span class="keyword">int</span> maxSubStringLength = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (rIndex &lt; n &amp;&amp; lIndex &lt; n) &#123;</span><br><span class="line">          <span class="keyword">char</span> c = s.charAt(rIndex);</span><br><span class="line">          <span class="keyword">if</span> (!characterSet.contains(c)) &#123;</span><br><span class="line">              characterSet.add(c);</span><br><span class="line">              rIndex++;</span><br><span class="line">              maxSubStringLength = Math.max(maxSubStringLength, rIndex - lIndex);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              characterSet.remove(s.charAt(lIndex++));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> maxSubStringLength;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>Leetcode</tag>
        <tag>字节跳动</tag>
      </tags>
  </entry>
  <entry>
    <title>Github Gist入坑</title>
    <url>/2018/05/12/Github%20Gist/</url>
    <content><![CDATA[<h2 id="github-gist简介"><a href="#github-gist简介" class="headerlink" title="github gist简介"></a>github gist简介</h2><h3 id="gist是基于版本控制的共享链接。再也不用打开qq收文件啦-而且最良心的还是竟然还支持私有，天，git仓库都还要付费的。。。"><a href="#gist是基于版本控制的共享链接。再也不用打开qq收文件啦-而且最良心的还是竟然还支持私有，天，git仓库都还要付费的。。。" class="headerlink" title="gist是基于版本控制的共享链接。再也不用打开qq收文件啦 ~ _ ~,而且最良心的还是竟然还支持私有，天，git仓库都还要付费的。。。"></a>gist是基于版本控制的共享链接。再也不用打开qq收文件啦 ~ _ ~,而且最良心的还是竟然还支持私有，天，git仓库都还要付费的。。。</h3><h2 id="gist生成步骤"><a href="#gist生成步骤" class="headerlink" title="gist生成步骤"></a>gist生成步骤</h2><h4 id="1-创建一个git仓库"><a href="#1-创建一个git仓库" class="headerlink" title="1. 创建一个git仓库"></a>1. 创建一个git仓库</h4><h4 id="2-在git仓库下的代码或输出日志，待处理任务等上右键Create-Gist"><a href="#2-在git仓库下的代码或输出日志，待处理任务等上右键Create-Gist" class="headerlink" title="2. 在git仓库下的代码或输出日志，待处理任务等上右键Create_Gist"></a>2. 在git仓库下的代码或输出日志，待处理任务等上右键Create_Gist</h4><p> <img src="/images/1.png" alt="android_gist"></p>
<h4 id="3-配置gist属性即可"><a href="#3-配置gist属性即可" class="headerlink" title="3. 配置gist属性即可"></a>3. 配置gist属性即可</h4><h4 id="4-登录github或输入Token"><a href="#4-登录github或输入Token" class="headerlink" title="4. 登录github或输入Token"></a>4. 登录github或输入Token</h4><p> <img src="/images/2.png" alt="enter description here"></p>
<h4 id="5-共享友链给你的朋友"><a href="#5-共享友链给你的朋友" class="headerlink" title="5. 共享友链给你的朋友"></a>5. 共享友链给你的朋友</h4>]]></content>
      <categories>
        <category>skills</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Http缓存</title>
    <url>/2018/03/23/Http%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<p>转自<a href="https://www.cnblogs.com/chenqf/p/6386163.html" target="_blank" rel="noopener">reference_link</a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>Q:Http的所有请求都会到服务器吗？<br>A:不会，当缓存策略采取了强制缓存时，会直接从本地内存中读取</p>
<p>HTTP报文就是浏览器和服务器间通信时发送及响应的数据块。<br>浏览器向服务器请求数据，发送请求(request)报文；服务器向浏览器返回数据，返回响应(response)报文。<br>报文信息主要分为两部分<br>1.包含属性的首部(header)————————–附加信息（cookie，缓存信息等）与缓存相关的规则信息，均包含在header中<br>2.包含数据的主体部分(body)———————–HTTP请求真正想要传输的部分</p>
<h2 id="缓存规则"><a href="#缓存规则" class="headerlink" title="缓存规则"></a>缓存规则</h2><p>为方便理解，假设浏览器存在一个缓存数据库,用于存储缓存信息。（实则并不存在，以本地缓存形式存在）<br>在客户端第一次请求数据时，此时缓存数据库中没有对应的缓存数据，需要请求服务器，服务器返回后，将数据存储至缓存数据库中。<br><img src="/images/first_request.png" alt="first_request"></p>
<p>HTTP缓存有多种规则，根据是否需要重新向服务器发起请求来分类，将其分为两大类—<code>强制缓存，对比缓存</code></p>
<h3 id="强制缓存"><a href="#强制缓存" class="headerlink" title="强制缓存"></a>强制缓存</h3><p>已存在缓存数据时，仅基于强制缓存，请求数据的流程如下<br><img src="/images/force_cache.PNG" alt="force_cache"><br>强制缓存，在缓存数据未失效的情况下，可以直接使用缓存数据，那么浏览器是如何判断缓存数据是否失效呢？<br>我们知道，在没有缓存数据的时候，浏览器向服务器请求数据时，服务器会将数据和缓存规则一并返回，缓存规则信息包含在response的header中。<br>对于强制缓存来说，响应header中会有两个字段来标明失效规则（Expires/Cache-Control）<br>Expires 一般会放在响应头中，表示过期时间<br>Expires: Thu, 12 Jan 2017 11:01:33 GMT<br>Cache-Control 表示缓存的时间 max-age = 60 表示可以缓存 60s</p>
<p>　Expires的值为服务端返回的到期时间，即下一次请求时，请求时间小于服务端返回的到期时间，直接使用缓存数据。<br>不过Expires 是HTTP 1.0的东西，现在默认浏览器均默认使用HTTP 1.1，所以它的作用基本忽略。因为到期时间是由服务端生成的，但是客户端时间可能跟服务端时间有误差，这就会导致缓存命中的误差。<br>所以HTTP 1.1 的版本，使用Cache-Control替代。</p>
<h3 id="对比缓存"><a href="#对比缓存" class="headerlink" title="对比缓存"></a>对比缓存</h3><p>对比缓存，顾名思义，需要进行比较判断是否可以使用缓存。<br><img src="/images/compare_cache.PNG" alt="compare_cache"><br>浏览器第一次请求数据时，服务器会将缓存标识与数据一起返回给客户端，客户端将二者备份至缓存数据库中。<br>再次请求数据时，客户端将备份的缓存标识发送给服务器，服务器根据缓存标识进行判断，缓存未失效的情况下，返回304状态码，通知客户端比较成功，可以使用缓存数据。缓存失效，则返回最新数据和缓存规则。那服务器是如何判断缓存失效呢？<br>对于对比缓存来说，缓存标识的传递是我们着重需要理解的，它在请求header和响应header间进行传递，<br>一共分为两种标识传递，接下来，我们分开介绍。</p>
<h4 id="E-Tag-If-None-Match-（优先级高于Last-Modified-If-Modified-Since）"><a href="#E-Tag-If-None-Match-（优先级高于Last-Modified-If-Modified-Since）" class="headerlink" title="E-Tag / If-None-Match （优先级高于Last-Modified  /  If-Modified-Since）"></a>E-Tag / If-None-Match （优先级高于Last-Modified  /  If-Modified-Since）</h4><p> E-Tag 表示服务器返回的一个资源标识，下次客户端请求时将该值作为 key 为 If-None-Match 的值传给服务器判断，如果ETag没改变，则返回状态304；否则返回最新的数据与缓存规则。</p>
<h4 id="Last-Modified-if-Modified-since"><a href="#Last-Modified-if-Modified-since" class="headerlink" title="Last-Modified / if-Modified-since"></a>Last-Modified / if-Modified-since</h4><p>Last-Modified  在浏览器第一次请求某一个URL时，服务器端的返回状态会是200，内容是你请求的资源，同时有一个Last-Modified的属性标记此文件在服务期端最后被修改的时间，格式类似这样：Last-Modified:Tue, 24 Feb 2009 08:01:04 GMT，第二次请求浏览器会向服务器传送If-Modified-Since，询问该时间之后文件是否有被修改过，如果资源没有变化，则自动返回HTTP304状态码，内容为空，这样就节省了传输数据量；否则返回最新的数据与缓存规则。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>强制缓存如果生效，不需要再和服务器发生交互，而对比缓存不管是否生效，都需要与服务端发生交互。<br>两类缓存规则可以同时存在，强制缓存优先级高于对比缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行对比缓存规则。<br>对于强制缓存，服务器通知浏览器一个缓存时间，在缓存时间内，下次请求，直接用缓存，不在时间内，执行比较缓存策略。<br>对于比较缓存，将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，返回304状态码时，浏览器直接使用缓存。<br>流程如下：<br><img src="/images/browser_request_again.png" alt="browser_request_again"></p>
]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>缓存</tag>
      </tags>
  </entry>
  <entry>
    <title>OKHttp源码</title>
    <url>/2018/03/23/OKHttp%E6%BA%90%E7%A0%81/</url>
    <content><![CDATA[<p>参考自：<a href="https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html" target="_blank" rel="noopener">okhttp解析</a></p>
<h2 id="OkHttp源码分析"><a href="#OkHttp源码分析" class="headerlink" title="OkHttp源码分析"></a>OkHttp源码分析</h2><p><img src="/images/okhttp_full_process.png" alt="enter description here"><br>首先放一张完整流程图与样例<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//demo</span></span><br><span class="line"><span class="comment">//sync</span></span><br><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line"><span class="function">String <span class="title">run</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(url)</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> (Response response = client.newCall(request).execute()) &#123;</span><br><span class="line">    <span class="keyword">return</span> response.body().string();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//async</span></span><br><span class="line">client.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(response.body().string());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="创建OkHttpClient对象"><a href="#创建OkHttpClient对象" class="headerlink" title="创建OkHttpClient对象"></a>创建OkHttpClient对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br></pre></td></tr></table></figure>
<p>进入构造方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(<span class="keyword">new</span> Builder());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  dispatcher = <span class="keyword">new</span> Dispatcher();</span><br><span class="line">  protocols = DEFAULT_PROTOCOLS;</span><br><span class="line">  connectionSpecs = DEFAULT_CONNECTION_SPECS;</span><br><span class="line">  proxySelector = ProxySelector.getDefault();</span><br><span class="line">  cookieJar = CookieJar.NO_COOKIES;</span><br><span class="line">  socketFactory = SocketFactory.getDefault();</span><br><span class="line">  hostnameVerifier = OkHostnameVerifier.INSTANCE;</span><br><span class="line">  certificatePinner = CertificatePinner.DEFAULT;</span><br><span class="line">  proxyAuthenticator = Authenticator.NONE;</span><br><span class="line">  authenticator = Authenticator.NONE;</span><br><span class="line">  connectionPool = <span class="keyword">new</span> ConnectionPool();</span><br><span class="line">  dns = Dns.SYSTEM;</span><br><span class="line">  followSslRedirects = <span class="keyword">true</span>;</span><br><span class="line">  followRedirects = <span class="keyword">true</span>;</span><br><span class="line">  retryOnConnectionFailure = <span class="keyword">true</span>;</span><br><span class="line">  connectTimeout = <span class="number">10_000</span>;</span><br><span class="line">  readTimeout = <span class="number">10_000</span>;</span><br><span class="line">  writeTimeout = <span class="number">10_000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里采用了建造者模式，动态添加对象属性，提高代码可读性。 </p>
<h3 id="发起Http请求"><a href="#发起Http请求" class="headerlink" title="发起Http请求"></a>发起Http请求</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">String <span class="title">run</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">      .url(url)</span><br><span class="line">      .build();</span><br><span class="line">  Response response = client.newCall(request).execute();</span><br><span class="line">  <span class="keyword">return</span> response.body().string();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OkHttpClient实现了Call.Factory，负责根据请求创建新的Call。进入newCall<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Prepares the &#123;<span class="doctag">@code</span> request&#125; to be executed at some point in the future.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RealCall(<span class="keyword">this</span>, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入RealCall</p>
<h3 id="同步网络请求"><a href="#同步网络请求" class="headerlink" title="同步网络请求"></a>同步网络请求</h3><p>RealCall<code>execute()</code><br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);  <span class="comment">// (1)</span></span><br><span class="line">    executed = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    client.dispatcher().executed(<span class="keyword">this</span>);                                 <span class="comment">// (2)</span></span><br><span class="line">    Response result = getResponseWithInterceptorChain();                <span class="comment">// (3)</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    client.dispatcher().finished(<span class="keyword">this</span>);                                 <span class="comment">// (4)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>检查这个 call 是否已经被执行了，每个 call 只能被执行一次，如果想要一个完全一样的 call，可以利用call#clone方法进行克隆。</li>
<li>利用client.dispatcher().executed(this)来进行实际执行dispatcher是刚才看到的OkHttpClient.Builder的成员之一，文档说自己是异步 HTTP 请求的执行策略，现在看来，同步请求它也有掺和。</li>
<li>调用getResponseWithInterceptorChain()函数获取 HTTP 返回结果，从函数名可以看出，这一步还会进行一系列“拦截”操作。</li>
<li>最后还要通知dispatcher自己已经执行完毕。</li>
</ol>
<p>dispatcher 这里我们不过度关注，在同步执行的流程中，涉及到 dispatcher 的内容只不过是告知它我们的执行状态，比如开始执行了（调用executed），比如执行完毕了（调用finished），在异步执行流程中它会有更多的参与。</p>
<p>真正发出网络请求，解析返回结果的，还是getResponseWithInterceptorChain：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Response <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">  List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  interceptors.addAll(client.interceptors());</span><br><span class="line">  interceptors.add(retryAndFollowUpInterceptor);</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> ConnectInterceptor(client));</span><br><span class="line">  <span class="keyword">if</span> (!retryAndFollowUpInterceptor.isForWebSocket()) &#123;</span><br><span class="line">    interceptors.addAll(client.networkInterceptors());</span><br><span class="line">  &#125;</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> CallServerInterceptor(</span><br><span class="line">      retryAndFollowUpInterceptor.isForWebSocket()));</span><br><span class="line">  Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(</span><br><span class="line">      interceptors, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, originalRequest);</span><br><span class="line">  <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>the whole thing is just a stack of built-in interceptors.</p>
</blockquote>
<p><code>Interceptor</code>是 OkHttp 最核心的一个东西，不要误以为它只负责拦截请求进行一些额外的处理（例如 cookie），<strong>实际上它把实际的网络请求、缓存、透明压缩等功能都统一了起来</strong>，<code>每一个功能都只是一个Interceptor</code>，它们再连接成一个<code>Interceptor.Chain</code>，如链条一般,环环相扣，最终圆满完成一次网络请求。关于责任链模式在下一篇博文有详细阐述。</p>
<p>从<code>getResponseWithInterceptorChain</code>函数我们可以看到<code>Interceptor.Chain</code>的分布依次是：<br><img src="/images/okhttp_interceptors.png" alt="okhttp_interceptors"></p>
<ol>
<li>配置<code>OkHttpClient</code>时设置的<code>interceptors</code>；</li>
<li>负责失败重试以及重定向的<code>RetryAndFollowUpInterceptor</code>；</li>
<li>负责把用户构造的请求转换为发送到服务器的请求、把服务器返回的响应转换为用户友好的响应的<code>BridgeInterceptor</code>；</li>
<li>负责读取缓存直接返回、更新缓存的<code>CacheInterceptor</code>；</li>
<li>负责和服务器建立连接的<code>ConnectInterceptor</code>；</li>
<li>配置<code>OkHttpClient</code>时设置的<code>networkInterceptors</code>, interceptors that observe a single network request and response.</li>
<li>负责向服务器发送请求数据、从服务器读取响应数据<code>CallServerInterceptor</code></li>
</ol>
<p>位置决定了功能，最后一个 Interceptor 一定是负责和服务器实际通讯的，重定向、缓存等一定是在实际通讯之前的。</p>
<p>对于把<code>Request</code>变成<code>Response</code>这件事来说，每个<code>Interceptor</code>都可能完成这件事，所以我们循着链条让每个<code>Interceptor</code>自行决定能否完成任务以及怎么完成任务（自力更生或者交给下一个<code>Interceptor</code>）。这样一来，完成网络请求这件事就彻底从<code>RealCall</code>类中剥离了出来，简化了各自的责任和逻辑。</p>
<p>进入<code>ConnectInterceptor和CallServerInterceptor</code>，看看 OkHttp 是怎么进行和服务器的实际通信的。</p>
<h3 id="建立连接：ConnectInterceptor"><a href="#建立连接：ConnectInterceptor" class="headerlink" title="建立连接：ConnectInterceptor"></a>建立连接：ConnectInterceptor</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  RealInterceptorChain realChain = (RealInterceptorChain) chain;</span><br><span class="line">  Request request = realChain.request();</span><br><span class="line">  StreamAllocation streamAllocation = realChain.streamAllocation();</span><br><span class="line">  <span class="comment">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span></span><br><span class="line">  <span class="keyword">boolean</span> doExtensiveHealthChecks = !request.method().equals(<span class="string">"GET"</span>);</span><br><span class="line">  HttpCodec httpCodec = streamAllocation.newStream(client, doExtensiveHealthChecks);</span><br><span class="line">  RealConnection connection = streamAllocation.connection();</span><br><span class="line">  <span class="keyword">return</span> realChain.proceed(request, streamAllocation, httpCodec, connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立连接就是创建了一个<code>HttpCodec</code>对象，它将在后面的步骤中被使用，那它又是何方神圣呢？它是对 HTTP 协议操作的抽象，有两个实现：<code>Http1Codec和Http2Codec</code>，顾名思义，它们分别对应 HTTP/1.1 和 HTTP/2 版本的实现。</p>
<p>在Http1Codec中，它利用Okio对Socket的读写操作进行封装，Okio 以后有机会再进行分析，现在让我们对它们保持一个简单地认识：它对java.io和java.nio进行了封装，让我们更便捷高效的进行 IO 操作。</p>
<p>而创建<code>HttpCodec</code>对象的过程涉及到<code>StreamAllocation、RealConnection</code>，代码较长，这里就不展开，这个过程概括来说，就是找到一个<code>可用的RealConnection</code>，再利用RealConnection的输入输出（BufferedSource和BufferedSink）创建HttpCodec对象，供后续步骤使用。</p>
<h3 id="发送和接收数据：CallServerInterceptor"><a href="#发送和接收数据：CallServerInterceptor" class="headerlink" title="发送和接收数据：CallServerInterceptor"></a>发送和接收数据：CallServerInterceptor</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  HttpCodec httpCodec = ((RealInterceptorChain) chain).httpStream();</span><br><span class="line">  StreamAllocation streamAllocation = ((RealInterceptorChain) chain).streamAllocation();</span><br><span class="line">  Request request = chain.request();</span><br><span class="line">  <span class="keyword">long</span> sentRequestMillis = System.currentTimeMillis();</span><br><span class="line">  httpCodec.writeRequestHeaders(request);</span><br><span class="line">  <span class="keyword">if</span> (HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Sink requestBodyOut = httpCodec.createRequestBody(request, request.body().contentLength());</span><br><span class="line">    BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut);</span><br><span class="line">    request.body().writeTo(bufferedRequestBody);</span><br><span class="line">    bufferedRequestBody.close();</span><br><span class="line">  &#125;</span><br><span class="line">  httpCodec.finishRequest();</span><br><span class="line">  Response response = httpCodec.readResponseHeaders()</span><br><span class="line">      .request(request)</span><br><span class="line">      .handshake(streamAllocation.connection().handshake())</span><br><span class="line">      .sentRequestAtMillis(sentRequestMillis)</span><br><span class="line">      .receivedResponseAtMillis(System.currentTimeMillis())</span><br><span class="line">      .build();</span><br><span class="line">  <span class="keyword">if</span> (!forWebSocket || response.code() != <span class="number">101</span>) &#123;</span><br><span class="line">    response = response.newBuilder()</span><br><span class="line">        .body(httpCodec.openResponseBody(response))</span><br><span class="line">        .build();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"close"</span>.equalsIgnoreCase(response.request().header(<span class="string">"Connection"</span>))</span><br><span class="line">      || <span class="string">"close"</span>.equalsIgnoreCase(response.header(<span class="string">"Connection"</span>))) &#123;</span><br><span class="line">    streamAllocation.noNewStreams();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 省略部分检查代码</span></span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>向服务器发送 request header；</li>
<li>如果有 request body，就向服务器发送；</li>
<li>读取 response header，先构造一个Response对象；</li>
<li>如果有 response body，就在 3 的基础上加上 body 构造一个新的Response对象；</li>
</ol>
<p>核心工作都由HttpCodec对象完成，而HttpCodec实际上利用的是 Okio，而 Okio 实际上还是用的Socket，所以没什么神秘的，只不过一层套一层，层数有点多。</p>
<p>其实Interceptor的设计也是一种分层的思想，每个Interceptor就是一层。为什么要套这么多层呢？分层的思想在 TCP/IP 协议中就体现得淋漓尽致，分层简化了每一层的逻辑，每层只需要关注自己的责任（单一原则思想也在此体现），而各层之间通过约定的接口/协议进行合作（面向接口编程思想），共同完成复杂的任务。</p>
<h3 id="异步网络请求"><a href="#异步网络请求" class="headerlink" title="异步网络请求"></a>异步网络请求</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">client.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(response.body().string());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// RealCall的enqueue</span></span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</span><br><span class="line">    executed = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Dispatcher的enqueue</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(AsyncCall call)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">    runningAsyncCalls.add(call);</span><br><span class="line">    executorService().execute(call);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    readyAsyncCalls.add(call);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在dispatcher的enqueue（）中，如果当前队列大小 小于64，且队列内当前请求的同一host不超过5个，则直接加入队列开始执行，否则只加入队列。<br>这里的AsyncCall是RealCall的一个内部类，它实现了Runnable，所以可以被提交到ExecutorService（线程池）上执行，而它在执行时会调用getResponseWithInterceptorChain()函数，并把结果通过responseCallback传递给上层使用者。</p>
<p>这样看来，同步请求和异步请求的原理是一样的，都是在getResponseWithInterceptorChain()函数中通过Interceptor链条来实现的网络请求逻辑，而异步则是通过ExecutorService实现。</p>
<h3 id="返回数据的获取"><a href="#返回数据的获取" class="headerlink" title="返回数据的获取"></a>返回数据的获取</h3><p>上述同步（Call#execute()执行之后）或者异步（Callback#onResponse()回调中）请求完成之后，我们就可以从Response对象中获取到响应数据了，包括 HTTP status code，status message，response header，response body 等。这里 body 部分最为特殊，因为服务器返回的数据可能非常大，所以必须通过数据流的方式来进行访问（当然也提供了诸如string()和bytes()这样的方法将流内的数据一次性读取完毕），而响应中其他部分则可以随意获取。</p>
<p>响应 body 被封装到ResponseBody类中，该类主要有两点需要注意：</p>
<ol>
<li>每个 body 只能被消费一次，多次消费会抛出异常；</li>
<li>body 必须被关闭，否则会发生资源泄漏；<br>在发送和接收数据：CallServerInterceptor小节中，我们就看过了 body 相关的代码。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!forWebSocket || response.code() != <span class="number">101</span>) &#123;</span><br><span class="line">  response = response.newBuilder()</span><br><span class="line">      .body(httpCodec.openResponseBody(response))</span><br><span class="line">      .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>由<code>HttpCodec#openResponseBody</code>提供具体 HTTP 协议版本的响应 body，而<code>HttpCodec</code>则是利用 Okio 实现具体的数据 IO 操作。</p>
<h3 id="Http缓存（参见下一篇博文）"><a href="#Http缓存（参见下一篇博文）" class="headerlink" title="Http缓存（参见下一篇博文）"></a>Http缓存（参见下一篇博文）</h3><p>我们已经看到了<code>Interceptor</code>的布局，在建立连接、和服务器通讯之前，就是<code>CacheInterceptor</code>，在建立连接之前，我们检查响应是否已经被缓存、缓存是否可用，如果是则直接返回缓存的数据，否则就进行后面的流程，并在返回之前，把网络的数据写入缓存。</p>
<p>这块代码比较多，但也很直观，主要涉及 HTTP 协议缓存细节的实现，而具体的缓存逻辑 OkHttp 内置封装了一个<code>Cache</code>类，它利用<code>DiskLruCache</code>，用磁盘上的有限大小空间进行缓存，按照 LRU 算法进行缓存淘汰。</p>
<h3 id="连接复用"><a href="#连接复用" class="headerlink" title="连接复用"></a>连接复用</h3><p>若有大量连接，每次都要建立连接，释放连接，这会导致性能低下，在Http中有keepalive connections机制，它可以在传输数据后保持连接，当客户端再次获取数据时，直接使用刚刚空闲下来的连接而无须再次握手。<br><img src="/images/connect_reuse.png" alt="okhttp_reuse"></p>
<ol>
<li>建立连接并保存至连接池connections（Deque &lt; RealConnection &gt;）中</li>
<li>写请求数据</li>
<li>读相应数据</li>
<li>计算延时timeout5分钟，延时内若有数据请求访问，遍历连接池如果连接池请求具有相同Address（相同的Host与端口）可以共用相同的连接RealConnection。</li>
<li>回到2.，否则进入5</li>
<li>OkHttp根据StreamAllocation引用计数是否为0来实现自动回收连接</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/images/okhttp_full_process.png" alt="enter description here"><br>OkHttp执行流程如下：</p>
<ol>
<li>OkHttpClient实现Call.Factory，负责为Request创建Call；</li>
<li>RealCall为具体的Call实现，其enqueue()异步接口通过Dispatcher利用ExecutorService实现，而最终进行网络请求时和同步execute()接口一致，都是通过getResponseWithInterceptorChain()函数实现；</li>
<li>getResponseWithInterceptorChain()中利用Interceptor链条，分层实现缓存、透明压缩、网络 IO 等功能；</li>
</ol>
]]></content>
      <categories>
        <category>源码解析</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>OKHttp责任链分析</title>
    <url>/2018/03/23/OKHttp%E8%B4%A3%E4%BB%BB%E9%93%BE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>参考自<a href="https://www.jianshu.com/p/fd4255be60d7" target="_blank" rel="noopener">okHttp责任链解析</a></p>
<h2 id="责任链概述"><a href="#责任链概述" class="headerlink" title="责任链概述"></a>责任链概述</h2><blockquote>
<p>责任链模式：由多个处理请求的对象，其中每一个对象都引用了其下家的对象，从而形成一条处理请求的链。当客户端的请求到达时，并不<br>知道责任链上的哪一个对象处理了请求。这样的好处是：可以对客户端过来的请求做动态的处理。</p>
<ul>
<li>1.纯责任链模式：当请求到达一个类时要么处理完，要么扔给下一个对象。Sample：事件分发</li>
<li>2.不纯的责任链模式：当请求到达时，该类处理一部分（可以配置一些参数，适配一下请求），然后扔给下一个。Sample：okhttp</li>
</ul>
</blockquote>
<h2 id="OKHttp责任链"><a href="#OKHttp责任链" class="headerlink" title="OKHttp责任链"></a>OKHttp责任链</h2><p>OKHttp的责任链模式是一种不纯的责任链，即每一个拦截器都组装Reponse的一部分。</p>
<p>1.Interceptor接口中的intercept方法是实际处理请求的方法，每一个实现该接口的对象负责配置Request的一部分。并返回Response。<br>2.Chain接口负责执行intercept方法。并最终拿到intercept处理后的请求，绝大部分传递给intercept方法的Chain对象是RealInterceptorChain</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="function">Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Chain</span> </span>&#123;</span><br><span class="line">    <span class="function">Request <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Response <span class="title">proceed</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Connection <span class="title">connection</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>proceed相当于责任链中的dispose方法，不过真正做实际工作的是它内部持有的interceptor对象的intercept方法。</li>
<li><p>Chain的proceed方法持有intercept对象，通过interceptors.get(index),并且将索引+1生成下一个chain传递给intercept方法。而当intercept生成一部分响应后又会调用proceed(实际调用intercept方法)。从而形成责任链。<br>从 getResponseWithInterceptorChain 开始分析</p>
<h3 id="getResponseWithInterceptorChain"><a href="#getResponseWithInterceptorChain" class="headerlink" title="getResponseWithInterceptorChain"></a>getResponseWithInterceptorChain</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Response <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">  List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  interceptors.addAll(client.interceptors());</span><br><span class="line">  interceptors.add(retryAndFollowUpInterceptor);</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> ConnectInterceptor(client));</span><br><span class="line">  <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">    interceptors.addAll(client.networkInterceptors());</span><br><span class="line">  &#125;</span><br><span class="line">  interceptors.add(<span class="keyword">new</span> CallServerInterceptor(forWebSocket));</span><br><span class="line"></span><br><span class="line">  Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(</span><br><span class="line">      interceptors, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, originalRequest);<span class="comment">//1</span></span><br><span class="line">  <span class="keyword">return</span> chain.proceed(originalRequest);<span class="comment">//2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在OkHttp的RealCall类中的getReponseWithInterceptorChain方法，配置了多个拦截器，组装成一个任务链对象(将配置好的拦截器数组，索引第一次是0，和请求)生成一个RealIntecceptorChain</p>
</li>
<li>调用RealIntecceptorChain的proceed方法<h3 id="proceed"><a href="#proceed" class="headerlink" title="proceed"></a>proceed</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//RealIntecceptorChain</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span></span></span><br><span class="line"><span class="function"><span class="params">      Connection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// Call the next interceptor in the chain.</span></span><br><span class="line">    RealInterceptorChain next = <span class="keyword">new</span> RealInterceptorChain(</span><br><span class="line">        interceptors, streamAllocation, httpCodec, connection, index + <span class="number">1</span>, request);<span class="comment">// 1</span></span><br><span class="line">    Interceptor interceptor = interceptors.get(index);<span class="comment">// 2</span></span><br><span class="line">    Response response = interceptor.intercept(next);<span class="comment">// 3</span></span><br><span class="line"> ....</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>1.根据传进来的拦截器数组interceptors对象，和索引index构建一个新的拦截链—next对象。即每一个interceptor都会持有一个索引+1的任务链 RealInterceptorChain<br>2.从拦截器数组interceptors对象中根据索引获取拦截对象。并传入下一个任务链<br>3.调用拦截方法</p>
<p>开始拦截时，传入的索引是0，如果没有传入任何的interceptor类，那么将执行 RetryAndFollowUpInterceptor，调用的就是该类的intercept方法。查看代码。该类内部有两处也调用了chain.proceed方法。这个chain对象的持有的索引是(当前是0)index+1。调用它的proceed方法会执行集合中index=1的interceptor对象。</p>
<h3 id="RetryAndFollowUpInterceptor"><a href="#RetryAndFollowUpInterceptor" class="headerlink" title="RetryAndFollowUpInterceptor"></a>RetryAndFollowUpInterceptor</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RetryAndFollowUpInterceptor</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Request request = chain.request();</span><br><span class="line"></span><br><span class="line">    streamAllocation = <span class="keyword">new</span> StreamAllocation(</span><br><span class="line">        client.connectionPool(), createAddress(request.url()), callStackTrace);<span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> followUpCount = <span class="number">0</span>;</span><br><span class="line">    Response priorResponse = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">      Response response = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">boolean</span> releaseConnection = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        response = ((RealInterceptorChain) chain).proceed(request, streamAllocation, <span class="keyword">null</span>, <span class="keyword">null</span>); <span class="comment">// 2</span></span><br><span class="line">        releaseConnection = <span class="keyword">false</span>;</span><br><span class="line">      &#125; </span><br><span class="line">	  ...</span><br><span class="line">        <span class="keyword">return</span> response;<span class="comment">// 3</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>配置request的失败重试以及重定向功能</li>
<li>调用剩下的拦截链</li>
<li><p>返回response<br>进入 BridgeInterceptor</p>
<h3 id="BridgeInterceptor"><a href="#BridgeInterceptor" class="headerlink" title="BridgeInterceptor"></a>BridgeInterceptor</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//BridgeInterceptor</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Request userRequest = chain.request();</span><br><span class="line">    Request.Builder requestBuilder = userRequest.newBuilder();</span><br><span class="line"></span><br><span class="line">    RequestBody body = userRequest.body();</span><br><span class="line">    <span class="keyword">if</span> (body != <span class="keyword">null</span>) &#123;</span><br><span class="line">      MediaType contentType = body.contentType();</span><br><span class="line">      <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Content-Type"</span>, contentType.toString());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> contentLength = body.contentLength();</span><br><span class="line">      <span class="keyword">if</span> (contentLength != -<span class="number">1</span>) &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Content-Length"</span>, Long.toString(contentLength));</span><br><span class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>);</span><br><span class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Host"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Host"</span>, hostHeader(userRequest.url(), <span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Connection"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we add an "Accept-Encoding: gzip" header field we're responsible for also decompressing</span></span><br><span class="line">    <span class="comment">// the transfer stream.</span></span><br><span class="line">    <span class="keyword">boolean</span> transparentGzip = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Accept-Encoding"</span>) == <span class="keyword">null</span> &amp;&amp; userRequest.header(<span class="string">"Range"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      transparentGzip = <span class="keyword">true</span>;</span><br><span class="line">      requestBuilder.header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Cookie&gt; cookies = cookieJar.loadForRequest(userRequest.url());</span><br><span class="line">    <span class="keyword">if</span> (!cookies.isEmpty()) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Cookie"</span>, cookieHeader(cookies));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"User-Agent"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"User-Agent"</span>, Version.userAgent());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line">    Response networkResponse = chain.proceed(requestBuilder.build());<span class="comment">//2</span></span><br><span class="line"></span><br><span class="line">    HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());</span><br><span class="line"></span><br><span class="line">    Response.Builder responseBuilder = networkResponse.newBuilder()</span><br><span class="line">        .request(userRequest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (transparentGzip</span><br><span class="line">        &amp;&amp; <span class="string">"gzip"</span>.equalsIgnoreCase(networkResponse.header(<span class="string">"Content-Encoding"</span>))</span><br><span class="line">        &amp;&amp; HttpHeaders.hasBody(networkResponse)) &#123;</span><br><span class="line">      GzipSource responseBody = <span class="keyword">new</span> GzipSource(networkResponse.body().source());</span><br><span class="line">      Headers strippedHeaders = networkResponse.headers().newBuilder()</span><br><span class="line">          .removeAll(<span class="string">"Content-Encoding"</span>)</span><br><span class="line">          .removeAll(<span class="string">"Content-Length"</span>)</span><br><span class="line">          .build();</span><br><span class="line">      responseBuilder.headers(strippedHeaders);</span><br><span class="line">      responseBuilder.body(<span class="keyword">new</span> RealResponseBody(strippedHeaders, Okio.buffer(responseBody)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responseBuilder.build();<span class="comment">// 3</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>负责把用户构造的请求转换为发送到服务器的请求</p>
</li>
<li>调用剩余的拦截链处理请求</li>
<li>把服务器返回的Response转换为用户友好的Response返回</li>
</ol>
<p>依次类推，直到集合中的所有拦截器的interceptor方法全部调用完毕，流程是procced—interceptor—procced—interceptor—procced—-interceptor—interceptor方法。完成整个任务链。</p>
<h2 id="加工资"><a href="#加工资" class="headerlink" title="加工资"></a>加工资</h2><p>比如加工资审批场景</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">intercept</span><span class="params">(Chain chain)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Chain</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">proceed</span><span class="params">(<span class="keyword">int</span> salary, String name)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//hr拦截审批</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaffInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">intercept</span><span class="params">(Chain chain)</span> </span>&#123;</span><br><span class="line">        String user = ((RealInterceptorChain)chain).getUser();</span><br><span class="line">        <span class="keyword">int</span> salary = ((RealInterceptorChain)chain).getSalary() + <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(user + <span class="string">" Hr审核通过 : "</span> + salary);</span><br><span class="line"></span><br><span class="line">        chain.proceed(salary, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//经理拦截审批</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManagerInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">intercept</span><span class="params">(Chain chain)</span> </span>&#123;</span><br><span class="line">        String user = ((RealInterceptorChain)chain).getUser();</span><br><span class="line">        <span class="keyword">int</span> salary = ((RealInterceptorChain)chain).getSalary() + <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(user  + <span class="string">" Manager审核通过 : "</span> + salary);</span><br><span class="line"></span><br><span class="line">        chain.proceed(salary, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拦截链</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealInterceptorChain</span> <span class="keyword">implements</span> <span class="title">Interceptor</span>.<span class="title">Chain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Interceptor&gt; mInterceptors;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mIndex;</span><br><span class="line">    <span class="keyword">private</span> String mUser;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSalary;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RealInterceptorChain</span><span class="params">(List&lt;Interceptor&gt; interceptors, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        mInterceptors = interceptors;</span><br><span class="line">        mIndex = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">proceed</span><span class="params">(<span class="keyword">int</span> salary, String user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mSalary = salary;</span><br><span class="line">        <span class="keyword">this</span>.mUser = user;</span><br><span class="line">        <span class="keyword">if</span> (mIndex &gt;= mInterceptors.size()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RealInterceptorChain nextChain = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Interceptor interceptor = nextChain.mInterceptors.get(mIndex);</span><br><span class="line"></span><br><span class="line">        nextChain.setIndex(mIndex + <span class="number">1</span>);</span><br><span class="line">        interceptor.intercept(nextChain);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSalary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mSalary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        mIndex = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        interceptors.add(<span class="keyword">new</span> StaffInterceptor());</span><br><span class="line">        interceptors.add(<span class="keyword">new</span> ManagerInterceptor());</span><br><span class="line"></span><br><span class="line">        RealInterceptorChain chain = <span class="keyword">new</span> RealInterceptorChain(interceptors, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        chain.proceed(<span class="number">6000</span>, <span class="string">"night"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>源码解析</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Android 8.0 apk自动更新的一些坑</title>
    <url>/2017/09/06/Android%208.0%20apk%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/</url>
    <content><![CDATA[<h2 id="跳转系统安装界面闪退"><a href="#跳转系统安装界面闪退" class="headerlink" title="跳转系统安装界面闪退"></a>跳转系统安装界面闪退</h2><p>  这个是8.0独有的坑，在AndroidManifast中加上</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.REQUEST_INSTALL_PACKAGES"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>即可解决跳转安装界面闪退bug。</p>
<h2 id="安装时提示软件包出错"><a href="#安装时提示软件包出错" class="headerlink" title="安装时提示软件包出错"></a>安装时提示软件包出错</h2><p>  在用Intent install apk，时加上install.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);  </p>
<pre><code class="java"> Intent install = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);
install.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
install.setDataAndType(uri, <span class="string">"application/vnd.android.package-archive"</span>);
install.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
context.startActivity(install);
</code></pre>
]]></content>
      <categories>
        <category>bug</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Android事件分发源码解析</title>
    <url>/2017/08/20/Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="View的事件分发机制"><a href="#View的事件分发机制" class="headerlink" title="View的事件分发机制"></a>View的事件分发机制</h2><h3 id="事件分发机制图解"><a href="#事件分发机制图解" class="headerlink" title="事件分发机制图解"></a>事件分发机制图解</h3><p> <img src="/images/事件分发机制图解.png" alt="该图示自上而下有些许错误，请参考底部图解"></p>
<p> 由上图可看出所涉及到了三个重要的方法</p>
<ul>
<li><p>dispatchTouchEvent(MotionEvent ev):用于事件的分发</p>
</li>
<li><p>onIerveptTouchEvent(MotionEvent ev):用来进行事件的拦截，<br>在dispatchTouchEvent()中进行调用，且View没有该方法，只有ViewGroup有。</p>
</li>
<li><p>onTouchEvent(MotionEvent ev):用来处理点击事件，<br>在dispatchTouchEvent()中进行调用。</p>
</li>
</ul>
<p>  <code>事件分发</code>：当我们点击屏幕时，就产生了点击事件，该事件被封装成了一个MotionEvent类。系统会将MotionEvent传递给View的层级，MotionEvent在View中的层级传递过程就是事件分发。</p>
<h3 id="View的事件分发机制-1"><a href="#View的事件分发机制-1" class="headerlink" title="View的事件分发机制"></a>View的事件分发机制</h3><p>  当点击事件产生后，事件会首先传递给Activity，Activity会调用dispatchEvent()，将事件分发给phoneWindow,phoneWindow再分发给DecorView，最后由DecorView分发给根ViewGroup.</p>
<p>  进入ViewGroup的dispatchTouchEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line"> ...</span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;<span class="comment">//判断是否是Down事件，是则进行初始化mFirstTouchEvent</span></span><br><span class="line">                cancelAndClearTouchTargets(ev);</span><br><span class="line">                resetTouchState();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || mFirstTouchTarget != <span class="keyword">null</span>) &#123;<span class="comment">//mFirstTouchEvent表示当前ViewGroup是否拦截了事件，mFirstTouchEvent！=null表示不拦截</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;<span class="comment">//FLAG_DISALLOW_INTERCEPT：禁止ViewGroup拦截除了Down之外的事件，一般可通过子View的requestDisallowInterceptTouchEvent()来设置</span></span><br><span class="line">                <span class="keyword">if</span> (!disallowIntercept) &#123;<span class="comment">//进行拦截</span></span><br><span class="line">                    intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                    ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    intercepted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//既不是touch目标，也不是down事件，则进行拦截，如ACTION_UP,ACTION_MOVE</span></span><br><span class="line">                         intercepted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">              ...</span><br><span class="line">                        <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">       <span class="comment">//倒序遍历子View（即从最外层开始遍历），判断其是否能接收到点击事件，如果能，则交由子View来进行处理，</span></span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = getAndVerifyPreorderedIndex(</span><br><span class="line">                                    childrenCount, i, customOrder);</span><br><span class="line">                            <span class="keyword">final</span> View child = getAndVerifyPreorderedView(</span><br><span class="line">                                    preorderedList, children, childIndex);</span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line">                            <span class="keyword">if</span> (childWithAccessibilityFocus != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (childWithAccessibilityFocus != child) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                childWithAccessibilityFocus = <span class="keyword">null</span>;</span><br><span class="line">                                i = childrenCount - <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!canViewReceivePointerEvents(child)</span><br><span class="line">                                    || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</span><br><span class="line">     <span class="comment">//判断子View是否在播放动画或者触摸点位置是否在子View的范围里，均不满足则continue</span></span><br><span class="line">                                ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            newTouchTarget = getTouchTarget(child);</span><br><span class="line">                            <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// Child is already receiving touch within its bounds.</span></span><br><span class="line">                                <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></span><br><span class="line">                                newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            resetCancelNextUpFlag(child);</span><br><span class="line">                            <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;<span class="comment">//转换触控分发事件</span></span><br><span class="line">                                <span class="comment">// Child wants to receive touch within its bounds.</span></span><br><span class="line">                                mLastTouchDownTime = ev.getDownTime();</span><br><span class="line">                                <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="comment">// childIndex points into presorted list, find original index</span></span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</span><br><span class="line">                                            mLastTouchDownIndex = j;</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    mLastTouchDownIndex = childIndex;</span><br><span class="line">                                &#125;</span><br><span class="line">                                mLastTouchDownX = ev.getX();</span><br><span class="line">                                mLastTouchDownY = ev.getY();</span><br><span class="line">                                newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                                alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>
<p>  当ViewGroup要拦截事件的时候，后续事件全部交由它处理，而不用再调用onInterceptTouchEvent()进行判断，因此onInterceptTouchEvent()并不是每次事件都会执行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (ev.isFromSource(InputDevice.SOURCE_MOUSE)</span><br><span class="line">              &amp;&amp; ev.getAction() == MotionEvent.ACTION_DOWN</span><br><span class="line">              &amp;&amp; ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY)</span><br><span class="line">              &amp;&amp; isOnScrollbarThumb(ev.getX(), ev.getY())) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  onInterceptTouchEvent()默认返回false，不进行拦截，可在ViewGroup中重写该方法进行拦截。</p>
<p>  查看上述转换触控分发事件dispatchTransformedTouchEvent()：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></span><br><span class="line"><span class="function"><span class="params">           View child, <span class="keyword">int</span> desiredPointerIdBits)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> handled;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></span><br><span class="line">       <span class="comment">// or filtering.  The important part is the action, not the contents.</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</span><br><span class="line">       <span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</span><br><span class="line">           event.setAction(MotionEvent.ACTION_CANCEL);</span><br><span class="line">           <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">               handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               handled = child.dispatchTouchEvent(event);</span><br><span class="line">           &#125;</span><br><span class="line">           event.setAction(oldAction);</span><br><span class="line">           <span class="keyword">return</span> handled;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>   如果viewGroup有子View，则调用子View的dispatchTouchEvent(event),没有则调用super.dispatchTouchEvent(event)，因为ViewGroup是继承自View，进入View的dispatchTouchEvent(event)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.isTargetAccessibilityFocus()) &#123;</span><br><span class="line">            <span class="comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span></span><br><span class="line">            <span class="keyword">if</span> (!isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// We have focus and got the event, then use normal event dispatch.</span></span><br><span class="line">            event.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            <span class="comment">// Defensive cleanup for new gesture</span></span><br><span class="line">            stopNestedScroll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">            ListenerInfo li = mListenerInfo;</span><br><span class="line">            <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">                    &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>  如果OnTouchListener不为null且onTouch()返回为true，则表示事件被消费，不会执行onTouchEvent(event),否则就会执行onTouchEvent(event).根据执行顺序可看出OnTouchListener.onTouch()优先级&gt;onTouchEvent(event).下面进入omTouchEvent()。</p>
<pre><code class="java"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>{
        <span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();
        <span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();
        <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;
        <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();

        <span class="keyword">final</span> <span class="keyword">boolean</span> clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE
                || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)
                || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;

        <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) {
            <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) {
                setPressed(<span class="keyword">false</span>);
            }
            mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;
            <span class="comment">// A disabled view that is clickable still consumes the touch</span>
            <span class="comment">// events, it just doesn't respond to them.</span>
            <span class="keyword">return</span> clickable;
        }
        <span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) {
            <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) {
                <span class="keyword">return</span> <span class="keyword">true</span>;
            }
        }

        <span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) {
            <span class="keyword">switch</span> (action) {
                <span class="keyword">case</span> MotionEvent.ACTION_UP:
                    mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;
                    <span class="keyword">if</span> ((viewFlags &amp; TOOLTIP) == TOOLTIP) {
                        handleTooltipUp();
                    }
                    <span class="keyword">if</span> (!clickable) {
                        removeTapCallback();
                        removeLongPressCallback();
                        mInContextButtonPress = <span class="keyword">false</span>;
                        mHasPerformedLongPress = <span class="keyword">false</span>;
                        mIgnoreNextUpEvent = <span class="keyword">false</span>;
                        <span class="keyword">break</span>;
                    }
                    <span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;
                    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) {
                        <span class="comment">// take focus if we don't have it already and we should in</span>
                        <span class="comment">// touch mode.</span>
                        <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;
                        <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) {
                            focusTaken = requestFocus();
                        }

                        <span class="keyword">if</span> (prepressed) {
                            <span class="comment">// The button is being released before we actually</span>
                            <span class="comment">// showed it as pressed.  Make it show the pressed</span>
                            <span class="comment">// state now (before scheduling the click) to ensure</span>
                            <span class="comment">// the user sees it.</span>
                            setPressed(<span class="keyword">true</span>, x, y);
                        }

                        <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) {
                            <span class="comment">// This is a tap, so remove the longpress check</span>
                            removeLongPressCallback();

                            <span class="comment">// Only perform take click actions if we were in the pressed state</span>
                            <span class="keyword">if</span> (!focusTaken) {
                                <span class="comment">// Use a Runnable and post this rather than calling</span>
                                <span class="comment">// performClick directly. This lets other visual state</span>
                                <span class="comment">// of the view update before click actions start.</span>
                                <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) {
                                    mPerformClick = <span class="keyword">new</span> PerformClick();
                                }
                                <span class="keyword">if</span> (!post(mPerformClick)) {
                                    performClick();
                                }
                            }
                        }

                        ...
            }

            <span class="keyword">return</span> <span class="keyword">true</span>;
        }

        <span class="keyword">return</span> <span class="keyword">false</span>;
    }
</code></pre>
<p>  只要View的CLICKABLE和LONG_CLICKABLE有一个为true，那么onTouchEvent()就会返回true消费这个事件。只要设置View设置了对应的监听事件setOnClickListener和setOnLongClickListener来设置，其会自动将对应属性设置为true。进入至performClick()。</p>
<pre><code class="java"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>{
       <span class="keyword">final</span> <span class="keyword">boolean</span> result;
       <span class="keyword">final</span> ListenerInfo li = mListenerInfo;
       <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) {<span class="comment">//如果view设置了onClickListener，则就会执行其onClick()，</span>
           playSoundEffect(SoundEffectConstants.CLICK);
           li.mOnClickListener.onClick(<span class="keyword">this</span>);
           result = <span class="keyword">true</span>;
       } <span class="keyword">else</span> {
           result = <span class="keyword">false</span>;
       }

       sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);

       notifyEnterOrExitForAutoFillIfNeeded(<span class="keyword">true</span>);

       <span class="keyword">return</span> result;
   }
</code></pre>
<h2 id="点击事件分发的传递原则"><a href="#点击事件分发的传递原则" class="headerlink" title="点击事件分发的传递原则"></a>点击事件分发的传递原则</h2><p>   <img src="/images/事件分发.png" alt="事件分发自上而下分发"></p>
<p>  根ViewGroupdispatchTouchEvent()遍历子View询问是否允许拦截，不允许则将事件分发给子View的dispatchTouchEvent()，允许则进入onInterceptTouchEvent(event)判断自己是否要拦截这个事件，不拦截则将事件分发给子View的dispatchTouchEvent()，拦截则进入自己的onTouchEvent()进行处理。当传递到子View，如果其onTouchEvent返回true表明其处理了该事件，返回false，会将事件传递给父View进行处理。</p>
]]></content>
      <categories>
        <category>进阶之光</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>关于IM上拉加载RecylerView闪烁至错误位置</title>
    <url>/2017/06/06/IM%E4%B8%8A%E6%8B%89%E5%8A%A0%E8%BD%BDRecylerView/</url>
    <content><![CDATA[<p>  在上拉刷新时采取 mChatAdapter.notifyItemRangeInserted(0, size)，而不是mChatAdapter.notifyDataSetChanged();</p>
]]></content>
      <categories>
        <category>bug</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>RecylerView中嵌套横向滑动冲突</title>
    <url>/2017/05/09/RecylerView%E5%B5%8C%E5%A5%97%E6%A8%AA%E5%90%91%E6%BB%91%E5%8A%A8%E5%86%B2%E7%AA%81/</url>
    <content><![CDATA[<h2 id="Bug描述"><a href="#Bug描述" class="headerlink" title="Bug描述"></a>Bug描述</h2><p>  在RecylerView中的item存在横向滑动，(PS:item的横向滑动通过属性动画实现)可是参照网上已存的教程要么是item不能垂直滑动，要么item不能水平滑动，这就相当恼人。结果在和朋友交流中发现，不能简单的通过覆写父类进行外部拦截，应该要从子View进行内部拦截。</p>
<h2 id="解决代码"><a href="#解决代码" class="headerlink" title="解决代码"></a>解决代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopAreaContainer</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AvatarsContainers mAvatarsContainers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ViewGroup parent;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mLastX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mLastY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> state;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> touchSlop;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PostTopAreaContainer</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PostTopAreaContainer</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        touchSlop = ViewConfiguration.get(context).getScaledEdgeSlop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">        <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line">        <span class="keyword">if</span> (mAvatarsContainers.getChildCount() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);<span class="comment">//默认按下时不让父View进行拦截</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="keyword">int</span> dx = x - mLastX;</span><br><span class="line">                <span class="keyword">int</span> dy = y - mLastY;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((Math.abs(dx) &lt; Math.abs(dy)) &amp;&amp; (Math.abs(dy) &gt; touchSlop)) &#123;</span><br><span class="line">                    state = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (state) &#123;<span class="comment">//垂直滑动则让父View拦截本次事件</span></span><br><span class="line">                    parent.requestDisallowInterceptTouchEvent(<span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//横向滑动</span></span><br><span class="line">                    <span class="keyword">if</span> (deltaX &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        mAvatarsContainers.shrink();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mAvatarsContainers.expand();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLastX = x;</span><br><span class="line">        mLastY = y;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  里面还有个坑就是之前和朋友讨论用int值记录状态，就会出现迷之滑动，在上下滑的同时也在左右滑，但是左右滑时却是正常的。Bug代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</span><br><span class="line">     <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">         <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">             parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);<span class="comment">//请求父View(RecylerView)不进行拦截</span></span><br><span class="line">             state = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">             <span class="keyword">int</span> deltaX = x - mLastX;</span><br><span class="line">             <span class="keyword">int</span> deltaY = y - mLastY;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (state == <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (Math.abs(deltaX) &lt; Math.abs(deltaY)) &#123;</span><br><span class="line">                     state = <span class="number">1</span>;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     state = <span class="number">2</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (state == <span class="number">1</span>) &#123;</span><br><span class="line">                 parent.requestDisallowInterceptTouchEvent(<span class="keyword">false</span>);</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">if</span> (deltaX &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                     Log.i(TAG, <span class="string">"左滑"</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     Log.i(TAG, <span class="string">"右滑"</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> MotionEvent.ACTION_UP :</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mLastX = x;</span><br><span class="line">     mLastY = y;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>  调试后发现问题出在if(state==0)这里，因为在state=0情况只会出现在第一次按下的情况，后续滑动state都是不等于0的，所以后续滑动的state都没有再变化过了，只会重复第一次的state，所以采取直线救国,直接将state的改为boolean类型，并取消之前的判断就阔以啦！！！嗨呀，算是交代了这个Bug了…..</p>
<p>  那问题是出自哪尼？为什么横向滑动会惨遭recylerview拦截呢？欢迎走入recylerviewonInterceptTouchEvent源码解析。</p>
<h2 id="recylerviewonInterceptTouchEvent源码"><a href="#recylerviewonInterceptTouchEvent源码" class="headerlink" title="recylerviewonInterceptTouchEvent源码"></a>recylerviewonInterceptTouchEvent源码</h2><pre><code class="java"><span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent e)</span> </span>{
       ...
        <span class="keyword">if</span> (dispatchOnItemTouchIntercept(e)) {
            cancelTouch();
            <span class="keyword">return</span> <span class="keyword">true</span>;
        }

        <span class="keyword">if</span> (mLayout == <span class="keyword">null</span>) {
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }

        <span class="keyword">final</span> <span class="keyword">boolean</span> canScrollHorizontally = mLayout.canScrollHorizontally();
        <span class="keyword">final</span> <span class="keyword">boolean</span> canScrollVertically = mLayout.canScrollVertically();

        <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) {
            mVelocityTracker = VelocityTracker.obtain();
        }
        mVelocityTracker.addMovement(e);

        <span class="keyword">final</span> <span class="keyword">int</span> action = e.getActionMasked();
        <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = e.getActionIndex();

        <span class="keyword">switch</span> (action) {
            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:
                <span class="keyword">if</span> (mIgnoreMotionEventTillDown) {
                    mIgnoreMotionEventTillDown = <span class="keyword">false</span>;
                }
                mScrollPointerId = e.getPointerId(<span class="number">0</span>);
                mInitialTouchX = mLastTouchX = (<span class="keyword">int</span>) (e.getX() + <span class="number">0.5f</span>);
                mInitialTouchY = mLastTouchY = (<span class="keyword">int</span>) (e.getY() + <span class="number">0.5f</span>);

                <span class="keyword">if</span> (mScrollState == SCROLL_STATE_SETTLING) {
                    getParent().requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);
                    setScrollState(SCROLL_STATE_DRAGGING);
                }

                <span class="comment">// Clear the nested offsets</span>
                mNestedOffsets[<span class="number">0</span>] = mNestedOffsets[<span class="number">1</span>] = <span class="number">0</span>;

                <span class="keyword">int</span> nestedScrollAxis = ViewCompat.SCROLL_AXIS_NONE;
                <span class="keyword">if</span> (canScrollHorizontally) {
                    nestedScrollAxis |= ViewCompat.SCROLL_AXIS_HORIZONTAL;
                }
                <span class="keyword">if</span> (canScrollVertically) {
                    nestedScrollAxis |= ViewCompat.SCROLL_AXIS_VERTICAL;
                }
                startNestedScroll(nestedScrollAxis, TYPE_TOUCH);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:
                mScrollPointerId = e.getPointerId(actionIndex);
                mInitialTouchX = mLastTouchX = (<span class="keyword">int</span>) (e.getX(actionIndex) + <span class="number">0.5f</span>);
                mInitialTouchY = mLastTouchY = (<span class="keyword">int</span>) (e.getY(actionIndex) + <span class="number">0.5f</span>);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> MotionEvent.ACTION_MOVE: {
                <span class="keyword">final</span> <span class="keyword">int</span> index = e.findPointerIndex(mScrollPointerId);
                <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {
                    Log.e(TAG, <span class="string">"Error processing scroll; pointer index for id "</span>
                            + mScrollPointerId + <span class="string">" not found. Did any MotionEvents get skipped?"</span>);
                    <span class="keyword">return</span> <span class="keyword">false</span>;
                }

                <span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) (e.getX(index) + <span class="number">0.5f</span>);
                <span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) (e.getY(index) + <span class="number">0.5f</span>);
                <span class="keyword">if</span> (mScrollState != SCROLL_STATE_DRAGGING) {
                    <span class="keyword">final</span> <span class="keyword">int</span> dx = x - mInitialTouchX;
                    <span class="keyword">final</span> <span class="keyword">int</span> dy = y - mInitialTouchY;
                    <span class="keyword">boolean</span> startScroll = <span class="keyword">false</span>;
                    <span class="keyword">if</span> (canScrollHorizontally &amp;&amp; Math.abs(dx) &gt; mTouchSlop) {<span class="comment">//罪魁祸首</span>
                        mLastTouchX = x;
                        startScroll = <span class="keyword">true</span>;
                    }
                    <span class="keyword">if</span> (canScrollVertically &amp;&amp; Math.abs(dy) &gt; mTouchSlop) {
                        mLastTouchY = y;
                        startScroll = <span class="keyword">true</span>;
                    }
                    <span class="keyword">if</span> (startScroll) {
                        setScrollState(SCROLL_STATE_DRAGGING);
                    }
                }
            } <span class="keyword">break</span>;          
        }
        <span class="keyword">return</span> mScrollState == SCROLL_STATE_DRAGGING;
    }
</code></pre>
<p>  罪魁祸首不难看出是其进入了recylerview中的if (canScrollHorizontally &amp;&amp; Math.abs(dx) &gt; mTouchSlop)然后描述性地设置了startScroll为true，startScroll为true设置了mScrollState = SCROLL_STATE_DRAGGING,所以最后返回true拦截了子View的事件。</p>
<p>  之前的事件分发顺序有遗漏，在从上自下中，通过requestDisallowInterceptTouchEvent()会先询问子View是否允许父View拦截事件，如果允许则进入onIntercept()，否则将事件分发给子View的dispatchEvent().</p>
<p>  本文参考至<a href="http://blog.csdn.net/qq_36523667/article/details/79223576" target="_blank" rel="noopener">http://blog.csdn.net/qq_36523667/article/details/79223576</a></p>
]]></content>
      <categories>
        <category>bug修复</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>代理</title>
    <url>/2016/04/23/%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h2 id="创建代理对象"><a href="#创建代理对象" class="headerlink" title="创建代理对象"></a>创建代理对象</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      Object[] elements = <span class="keyword">new</span> Object[<span class="number">1000</span>];</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; elements.length; i++)</span><br><span class="line">      &#123;</span><br><span class="line">         Integer value = i + <span class="number">1</span>;</span><br><span class="line">         InvocationHandler handler = <span class="keyword">new</span> TraceHandler(value);</span><br><span class="line">         Object proxy = Proxy.newProxyInstance(<span class="keyword">null</span>, <span class="keyword">new</span> Class[] &#123; Comparable<span class="class">.<span class="keyword">class</span> &#125; , <span class="title">handler</span>)</span>;<span class="comment">//（ClassLoader,Class对象数组，InvocationHandler）</span></span><br><span class="line">         elements[i] = proxy;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// construct a random integer</span></span><br><span class="line">      Integer key = <span class="keyword">new</span> Random().nextInt(elements.length) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// search for the key</span></span><br><span class="line">      <span class="keyword">int</span> result = Arrays.binarySearch(elements, key);<span class="comment">//会获取到elements中的Comparable接口，调用compareTo()，而在compareTo()中调用了代理对象的InvocationHandler的invoke()</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// print match if found</span></span><br><span class="line">      <span class="keyword">if</span> (result &gt;= <span class="number">0</span>) System.out.println(elements[result]);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An invocation handler that prints out the method name and parameters, then</span></span><br><span class="line"><span class="comment"> * invokes the original method</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TraceHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Constructs a TraceHandler</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> t the implicit parameter of the method call</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">TraceHandler</span><span class="params">(Object t)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      target = t;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method m, Object[] args)</span> <span class="keyword">throws</span> Throwable</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="comment">// print implicit argument</span></span><br><span class="line">      System.out.print(target);</span><br><span class="line">      <span class="comment">// print method name</span></span><br><span class="line">      System.out.print(<span class="string">"."</span> + m.getName() + <span class="string">"("</span>);</span><br><span class="line">      <span class="comment">// print explicit arguments</span></span><br><span class="line">      <span class="keyword">if</span> (args != <span class="keyword">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++)</span><br><span class="line">         &#123;</span><br><span class="line">            System.out.print(args[i]);</span><br><span class="line">            <span class="keyword">if</span> (i &lt; args.length - <span class="number">1</span>) System.out.print(<span class="string">", "</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(<span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// invoke actual method</span></span><br><span class="line">      <span class="keyword">return</span> m.invoke(target, args);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  代理类通过提供一个invocation handler(其实现了InnovationHandler接口，该函数接口只有一个invoke(object proxy，Method method,Object[] args)),只要调用代理对象的方法，invocation handler的invoke()都会被调用。</p>
<h2 id="代理类的特性"><a href="#代理类的特性" class="headerlink" title="代理类的特性"></a>代理类的特性</h2><p>  代理类是在程序运行过程中创建的，所有同参数构造出来的代理类只会得到同一个代理类。可通过getProxyClass()获得这个类。</p>
]]></content>
      <categories>
        <category>Java核心技术</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Foreach与迭代器</title>
    <url>/2016/01/04/Foreach%E4%B8%8E%E8%BF%AD%E4%BB%A3%E5%99%A8/</url>
    <content><![CDATA[<h2 id="Foreach与迭代器"><a href="#Foreach与迭代器" class="headerlink" title="Foreach与迭代器"></a>Foreach与迭代器</h2><p>  emmmmmm，孤陋寡闻的博主在看TIJ之前只以为Foreach语句只可以用在数组，结果没想到可以应用到任意Collection对象。/捂脸</p>
<p>  瞅瞅Collection对象的Foreach肿么写哈……</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IterableClass</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">String</span>&gt; </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    String[] words = (<span class="string">"Nice to meet you"</span>).split(<span class="string">" "</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;String&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;String&gt;()&#123;  </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">0</span>;  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">                <span class="keyword">return</span> index &lt; words.length;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">next</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">                <span class="keyword">return</span> words[index++];  </span><br><span class="line">            &#125;  </span><br><span class="line">              </span><br><span class="line">        &#125;;  </span><br><span class="line">    &#125;  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">for</span>(String s : <span class="keyword">new</span> IterableClass())&#123;  </span><br><span class="line">            System.out.print(s + <span class="string">" "</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  输出请自行脑补，不做另行说明….刚才是谁说我菜的站出来，说的就是你，死肥宅！！！</p>
<p>  从上述代码可以看出一个类要使用ForEach需要实现Iterable这个接口，实现iterator()方法，在方法中可以看到我返回了一个匿名内部类，操作的具体实现都在内部类里面了。它也就重写了hasNext()、next()方法在遍历时进行回调。</p>
<p>  emmmmm还有一个ForEach的非常规操作，一般人我都不告诉，看在阁下看你的骨骼精奇，是万中无一的武学奇才，见与你有缘。就告诉你罢。</p>
<p>  众所周知，ForEach都是顺序访问，那要逆序访问呢？show you the code……</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReverseArrayList</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReverseArrayList</span><span class="params">(@NotNull Collection&lt;? extends T&gt; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;T&gt; <span class="title">reversed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Iterable&lt;T&gt;() &#123;</span><br><span class="line">                      <span class="function"><span class="keyword">public</span> Iterator&lt;T&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;T&gt;() &#123;</span><br><span class="line">                    <span class="keyword">int</span> current = size() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> current &gt; -<span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> T <span class="title">next</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> get(current--);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String s : <span class="keyword">new</span> ReverseArrayList&lt;String&gt;(Arrays.asList(<span class="string">"Nice to meet you !"</span>.split(<span class="string">" "</span>))).reversed()) &#123;</span><br><span class="line">            System.out.println(s+<span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">output:</span><br><span class="line">!</span><br><span class="line">you</span><br><span class="line">meet</span><br><span class="line">to</span><br><span class="line">Nice</span><br></pre></td></tr></table></figure>
<p>  系不系很神奇呀，如果你细心的话，可以注意到我在reverse返回的是Iterable而不是Iterator,Iterable可以在默认迭代器的基础上，添加产生反向迭代器的能力，而Iterator只能实现现有的方法。在上述代码中，我自定义了一个reversed()逆序访问。那随机访问也类似……</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IterClass</span> <span class="keyword">extends</span> <span class="title">IterableClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">randomize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Iterable&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@NotNull</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterator&lt;String&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                List&lt;String&gt; shuffle = <span class="keyword">new</span> ArrayList&lt;String&gt;(Arrays.asList(words));</span><br><span class="line">                Collections.shuffle(shuffle, <span class="keyword">new</span> Random(<span class="number">47</span>));</span><br><span class="line">                <span class="keyword">return</span> shuffle.iterator();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String s : <span class="keyword">new</span> IterClass().randomize()) &#123;</span><br><span class="line">            System.out.println(s + <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">output:</span><br><span class="line">Nice</span><br><span class="line">to</span><br><span class="line">you</span><br><span class="line">meet</span><br></pre></td></tr></table></figure>
<p>  值得注意的是Collections.shuffle()并没有影响到原数组，只是打乱了shuffle的引用，所以在上述代码中new ArrayList<string>(Arrays.asList(words));通过创建一个list用以保存新的引用，防止更改原先的数组引用。</string></p>
]]></content>
      <categories>
        <category>Thinking in Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>RTTI</title>
    <url>/2016/01/04/%E8%BF%90%E8%A1%8C%E6%97%B6%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF/</url>
    <content><![CDATA[<h2 id="Java中的RTTI"><a href="#Java中的RTTI" class="headerlink" title="Java中的RTTI"></a>Java中的RTTI</h2><p>  RTTI可以在程序运行时发现和使用类型信息；传统的RTTI，在编译期和运行期已经知道了所有的类型。举个栗子，在数组中存放类A的实例，在A对象放入数组中时会进行向上转型为Object，取出时会自动将结果转型为A.在Java中所有的类型转换都是在运行时进行正确性检查的，即在运行时识别一个对象的类型。</p>
<h2 id="Class对象"><a href="#Class对象" class="headerlink" title="Class对象"></a>Class对象</h2><p>  <code>Class对象</code>是RTTI中的核心,Class对象是一个特殊对象，其包含了与类有关的信息，可创建类的所有的“常规”对象（PS:即通过new出来的对象）。Java通过Class对象执行RTTI。</p>
<p>  <code>每个类都有一个Class对象</code>，每经编译一个新类时都会产生一个Class对象。JVM通过<code>类加载器子系统</code>来生成该对象。所有的类都是在对其第一次使用时，动态地加载到JVM中。当程序创建第一个对类的静态引用时，就会加载这个类。即使构造方法没有使用static关键字。第一次使用new创建类的新对象也会被当作对类的静态成员的引用。</p>
<p>  类加载器会首先检查类的Class对象是否已经加载。若未加载，默认的类加载器就会根据类名查找.class文件。一旦类的Class对象被载入内存，它就会被用来创建这个类的所有对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">          Class.forName(<span class="string">"springapp.domain.Product"</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>  public static Class&lt;?&gt; forName(String className)是Class类的一个static成员。其返回是一个Class对象的引用，该引用对应着传入的className。如果该Product还未被加载就加载它，在加载类Product时，<code>Product的static{}</code>会被执行。如果找不到要加载的类，则会抛出异常ClassNotFoundException。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class c=Class.forName(<span class="string">"springapp.domain.Product"</span>);</span><br><span class="line">    System.out.println(<span class="string">"ClassName: "</span> + c.getName() + <span class="string">"\nSimpleName: "</span> + c.getSimpleName() + <span class="string">"\nCanonical name: "</span> + c.getCanonicalName());</span><br><span class="line">    Product p= (Product) c.newInstance();<span class="comment">//创建实例</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/RTTI.png" alt="输出结果"></p>
<p>  其中 class.newInstance()创建的类必须带有默认的构造方法。</p>
<h3 id="类字面常量"><a href="#类字面常量" class="headerlink" title="类字面常量"></a>类字面常量</h3><p>  类字面变量：用于生成对Class对象的引用。使用方法：类名.class。使用.class创建Class引用时，不会自动地初始化Class对象，其初始化被延迟到对静态方法（构造方法隐式是静态的）或者非常数静态域（即静态变量）进行首次引用时才执行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CI</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Random sRandom = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        Class initable = I1<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        System.out.println(<span class="string">"After creating initble ref "</span>);</span><br><span class="line">        System.out.println(I1.sfinal);</span><br><span class="line">        System.out.println(I1.sfinal2);</span><br><span class="line">        Class initable3 = Class.forName(<span class="string">"springapp.domain.I3"</span>);</span><br><span class="line">        System.out.println(<span class="string">"After creating Initable3 ref"</span>);</span><br><span class="line">        System.out.println(I3.sNonfinal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">I1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> sfinal = <span class="number">47</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> sfinal2 = CI.sRandom.nextInt(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">I3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> sNonfinal = <span class="number">74</span>;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I3"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/5-2.png" alt="输出结果"></p>
<p>  从输出可以看出，仅使用.class是不会初始化类的引用，而Class.forName立即就对类的引用进行了初始化。如果一个static变量被声明为final常量，那么这个读取这个值也并不需要初始化Class。static fianl 是<code>编译期常量</code>,如果一个static不是final的变量，对其进行访问时，要先进行链接(为静态域分配空间)和初始化(初始化该存储空间)。</p>
<h3 id="泛化的Class引用"><a href="#泛化的Class引用" class="headerlink" title="泛化的Class引用"></a>泛化的Class引用</h3><p>  泛化的Class引用：使用泛型限定Class对象的类型。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;Integer&gt; integerClass = <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">  <span class="comment">// integerClass = double.class;非法转换</span></span><br><span class="line">   Class&lt;?&gt; intClass = <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">   intClass = <span class="keyword">double</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">   Class&lt;I1&gt; i=I1<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">   Class&lt;? extends I1&gt; i1 = I1<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">   Class&lt;? <span class="keyword">super</span> I1&gt; i2 = i.getSuperclass();</span><br></pre></td></tr></table></figure>
<p>  其中Class&lt;?&gt;的?表示通配符，意味着一个非具体的类引用。&lt;? extends A&gt;限定是A的子类，&lt;? super A&gt;限定是A的父类。</p>
<h3 id="类型转换前先检查"><a href="#类型转换前先检查" class="headerlink" title="类型转换前先检查"></a>类型转换前先检查</h3><p>  (1)强转，通过RTTI保证正确性，如果转换出错抛出ClassCastException</p>
<p>  (2)转换前先通过A instanceof B/B.isInstance(A)询问 A对象是否从属于B的实例，如果是，再进行转换。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;? extends I1&gt; i1 = I1<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">I1 f = <span class="keyword">new</span> I1();</span><br><span class="line"><span class="keyword">if</span> (f <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">    System.out.println(<span class="string">"true"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (i1.isInstance(f)) &#123;</span><br><span class="line">    System.out.println(<span class="string">"true"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>  反射：用来在运行时分析类。</p>
<p>  反射可用来：</p>
<ol>
<li>在运行时分析类</li>
<li>在运行时查看对象</li>
<li>实现通用的数组操作代码</li>
<li>使用Method对象（类比于C++中的函数指针）</li>
</ol>
<h4 id="利用反射分析类"><a href="#利用反射分析类" class="headerlink" title="利用反射分析类"></a>利用反射分析类</h4><p>  在reflect包中有三个类Field、Method、Constructor可用来获取类的对应成员变量、方法、构造方法。具体操作如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="comment">// read class name from command line args or user input</span></span><br><span class="line">      String name;</span><br><span class="line">      <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) name = args[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">         Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">         System.out.println(<span class="string">"Enter class name (e.g. java.util.Date): "</span>);</span><br><span class="line">         name = in.next();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="comment">// print class name and superclass name (if != Object)</span></span><br><span class="line">         Class cl = Class.forName(name);</span><br><span class="line">         Class supercl = cl.getSuperclass();</span><br><span class="line">         String modifiers = Modifier.toString(cl.getModifiers());</span><br><span class="line">         <span class="keyword">if</span> (modifiers.length() &gt; <span class="number">0</span>) System.out.print(modifiers + <span class="string">" "</span>);</span><br><span class="line">         System.out.print(<span class="string">"class "</span> + name);</span><br><span class="line">         if (supercl != null &amp;&amp; supercl != Object.class) System.out.print(" extends "</span><br><span class="line">               + supercl.getName());</span><br><span class="line"></span><br><span class="line">         System.out.print(<span class="string">"\n&#123;\n"</span>);</span><br><span class="line">         printConstructors(cl);</span><br><span class="line">         System.out.println();</span><br><span class="line">         printMethods(cl);</span><br><span class="line">         System.out.println();</span><br><span class="line">         printFields(cl);</span><br><span class="line">         System.out.println(<span class="string">"&#125;"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ClassNotFoundException e)</span><br><span class="line">      &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      System.exit(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Prints all constructors of a class</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> cl a class</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printConstructors</span><span class="params">(Class cl)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      Constructor[] constructors = cl.getDeclaredConstructors();<span class="comment">//获取所有构造方法，如果方法中没有Declared，则不能获取私有构造方法</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Constructor c : constructors)</span><br><span class="line">      &#123;</span><br><span class="line">         String name = c.getName();</span><br><span class="line">         System.out.print(<span class="string">"   "</span>);</span><br><span class="line">         String modifiers = Modifier.toString(c.getModifiers());</span><br><span class="line">         <span class="keyword">if</span> (modifiers.length() &gt; <span class="number">0</span>) System.out.print(modifiers + <span class="string">" "</span>);         </span><br><span class="line">         System.out.print(name + <span class="string">"("</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// print parameter types</span></span><br><span class="line">         Class[] paramTypes = c.getParameterTypes();</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; paramTypes.length; j++)</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="keyword">if</span> (j &gt; <span class="number">0</span>) System.out.print(<span class="string">", "</span>);</span><br><span class="line">            System.out.print(paramTypes[j].getName());</span><br><span class="line">         &#125;</span><br><span class="line">         System.out.println(<span class="string">");"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Prints all methods of a class</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> cl a class</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMethods</span><span class="params">(Class cl)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      Method[] methods = cl.getDeclaredMethods();<span class="comment">//获取这个类/接口的所有方法</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Method m : methods)</span><br><span class="line">      &#123;</span><br><span class="line">         Class retType = m.getReturnType();<span class="comment">//获取返回值</span></span><br><span class="line">         String name = m.getName();<span class="comment">//获取方法名</span></span><br><span class="line"></span><br><span class="line">         System.out.print(<span class="string">"   "</span>);</span><br><span class="line">         <span class="comment">// print modifiers, return type and method name</span></span><br><span class="line">         String modifiers = Modifier.toString(m.getModifiers());<span class="comment">//获取方法修饰符</span></span><br><span class="line">         <span class="keyword">if</span> (modifiers.length() &gt; <span class="number">0</span>) System.out.print(modifiers + <span class="string">" "</span>);         </span><br><span class="line">         System.out.print(retType.getName() + <span class="string">" "</span> + name + <span class="string">"("</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// print parameter types</span></span><br><span class="line">         Class[] paramTypes = m.getParameterTypes();<span class="comment">//获取方法参数类型</span></span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; paramTypes.length; j++)</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="keyword">if</span> (j &gt; <span class="number">0</span>) System.out.print(<span class="string">", "</span>);</span><br><span class="line">            System.out.print(paramTypes[j].getName());</span><br><span class="line">         &#125;</span><br><span class="line">         System.out.println(<span class="string">");"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Prints all fields of a class</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> cl a class</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printFields</span><span class="params">(Class cl)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      Field[] fields = cl.getDeclaredFields();<span class="comment">//获取该类所有成员变量</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Field f : fields)</span><br><span class="line">      &#123;</span><br><span class="line">         Class type = f.getType();</span><br><span class="line">         String name = f.getName();</span><br><span class="line">         System.out.print(<span class="string">"   "</span>);</span><br><span class="line">         String modifiers = Modifier.toString(f.getModifiers());</span><br><span class="line">         <span class="keyword">if</span> (modifiers.length() &gt; <span class="number">0</span>) System.out.print(modifiers + <span class="string">" "</span>);         </span><br><span class="line">         System.out.println(type.getName() + <span class="string">" "</span> + name + <span class="string">";"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">  值得注意的是Field、Method、Constructor在使用.get/.set访问时只能获取设置可访问的成员变量，如<span class="keyword">public</span>等，如果想要覆盖访问控制可以调用AccessibleObject.setAccessible(AccessibleObject[],<span class="keyword">boolean</span>);</span><br><span class="line">  </span><br><span class="line">#### 反射编写泛型数组代码</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">package</span> arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyOfTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="keyword">int</span>[] a = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line">      a = (<span class="keyword">int</span>[]) goodCopyOf(a, <span class="number">10</span>);</span><br><span class="line">      System.out.println(Arrays.toString(a));</span><br><span class="line"></span><br><span class="line">      String[] b = &#123; <span class="string">"Tom"</span>, <span class="string">"Dick"</span>, <span class="string">"Harry"</span> &#125;;</span><br><span class="line">      b = (String[]) goodCopyOf(b, <span class="number">10</span>);</span><br><span class="line">      System.out.println(Arrays.toString(b));</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">"The following call will generate an exception."</span>);</span><br><span class="line">      b = (String[]) badCopyOf(b, <span class="number">10</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * This method attempts to grow an array by allocating a new array and copying all elements.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> a the array to grow</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> newLength the new length</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a larger array that contains all elements of a. However, the returned array has </span></span><br><span class="line"><span class="comment">    * type Object[], not the same type as a</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> Object[] badCopyOf(Object[] a, <span class="keyword">int</span> newLength) <span class="comment">// not useful</span></span><br><span class="line">  <span class="comment">//一个从一开始就是Object[]的数组是不能够向下转型为其它类型数组的，故需要在一开始创建与原数组类型相同的数组</span></span><br><span class="line">   &#123;</span><br><span class="line">      Object[] newArray = <span class="keyword">new</span> Object[newLength];</span><br><span class="line">      System.arraycopy(a, <span class="number">0</span>, newArray, <span class="number">0</span>, Math.min(a.length, newLength));</span><br><span class="line">      <span class="keyword">return</span> newArray;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * This method grows an array by allocating a new array of the same type and</span></span><br><span class="line"><span class="comment">    * copying all elements.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> a the array to grow. This can be an object array or a primitive</span></span><br><span class="line"><span class="comment">    * type array</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a larger array that contains all elements of a.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">goodCopyOf</span><span class="params">(Object a, <span class="keyword">int</span> newLength)</span> </span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      Class cl = a.getClass();</span><br><span class="line">      <span class="keyword">if</span> (!cl.isArray()) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      Class componentType = cl.getComponentType();<span class="comment">//获取数据类型</span></span><br><span class="line">      <span class="keyword">int</span> length = Array.getLength(a);</span><br><span class="line">      Object newArray = Array.newInstance(componentType, newLength);</span><br><span class="line">      System.arraycopy(a, <span class="number">0</span>, newArray, <span class="number">0</span>, Math.min(length, newLength));</span><br><span class="line">      <span class="keyword">return</span> newArray;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调用任意方法"><a href="#调用任意方法" class="headerlink" title="调用任意方法"></a>调用任意方法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> methods;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodTableTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="comment">// get method pointers to the square and sqrt methods</span></span><br><span class="line">      Method square = MethodTableTest.class.getMethod("square", double.class);</span><br><span class="line">      Method sqrt = Math.class.getMethod("sqrt", double.class);//第一个参数为方法名，后面若干变量为方法参数类型</span><br><span class="line"></span><br><span class="line">      <span class="comment">// print tables of x- and y-values</span></span><br><span class="line"></span><br><span class="line">      printTable(<span class="number">1</span>, <span class="number">10</span>, <span class="number">10</span>, square);</span><br><span class="line">      printTable(<span class="number">1</span>, <span class="number">10</span>, <span class="number">10</span>, sqrt);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the square of a number</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> x a number</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> x squared</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">square</span><span class="params">(<span class="keyword">double</span> x)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> x * x;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Prints a table with x- and y-values for a method</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> from the lower bound for the x-values</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> to the upper bound for the x-values</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> n the number of rows in the table</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> f a method with a double parameter and double return value</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTable</span><span class="params">(<span class="keyword">double</span> from, <span class="keyword">double</span> to, <span class="keyword">int</span> n, Method f)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="comment">// print out the method as table header</span></span><br><span class="line">      System.out.println(f);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">double</span> dx = (to - from) / (n - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">double</span> x = from; x &lt;= to; x += dx)</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">try</span></span><br><span class="line">         &#123;</span><br><span class="line">            <span class="keyword">double</span> y = (Double) f.invoke(<span class="keyword">null</span>, x);<span class="comment">//调用当前封装在Method中的方法，如果是静态方法，第一个参数隐式参数传null，后面若干变量为方法参数。</span></span><br><span class="line">            System.out.printf(<span class="string">"%10.4f | %10.4f%n"</span>, x, y);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Exception e)</span><br><span class="line">         &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Thinking in Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin修仙之逍遥篇</title>
    <url>/2015/12/04/Kotlin%E9%80%8D%E9%81%A5%E7%AF%87/</url>
    <content><![CDATA[<h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><ol>
<li>kt中构造方法分为主构造方法和次构造方法。</li>
<li>主构造方法可看作是必定会执行的构造方法，且是唯一；次构造方法是重写了的构造方法，且不唯一，第二构造方法必须在方法声明后调用主构造方法。</li>
<li>kt中，主构造方法的参数允许使用var和val关键字，var表示该参数可修改，val不可修改；次构造方法里不能使用var和val关键字，即次构造方法都是只读的，不能在构造方法内部改变参数的值。</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>  <span class="keyword">constructor</span></span>(firstName: String=<span class="string">"Night"</span>) &#123;<span class="comment">//声明主构造器</span></span><br><span class="line">        <span class="comment">//如果constructor前没有修饰符则constructor可省略不写。</span></span><br><span class="line">        <span class="keyword">init</span> &#123;<span class="comment">//主构造方法</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(a: <span class="built_in">Int</span>) : <span class="keyword">this</span>(<span class="string">""</span>)&#123;<span class="comment">//必须先调用主构造器</span></span><br><span class="line">        println(<span class="string">""</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">        Person()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方法中的默认参数"><a href="#方法中的默认参数" class="headerlink" title="方法中的默认参数"></a>方法中的默认参数</h3><p>emmmm，我们造Java中是不可以设置默认参数的，毕竟底层的JVM就不支持。那可以转化为java字节码的kt却意外地支持。(≧▽≦)/，那它是怎么做到的呢？从上述代码的字节码出发</p>
<p>在intellj/AndroidStudio中查看kotlin的字节码选项是在 Menu &gt; Tools &gt; Kotlin &gt; Show Kotlin Bytecode。点击Decompile即可得到字节码，字节码还是太鬼畜啦，我们还是看下java代码压下惊吧。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.DefaultConstructorMarker;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.Intrinsics;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Metadata</span>(</span><br><span class="line">   mv = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">7</span>&#125;,</span><br><span class="line">   bv = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>&#125;,</span><br><span class="line">   k = <span class="number">1</span>,</span><br><span class="line">   d1 = &#123;<span class="string">"\u0000(\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0000\n\u0002\u0010\b\n\u0002\b\u0002\n\u0002\u0010\u000e\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0000\n\u0002\u0010\u0011\n\u0002\b\u0002\u0018\u00002\u00020\u0001B\u000f\b\u0016\u0012\u0006\u0010\u0002\u001a\u00020\u0003¢\u0006\u0002\u0010\u0004B\u000f\u0012\b\b\u0002\u0010\u0005\u001a\u00020\u0006¢\u0006\u0002\u0010\u0007J\u0019\u0010\b\u001a\u00020\t2\f\u0010\n\u001a\b\u0012\u0004\u0012\u00020\u00060\u000b¢\u0006\u0002\u0010\f¨\u0006\r"</span>&#125;,</span><br><span class="line">   d2 = &#123;<span class="string">"Lcom/example/shopsystem/Person;"</span>, <span class="string">""</span>, <span class="string">"a"</span>, <span class="string">""</span>, <span class="string">"(I)V"</span>, <span class="string">"firstName"</span>, <span class="string">""</span>, <span class="string">"(Ljava/lang/String;)V"</span>, <span class="string">"main"</span>, <span class="string">""</span>, <span class="string">"args"</span>, <span class="string">""</span>, <span class="string">"([Ljava/lang/String;)V"</span>, <span class="string">"production sources for module ShopSystem"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(@NotNull String[] args)</span> </span>&#123;</span><br><span class="line">      Intrinsics.checkParameterIsNotNull(args, <span class="string">"args"</span>);</span><br><span class="line">      <span class="keyword">new</span> Person((String)<span class="keyword">null</span>, <span class="number">1</span>, (DefaultConstructorMarker)<span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(@NotNull String firstName)</span> </span>&#123;</span><br><span class="line">      Intrinsics.checkParameterIsNotNull(firstName, <span class="string">"firstName"</span>);</span><br><span class="line">      <span class="keyword">super</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//自动生成的处理默认参数的构造方法</span></span><br><span class="line">   <span class="comment">//DefaultConstructorMarker是kotlin的一个内部类，负责处理构造方法的默认参数值。</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String var1, <span class="keyword">int</span> var2, DefaultConstructorMarker var3)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ((var2 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">         var1 = <span class="string">"Night"</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>(var1);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//自动生成的没有参数的构造方法</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>((String)<span class="keyword">null</span>, <span class="number">1</span>, (DefaultConstructorMarker)<span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>(<span class="string">""</span>);</span><br><span class="line">      String var2 = <span class="string">""</span>;</span><br><span class="line">      System.out.println(var2);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   从上面代码可以看出，源码并没有直接调用主构造方法，而是调用了另一个自动生成的处理默认参数的构造方法。指定参数的默认值，再调用主构造方法。所以其实kt中的参数默认值是通过在中间构造方法硬编码到字节码中的，然后在中间构造方法又调用包含默认参数值的构造方法。</p>
<p>   kt中方法默认值的设置和C++类似，设置默认值是从后往前的，也就是说如果某个参数带默认值，那么该参数后面的所有参数必须都有默认值。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">constructor</span></span>(a :String ,b:<span class="built_in">Int</span>=<span class="number">3</span>,c:<span class="built_in">Int</span>=<span class="number">4</span>)&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>   那如果有这么一种情况，一个方法里指定了很多默认值，你只想修改一个默认值的输入，其余采取原默认值。kt中可以命名参数来传递参数值。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">Person(<span class="string">""</span>,c=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>   kt中创建类和调用方法语法上是没有区别的，都是类名、方法名（）；因此kt中，<code>调用方法和创建类的实例是通过语义和上下文来进行区分</code></p>
<h3 id="方法中空参数"><a href="#方法中空参数" class="headerlink" title="方法中空参数"></a>方法中空参数</h3><p>  kt默认在方法中的参数是不允许为空，当传入的参数为空，编译器会直接编译报错；如果想指定方法中的参数可为空，在参数后面加入？即可</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">b</span><span class="params">(s:<span class="type">String</span>?)</span></span>&#123;</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="属性语法"><a href="#属性语法" class="headerlink" title="属性语法"></a>属性语法</h3><p>   属性语法：类似JavaBean中属性的getter,setter方法；<br>   看一段代码</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = Person()</span><br><span class="line">   p.a=<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>   代码很简单是吧，但p.a=5其实并不是直接赋值，而是调用了属性a的get属性方法。你可能想我并没有写a的get和set方法；其实类的成员变量有默认的get、set方法。</p>
<p>   当然你可能想重写get、set方法，这就需要属性语法啦~<br>   完整的属性语法如下：</p>
<pre><code>var/val &lt;propertyName&gt;[: &lt;PropertyType&gt;] [= &lt;property_initializer&gt;]
[&lt;getter&gt;]
[&lt;setter&gt;]
</code></pre><p>   操作如下：</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">	 <span class="keyword">var</span> a: <span class="built_in">Int</span>=<span class="number">0</span></span><br><span class="line">        <span class="keyword">get</span>() = field</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">        &#125;</span><br><span class="line">```     </span><br><span class="line">   </span><br><span class="line">   和Java类似如果变量声明为<span class="keyword">private</span>，还想在类外访问必须手写<span class="keyword">get</span>、<span class="keyword">set</span>方法。不造intellij idea为什么没有自动生成功能⊙︿⊙.</span><br><span class="line"></span><br><span class="line">```kolin</span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">geta</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>   方法中的可变参数：</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(<span class="keyword">vararg</span> persons: <span class="type">Person</span>)</span></span> &#123;<span class="comment">//persons为可变参数，可传入任意多个Person对象</span></span><br><span class="line">      </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>   当函数体只有一行代码时，可直接在函数体声明后直接加=号，后面直接加代码。返回值类型可省略</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">()</span></span>:String = a</span><br><span class="line"><span class="comment">//fun get()= a  两种表达方式等价，</span></span><br></pre></td></tr></table></figure>
<h3 id="本地函数"><a href="#本地函数" class="headerlink" title="本地函数"></a>本地函数</h3><p>   就是函数中套函数，在java中函数中函数是不允许的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fun add(vararg person: Person) &#123;</span><br><span class="line">       fun a() &#123;&#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><p>   和Java有差异的就只有kt并没有default修饰符，kt默认是public。kt多了一个internel修饰符。</p>
<p>   internal：任何在Module内部类都可以访问。</p>
<h3 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h3><h4 id="重写方法"><a href="#重写方法" class="headerlink" title="重写方法"></a>重写方法</h4><p>   如果一个类是可继承的则需要显示的使用open关键字表明该类是可继承的。如果父类中的方法需要被重写则也需要加上open关键字。子类对应的方法也需要加上override关键字。如下所示：<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">constructor</span></span>(a :String ,b:<span class="built_in">Int</span>=<span class="number">3</span>,c:<span class="built_in">Int</span>=<span class="number">3</span>)&#123;</span><br><span class="line">   <span class="comment">//声明主构造器</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">var</span> b: <span class="built_in">Int</span> = <span class="number">3</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">var</span> a: <span class="built_in">Int</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">geta</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> a</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">student</span> : <span class="type">Person</span></span>(<span class="string">""</span>) &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">geta</span><span class="params">()</span></span>:<span class="built_in">Int</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.geta()</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="重写属性"><a href="#重写属性" class="headerlink" title="重写属性"></a>重写属性</h4><p>属性也可以重写，是的，你没有听错，只要998，只要998，你就能……咳咳，要注意哈，val属性可被重写为var属性，反之则不行。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">constructor</span></span>(a :String ,b:<span class="built_in">Int</span>=<span class="number">3</span>,c:<span class="built_in">Int</span>=<span class="number">3</span>)&#123;</span><br><span class="line">    <span class="comment">//声明主构造器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> b: <span class="built_in">Int</span> = <span class="number">3</span></span><br><span class="line">    <span class="keyword">open</span>  <span class="keyword">val</span> a: <span class="built_in">Int</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">geta</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">student</span> : <span class="type">Person</span></span>(<span class="string">""</span>) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> a:<span class="built_in">Int</span>=<span class="number">3</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">geta</span><span class="params">()</span></span>:<span class="built_in">Int</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.geta()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>与Java的差异：kt中的接口可以有默认方法实现，有默认方法实现的方法可以不重写该方法</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">constructor</span></span>(a :String ,b:<span class="built_in">Int</span>=<span class="number">3</span>,c:<span class="built_in">Int</span>=<span class="number">3</span>):Talk&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">a</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        TODO(<span class="string">"not implemented"</span>) <span class="comment">//To change body of created functions use File | Settings | File Templates.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Talk</span></span>&#123;<span class="comment">//接口所有属性、方法都是open的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">say</span><span class="params">()</span></span>: String&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"bb"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">a</span><span class="params">()</span></span>:String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Kotlin学习笔记</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>Kotlin修仙之觉醒篇</title>
    <url>/2015/12/03/Kotlin%E8%A7%89%E9%86%92%E7%AF%87/</url>
    <content><![CDATA[<h2 id="Kotlin基本语法"><a href="#Kotlin基本语法" class="headerlink" title="Kotlin基本语法"></a>Kotlin基本语法</h2><h3 id="变量与常量"><a href="#变量与常量" class="headerlink" title="变量与常量"></a>变量与常量</h3><ol>
<li>语句末尾没有分号</li>
<li>变量以var开头，常量以val开头</li>
<li>数据类型放在变量的后面，且用：隔开</li>
<li>数据类型首字母大写</li>
<li>变量未初始化，必须指定数据类型，如果初始化了，就可以不指定数据类型。kotlin会自动推导数据类型<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a: <span class="built_in">Int</span> = <span class="number">3</span></span><br><span class="line"><span class="keyword">val</span> b: <span class="built_in">Int</span> = <span class="number">20</span></span><br><span class="line"><span class="keyword">var</span> c =<span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>敲黑板:<code>和 Java类似的是常量的值是不能修改的.</code></p>
<p><img src="/images/常量修改编译错误.png" alt="更改常量编译出错"></p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>函数头除了函数名还有fun关键字，返回值在末尾指定与函数定义部分用：隔开。返回值为void可以不写</p>
<p>举个栗子：<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">   	<span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">   	setContentView(R.layout.activity_main)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(a:<span class="type">Int</span>,b:<span class="type">Int</span>)</span></span>:<span class="built_in">Int</span>&#123;</span><br><span class="line">   	<span class="keyword">return</span> a+b</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Kotlin数据类型"><a href="#Kotlin数据类型" class="headerlink" title="Kotlin数据类型"></a>Kotlin数据类型</h2><h3 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h3><p>kotlin内置数据类型将Java中基本数据类型首字母大写，诸如Double、Int、Byte.<br>值得注意的是：<code>kotlin不像Java一样会自动将数据类型向上转型。</code><br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m=<span class="number">20</span></span><br><span class="line"><span class="keyword">var</span> n:<span class="built_in">Byte</span>=<span class="number">10</span></span><br><span class="line">m=n<span class="comment">//会报Type mismatch error</span></span><br></pre></td></tr></table></figure></p>
<p>那如果傲娇的想要转换总归还是有办法的：</p>
<ul>
<li>toByte()//转换到Byte</li>
<li>toShort()//转换到Short</li>
<li>、、、</li>
</ul>
<p>Long与Float表示：<br>Long:123L<br>Float:12.F</p>
<p>kotlin支持_进行占位,可以不用马上确定值的大小。</p>
<pre><code>val oneMillion=1_000_000    
</code></pre><p><img src="/images/happy.png" alt></p>
<p>kotlin并不支持8进制<br><img src="/images/helpness.png" alt></p>
<h3 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h3><p><code>kotlin中字符不能当作数字进行食用。</code></p>
<p>so，this is wrong.</p>
<pre><code>var a:Char=&apos;a&apos;
if(a==95)//编译出错
</code></pre><p>难道就没有姿势食用吗？<br><img src="/images/noexist.jpg" alt></p>
<p>前面不是被我提过那啥to什么的，对就是toInt().</p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><ul>
<li>kotlin中，数组使用Array类。如IntArray、ShortArray</li>
<li>arrayOf()函数定义存储<code>任何值</code>的数组。</li>
<li>arrayOfNulls:定义指定长度的空数组</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> arr= arrayOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">'a'</span>)</span><br><span class="line">arr[<span class="number">2</span>]=<span class="string">'b'</span></span><br><span class="line"><span class="keyword">var</span> arr1 = arrayOfNulls&lt;<span class="built_in">Int</span>&gt;(<span class="number">10</span>)</span><br><span class="line"><span class="comment">//使用Array类的构造器进行定义数组，第一个参数：size,第二个参数：初始化每一个数组元素的值</span></span><br><span class="line"><span class="comment">//每个数组元素的就是当前数组索引i的乘积的String。</span></span><br><span class="line"><span class="keyword">var</span> arr2=Array(<span class="number">10</span>,&#123;i-&gt;(i*i).toString()&#125;)</span><br><span class="line"><span class="keyword">var</span> arr3=intArrayOf(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>kotlin也是使用String作为字符串。除了普通使用的字符串</p>
<pre><code>var s=&quot;hello world\n&quot;
</code></pre><h4 id="神奇的保留原格式的字符串："><a href="#神奇的保留原格式的字符串：" class="headerlink" title="神奇的保留原格式的字符串："></a>神奇的保留原格式的字符串：</h4><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s=<span class="string">"""</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	hello </span></span><br><span class="line"><span class="string">		world</span></span><br><span class="line"><span class="string">			"""</span></span><br></pre></td></tr></table></figure>
<p>输出格式就是:<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">hello </span><br><span class="line">	world</span><br><span class="line">																	.</span><br></pre></td></tr></table></figure></p>
<p>Amazing!</p>
<h4 id="字符串模版"><a href="#字符串模版" class="headerlink" title="字符串模版"></a>字符串模版</h4><p>   字符串添加占位符，内容可在后期指定。模版用$指定，$后跟的是变量如下所示<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> i=<span class="number">10</span></span><br><span class="line"><span class="keyword">val</span> s=<span class="string">"i=<span class="variable">$i</span>"</span></span><br><span class="line">println(s1)</span><br></pre></td></tr></table></figure></p>
<p>输出：i=3</p>
<h2 id="包"><a href="#包" class="headerlink" title="包"></a>包</h2><p>kotlin中的包与目录没关系，<code>kt中的包仅仅是为了引用文件资源（函数和类等）。</code>kt为什么会想单单import个方法，java也有import一个static方法的做法，但是key point Java中方法是定义在类中的，而kt中方法是可以写在类外面的，经测试，kt中类外的方法是static方法，在同包下可以直接访问，不同包下需要import.</p>
<p>   kotlin会默认导入一些常用包，如java.lang.<em>、kotlin.jvm.</em>、kotlin.*等。</p>
<h2 id="控制流"><a href="#控制流" class="headerlink" title="控制流"></a>控制流</h2><h3 id="if语句本身就是表达式"><a href="#if语句本身就是表达式" class="headerlink" title="if语句本身就是表达式."></a>if语句本身就是表达式.</h3><p>kt中的三表达式只能用if，else完成</p>
<pre><code>val max=if(a&gt;b) a else b
</code></pre><h3 id="多分支选择之when"><a href="#多分支选择之when" class="headerlink" title="多分支选择之when"></a>多分支选择之when</h3><p>   kt中when取代了switch的位置，就这么上位了，小不习惯的<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x=<span class="number">1</span></span><br><span class="line"><span class="keyword">when</span>(x)&#123;</span><br><span class="line">	<span class="number">1</span>-&gt;&#123;</span><br><span class="line">		<span class="comment">//多于一条语句用&#123;&#125;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="number">2</span>-&gt;&#123;</span><br><span class="line">		<span class="comment">//满足条件的分支执行后，会自动终止when语句的执行</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="number">3</span>,<span class="number">4</span>-&gt;&#123;</span><br><span class="line">		<span class="comment">//多分支执行相同代码</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>-&gt;&#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>   当执行同代码的条件比较多时，可食用in关键字。代码：<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">when</span>(n)&#123;</span><br><span class="line">	<span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span>-&gt;&#123;&#125;</span><br><span class="line">	! <span class="keyword">in</span> <span class="number">30</span>..<span class="number">60</span>-&gt;&#123;&#125;<span class="comment">//!in表示不在</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>   when分支条件不仅可以是常量，还可以是任意表达式。如函数。<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">      <span class="keyword">var</span> n=<span class="number">4</span></span><br><span class="line">      <span class="keyword">when</span> (n) &#123;</span><br><span class="line">          <span class="keyword">get</span>(<span class="number">2</span>)-&gt;&#123;&#125;</span><br><span class="line">          <span class="keyword">get</span>(<span class="number">4</span>)-&gt;&#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(i: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> i*i</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p>   for-iterator:<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr =intArrayOf(<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span>(item:<span class="built_in">Int</span> <span class="keyword">in</span> arr)&#123;</span><br><span class="line">	println(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> arr.indices)&#123;<span class="comment">//i：是索引</span></span><br><span class="line">	println(<span class="string">"arr[<span class="variable">$i</span>]="</span>+arr[i])</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>((index,value) <span class="keyword">in</span> array.withIndex())&#123;<span class="comment">//键值对</span></span><br><span class="line">	println(<span class="string">"arr[<span class="variable">$index</span>]="</span>+value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Kotlin学习笔记</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>dx.jar is missing</title>
    <url>/2015/07/03/%E5%AF%BC%E5%85%A5%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%AE%89%E8%A3%85%E5%9C%A8%E7%9C%9F%E6%9C%BA%E6%97%B6%E5%87%BA%E7%8E%B0dex.jar%20is%20missing%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<h1 id="Bug代码："><a href="#Bug代码：" class="headerlink" title="Bug代码："></a>Bug代码：</h1><p>Error:Execution failed for task ‘:app:transformClassesWithDexForDebug’. &gt; com.android.build.api.transform.TransformException: java.lang.RuntimeException: java.lang.RuntimeException: com.android.ide.common.process.ProcessException: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: dx.jar is missing<br> 报错的原因：<br> <code>该项目的buildTools太低了，把它改大一点就Ok了。Like this!</code></p>
<p> <img src="http://img.blog.csdn.net/20170220195157052?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzMyOTkyODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="build gradle配置文件"></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Bug调试</tag>
      </tags>
  </entry>
</search>
