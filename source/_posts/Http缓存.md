title: Http缓存
date: 2018-3-23
tags: [缓存]
categories: 计算机网络
description: 304重定向
---
转自[reference_link](https://www.cnblogs.com/chenqf/p/6386163.html)
## 基础知识
Q:Http的所有请求都会到服务器吗？
A:不会，当缓存策略采取了强制缓存时，会直接从本地内存中读取

HTTP报文就是浏览器和服务器间通信时发送及响应的数据块。
浏览器向服务器请求数据，发送请求(request)报文；服务器向浏览器返回数据，返回响应(response)报文。
报文信息主要分为两部分
1.包含属性的首部(header)--------------------------附加信息（cookie，缓存信息等）与缓存相关的规则信息，均包含在header中
2.包含数据的主体部分(body)-----------------------HTTP请求真正想要传输的部分

## 缓存规则
为方便理解，假设浏览器存在一个缓存数据库,用于存储缓存信息。（实则并不存在，以本地缓存形式存在）
在客户端第一次请求数据时，此时缓存数据库中没有对应的缓存数据，需要请求服务器，服务器返回后，将数据存储至缓存数据库中。
![first_request](/images/first_request.png)

HTTP缓存有多种规则，根据是否需要重新向服务器发起请求来分类，将其分为两大类—`强制缓存，对比缓存`

### 强制缓存
已存在缓存数据时，仅基于强制缓存，请求数据的流程如下
![force_cache](/images/force_cache.PNG)
强制缓存，在缓存数据未失效的情况下，可以直接使用缓存数据，那么浏览器是如何判断缓存数据是否失效呢？
我们知道，在没有缓存数据的时候，浏览器向服务器请求数据时，服务器会将数据和缓存规则一并返回，缓存规则信息包含在response的header中。
对于强制缓存来说，响应header中会有两个字段来标明失效规则（Expires/Cache-Control）
Expires 一般会放在响应头中，表示过期时间
Expires: Thu, 12 Jan 2017 11:01:33 GMT
Cache-Control 表示缓存的时间 max-age = 60 表示可以缓存 60s

　Expires的值为服务端返回的到期时间，即下一次请求时，请求时间小于服务端返回的到期时间，直接使用缓存数据。
不过Expires 是HTTP 1.0的东西，现在默认浏览器均默认使用HTTP 1.1，所以它的作用基本忽略。因为到期时间是由服务端生成的，但是客户端时间可能跟服务端时间有误差，这就会导致缓存命中的误差。
所以HTTP 1.1 的版本，使用Cache-Control替代。

### 对比缓存
对比缓存，顾名思义，需要进行比较判断是否可以使用缓存。
![compare_cache](/images/compare_cache.PNG)
浏览器第一次请求数据时，服务器会将缓存标识与数据一起返回给客户端，客户端将二者备份至缓存数据库中。
再次请求数据时，客户端将备份的缓存标识发送给服务器，服务器根据缓存标识进行判断，缓存未失效的情况下，返回304状态码，通知客户端比较成功，可以使用缓存数据。缓存失效，则返回最新数据和缓存规则。那服务器是如何判断缓存失效呢？
对于对比缓存来说，缓存标识的传递是我们着重需要理解的，它在请求header和响应header间进行传递，
一共分为两种标识传递，接下来，我们分开介绍。
#### E-Tag / If-None-Match （优先级高于Last-Modified  /  If-Modified-Since）
 E-Tag 表示服务器返回的一个资源标识，下次客户端请求时将该值作为 key 为 If-None-Match 的值传给服务器判断，如果ETag没改变，则返回状态304；否则返回最新的数据与缓存规则。
 #### Last-Modified / if-Modified-since
Last-Modified  在浏览器第一次请求某一个URL时，服务器端的返回状态会是200，内容是你请求的资源，同时有一个Last-Modified的属性标记此文件在服务期端最后被修改的时间，格式类似这样：Last-Modified:Tue, 24 Feb 2009 08:01:04 GMT，第二次请求浏览器会向服务器传送If-Modified-Since，询问该时间之后文件是否有被修改过，如果资源没有变化，则自动返回HTTP304状态码，内容为空，这样就节省了传输数据量；否则返回最新的数据与缓存规则。

## 总结
强制缓存如果生效，不需要再和服务器发生交互，而对比缓存不管是否生效，都需要与服务端发生交互。
两类缓存规则可以同时存在，强制缓存优先级高于对比缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行对比缓存规则。
对于强制缓存，服务器通知浏览器一个缓存时间，在缓存时间内，下次请求，直接用缓存，不在时间内，执行比较缓存策略。
对于比较缓存，将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，返回304状态码时，浏览器直接使用缓存。
流程如下：
![browser_request_again](/images/browser_request_again.png)

